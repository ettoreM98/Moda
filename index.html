<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Archivio Moda</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* --- STILE ORIGINALE LOGIN (RIPRISTINATO) --- */
    body { background:#0a0a0a; color:#fff; font-family:'Inter',sans-serif; margin:0; height:100vh; overflow-x: hidden; }
    .serif { font-family:'Playfair Display',serif }
    .hidden { display:none!important }
    
    .split-layout { display:flex; height:100vh; width: 100vw; position: fixed; top:0; left:0; z-index: 50; background:#0a0a0a; transition: transform 0.8s ease-in-out; }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }

    /* Effetto Hover Foto (Ripristinato) */
    .visual-side img{
      position:absolute; top:0; left:0; width:100%; height:100%;
      object-fit:cover; filter:grayscale(100%); opacity:0;
      transition:opacity 1.5s ease, filter .8s ease; z-index:0
    }
    .visual-side img.active{ opacity:1; z-index:1 }
    .visual-side img:hover{ filter:grayscale(0%); cursor:crosshair }

    .form-side{
      flex:1; display:flex; flex-direction:column; justify-content:center;
      padding:60px; background:#0a0a0a; max-width:600px; margin:auto
    }
    .input-group{ margin-bottom:25px }
    .input-label{
      display:block; font-size:10px; text-transform:uppercase;
      letter-spacing:2px; color:#555; margin-bottom:8px
    }
    input{
      background:transparent; border-bottom:1px solid #222;
      padding:10px 0; color:#fff; width:100%; outline:none; font-size:14px
    }
    input:focus{ border-bottom-color:#fff }
    .btn-white{
      background:#fff; color:#000; padding:18px; font-weight:500;
      text-transform:uppercase; width:100%; cursor:pointer;
      border:1px solid #fff; transition:.3s; margin-top:10px
    }
    .btn-white:hover{ background:#000; color:#fff }
    #msg-box{
      display:none; padding:12px; border:1px solid #333;
      font-size:11px; text-transform:uppercase;
      margin-bottom:20px; text-align:center
    }
    .link-small{
      text-align:center; margin-top:20px;
      font-size:10px; color:#555; cursor:pointer;
      text-transform:uppercase; letter-spacing:1px
    }

    /* --- STILI SOCIAL (MODIFICATI PER SCORRIMENTO) --- */
    #app-interface { display: none; min-height: 100vh; background: #000; }
    .app-layout { display: flex; max-width: 1400px; margin: 0 auto; min-height: 100vh; }
    
    .sidebar { width: 250px; border-right: 1px solid #262626; height: 100vh; position: sticky; top: 0; padding: 20px; display: flex; flex-direction: column; }
    .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #f5f5f5; margin-bottom: 5px; }
    .nav-item:hover { background: #1a1a1a; }

    .main-content { flex: 1; padding: 40px; overflow-y: auto; }
    
    /* Layout Post (Tipo Facebook/Instagram) */
    .feed-container { max-width: 600px; margin: 0 auto; }
    .post-card { background: #000; border: 1px solid #262626; border-radius: 8px; margin-bottom: 30px; padding: 15px; }
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
    .post-img { width: 100%; border-radius: 4px; cursor: pointer; border: 1px solid #262626; }
    
    /* Profilo Utente (Dashboard) */
    .profile-header { text-align: center; border-bottom: 1px solid #262626; padding-bottom: 30px; margin-bottom: 30px; }
    .big-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #333; margin: 0 auto 15px; cursor: pointer; transition: 0.3s; }
    .big-avatar:hover { border-color: #fff; opacity: 0.8; }
    
    /* Modale Post (Zoom + Commenti) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .post-modal-box { background: #000; width: 90%; max-width: 900px; height: 80vh; border: 1px solid #333; display: flex; border-radius: 4px; overflow: hidden; }
    .modal-img-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; border-right: 1px solid #262626; }
    .modal-img-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .modal-info-side { flex: 1; display: flex; flex-direction: column; padding: 20px; }
    .comment-list { flex: 1; overflow-y: auto; margin: 20px 0; border-top: 1px solid #262626; padding-top: 10px; font-size: 13px; }
  </style>
</head>

<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>

  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic">Hawenishland</h1>
    <div id="msg-box"></div>

    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>

    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username (Pubblico)</label><input type="text" id="r-username"></div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome"></div>
      </div>
      <div class="input-group"><label class="input-label">Data di Nascita</label><input type="date" id="r-nascita" style="color-scheme:dark"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass"></div>
      <button onclick="faiRegistrazione()" class="btn-white">Registrati</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface">
  <div class="app-layout">
    
    <div class="sidebar">
      <h1 class="serif italic text-2xl mb-8 pl-4 cursor-pointer" onclick="switchView('feed')">Hawenishland</h1>
      <div class="nav-item" onclick="switchView('feed')"><i class="fa-solid fa-house"></i><span>Home Feed</span></div>
      <div class="nav-item" onclick="openSearch()"><i class="fa-solid fa-magnifying-glass"></i><span>Cerca</span></div>
      <div class="nav-item" onclick="openUploadModal()"><i class="fa-regular fa-square-plus"></i><span>Nuovo Post</span></div>
      <div class="nav-item" onclick="switchView('dashboard')"><i class="fa-regular fa-user"></i><span>Il Mio Profilo</span></div>
      <div class="mt-auto nav-item text-red-500" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Esci</span></div>
    </div>

    <div class="main-content">
      
      <div id="view-feed" class="view-section">
        <h2 class="serif text-2xl mb-6 italic">Ultime Novità</h2>
        <div class="feed-container" id="posts-feed"></div>
      </div>

      <div id="view-dashboard" class="view-section hidden">
        <div class="feed-container">
          
          <div class="profile-header">
            <div class="relative inline-block">
               <img id="dash-avatar" src="https://via.placeholder.com/150" class="big-avatar" onclick="document.getElementById('avatar-upload').click()">
               <div class="text-xs text-gray-500 mt-2">Clicca la foto per cambiarla</div>
               <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar()">
            </div>
            <h2 id="dash-username" class="text-2xl font-light mt-4">...</h2>
            <p id="dash-fullname" class="font-bold text-gray-400 text-sm mb-4">...</p>
            
            <div class="max-w-xs mx-auto bg-[#111] p-4 rounded border border-[#333] text-left mt-4 hidden" id="edit-info-box">
              <label class="input-label">Nuovo Nome</label>
              <input type="text" id="edit-name-input" class="mb-2">
              <button onclick="updateProfileInfo()" class="btn-white py-2 text-xs">Salva Info</button>
            </div>
            <button onclick="document.getElementById('edit-info-box').classList.toggle('hidden')" class="text-xs underline text-gray-500 mt-2">Modifica Dati Personali</button>
          </div>

          <h3 class="serif text-xl mb-6 italic text-center">I Miei Post</h3>
          <div id="my-posts-feed"></div>

        </div>
      </div>

    </div>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="modal-box" style="background:#111; padding:30px; max-width:400px; width:90%;">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-xl" onclick="closeModal('upload-modal')"></i>
    <h2 class="serif text-xl mb-4 italic">Crea Post</h2>
    
    <label class="block mb-4 text-center border border-dashed border-gray-500 p-6 rounded cursor-pointer hover:border-white">
      <span class="text-xs uppercase block mb-2">Seleziona Foto (Obbligatoria)</span>
      <input type="file" id="post-file" accept="image/*">
    </label>
    
    <input type="text" id="post-caption" placeholder="Scrivi qualcosa..." class="w-full bg-black border-b border-gray-600 p-2 mb-4 text-white outline-none">
    <button onclick="submitPost()" class="btn-white">Pubblica</button>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="post-modal-box">
    <div class="modal-img-side">
      <img id="detail-img" src="">
    </div>
    <div class="modal-info-side relative">
      <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-xl" onclick="closeModal('post-detail-modal')"></i>
      
      <div class="flex items-center gap-3 mb-4">
        <img id="detail-avatar" src="" class="w-8 h-8 rounded-full bg-gray-700">
        <span id="detail-username" class="font-bold text-sm">User</span>
      </div>
      
      <p id="detail-caption" class="text-sm text-gray-300 mb-4"></p>
      
      <div class="comment-list" id="detail-comments">
        </div>
      
      <div class="mt-auto flex gap-2">
        <input type="text" id="new-comment" placeholder="Scrivi un commento..." class="flex-1 bg-black border border-gray-700 p-2 rounded text-sm text-white">
        <button onclick="inviaCommento()" class="text-blue-400 font-bold text-sm uppercase">Invia</button>
      </div>
    </div>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="modal-box" style="background:#111; padding:20px;">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer" onclick="closeModal('search-modal')"></i>
    <h2 class="serif text-xl mb-4">Cerca Utenti</h2>
    <input type="text" id="search-query" class="w-full bg-black border border-gray-700 p-2 text-white mb-4" placeholder="Nome o Username..." onkeyup="performSearch()">
    <div id="search-results" class="max-h-60 overflow-y-auto"></div>
  </div>
</div>

<script>
  /* ================= CONFIGURAZIONE ================= */
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  let currentUser = null;
  let currentPostId = null; // Per i commenti

  /* ================= INIT & AUTH ================= */
  window.addEventListener('load', async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) enterApp(session.user);
    
    // Slider Login (Ripristinato)
    let idx = 0;
    const imgs = document.querySelectorAll('.visual-side img');
    if(imgs.length){
      setInterval(() => {
        imgs[idx].classList.remove('active');
        idx = (idx + 1) % imgs.length;
        imgs[idx].classList.add('active');
      }, 5000);
    }
  });

  async function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-container').style.transform = "translateY(-100vh)";
    setTimeout(() => {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-interface').style.display = 'block';
      loadUserData();
      switchView('feed');
    }, 600);
  }

  function mess(t, err=false) {
    const b = document.getElementById('msg-box');
    b.innerText = t; b.style.display = 'block'; b.style.color = err ? '#ff4444' : '#44ff44';
  }
  function vaiA(m) {
    document.getElementById('login-form').classList.toggle('hidden', m === 'signup');
    document.getElementById('signup-form').classList.toggle('hidden', m === 'login');
    document.getElementById('msg-box').style.display = 'none';
  }

  // REGISTRAZIONE CON CONTROLLO ETA' RIPRISTINATO
  async function faiRegistrazione() {
    const u = document.getElementById('r-username').value.trim();
    const e = document.getElementById('r-email').value.trim();
    const p = document.getElementById('r-pass').value;
    const n = document.getElementById('r-nome').value.trim();
    const c = document.getElementById('r-cognome').value.trim();
    const d = document.getElementById('r-nascita').value;

    if(!u || !e || !p || !n || !c || !d) return mess("Compila tutti i campi.", true);
    
    // Controllo età 16 anni (Ripristinato)
    const nascita = new Date(d);
    const oggi = new Date();
    let eta = oggi.getFullYear() - nascita.getFullYear();
    if (oggi.getMonth() < nascita.getMonth() || (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())) eta--;
    if (eta < 16) return mess("Devi avere almeno 16 anni.", true);

    try {
      const { data, error } = await sb.auth.signUp({ email: e, password: p });
      if(error) throw error;
      
      if(data.user) {
        await sb.from('profiles').insert([{
          id: data.user.id,
          username: u.toLowerCase(),
          full_name: `${n} ${c}`,
          avatar_url: 'https://via.placeholder.com/150'
        }]);
      }
      mess("Registrazione OK! Controlla l'email per confermare."); // Messaggio chiaro
      setTimeout(() => vaiA('login'), 3000);
    } catch(err) { mess("Errore: " + err.message, true); }
  }

  async function faiLogin() {
    const e = document.getElementById('l-email').value.trim();
    const p = document.getElementById('l-pass').value;
    const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if(error) mess("Errore: " + error.message + " (Hai confermato la mail?)", true);
    else enterApp(data.user);
  }

  async function recuperoPassword() {
    const email = prompt("Email per recupero:");
    if(email) {
      const { error } = await sb.auth.resetPasswordForEmail(email);
      alert(error ? error.message : "Controlla la tua email.");
    }
  }
  async function logout() { await sb.auth.signOut(); location.reload(); }

  /* ================= SOCIAL & POST ================= */
  
  function switchView(name) {
    ['view-feed', 'view-dashboard'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(`view-${name}`).classList.remove('hidden');
    if(name === 'feed') loadFeed('posts-feed', false); // Feed globale
    if(name === 'dashboard') loadProfile(); // Mio Profilo
  }

  // CARICAMENTO PROFILO (Dati + Feed Verticale)
  async function loadProfile() {
    const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(data) {
      document.getElementById('dash-username').innerText = data.username;
      document.getElementById('dash-fullname').innerText = data.full_name;
      document.getElementById('dash-avatar').src = data.avatar_url;
      document.getElementById('edit-name-input').value = data.full_name;
    }
    // Carica i miei post nel formato "Feed Verticale"
    loadFeed('my-posts-feed', true);
  }

  // GENERATORE FEED (Usato sia per Home che per Profilo)
  async function loadFeed(containerId, onlyMine) {
    const c = document.getElementById(containerId);
    c.innerHTML = '<p class="text-center text-gray-500 py-10">Caricamento...</p>';
    
    let query = sb.from('posts').select('*, profiles(username, avatar_url), likes(user_id)').order('created_at', {ascending:false});
    if(onlyMine) query = query.eq('user_id', currentUser.id);

    const { data: posts } = await query;
    c.innerHTML = '';

    if(!posts || !posts.length) {
      c.innerHTML = '<p class="text-center text-gray-500">Nessun post trovato.</p>';
      return;
    }

    posts.forEach(p => {
      const isLiked = p.likes && p.likes.some(l => l.user_id === currentUser.id);
      const heartClass = isLiked ? "fa-solid text-red-500" : "fa-regular";

      // Template Card (uguale per home e profilo)
      const html = `
        <div class="post-card">
          <div class="post-header">
            <img src="${p.profiles?.avatar_url || 'https://via.placeholder.com/30'}" class="user-avatar">
            <span class="font-bold text-sm text-white">${p.profiles?.username}</span>
            ${onlyMine ? `<i class="fa-solid fa-trash ml-auto text-gray-600 cursor-pointer hover:text-red-500" onclick="deletePost('${p.id}')"></i>` : ''}
          </div>
          
          <img src="${p.image_url}" class="post-img" onclick='openPostDetail(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
          
          <div class="flex gap-4 mt-3 text-xl text-gray-300">
            <i class="${heartClass} fa-heart cursor-pointer hover:text-red-500" onclick="toggleLike('${p.id}')"></i>
            <i class="fa-regular fa-comment cursor-pointer hover:text-white" onclick='openPostDetail(${JSON.stringify(p).replace(/'/g, "&#39;")})'></i>
          </div>
          
          <div class="mt-2 text-sm text-gray-300">
            <span class="font-bold text-white mr-2">${p.profiles?.username}</span>
            ${p.caption || ''}
          </div>
        </div>
      `;
      c.innerHTML += html;
    });
  }

  /* ================= DETTAGLIO POST & COMMENTI ================= */
  async function openPostDetail(post) {
    currentPostId = post.id;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    
    // Popola dati
    document.getElementById('detail-img').src = post.image_url;
    document.getElementById('detail-avatar').src = post.profiles.avatar_url;
    document.getElementById('detail-username').innerText = post.profiles.username;
    document.getElementById('detail-caption').innerText = post.caption || '';
    
    // Carica Commenti
    loadComments();
  }

  async function loadComments() {
    const list = document.getElementById('detail-comments');
    list.innerHTML = 'Caricamento...';
    
    const { data: comments } = await sb
      .from('comments')
      .select('*, profiles(username)')
      .eq('post_id', currentPostId)
      .order('created_at', {ascending: true});
      
    list.innerHTML = '';
    if(!comments || !comments.length) {
      list.innerHTML = '<p class="text-gray-500 text-center mt-4">Nessun commento.</p>';
      return;
    }
    
    comments.forEach(c => {
      list.innerHTML += `
        <div class="mb-2">
          <span class="font-bold text-white mr-2">${c.profiles.username}</span>
          <span class="text-gray-300">${c.content}</span>
        </div>
      `;
    });
  }

  async function inviaCommento() {
    const input = document.getElementById('new-comment');
    const txt = input.value.trim();
    if(!txt) return;
    
    const { error } = await sb.from('comments').insert([{
      post_id: currentPostId,
      user_id: currentUser.id,
      content: txt
    }]);
    
    if(error) alert("Errore commento: " + error.message);
    else {
      input.value = '';
      loadComments();
    }
  }

  /* ================= AZIONI UTENTE (Like, Upload, Delete) ================= */
  
  async function toggleLike(postId) {
    const { data } = await sb.from('likes').select('*').eq('post_id', postId).eq('user_id', currentUser.id);
    if (data.length > 0) await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    else await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
    
    // Ricarica la vista corrente
    const currentView = document.getElementById('view-feed').classList.contains('hidden') ? 'dashboard' : 'feed';
    switchView(currentView);
  }

  // UPLOAD AVATAR
  async function uploadAvatar() {
    const file = document.getElementById('avatar-upload').files[0];
    if(!file) return;
    
    const fileName = `avatar_${currentUser.id}_${Date.now()}`;
    // Carica su bucket 'posts' che sappiamo funzionare
    const { error } = await sb.storage.from('posts').upload(fileName, file);
    if(error) return alert("Errore caricamento: " + error.message);
    
    const { data } = sb.storage.from('posts').getPublicUrl(fileName);
    await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
    
    alert("Foto profilo aggiornata!");
    loadProfile();
  }
  
  // MODIFICA NOME
  async function updateProfileInfo() {
    const name = document.getElementById('edit-name-input').value;
    await sb.from('profiles').update({ full_name: name }).eq('id', currentUser.id);
    alert("Nome aggiornato.");
    loadProfile();
  }

  // UPLOAD POST
  function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  async function submitPost() {
    const file = document.getElementById('post-file').files[0];
    const caption = document.getElementById('post-caption').value;
    if(!file) return alert("Devi caricare una foto per postare."); // Vincolo foto

    const fileName = `post_${Date.now()}`;
    const { error } = await sb.storage.from('posts').upload(fileName, file);
    if(error) return alert("Errore upload: " + error.message);
    
    const { data } = sb.storage.from('posts').getPublicUrl(fileName);
    
    const { error: dbErr } = await sb.from('posts').insert([{
      user_id: currentUser.id,
      image_url: data.publicUrl,
      caption: caption
    }]);

    if(dbErr) alert("Errore Database: " + dbErr.message);
    else {
      closeModal('upload-modal');
      switchView('feed');
    }
  }
  
  async function deletePost(id) {
    if(!confirm("Eliminare questo post?")) return;
    await sb.from('posts').delete().eq('id', id);
    loadProfile();
  }

  // RICERCA
  function openSearch(){ document.getElementById('search-modal').classList.remove('hidden'); }
  async function performSearch() {
    const q = document.getElementById('search-query').value;
    if(q.length < 2) return;
    const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`);
    const c = document.getElementById('search-results');
    c.innerHTML = '';
    data?.forEach(u => {
      c.innerHTML += `<div class="p-2 border-b border-gray-700 flex gap-2 items-center text-white"><img src="${u.avatar_url}" class="w-6 h-6 rounded-full">${u.username}</div>`;
    });
  }
  
  // Helper caricamento dati
  async function loadUserData() { /* ... */ }

</script>
</body>
</html>
