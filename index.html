<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Archivio Moda</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* --- STILE ORIGINALE (NON TOCCATO) --- */
    body { background:#0a0a0a; color:#fff; font-family:'Inter',sans-serif; margin:0; height:100vh; overflow-x: hidden; }
    .serif { font-family:'Playfair Display',serif }
    .hidden { display:none!important }
    .split-layout { display:flex; height:100vh; width: 100vw; position: fixed; top:0; left:0; z-index: 50; background:#0a0a0a; transition: transform 0.8s ease-in-out; }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }

    .visual-side img{
      position:absolute; top:0; left:0; width:100%; height:100%;
      object-fit:cover; filter:grayscale(100%); opacity:0;
      transition:opacity 1.5s ease, filter .8s ease; z-index:0
    }
    .visual-side img.active{ opacity:1; z-index:1 }
    .visual-side img:hover{ filter:grayscale(0%); cursor:crosshair }

    .form-side{
      flex:1; display:flex; flex-direction:column; justify-content:center;
      padding:60px; background:#0a0a0a; max-width:600px; margin:auto
    }
    .input-group{ margin-bottom:25px }
    .input-label{
      display:block; font-size:10px; text-transform:uppercase;
      letter-spacing:2px; color:#555; margin-bottom:8px
    }
    input{
      background:transparent; border-bottom:1px solid #222;
      padding:10px 0; color:#fff; width:100%; outline:none; font-size:14px
    }
    input:focus{ border-bottom-color:#fff }
    .btn-white{
      background:#fff; color:#000; padding:18px; font-weight:500;
      text-transform:uppercase; width:100%; cursor:pointer;
      border:1px solid #fff; transition:.3s; margin-top:10px
    }
    .btn-white:hover{ background:#000; color:#fff }
    #msg-box{
      display:none; padding:12px; border:1px solid #333;
      font-size:11px; text-transform:uppercase;
      margin-bottom:20px; text-align:center
    }
    .link-small{
      text-align:center; margin-top:20px;
      font-size:10px; color:#555; cursor:pointer;
      text-transform:uppercase; letter-spacing:1px
    }

    /* --- NUOVI STILI PER LA HOME (INSTAGRAM STYLE DARK) --- */
    #app-interface { display: none; min-height: 100vh; background: #000; }
    
    /* Layout griglia */
    .app-layout { display: flex; max-width: 1400px; margin: 0 auto; }
    
    /* Sidebar Sinistra */
    .sidebar { width: 250px; border-right: 1px solid #262626; height: 100vh; position: sticky; top: 0; padding: 20px; display: flex; flex-direction: column; }
    .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #f5f5f5; margin-bottom: 5px; }
    .nav-item:hover { background: #1a1a1a; }
    .nav-item i { font-size: 20px; width: 25px; }
    .nav-item span { font-size: 16px; font-weight: 400; }

    /* Feed Centrale */
    .feed-container { flex: 1; max-width: 600px; margin: 0 auto; padding: 40px 0; }
    
    /* Post Card */
    .post-card { margin-bottom: 40px; border-bottom: 1px solid #262626; padding-bottom: 20px; }
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 0 5px; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #333; }
    .post-img { width: 100%; border-radius: 4px; border: 1px solid #262626; }
    .post-actions { display: flex; gap: 20px; margin-top: 12px; font-size: 22px; padding: 0 5px; }
    .action-btn { cursor: pointer; transition: 0.2s; }
    .action-btn:hover { opacity: 0.7; }
    .post-likes { font-weight: 600; font-size: 14px; margin-top: 8px; padding: 0 5px; display: block; }
    .post-caption { font-size: 14px; margin-top: 6px; padding: 0 5px; color: #e5e5e5; }
    .post-caption b { font-weight: 600; margin-right: 5px; color: #fff; }
    
    /* Sezione Destra (Suggerimenti) */
    .suggestions { width: 300px; padding: 30px 0 0 30px; display: none; }
    @media (min-width: 1000px) { .suggestions { display: block; } }
    
    /* Modale Upload */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: #1a1a1a; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid #333; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 20px; }
    
    /* Utility */
    .search-input { background: #1a1a1a; border: none; padding: 10px 15px; border-radius: 8px; color: #fff; width: 100%; margin-bottom: 20px; }
    .user-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .follow-btn { color: #3badf8; font-size: 12px; font-weight: 600; cursor: pointer; }
    .follow-btn:hover { color: #fff; }

  </style>
</head>

<body>

<div id="auth-container" class="split-layout">

  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>

  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic">Hawenishland</h1>
    <div id="msg-box"></div>

    <div id="login-form">
      <div class="input-group">
        <label class="input-label">Email</label>
        <input type="email" id="l-email">
      </div>
      <div class="input-group">
        <label class="input-label">Password</label>
        <input type="password" id="l-pass">
      </div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>

    <div id="signup-form" class="hidden">
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome"></div>
      </div>
      <div class="input-group">
        <label class="input-label">Data di Nascita</label>
        <input type="date" id="r-nascita" style="color-scheme:dark">
      </div>
      <div class="input-group">
        <label class="input-label">Email</label>
        <input type="email" id="r-email">
      </div>
      <div class="input-group">
        <label class="input-label">Password</label>
        <input type="password" id="r-pass">
      </div>
      <button id="btn-reg" onclick="faiRegistrazione()" class="btn-white">Invia Richiesta</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface">
  <div class="app-layout">
    
    <div class="sidebar">
      <h1 class="serif italic text-2xl mb-8 pl-4">Hawenishland</h1>
      
      <div class="nav-item" onclick="loadFeed()">
        <i class="fa-solid fa-house"></i>
        <span>Home</span>
      </div>
      <div class="nav-item" onclick="openSearch()">
        <i class="fa-solid fa-magnifying-glass"></i>
        <span>Cerca</span>
      </div>
      <div class="nav-item" onclick="openUploadModal()">
        <i class="fa-regular fa-square-plus"></i>
        <span>Crea</span>
      </div>
      <div class="nav-item">
        <i class="fa-regular fa-heart"></i>
        <span>Notifiche</span>
      </div>
      <div class="nav-item" onclick="openProfile()">
        <img id="my-mini-avatar" src="https://via.placeholder.com/30" class="rounded-full w-6 h-6 object-cover border border-gray-600">
        <span>Profilo</span>
      </div>
      
      <div class="mt-auto nav-item text-red-500" onclick="logout()">
        <i class="fa-solid fa-arrow-right-from-bracket"></i>
        <span>Esci</span>
      </div>
    </div>

    <div class="feed-container">
      <div class="flex gap-4 mb-8 overflow-x-auto pb-4 border-b border-gray-800" id="stories-bar">
        </div>

      <div id="posts-feed">
        <p class="text-center text-gray-500 mt-10">Caricamento archivio...</p>
      </div>
    </div>

    <div class="suggestions">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <img id="my-side-avatar" src="https://via.placeholder.com/50" class="w-12 h-12 rounded-full border border-gray-700 object-cover">
          <div>
            <p id="my-username" class="font-bold text-sm">user</p>
            <p id="my-fullname" class="text-gray-500 text-xs">Nome Cognome</p>
          </div>
        </div>
        <button class="text-xs text-blue-400 font-bold">Passa a</button>
      </div>
      
      <h3 class="text-gray-500 font-bold text-xs mb-4">Suggeriti per te</h3>
      <div id="suggestions-list">
        </div>
    </div>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <i class="fa-solid fa-xmark close-modal" onclick="closeUploadModal()"></i>
    <h2 class="serif text-xl mb-4 italic">Nuovo Post</h2>
    <div class="input-group">
      <label class="input-label">Seleziona Immagine</label>
      <input type="file" id="post-file" accept="image/*" class="text-sm">
    </div>
    <div class="input-group">
      <label class="input-label">Didascalia</label>
      <input type="text" id="post-caption" placeholder="Scrivi qualcosa...">
    </div>
    <button onclick="submitPost()" class="btn-white">Condividi</button>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <i class="fa-solid fa-xmark close-modal" onclick="document.getElementById('search-modal').classList.add('hidden')"></i>
    <h2 class="serif text-xl mb-4 italic">Cerca Utenti</h2>
    <input type="text" class="search-input" id="search-query" placeholder="Cerca..." onkeyup="performSearch()">
    <div id="search-results" class="max-h-60 overflow-y-auto"></div>
  </div>
</div>

<script>
  /* ================= CONFIGURAZIONE ================= */
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';

  if (!window.supabase) { alert("Errore caricamento Supabase."); throw new Error("Supabase mancante"); }
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  let currentUser = null;

  /* ================= LOGICA DI AVVIO ================= */
  
  // Controlla se l'utente è già loggato all'apertura
  window.addEventListener('load', async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      enterApp(session.user);
    }
  });

  // Funzione per "entrare" nell'app
  async function enterApp(user) {
    currentUser = user;
    // Animazione transizione
    const authContainer = document.getElementById('auth-container');
    authContainer.style.transform = "translateY(-100vh)";
    
    // Mostra app e carica dati
    setTimeout(() => {
      authContainer.style.display = 'none';
      document.getElementById('app-interface').style.display = 'block';
      loadUserData();
      loadFeed();
      loadSuggestions();
    }, 600);
  }

  /* ================= FUNZIONI LOGIN (MODIFICATE) ================= */
  
  function vaiA(m) {
    document.getElementById('login-form').classList.toggle('hidden', m === 'signup');
    document.getElementById('signup-form').classList.toggle('hidden', m === 'login');
    document.getElementById('msg-box').style.display = 'none';
  }

  function mess(t, err=false) {
    const b = document.getElementById('msg-box');
    b.innerText = t;
    b.style.display = 'block';
    b.style.color = err ? '#ff4444' : '#44ff44';
  }

  async function faiRegistrazione() {
    const e = document.getElementById('r-email').value.trim();
    const p = document.getElementById('r-pass').value;
    const n = document.getElementById('r-nome').value.trim();
    const c = document.getElementById('r-cognome').value.trim();
    
    // Logica esistente + creazione profilo
    if(!e || !p) return mess("Dati mancanti", true);
    
    try {
      const { data, error } = await sb.auth.signUp({
        email: e, password: p,
        options: { data: { first_name: n, last_name: c } }
      });
      if (error) throw error;

      // Creazione riga nella tabella profiles
      if (data.user) {
        await sb.from('profiles').insert([{
          id: data.user.id,
          username: n.toLowerCase() + c.toLowerCase(), // Username base
          full_name: n + ' ' + c,
          avatar_url: 'https://via.placeholder.com/150'
        }]);
      }

      mess("Registrazione ok! Controlla l'email.");
      setTimeout(() => vaiA('login'), 2500);
    } catch (err) {
      mess(err.message, true);
    }
  }

  async function faiLogin() {
    const e = document.getElementById('l-email').value.trim();
    const p = document.getElementById('l-pass').value;
    const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
    
    if (error) {
      mess("Errore: " + error.message, true);
    } else {
      // SUCCESS: Lancia la nuova interfaccia invece dell'alert
      enterApp(data.user);
    }
  }

  async function logout() {
    await sb.auth.signOut();
    location.reload();
  }

  /* ================= LOGICA SOCIAL ================= */

  async function loadUserData() {
    const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(data) {
      document.getElementById('my-username').innerText = data.username || 'Utente';
      document.getElementById('my-fullname').innerText = data.full_name || '';
      if(data.avatar_url) {
        document.getElementById('my-mini-avatar').src = data.avatar_url;
        document.getElementById('my-side-avatar').src = data.avatar_url;
      }
    }
  }

  async function loadFeed() {
    const feed = document.getElementById('posts-feed');
    feed.innerHTML = '<p class="text-center text-gray-500 mt-10">Aggiornamento feed...</p>';

    // Prendi post con dati utente (join)
    // Nota: richiede policy RLS corrette su Supabase
    const { data: posts, error } = await sb
      .from('posts')
      .select(`
        *,
        profiles (username, avatar_url)
      `)
      .order('created_at', { ascending: false });

    if(error || !posts) {
      feed.innerHTML = '<p class="text-center text-gray-500">Nessun post trovato.</p>';
      return;
    }

    feed.innerHTML = '';
    posts.forEach(post => {
      const html = `
        <div class="post-card">
          <div class="post-header">
            <img src="${post.profiles?.avatar_url || 'https://via.placeholder.com/30'}" class="user-avatar">
            <span class="font-bold text-sm">${post.profiles?.username || 'Anonimo'}</span>
          </div>
          <img src="${post.image_url}" class="post-img" ondblclick="toggleLike('${post.id}')">
          <div class="post-actions">
            <i class="fa-regular fa-heart action-btn" onclick="toggleLike('${post.id}')"></i>
            <i class="fa-regular fa-comment action-btn"></i>
            <i class="fa-regular fa-paper-plane action-btn"></i>
          </div>
          <span class="post-likes">Piace a 0 persone</span>
          <div class="post-caption">
            <b>${post.profiles?.username}</b> ${post.caption || ''}
          </div>
          <div class="text-gray-500 text-xs mt-2 pl-1 uppercase tracking-widest">
            ${new Date(post.created_at).toLocaleDateString()}
          </div>
        </div>
      `;
      feed.innerHTML += html;
    });
  }

  /* ================= UPLOAD ================= */
  function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
  function closeUploadModal() { document.getElementById('upload-modal').classList.add('hidden'); }

  async function submitPost() {
    const fileInput = document.getElementById('post-file');
    const caption = document.getElementById('post-caption').value;
    const file = fileInput.files[0];

    if (!file) return alert("Seleziona una foto");

    // Upload immagine
    const fileName = `post_${Date.now()}_${file.name}`;
    const { data, error } = await sb.storage.from('posts').upload(fileName, file);

    if (error) return alert("Errore upload: " + error.message);

    // Ottieni URL pubblico
    const { data: publicData } = sb.storage.from('posts').getPublicUrl(fileName);

    // Salva nel DB
    const { error: dbError } = await sb.from('posts').insert([{
      user_id: currentUser.id,
      image_url: publicData.publicUrl,
      caption: caption
    }]);

    if (dbError) return alert("Errore DB: " + dbError.message);

    closeUploadModal();
    loadFeed(); // Ricarica feed
  }

  /* ================= RICERCA & SUGGERIMENTI ================= */
  
  function openSearch() { document.getElementById('search-modal').classList.remove('hidden'); }
  
  async function performSearch() {
    const q = document.getElementById('search-query').value;
    if(q.length < 2) return;

    const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(5);
    
    const container = document.getElementById('search-results');
    container.innerHTML = '';
    
    data?.forEach(u => {
      container.innerHTML += `
        <div class="user-row">
          <div class="flex items-center gap-2">
            <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full bg-gray-700">
            <span class="text-sm font-bold">${u.username}</span>
          </div>
          <span class="follow-btn" onclick="follow('${u.id}')">Segui</span>
        </div>
      `;
    });
  }

  async function loadSuggestions() {
    // Carica 5 utenti a caso (logica semplificata)
    const { data } = await sb.from('profiles').select('*').neq('id', currentUser.id).limit(5);
    const list = document.getElementById('suggestions-list');
    list.innerHTML = '';
    data?.forEach(u => {
      list.innerHTML += `
        <div class="user-row">
          <div class="flex items-center gap-2">
            <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full bg-gray-700">
            <div class="flex flex-col">
              <span class="text-sm font-bold">${u.username}</span>
              <span class="text-xs text-gray-500">Nuovo utente</span>
            </div>
          </div>
          <span class="follow-btn" onclick="follow('${u.id}')">Segui</span>
        </div>
      `;
    });
  }

  async function follow(targetId) {
    const { error } = await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
    if(!error) alert("Seguito!");
  }

  /* ================= ANIMAZIONE SLIDER LOGIN ================= */
  let idx = 0;
  const imgs = document.querySelectorAll('.visual-side img');
  setInterval(() => {
    imgs[idx].classList.remove('active');
    idx = (idx + 1) % imgs.length;
    imgs[idx].classList.add('active');
  }, 5000);

</script>
</body>
</html>
