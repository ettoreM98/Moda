<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Social</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    body { background:#0a0a0a; color:#fff; font-family:'Inter',sans-serif; margin:0; height:100vh; overflow-x:hidden; }
    .serif { font-family:'Playfair Display',serif }
    .hidden { display:none!important }

    /* AUTH */
    .split-layout { display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:50; background:#0a0a0a; transition:transform .8s ease-in-out; }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{
      position:absolute; top:0; left:0; width:100%; height:100%;
      object-fit:cover; filter:grayscale(100%); opacity:0;
      transition:opacity 1.5s ease, filter .8s ease; z-index:0;
      pointer-events:none;
    }
    .visual-side img.active{ opacity:1; z-index:1; pointer-events:auto; }
    .visual-side img.active:hover{ filter:grayscale(0%); cursor:crosshair; }

    .form-side{
      flex:1; display:flex; flex-direction:column; justify-content:center;
      padding:60px; background:#0a0a0a; max-width:600px; margin:auto
    }
    .input-group{ margin-bottom:25px }
    .input-label{
      display:block; font-size:10px; text-transform:uppercase;
      letter-spacing:2px; color:#555; margin-bottom:8px
    }
    input{
      background:transparent; border-bottom:1px solid #222;
      padding:10px 0; color:#fff; width:100%; outline:none; font-size:14px
    }
    input:focus{ border-bottom-color:#fff }
    .btn-white{
      background:#fff; color:#000; padding:18px; font-weight:500;
      text-transform:uppercase; width:100%; cursor:pointer;
      border:1px solid #fff; transition:.3s; margin-top:10px
    }
    .btn-white:hover{ background:#000; color:#fff }
    #msg-box{
      display:none; padding:12px; border:1px solid #333;
      font-size:11px; text-transform:uppercase;
      margin-bottom:20px; text-align:center
    }
    .link-small{
      text-align:center; margin-top:20px;
      font-size:10px; color:#555; cursor:pointer;
      text-transform:uppercase; letter-spacing:1px
    }

    /* APP */
    #app-interface { display:none; min-height:100vh; background:#000; }
    .app-layout { display:flex; max-width:1400px; margin:0 auto; min-height:100vh; }
    .sidebar { width:250px; border-right:1px solid #262626; height:100vh; position:sticky; top:0; padding:20px; display:flex; flex-direction:column; background:#000; }
    .nav-item { display:flex; align-items:center; gap:15px; padding:15px; border-radius:10px; cursor:pointer; transition:.2s; color:#f5f5f5; margin-bottom:6px; }
    .nav-item:hover { background:#141414; }
    .shell { flex:1; display:flex; flex-direction:column; min-height:100vh; }
    .topbar{
      height:64px; border-bottom:1px solid #262626; display:flex; align-items:center;
      justify-content:space-between; padding:0 24px; position:sticky; top:0; background:#000; z-index:10;
    }
    .topbar .title{ font-size:12px; letter-spacing:.25em; text-transform:uppercase; color:#777; }
    .avatar-btn{
      width:40px; height:40px; border-radius:999px; overflow:hidden; border:1px solid #333;
      cursor:pointer; display:flex; align-items:center; justify-content:center; transition:.2s; background:#111;
    }
    .avatar-btn:hover{ border-color:#fff; }
    .avatar-btn img{ width:100%; height:100%; object-fit:cover; display:block; }

    .main-content{ flex:1; padding:28px 24px; overflow-y:auto; }
    .feed-container{ max-width:600px; margin:0 auto; }
    .post-card{ background:#000; border:1px solid #262626; border-radius:10px; margin-bottom:26px; padding:15px; }
    .post-header{ display:flex; align-items:center; gap:10px; margin-bottom:12px; }
    .user-avatar{ width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #333; background:#111; cursor:pointer; transition:.2s; }
    .user-avatar:hover{ border-color:#fff; }
    .post-img{ width:100%; border-radius:6px; cursor:pointer; border:1px solid #262626; margin-top:10px; }
    .post-textonly{ margin-top:10px; padding:14px; border:1px solid #262626; border-radius:6px; color:#bdbdbd; font-size:14px; }
    .post-actions{ display:flex; gap:8px; margin-top:12px; align-items:center; font-size:14px; }
    .action-item{ display:flex; align-items:center; gap:6px; cursor:pointer; transition:.15s; color:#bdbdbd; }
    .action-item:hover{ color:#fff; }
    .action-count{ font-size:12px; color:#999; }
    .icon-btn{ cursor:pointer; transition:.15s; }
    .icon-btn:hover{ color:#fff; }

    .profile-header{ text-align:center; border-bottom:1px solid #262626; padding-bottom:26px; margin-bottom:26px; }
    .big-avatar{ width:120px; height:120px; border-radius:50%; object-fit:cover; border:3px solid #333; margin:0 auto 12px; cursor:pointer; transition:.3s; background:#111; }
    .big-avatar:hover { border-color:#fff; opacity:.9; }
    .edit-box{
      max-width:520px; margin:18px auto 0; background:#0b0b0b; border:1px solid #262626; border-radius:10px;
      padding:16px; text-align:left;
    }
    .edit-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .edit-grid{ grid-template-columns:1fr; } }
    .edit-box label{ display:block; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:#666; margin-bottom:8px; }
    .edit-box input{
      background:transparent; border:1px solid #262626; border-radius:8px; padding:10px; color:#fff; width:100%;
      outline:none; font-size:14px;
    }
    .edit-box input:focus{ border-color:#fff; }
    .btn-mini{
      background:#fff; color:#000; padding:10px 12px; font-weight:600; text-transform:uppercase; cursor:pointer;
      border:1px solid #fff; transition:.2s; font-size:11px; letter-spacing:1px; border-radius:10px;
    }
    .btn-mini:hover{ background:#000; color:#fff; }

    .stats-row{ display:flex; gap:30px; justify-content:center; margin:16px 0; font-size:14px; }
    .stat-item{ display:flex; flex-direction:column; align-items:center; cursor:pointer; transition:.2s; }
    .stat-item:hover{ color:#aaa; }
    .stat-number{ font-weight:bold; font-size:18px; color:#fff; }
    .stat-label{ font-size:12px; color:#999; text-transform:uppercase; }

    /* Modali */
    .modal-overlay{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:100; display:flex; justify-content:center; align-items:center; backdrop-filter:blur(5px); }
    .post-modal-box{ background:#000; width:90%; max-width:900px; height:80vh; border:1px solid #333; display:flex; border-radius:6px; overflow:hidden; }
    .modal-img-side{ flex:1.5; background:#000; display:flex; align-items:center; justify-content:center; border-right:1px solid #262626; }
    .modal-img-side img{ max-width:100%; max-height:100%; object-fit:contain; }
    .modal-info-side{ flex:1; display:flex; flex-direction:column; padding:20px; }
    .comment-list{ flex:1; overflow-y:auto; margin:20px 0; border-top:1px solid #262626; padding-top:10px; font-size:13px; }
    .comment-item{ display:flex; gap:8px; margin-bottom:12px; align-items:flex-start; }
    .comment-avatar{ width:28px; height:28px; border-radius:50%; object-fit:cover; flex-shrink:0; cursor:pointer; border:1px solid #333; }
    .comment-content{ flex:1; }
    .comment-author{ font-weight:bold; color:#fff; cursor:pointer; text-decoration:none; transition:.2s; font-size:13px; }
    .comment-author:hover{ color:#aaa; }
    .comment-text{ color:#bdbdbd; margin-top:4px; word-wrap:break-word; }

    .follower-modal-content{ max-width:500px; width:90%; background:#000; border:1px solid #333; border-radius:10px; padding:20px; }
    .follower-list{ max-height:400px; overflow-y:auto; }
    .follower-item{ display:flex; align-items:center; gap:12px; padding:12px 0; border-bottom:1px solid #262626; }
    .follower-item:last-child{ border-bottom:none; }
    .follower-avatar{ width:40px; height:40px; border-radius:50%; object-fit:cover; cursor:pointer; border:1px solid #333; }
    .follower-info{ flex:1; }
    .follower-username{ font-weight:bold; color:#fff; cursor:pointer; transition:.2s; }
    .follower-username:hover{ color:#aaa; }
    .follower-fullname{ font-size:12px; color:#999; }
  </style>
</head>

<body>

<!-- AUTH -->
<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>

  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic">Hawenishland</h1>
    <div id="msg-box"></div>

    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="rinviaConferma()" class="link-small">non hai ricevuto la mail di conferma?</p>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>

    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username (Pubblico)</label><input type="text" id="r-username"></div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome"></div>
      </div>
      <div class="input-group"><label class="input-label">Data di Nascita</label><input type="date" id="r-nascita" style="color-scheme:dark"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass"></div>
      <button id="btn-reg" onclick="faiRegistrazione()" class="btn-white">Registrati</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app-interface">
  <div class="app-layout">
    <div class="sidebar">
      <h1 class="serif italic text-2xl mb-8 pl-4 cursor-pointer" onclick="switchView('feed')">Hawenishland</h1>
      <div class="nav-item" onclick="switchView('feed')"><i class="fa-solid fa-house"></i><span>Home / Feed</span></div>
      <div class="nav-item" onclick="openSearch()"><i class="fa-solid fa-magnifying-glass"></i><span>Cerca</span></div>
      <div class="nav-item" onclick="openUploadModal()"><i class="fa-regular fa-square-plus"></i><span>Nuovo Post</span></div>
      <div class="nav-item" onclick="switchView('dashboard')"><i class="fa-regular fa-user"></i><span>Il Mio Profilo</span></div>
      <div class="mt-auto nav-item text-red-500" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i><span>Esci</span></div>
    </div>

    <div class="shell">
      <div class="topbar">
        <div class="title" id="topbar-title">Feed</div>
        <div class="avatar-btn" title="Vai al profilo" onclick="switchView('dashboard')">
          <img id="top-avatar" src="https://via.placeholder.com/80" alt="avatar">
        </div>
      </div>

      <div class="main-content">
        <div id="view-feed" class="view-section">
          <h2 class="serif text-2xl mb-6 italic">Home Feed</h2>
          <div class="feed-container" id="posts-feed"></div>
        </div>

        <div id="view-dashboard" class="view-section hidden">
          <div class="feed-container">
            <div class="profile-header">
              <div class="relative inline-block">
                <img id="dash-avatar" src="https://via.placeholder.com/150" class="big-avatar" onclick="document.getElementById('avatar-upload').click()">
                <div class="text-xs text-gray-500 mt-2">Clicca la foto per cambiarla</div>
                <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar()">
              </div>

              <h2 id="dash-username" class="text-2xl font-light mt-4">...</h2>
              <p id="dash-fullname" class="font-bold text-gray-400 text-sm mb-2">...</p>
              <p id="dash-email" class="text-xs text-gray-500">...</p>

              <div class="stats-row">
                <div class="stat-item" onclick="openFollowersModal('mine')">
                  <span class="stat-number" id="my-followers-count">0</span>
                  <span class="stat-label">Follower</span>
                </div>
                <div class="stat-item" onclick="openFollowersModal('following')">
                  <span class="stat-number" id="my-following-count">0</span>
                  <span class="stat-label">Seguiti</span>
                </div>
              </div>

              <div class="edit-box">
                <div class="edit-grid">
                  <div><label>Nome</label><input id="edit-first" type="text" placeholder="Nome"></div>
                  <div><label>Cognome</label><input id="edit-last" type="text" placeholder="Cognome"></div>
                </div>
                <div style="height:12px"></div>
                <div class="edit-grid">
                  <div><label>Username</label><input id="edit-username" type="text" placeholder="username pubblico"></div>
                  <div><label>Email</label><input id="edit-email" type="email" placeholder="nuova email (verifica via link)"></div>
                </div>
                <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
                  <button class="btn-mini" onclick="saveProfile()">Salva Dati</button>
                  <button class="btn-mini" onclick="changeEmail()">Cambia Email</button>
                </div>
              </div>
            </div>

            <h3 class="serif text-xl mb-6 italic text-center">I Miei Post</h3>
            <div id="my-posts-feed"></div>
          </div>
        </div>

        <div id="view-user-profile" class="view-section hidden">
          <div class="feed-container">
            <div class="profile-header">
              <img id="user-profile-avatar" src="https://via.placeholder.com/150" class="big-avatar">
              <h2 id="user-profile-username" class="text-2xl font-light mt-4">...</h2>
              <p id="user-profile-fullname" class="font-bold text-gray-400 text-sm mb-2">...</p>

              <div class="stats-row">
                <div class="stat-item" onclick="openFollowersModal('user-followers')">
                  <span class="stat-number" id="user-followers-count">0</span>
                  <span class="stat-label">Follower</span>
                </div>
                <div class="stat-item" onclick="openFollowersModal('user-following')">
                  <span class="stat-number" id="user-following-count">0</span>
                  <span class="stat-label">Seguiti</span>
                </div>
              </div>

              <button id="follow-btn" class="btn-mini mt-4" onclick="toggleFollow()">Segui</button>
            </div>

            <h3 class="serif text-xl mb-6 italic text-center">Post</h3>
            <div id="user-posts-feed"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upload post -->
<div id="upload-modal" class="modal-overlay hidden">
  <div class="modal-box" style="background:#111; padding:30px; max-width:420px; width:90%; position:relative;">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-xl" onclick="closeModal('upload-modal')"></i>
    <h2 class="serif text-xl mb-4 italic">Crea Post</h2>

    <label class="block mb-4 text-center border border-dashed border-gray-500 p-6 rounded cursor-pointer hover:border-white">
      <span class="text-xs uppercase block mb-2">Seleziona Foto (opzionale)</span>
      <input type="file" id="post-file" accept="image/*">
    </label>

    <input type="text" id="post-caption" placeholder="Scrivi qualcosa..." class="w-full bg-black border-b border-gray-600 p-2 mb-4 text-white outline-none">
    <button onclick="submitPost()" class="btn-white">Pubblica</button>
  </div>
</div>

<!-- Dettaglio post -->
<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="post-modal-box">
    <div class="modal-img-side">
      <img id="detail-img" src="" style="display:none;">
      <div id="detail-noimg" class="text-gray-500 text-sm" style="display:none;">Nessuna immagine</div>
    </div>
    <div class="modal-info-side relative">
      <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-xl" onclick="closeModal('post-detail-modal')"></i>

      <div class="flex items-center gap-3 mb-4">
        <img id="detail-avatar" src="" class="w-8 h-8 rounded-full bg-gray-700 cursor-pointer" onclick="goToUserProfile(currentPostUserId)">
        <span id="detail-username" class="font-bold text-sm cursor-pointer" onclick="goToUserProfile(currentPostUserId)" style="text-decoration:underline;">User</span>

        <div class="ml-auto flex gap-6 text-lg">
          <div class="flex items-center gap-2 cursor-pointer" onclick="toggleLike(currentPostId)">
            <i id="detail-like" class="fa-regular fa-heart hover:text-red-500"></i>
            <span id="detail-like-count" class="text-sm text-gray-400">0</span>
          </div>
          <div class="flex items-center gap-2">
            <i class="fa-regular fa-comment"></i>
            <span id="detail-comment-count" class="text-sm text-gray-400">0</span>
          </div>
        </div>
      </div>

      <p id="detail-caption" class="text-sm text-gray-300 mb-4"></p>
      <div class="comment-list" id="detail-comments"></div>

      <div class="mt-auto flex gap-2">
        <input type="text" id="new-comment" placeholder="Scrivi un commento..." class="flex-1 bg-black border border-gray-700 p-2 rounded text-sm text-white">
        <button onclick="inviaCommento()" class="text-blue-400 font-bold text-sm uppercase">Invia</button>
      </div>
    </div>
  </div>
</div>

<!-- Followers Modal -->
<div id="followers-modal" class="modal-overlay hidden">
  <div class="follower-modal-content">
    <div class="flex items-center justify-between mb-4">
      <h2 id="followers-modal-title" class="serif text-lg italic">Follower</h2>
      <i class="fa-solid fa-xmark cursor-pointer text-xl" onclick="closeModal('followers-modal')"></i>
    </div>
    <div class="follower-list" id="followers-list"></div>
  </div>
</div>

<!-- Search -->
<div id="search-modal" class="modal-overlay hidden">
  <div class="modal-box" style="background:#111; padding:20px; width:90%; max-width:520px; position:relative;">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer" onclick="closeModal('search-modal')"></i>
    <h2 class="serif text-xl mb-4">Cerca Utenti</h2>
    <input type="text" id="search-query" class="w-full bg-black border border-gray-700 p-2 text-white mb-4" placeholder="Nome o Username..." onkeyup="performSearch()">
    <div id="search-results" class="max-h-60 overflow-y-auto"></div>
  </div>
</div>

<script>
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';

  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';

  const FK_POSTS_PROFILES = 'posts_user_id_fkey';
  const FK_COMMENTS_PROFILES = 'comments_user_id_fkey';

  let currentUser = null;
  let currentPostId = null;
  let currentPostUserId = null;
  let currentViewingUserId = null;
  let currentFollowersType = null;
  let currentFollowersUserId = null;

  window.addEventListener('load', async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) enterApp(session.user);

    let i = 0;
    const imgs = document.querySelectorAll('.visual-side img');
    if (imgs.length) {
      setInterval(() => {
        imgs[i].classList.remove('active');
        i = (i + 1) % imgs.length;
        imgs[i].classList.add('active');
      }, 5000);
    }
  });

  function mess(t, err=false) {
    const b = document.getElementById('msg-box');
    b.innerText = t; b.style.display = 'block';
    b.style.color = err ? '#ff4444' : '#44ff44';
  }
  function vaiA(m) {
    document.getElementById('login-form').classList.toggle('hidden', m === 'signup');
    document.getElementById('signup-form').classList.toggle('hidden', m === 'login');
    document.getElementById('msg-box').style.display = 'none';
  }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  function openSearch(){ document.getElementById('search-modal').classList.remove('hidden'); }
  function openUploadModal(){ document.getElementById('upload-modal').classList.remove('hidden'); }
  function setTopbarTitle(t){ document.getElementById('topbar-title').innerText = t; }
  function escapeHtml(str){ return (str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

  function switchView(name) {
    ['view-feed','view-dashboard','view-user-profile'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(`view-${name}`).classList.remove('hidden');
    if (name === 'feed') { setTopbarTitle('Feed'); loadFeedFollowed('posts-feed'); }
    if (name === 'dashboard') { setTopbarTitle('Profilo'); loadProfile(true); }
    if (name === 'user-profile') { setTopbarTitle('Profilo Utente'); loadUserProfile(currentViewingUserId, true); }
  }

  async function faiRegistrazione() {
    const u = document.getElementById('r-username').value.trim();
    const e = document.getElementById('r-email').value.trim();
    const p = document.getElementById('r-pass').value;
    const n = document.getElementById('r-nome').value.trim();
    const c = document.getElementById('r-cognome').value.trim();
    const d = document.getElementById('r-nascita').value;

    if (!u || !e || !p || !n || !c || !d) return mess("Compila tutti i campi.", true);

    const nascita = new Date(d);
    const oggi = new Date();
    let eta = oggi.getFullYear() - nascita.getFullYear();
    if (oggi.getMonth() < nascita.getMonth() || (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())) eta--;
    if (eta < 16) return mess("Devi avere almeno 16 anni.", true);
    if (p.length < 8) return mess("Password minimo 8 caratteri.", true);

    document.getElementById('btn-reg').disabled = true;
    document.getElementById('btn-reg').style.opacity = '0.6';

    try {
      const { data, error } = await sb.auth.signUp({
        email: e, password: p,
        options: { data: { first_name: n, last_name: c, birthday: d } }
      });
      if (error) throw error;

      if (data.user) {
        const ins = await sb.from('profiles').upsert([{
          id: data.user.id,
          username: u.toLowerCase(),
          full_name: `${n} ${c}`,
          avatar_url: null
        }], { onConflict: 'id' });
        if (ins.error) throw ins.error;
      }

      mess("Registrazione OK! Controlla l'email per confermare.");
      setTimeout(() => vaiA('login'), 3000);
    } catch(err) {
      mess("Errore: " + (err?.message || err), true);
    } finally {
      document.getElementById('btn-reg').disabled = false;
      document.getElementById('btn-reg').style.opacity = '1';
    }
  }

  async function faiLogin() {
    const e = document.getElementById('l-email').value.trim();
    const p = document.getElementById('l-pass').value;
    const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if (error) return mess("Errore: " + error.message, true);
    enterApp(data.user);
  }

  async function recuperoPassword() {
    const email = prompt("Email per recupero:");
    if (email) {
      const { error } = await sb.auth.resetPasswordForEmail(email);
      alert(error ? error.message : "Controlla la tua email.");
    }
  }

  async function rinviaConferma() {
    const email = document.getElementById('l-email').value.trim();
    if (!email) return mess("Scrivi prima la tua email.", true);
    const { error } = await sb.auth.resend({ type: 'signup', email });
    if (error) mess("Errore: " + error.message, true);
    else mess("Email di conferma inviata. Controlla anche lo spam.");
  }

  async function logout() { await sb.auth.signOut(); location.reload(); }

  async function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-container').style.transform = "translateY(-100vh)";
    setTimeout(async () => {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-interface').style.display = 'block';
      switchView('feed');
      await loadProfile(false);
    }, 600);
  }

  async function getMyProfileRow() {
    const { data, error } = await sb.from('profiles').select('*').eq('id', currentUser.id);
    if (error) throw error;
    return data && data[0] ? data[0] : null;
  }

  async function loadProfile(renderMyPosts=true) {
    try {
      const prof = await getMyProfileRow();
      if (!prof) return;

      document.getElementById('dash-username').innerText = prof.username || '—';
      document.getElementById('dash-fullname').innerText = prof.full_name || '—';
      document.getElementById('dash-email').innerText = currentUser.email || '—';
      document.getElementById('edit-first').value = prof.full_name ? prof.full_name.split(' ')[0] : '';
      document.getElementById('edit-last').value = prof.full_name ? prof.full_name.split(' ').slice(1).join(' ') : '';
      document.getElementById('edit-username').value = prof.username || '';
      document.getElementById('edit-email').value = currentUser.email || '';

      const avatarUrl = prof.avatar_url || 'https://via.placeholder.com/150';
      document.getElementById('dash-avatar').src = avatarUrl;
      document.getElementById('top-avatar').src = avatarUrl;

      const { data: followers } = await sb.from('follows').select('id').eq('followed_id', currentUser.id);
      const { data: following } = await sb.from('follows').select('id').eq('follower_id', currentUser.id);
      document.getElementById('my-followers-count').innerText = followers ? followers.length : 0;
      document.getElementById('my-following-count').innerText = following ? following.length : 0;

      if (renderMyPosts) await loadFeed('my-posts-feed', true);
    } catch (err) {
      alert("Errore profilo: " + (err?.message || err));
    }
  }

  async function loadUserProfile(userId, renderPosts=true) {
    try {
      const { data: prof } = await sb.from('profiles').select('*').eq('id', userId).single();
      if (!prof) return;

      currentViewingUserId = userId;
      document.getElementById('user-profile-username').innerText = prof.username || '—';
      document.getElementById('user-profile-fullname').innerText = prof.full_name || '—';

      const avatarUrl = prof.avatar_url || 'https://via.placeholder.com/150';
      document.getElementById('user-profile-avatar').src = avatarUrl;

      const { data: followers } = await sb.from('follows').select('id').eq('followed_id', userId);
      const { data: following } = await sb.from('follows').select('id').eq('follower_id', userId);
      document.getElementById('user-followers-count').innerText = followers ? followers.length : 0;
      document.getElementById('user-following-count').innerText = following ? following.length : 0;

      const { data: isFollowing } = await sb.from('follows').select('id').eq('follower_id', currentUser.id).eq('followed_id', userId);
      const followBtn = document.getElementById('follow-btn');
      if (isFollowing && isFollowing.length) {
        followBtn.innerText = 'Segui Già';
        followBtn.style.opacity = '0.6';
      } else {
        followBtn.innerText = 'Segui';
        followBtn.style.opacity = '1';
      }

      if (renderPosts) {
        const { data: posts, error } = await sb.from('posts')
          .select(`id,user_id,image_url,caption,created_at,profiles:profiles!posts_user_id_fkey(username,avatar_url)`)
          .eq('user_id', userId)
          .order('created_at', { ascending:false });
        if (!error) renderPostsInto(document.getElementById('user-posts-feed'), posts || [], false);
      }
    } catch (err) {
      alert("Errore caricamento profilo: " + (err?.message || err));
    }
  }

  async function toggleFollow() {
    try {
      const { data: isFollowing } = await sb.from('follows').select('id').eq('follower_id', currentUser.id).eq('followed_id', currentViewingUserId);
      if (isFollowing && isFollowing.length) {
        await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', currentViewingUserId);
      } else {
        await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: currentViewingUserId }]);
      }
      await loadUserProfile(currentViewingUserId, false);
    } catch (err) {
      alert("Errore: " + err.message);
    }
  }

  async function goToUserProfile(userId) {
    if (userId === currentUser.id) {
      switchView('dashboard');
    } else {
      currentViewingUserId = userId;
      switchView('user-profile');
      await loadUserProfile(userId, true);
    }
  }

  async function openFollowersModal(type) {
    currentFollowersType = type;
    if (type === 'mine') currentFollowersUserId = currentUser.id;
    else if (type === 'user-followers') currentFollowersUserId = currentViewingUserId;
    else if (type === 'user-following') currentFollowersUserId = currentViewingUserId;
    else if (type === 'following') currentFollowersUserId = currentUser.id;

    const title = document.getElementById('followers-modal-title');
    if (type === 'mine' || type === 'user-followers') {
      title.innerText = 'Follower';
    } else {
      title.innerText = 'Seguiti';
    }

    document.getElementById('followers-modal').classList.remove('hidden');
    await loadFollowersList();
  }

  async function loadFollowersList() {
    const list = document.getElementById('followers-list');
    list.innerHTML = 'Caricamento...';

    try {
      let query;
      if (currentFollowersType === 'mine' || currentFollowersType === 'user-followers') {
        query = sb.from('follows')
          .select(`follower_id,profiles!follows_follower_id_fkey(id,username,avatar_url,full_name)`)
          .eq('followed_id', currentFollowersUserId);
      } else {
        query = sb.from('follows')
          .select(`followed_id,profiles!follows_followed_id_fkey(id,username,avatar_url,full_name)`)
          .eq('follower_id', currentFollowersUserId);
      }

      const { data, error } = await query;
      if (error) return list.innerHTML = error.message;

      list.innerHTML = '';
      if (!data || !data.length) return list.innerHTML = '<p class="text-gray-500 text-center py-4">Nessuno ancora.</p>';

      data.forEach(item => {
        const prof = currentFollowersType === 'mine' || currentFollowersType === 'user-followers' ? item.profiles : item.profiles;
        if (!prof) return;
        const avatarUrl = prof.avatar_url || 'https://via.placeholder.com/40';
        list.insertAdjacentHTML('beforeend', `
          <div class="follower-item">
            <img src="${avatarUrl}" class="follower-avatar" onclick="goToUserProfile('${prof.id}')">
            <div class="follower-info">
              <div class="follower-username" onclick="goToUserProfile('${prof.id}')">${prof.username || 'user'}</div>
              <div class="follower-fullname">${prof.full_name || ''}</div>
            </div>
          </div>
        `);
      });
    } catch (err) {
      list.innerHTML = 'Errore: ' + err.message;
    }
  }

  async function saveProfile() {
    try {
      const first = document.getElementById('edit-first').value.trim();
      const last = document.getElementById('edit-last').value.trim();
      const username = document.getElementById('edit-username').value.trim().toLowerCase();
      const full_name = (first + " " + last).trim();
      if (!username) return alert("Username obbligatorio.");
      const { error } = await sb.from('profiles').update({ username, full_name }).eq('id', currentUser.id);
      if (error) throw error;
      alert("Dati aggiornati.");
      await loadProfile(true);
    } catch (err) {
      alert("Errore salvataggio: " + (err?.message || err));
    }
  }

  async function changeEmail() {
    try {
      const newEmail = document.getElementById('edit-email').value.trim();
      if (!newEmail) return alert("Inserisci una nuova email.");
      const { error } = await sb.auth.updateUser({ email: newEmail });
      if (error) throw error;
      alert("Link di conferma inviato alla nuova email. Dopo la conferma, esci e rientra.");
      document.getElementById('edit-email').value = '';
    } catch (err) {
      alert("Errore cambio email: " + (err?.message || err));
    }
  }

  async function uploadAvatar() {
    const file = document.getElementById('avatar-upload').files[0];
    if (!file) return;
    try {
      const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
      const path = `${currentUser.id}/avatar_${Date.now()}.${ext}`;
      const { error: upErr } = await sb.storage.from(BUCKET_AVATARS).upload(path, file, { upsert:true });
      if (upErr) throw upErr;
      const { data: pub } = sb.storage.from(BUCKET_AVATARS).getPublicUrl(path);
      const { error: dbErr } = await sb.from('profiles').update({ avatar_url: pub.publicUrl }).eq('id', currentUser.id);
      if (dbErr) throw dbErr;
      document.getElementById('dash-avatar').src = pub.publicUrl;
      document.getElementById('top-avatar').src = pub.publicUrl;
    } catch (err) {
      alert("Errore avatar: " + (err?.message || err));
    } finally {
      document.getElementById('avatar-upload').value = "";
    }
  }

  async function loadFeedFollowed(containerId) {
    const c = document.getElementById(containerId);
    c.innerHTML = 'Caricamento...';
    const f = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
    let query = sb.from('posts')
      .select(`id,user_id,image_url,caption,created_at,profiles:profiles!posts_user_id_fkey(username,avatar_url)`)
      .order('created_at', { ascending:false });
    if (!f.error && f.data) {
      const ids = [currentUser.id, ...f.data.map(x=>x.followed_id)];
      query = query.in('user_id', ids);
    }
    const { data, error } = await query;
    if (error) return c.innerHTML = error.message;
    renderPostsInto(c, data || [], false);
  }

  async function loadFeed(containerId, onlyMine) {
    const c = document.getElementById(containerId);
    c.innerHTML = 'Caricamento...';
    let query = sb.from('posts')
      .select(`id,user_id,image_url,caption,created_at,profiles:profiles!posts_user_id_fkey(username,avatar_url)`)
      .order('created_at', { ascending:false });
    if (onlyMine) query = query.eq('user_id', currentUser.id);
    const { data, error } = await query;
    if (error) return c.innerHTML = error.message;
    renderPostsInto(c, data || [], onlyMine);
  }

  async function renderPostsInto(containerEl, posts, allowDelete) {
    containerEl.innerHTML = '';
    if (!posts.length) return containerEl.innerHTML = '<p class="text-gray-500 text-center">Nessun post.</p>';

    for (const p of posts) {
      const prof = p.profiles || {};
      const imgBlock = p.image_url
        ? `<img src="${p.image_url}" class="post-img" onclick="openPostDetailById('${p.id}')">`
        : `<div class="post-textonly">${escapeHtml(p.caption || '')}</div>`;
      const showCaptionBelow = !!p.image_url;

      const { data: likesCount } = await sb.from('likes').select('id').eq('post_id', p.id);
      const { data: commentsCount } = await sb.from('comments').select('id').eq('post_id', p.id);
      const likeCnt = likesCount ? likesCount.length : 0;
      const commentCnt = commentsCount ? commentsCount.length : 0;

      containerEl.insertAdjacentHTML('beforeend', `
        <div class="post-card">
          <div class="post-header">
            <img src="${prof.avatar_url || 'https://via.placeholder.com/40'}" class="user-avatar" onclick="goToUserProfile('${p.user_id}')" title="Vai al profilo">
            <span class="font-bold text-sm text-white cursor-pointer" onclick="goToUserProfile('${p.user_id}')">${prof.username || 'user'}</span>
            ${allowDelete ? `<i class="fa-solid fa-trash ml-auto text-gray-600 icon-btn hover:text-red-500" onclick="deletePost('${p.id}')"></i>` : ''}
          </div>
          ${imgBlock}
          <div class="post-actions">
            <div class="action-item" onclick="toggleLike('${p.id}')">
              <i class="fa-regular fa-heart"></i>
              <span class="action-count">${likeCnt}</span>
            </div>
            <div class="action-item" onclick="openPostDetailById('${p.id}')">
              <i class="fa-regular fa-comment"></i>
              <span class="action-count">${commentCnt}</span>
            </div>
          </div>
          ${showCaptionBelow ? `<div class="mt-2 text-sm text-gray-300"><span class="font-bold text-white mr-2 cursor-pointer" onclick="goToUserProfile('${p.user_id}')">${prof.username || 'user'}</span>${escapeHtml(p.caption || '')}</div>` : ''}
        </div>
      `);
    }
  }

  async function submitPost() {
    const file = document.getElementById('post-file').files[0] || null;
    const caption = (document.getElementById('post-caption').value || '').trim();
    if (!caption && !file) return alert("Scrivi qualcosa oppure carica una foto.");

    let imageUrl = null;
    try {
      if (file) {
        const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();
        const fileName = `${currentUser.id}/post_${Date.now()}.${ext}`;
        const { error: upErr } = await sb.storage.from(BUCKET_POSTS).upload(fileName, file, { upsert:true });
        if (upErr) throw upErr;
        const { data } = sb.storage.from(BUCKET_POSTS).getPublicUrl(fileName);
        imageUrl = data.publicUrl;
      }
      const { error } = await sb.from('posts').insert([{ user_id: currentUser.id, image_url: imageUrl, caption }]);
      if (error) throw error;
      document.getElementById('post-file').value = '';
      document.getElementById('post-caption').value = '';
      closeModal('upload-modal');
      loadFeedFollowed('posts-feed');
    } catch (err) {
      alert("Errore pubblicazione: " + (err?.message || err));
    }
  }

  async function deletePost(id) {
    if (!confirm("Eliminare questo post?")) return;
    const { error } = await sb.from('posts').delete().eq('id', id);
    if (error) alert(error.message);
    loadFeed('my-posts-feed', true);
  }

  async function openPostDetailById(postId) {
    currentPostId = postId;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    const { data: post, error } = await sb.from('posts')
      .select(`id,user_id,image_url,caption,profiles:profiles!posts_user_id_fkey(username,avatar_url)`)
      .eq('id', postId)
      .maybeSingle();
    if (error || !post) return alert(error ? error.message : "Post non trovato");

    currentPostUserId = post.user_id;

    const img = document.getElementById('detail-img');
    const noimg = document.getElementById('detail-noimg');
    if (post.image_url) { img.src = post.image_url; img.style.display='block'; noimg.style.display='none'; }
    else { img.style.display='none'; noimg.style.display='block'; }

    const prof = post.profiles || {};
    document.getElementById('detail-avatar').src = prof.avatar_url || 'https://via.placeholder.com/30';
    document.getElementById('detail-username').innerText = prof.username || 'user';
    document.getElementById('detail-caption').innerText = post.caption || '';

    const { data: likesCount } = await sb.from('likes').select('id').eq('post_id', postId);
    document.getElementById('detail-like-count').innerText = likesCount ? likesCount.length : 0;

    loadComments();
  }

  async function loadComments() {
    const list = document.getElementById('detail-comments');
    list.innerHTML = 'Caricamento...';
    const { data, error } = await sb.from('comments')
      .select(`id,content,user_id,created_at,profiles:profiles!comments_user_id_fkey(id,username,avatar_url)`)
      .eq('post_id', currentPostId)
      .order('created_at', { ascending:true });
    if (error) return list.innerHTML = error.message;

    list.innerHTML = '';
    if (!data || !data.length) return list.innerHTML = '<p class="text-gray-500 text-center mt-4">Nessun commento.</p>';

    const { data: commentsCounts } = await sb.from('comments').select('id').eq('post_id', currentPostId);
    document.getElementById('detail-comment-count').innerText = commentsCounts ? commentsCounts.length : 0;

    data.forEach(c => {
      const u = c.profiles || {};
      const avatarUrl = u.avatar_url || 'https://via.placeholder.com/28';
      list.insertAdjacentHTML('beforeend', `
        <div class="comment-item">
          <img src="${avatarUrl}" class="comment-avatar" onclick="goToUserProfile('${c.user_id}')">
          <div class="comment-content">
            <span class="comment-author" onclick="goToUserProfile('${c.user_id}')">${u.username||'user'}</span>
            <div class="comment-text">${escapeHtml(c.content)}</div>
          </div>
        </div>
      `);
    });
  }

  async function inviaCommento() {
    const input = document.getElementById('new-comment');
    const txt = (input.value||'').trim();
    if (!txt) return;
    const { error } = await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
    if (error) return alert(error.message);
    input.value = '';
    loadComments();
  }

  async function toggleLike(postId) {
    const { data, error } = await sb.from('likes').select('post_id').eq('post_id', postId).eq('user_id', currentUser.id);
    if (error) return alert(error.message);
    if (data && data.length) await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    else await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
    if (currentPostId === postId) {
      const { data: likesCount } = await sb.from('likes').select('id').eq('post_id', postId);
      document.getElementById('detail-like-count').innerText = likesCount ? likesCount.length : 0;
    }
  }

  async function performSearch() {
    const q = document.getElementById('search-query').value.trim();
    if (q.length < 2) return;
    const { data, error } = await sb.from('profiles').select('id,username,avatar_url,full_name').ilike('username', `%${q}%`).limit(20);
    if (error) return;
    const c = document.getElementById('search-results');
    c.innerHTML = '';
    (data||[]).forEach(u => {
      const avatarUrl = u.avatar_url || 'https://via.placeholder.com/30';
      c.insertAdjacentHTML('beforeend', `<div class="p-3 border-b border-gray-700 flex gap-3 items-center text-white cursor-pointer hover:bg-gray-900 transition" onclick="goToUserProfile('${u.id}')"><img src="${avatarUrl}" class="w-8 h-8 rounded-full">@${u.username}</div>`);
    });
  }
</script>
</body>
</html>
