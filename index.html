<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* RESET & BASE */
    body { background-color: #050505; color: #e5e5e5; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    .serif { font-family: 'Playfair Display', serif; }
    .hidden { display: none !important; }
    ::-webkit-scrollbar { width: 8px; background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }

    /* --- LOGIN (Split Layout) --- */
    .split-layout { display: flex; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; z-index: 50; background: #000; }
    .visual-side { flex: 1; position: relative; overflow: hidden; display: none; background: #000; cursor: crosshair; }
    @media (min-width: 768px) { .visual-side { display: block; } }
    
    .visual-side img {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      object-fit: cover; filter: grayscale(100%); opacity: 0;
      transition: opacity 1.5s ease, filter 0.5s ease; pointer-events: none;
    }
    .visual-side img.active { opacity: 1; z-index: 1; }
    /* Effetto Hover richiesto: Torna a colori quando passi sopra */
    .visual-side:hover img.active { filter: grayscale(0%); }

    .form-side { flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 60px; max-width: 600px; margin: auto; }
    
    .input-field { background: transparent; border: none; border-bottom: 1px solid #333; padding: 12px 0; color: #fff; width: 100%; outline: none; margin-bottom: 20px; font-size: 14px; transition: 0.3s; }
    .input-field:focus { border-bottom-color: #fff; }
    
    .btn-main { background: #fff; color: #000; padding: 15px; width: 100%; text-transform: uppercase; font-weight: 700; cursor: pointer; margin-top: 10px; border: 1px solid #fff; transition: 0.3s; }
    .btn-main:hover { background: #000; color: #fff; }

    /* --- APP LAYOUT --- */
    #app-interface { display: none; min-height: 100vh; }
    
    /* TOP BAR (Header Fisso) */
    .top-bar {
      height: 70px; background: rgba(5,5,5,0.95); border-bottom: 1px solid #222;
      position: sticky; top: 0; z-index: 40; display: flex; align-items: center; justify-content: space-between; padding: 0 30px;
      backdrop-filter: blur(10px);
    }
    .brand-logo { font-family: 'Playfair Display', serif; font-size: 24px; font-style: italic; cursor: pointer; }
    
    /* AVATAR IN ALTO A DESTRA (Richiesto) */
    .top-right-profile { display: flex; align-items: center; gap: 15px; }
    .avatar-circle {
      width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
      border: 2px solid #333; cursor: pointer; transition: 0.3s;
    }
    .avatar-circle:hover { border-color: #fff; transform: scale(1.05); }

    .app-body { display: flex; max-width: 1400px; margin: 0 auto; min-height: calc(100vh - 70px); }

    /* SIDEBAR SINISTRA (Profilo Editabile + Navigazione) */
    .sidebar {
      width: 280px; background: #050505; border-right: 1px solid #222;
      position: sticky; top: 70px; height: calc(100vh - 70px); overflow-y: auto; padding: 30px 20px;
      display: flex; flex-direction: column;
    }
    
    .nav-item { display: flex; align-items: center; gap: 15px; padding: 12px; cursor: pointer; color: #aaa; transition: 0.2s; border-radius: 8px; margin-bottom: 5px; }
    .nav-item:hover { background: #1a1a1a; color: #fff; }
    .nav-item i { width: 24px; text-align: center; }

    /* Sezione Modifica Dati (Integrata nella Sidebar) */
    .profile-edit-box { margin-top: 30px; padding-top: 20px; border-top: 1px solid #222; }
    .edit-label { font-size: 10px; text-transform: uppercase; color: #666; margin-bottom: 5px; display: block; letter-spacing: 1px; }
    .edit-input { background: #111; border: 1px solid #333; color: white; padding: 8px; width: 100%; margin-bottom: 15px; font-size: 12px; border-radius: 4px; }
    
    /* FEED CENTRALE */
    .feed-area { flex: 1; padding: 30px; max-width: 700px; margin: 0 auto; }
    
    /* POST CARD (Stile Facebook) */
    .post-card { background: #0a0a0a; border: 1px solid #222; border-radius: 8px; margin-bottom: 30px; overflow: hidden; }
    .post-header { padding: 15px; display: flex; align-items: center; gap: 12px; }
    .post-user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; }
    .post-info h4 { font-size: 14px; font-weight: 700; color: #fff; margin: 0; cursor: pointer; }
    .post-info span { font-size: 11px; color: #666; }
    
    .post-content { padding: 5px 15px 15px 15px; font-size: 15px; line-height: 1.5; color: #eee; }
    .post-image { width: 100%; display: block; border-top: 1px solid #222; border-bottom: 1px solid #222; max-height: 600px; object-fit: cover; }
    
    .post-actions { padding: 10px 15px; display: flex; gap: 20px; border-top: 1px solid #222; }
    .action-btn { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #888; cursor: pointer; transition: 0.2s; font-weight: 600; }
    .action-btn:hover { color: #fff; }
    .action-btn.liked { color: #3b82f6; } /* Blu Like */

    /* SEZIONE COMMENTI */
    .comments-section { background: #0e0e0e; padding: 15px; display: none; border-top: 1px solid #222; }
    .comment-row { display: flex; gap: 10px; margin-bottom: 10px; font-size: 13px; }
    .comment-bubble { background: #1a1a1a; padding: 8px 12px; border-radius: 12px; color: #ddd; max-width: 90%; }
    
    /* Modale Generica */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=1200">
  </div>
  
  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic">Hawenishland</h1>
    
    <div id="login-form">
      <input type="email" id="l-email" class="input-field" placeholder="Email">
      <input type="password" id="l-pass" class="input-field" placeholder="Password">
      <button onclick="login()" class="btn-main">Entra</button>
      <div class="mt-6 text-center text-xs text-gray-500 uppercase cursor-pointer hover:text-white" onclick="toggleAuth('signup')">Non hai un account? Iscriviti</div>
    </div>

    <div id="signup-form" class="hidden">
      <div class="grid grid-cols-2 gap-4">
        <input type="text" id="r-nome" class="input-field" placeholder="Nome">
        <input type="text" id="r-cognome" class="input-field" placeholder="Cognome">
      </div>
      <input type="text" id="r-username" class="input-field" placeholder="Username">
      <label class="text-xs text-gray-500 block mb-1">Data di Nascita</label>
      <input type="date" id="r-nascita" class="input-field" style="color-scheme: dark;">
      <input type="email" id="r-email" class="input-field" placeholder="Email">
      <input type="password" id="r-pass" class="input-field" placeholder="Password">
      
      <button onclick="signup()" class="btn-main">Crea Account</button>
      <div class="mt-6 text-center text-xs text-gray-500 uppercase cursor-pointer hover:text-white" onclick="toggleAuth('login')">Torna al Login</div>
    </div>
    
    <div id="msg-box" class="mt-4 text-center text-xs p-3 border border-red-500 text-red-500 hidden"></div>
  </div>
</div>

<div id="app-interface">
  
  <div class="top-bar">
    <div class="brand-logo" onclick="renderHome()">Hawenishland</div>
    
    <div class="top-right-profile">
      <div class="text-right mr-2 hidden md:block">
        <div id="header-username" class="font-bold text-sm text-white">Caricamento...</div>
        <div class="text-xs text-gray-500 cursor-pointer hover:text-white" onclick="document.getElementById('avatar-input').click()">Cambia Foto</div>
      </div>
      <img id="header-avatar" src="" class="avatar-circle" onclick="renderProfile()" title="Il mio Profilo">
      <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="changeAvatar()">
    </div>
  </div>

  <div class="app-body">
    
    <div class="sidebar">
      <div class="nav-item" onclick="renderHome()"><i class="fa-solid fa-house"></i> Home Feed</div>
      <div class="nav-item" onclick="openModal('upload-modal')"><i class="fa-solid fa-pen-to-square"></i> Crea Post</div>
      <div class="nav-item" onclick="openSearch()"><i class="fa-solid fa-magnifying-glass"></i> Cerca Utenti</div>
      <div class="nav-item" onclick="renderProfile()"><i class="fa-solid fa-user"></i> Il Mio Profilo</div>
      
      <div class="profile-edit-box">
        <h4 class="text-xs font-bold text-gray-400 mb-4 uppercase">Modifica i tuoi dati</h4>
        
        <label class="edit-label">Nome Completo</label>
        <input type="text" id="edit-fullname" class="edit-input">
        
        <label class="edit-label">Username</label>
        <input type="text" id="edit-username" class="edit-input">
        
        <button onclick="updateProfileData()" class="btn-main" style="padding: 8px; font-size: 11px; margin-top: 0;">Salva Modifiche</button>
      </div>

      <div class="nav-item mt-auto text-red-500 hover:text-red-400" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i> Esci
      </div>
    </div>

    <div class="feed-area" id="feed-container">
      </div>

  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="bg-[#111] p-6 w-[500px] border border-[#333] rounded-lg relative">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-gray-400 hover:text-white" onclick="closeModal('upload-modal')"></i>
    <h3 class="text-xl font-serif italic mb-4 text-white">Crea Post</h3>
    
    <textarea id="post-caption" class="w-full bg-black border border-gray-700 p-3 text-white mb-4 rounded focus:border-white outline-none" rows="4" placeholder="A cosa stai pensando?"></textarea>
    
    <label class="flex items-center gap-3 cursor-pointer p-3 border border-dashed border-gray-600 rounded mb-4 hover:border-white transition">
      <i class="fa-solid fa-image text-green-500 text-xl"></i>
      <div>
        <div class="text-sm text-gray-300">Aggiungi una foto</div>
        <div class="text-xs text-gray-500">(Opzionale)</div>
      </div>
      <input type="file" id="post-file" class="hidden" accept="image/*" onchange="document.getElementById('file-name-display').innerText = this.files[0].name">
    </label>
    <div id="file-name-display" class="text-xs text-blue-400 mb-4 h-4 text-center"></div>

    <button onclick="createPost()" class="btn-main py-2">Pubblica</button>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="bg-[#111] p-6 w-[400px] border border-[#333] rounded-lg relative">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-gray-400" onclick="closeModal('search-modal')"></i>
    <input type="text" id="search-query" class="w-full bg-black border border-gray-700 p-2 text-white mb-4 rounded" placeholder="Cerca persone..." onkeyup="doSearch()">
    <div id="search-results" class="max-h-60 overflow-y-auto"></div>
  </div>
</div>

<script>
  /* --- CONFIGURAZIONE SUPABASE --- */
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  let currentUser = null;

  /* --- INIT & AUTH --- */
  window.onload = async () => {
    // Slider Login
    let idx = 0; const imgs = document.querySelectorAll('.visual-side img');
    setInterval(() => { imgs[idx].classList.remove('active'); idx=(idx+1)%imgs.length; imgs[idx].classList.add('active'); }, 5000);

    const {data} = await sb.auth.getSession();
    if(data.session) enterApp(data.session.user);
  };

  function toggleAuth(v) {
    document.getElementById('login-form').classList.toggle('hidden', v==='signup');
    document.getElementById('signup-form').classList.toggle('hidden', v==='login');
    document.getElementById('msg-box').classList.add('hidden');
  }

  function showMsg(txt) {
    const b = document.getElementById('msg-box');
    b.innerText = txt; b.classList.remove('hidden');
  }

  async function signup() {
    const n = document.getElementById('r-nome').value, c = document.getElementById('r-cognome').value;
    const u = document.getElementById('r-username').value, d = document.getElementById('r-nascita').value;
    const e = document.getElementById('r-email').value, p = document.getElementById('r-pass').value;

    if(!n || !c || !u || !d || !e || !p) return showMsg("Compila tutti i campi.");

    // Controllo Età 16+
    const birthDate = new Date(d);
    const age = new Date(Date.now() - birthDate.getTime()).getUTCFullYear() - 1970;
    if(age < 16) return showMsg("Devi avere almeno 16 anni.");

    const {data, error} = await sb.auth.signUp({email:e, password:p});
    if(error) return showMsg(error.message);
    
    if(data.user) {
      await sb.from('profiles').insert([{ id:data.user.id, username:u, full_name:`${n} ${c}` }]);
      alert("Registrazione effettuata! Controlla l'email.");
      toggleAuth('login');
    }
  }

  async function login() {
    const {data, error} = await sb.auth.signInWithPassword({
      email: document.getElementById('l-email').value,
      password: document.getElementById('l-pass').value
    });
    if(error) showMsg("Errore login: " + error.message);
    else enterApp(data.user);
  }

  async function logout() { await sb.auth.signOut(); location.reload(); }

  async function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('app-interface').style.display = 'block';
    
    // Carica Dati Utente per Header e Sidebar
    const {data} = await sb.from('profiles').select('*').eq('id', user.id).single();
    if(data) {
      document.getElementById('header-avatar').src = data.avatar_url;
      document.getElementById('header-username').innerText = data.username;
      
      // Popola campi edit
      document.getElementById('edit-fullname').value = data.full_name;
      document.getElementById('edit-username').value = data.username;
    }
    
    renderHome(); // Carica Home di default
  }

  /* --- FUNZIONI CORE --- */

  // CAMBIO FOTO PROFILO (Immediato)
  async function changeAvatar() {
    const file = document.getElementById('avatar-input').files[0];
    if(!file) return;

    // Upload
    const name = `avatar_${currentUser.id}_${Date.now()}`;
    const {error} = await sb.storage.from('posts').upload(name, file);
    if(error) return alert("Errore upload: " + error.message);

    // Get URL
    const {data} = sb.storage.from('posts').getPublicUrl(name);
    
    // Update DB
    await sb.from('profiles').update({avatar_url: data.publicUrl}).eq('id', currentUser.id);

    // Update Visivo Immediato
    document.getElementById('header-avatar').src = data.publicUrl;
  }

  // MODIFICA DATI
  async function updateProfileData() {
    const fn = document.getElementById('edit-fullname').value;
    const us = document.getElementById('edit-username').value;
    
    const {error} = await sb.from('profiles').update({full_name: fn, username: us}).eq('id', currentUser.id);
    if(error) alert("Errore: " + error.message);
    else {
      alert("Profilo aggiornato!");
      document.getElementById('header-username').innerText = us; // Aggiorna header
    }
  }

  // CREA POST (Testo O Foto)
  async function createPost() {
    const caption = document.getElementById('post-caption').value;
    const file = document.getElementById('post-file').files[0];
    let imgUrl = null;

    if(!caption && !file) return alert("Scrivi qualcosa o aggiungi una foto.");

    // Se c'è foto, caricala
    if(file) {
      const name = `post_${Date.now()}`;
      const {error} = await sb.storage.from('posts').upload(name, file);
      if(error) return alert("Errore Storage: " + error.message);
      const {data} = sb.storage.from('posts').getPublicUrl(name);
      imgUrl = data.publicUrl;
    }

    // Insert Post (imgUrl può essere null)
    const {error} = await sb.from('posts').insert([{ user_id: currentUser.id, caption, image_url: imgUrl }]);
    
    if(error) alert("Errore DB: " + error.message);
    else {
      closeModal('upload-modal');
      // Pulisci campi
      document.getElementById('post-caption').value = '';
      document.getElementById('post-file').value = '';
      document.getElementById('file-name-display').innerText = '';
      renderHome(); // Ricarica feed
    }
  }

  /* --- RENDER FEED --- */
  async function renderHome() { loadFeed(false); }
  async function renderProfile() { loadFeed(true); }

  async function loadFeed(onlyMine) {
    const container = document.getElementById('feed-container');
    container.innerHTML = '<div class="text-center mt-10 text-gray-600">Caricamento post...</div>';

    let q = sb.from('posts').select('*, profiles(*), likes(user_id), comments(id)').order('created_at', {ascending: false});
    if(onlyMine) q = q.eq('user_id', currentUser.id);

    const {data: posts} = await q;
    container.innerHTML = '';
    
    if(onlyMine) {
      const {data:p} = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
      container.innerHTML = `
        <div class="mb-8 text-center border-b border-[#222] pb-6">
           <img src="${p.avatar_url}" class="w-32 h-32 rounded-full border-4 border-[#222] mx-auto mb-4 object-cover">
           <h2 class="text-2xl font-serif italic text-white">${p.full_name}</h2>
           <p class="text-gray-500 text-sm">@${p.username}</p>
        </div>
      `;
    }

    if(!posts || posts.length === 0) {
      container.innerHTML += '<div class="text-center text-gray-500 mt-10">Nessun post trovato.</div>';
      return;
    }

    // Genera HTML Post
    for (const p of posts) {
      const isLiked = p.likes.some(l => l.user_id === currentUser.id);
      
      // Costruisci Card
      const html = `
        <div class="post-card">
          <div class="post-header">
            <img src="${p.profiles.avatar_url}" class="post-user-avatar">
            <div class="post-info">
              <h4>${p.profiles.full_name}</h4>
              <span>${new Date(p.created_at).toLocaleString()}</span>
            </div>
          </div>

          <div class="post-content">
             ${p.caption ? `<p>${p.caption}</p>` : ''}
          </div>

          ${p.image_url ? `<img src="${p.image_url}" class="post-image">` : ''}

          <div class="post-actions">
            <div class="action-btn ${isLiked ? 'liked' : ''}" onclick="toggleLike('${p.id}')">
              <i class="fa-solid fa-thumbs-up"></i> ${isLiked ? 'Piace' : 'Mi piace'}
            </div>
            <div class="action-btn" onclick="toggleComments('${p.id}')">
              <i class="fa-solid fa-comment"></i> Commenti (${p.comments.length})
            </div>
          </div>

          <div id="comments-${p.id}" class="comments-section">
             <div id="list-${p.id}" class="mb-4 flex flex-col gap-2"></div>
             <div class="flex gap-2">
               <input type="text" id="input-${p.id}" class="flex-1 bg-[#1a1a1a] border border-[#333] rounded px-3 text-sm text-white outline-none" placeholder="Scrivi un commento...">
               <button onclick="sendComment('${p.id}')" class="text-blue-500 font-bold text-xs uppercase px-2">Invia</button>
             </div>
          </div>
        </div>
      `;
      container.innerHTML += html;
    }
  }

  /* --- AZIONI SOCIAL --- */
  async function toggleLike(pid) {
    const {data} = await sb.from('likes').select().eq('post_id', pid).eq('user_id', currentUser.id);
    if(data.length > 0) await sb.from('likes').delete().eq('post_id', pid).eq('user_id', currentUser.id);
    else await sb.from('likes').insert([{post_id: pid, user_id: currentUser.id}]);
    
    // Refresh intelligente
    const isProfile = document.getElementById('feed-container').innerHTML.includes('border-4 border-[#222]');
    isProfile ? renderProfile() : renderHome();
  }

  async function toggleComments(pid) {
    const box = document.getElementById(`comments-${pid}`);
    if(box.style.display === 'block') { box.style.display = 'none'; return; }
    
    box.style.display = 'block';
    const list = document.getElementById(`list-${pid}`);
    list.innerHTML = '<span class="text-xs text-gray-500">Caricamento...</span>';
    
    const {data} = await sb.from('comments').select('*, profiles(username, avatar_url)').eq('post_id', pid).order('created_at');
    
    list.innerHTML = '';
    if(data.length === 0) list.innerHTML = '<span class="text-xs text-gray-500">Nessun commento.</span>';
    
    data.forEach(c => {
      list.innerHTML += `
        <div class="comment-row">
           <img src="${c.profiles.avatar_url}" class="w-8 h-8 rounded-full">
           <div class="comment-bubble">
             <div class="font-bold text-xs text-white mb-1">${c.profiles.username}</div>
             <div>${c.content}</div>
           </div>
        </div>
      `;
    });
  }

  async function sendComment(pid) {
    const txt = document.getElementById(`input-${pid}`).value;
    if(!txt) return;
    await sb.from('comments').insert([{post_id: pid, user_id: currentUser.id, content: txt}]);
    document.getElementById(`input-${pid}`).value = '';
    toggleComments(pid); // Ricarica commenti
    toggleComments(pid); // Riapri tendina
  }

  // Cerca
  function openSearch() { document.getElementById('search-modal').classList.remove('hidden'); }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
  
  async function doSearch() {
    const q = document.getElementById('search-query').value;
    if(q.length < 2) return;
    const {data} = await sb.from('profiles').select('*').ilike('username', `%${q}%`);
    const c = document.getElementById('search-results');
    c.innerHTML = '';
    data.forEach(u => {
      c.innerHTML += `<div class="p-2 border-b border-gray-700 text-white flex items-center gap-3"><img src="${u.avatar_url}" class="w-8 h-8 rounded-full bg-gray-700">${u.username}</div>`;
    });
  }

</script>
</body>
</html>
