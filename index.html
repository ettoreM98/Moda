<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HAWENISHLAND</title>

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest" defer></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- DESIGN PULITO & VELOCE --- */
    :root {
      --bg-body: #ffffff;
      --text-main: #000000;
      --text-gray: #8e8e8e;
      --accent: #0095f6; /* Blu standard per azioni, veloce da renderizzare */
      --border: #dbdbdb;
      --like-red: #ed4956;
    }

    body { 
      background-color: #fafafa; 
      color: var(--text-main); 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      margin: 0; 
      overflow-x: hidden; 
    }

    /* Rimuoviamo scrollbar brutte */
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    
    .hidden { display: none !important; }

    /* --- LAYOUT SIDEBAR --- */
    .app-layout { display: flex; max-width: 935px; margin: 0 auto; min-height: 100vh; }

    .sidebar { 
      width: 245px; height: 100vh; position: sticky; top: 0; 
      border-right: 1px solid var(--border); background: #fff; 
      padding: 30px 20px; display: flex; flex-direction: column; z-index: 50;
    }

    .brand-logo { font-size: 24px; font-weight: 700; margin-bottom: 40px; cursor: pointer; letter-spacing: -1px; }

    .nav-item { 
      display: flex; align-items: center; gap: 15px; padding: 12px; 
      cursor: pointer; font-size: 16px; border-radius: 8px; transition: 0.1s; margin-bottom: 5px; color: #000;
    }
    .nav-item:hover { background-color: #f2f2f2; }
    .nav-item.active { font-weight: 700; }
    .nav-item i { font-size: 24px; width: 24px; }

    /* MOBILE BAR (IN BASSO) */
    @media (max-width: 768px) {
      .sidebar { 
        width: 100%; height: 50px; position: fixed; bottom: 0; top: auto; left: 0; 
        border-right: none; border-top: 1px solid var(--border); 
        flex-direction: row; justify-content: space-around; padding: 0; 
        background: #fff; z-index: 90;
      }
      .brand-logo, .nav-text { display: none; }
      .nav-item { margin: 0; padding: 0; height: 100%; justify-content: center; }
      .nav-item:hover { background: transparent; }
      .app-layout { padding-bottom: 60px; display: block; }
    }

    /* --- FEED & POSTS --- */
    .main-content { flex: 1; padding: 30px 0; max-width: 470px; margin: 0 auto; }
    @media (max-width: 768px) { .main-content { width: 100%; padding: 10px 0; } }

    /* Tabs Feed */
    .feed-tabs-container { display: flex; justify-content: center; gap: 40px; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
    .feed-tab { padding: 10px; cursor: pointer; color: var(--text-gray); font-weight: 600; font-size: 14px; }
    .feed-tab.active { color: #000; border-bottom: 2px solid #000; }

    /* Post Card Styling */
    .post-card { background: #fff; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 20px; }
    @media (max-width: 768px) { .post-card { border: none; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); border-radius: 0; } }

    .post-header { display: flex; justify-content: space-between; align-items: center; padding: 10px; }
    .user-badge { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600; font-size: 14px; }
    .user-avatar { width: 32px; height: 32px; rounded-full: 50%; object-fit: cover; border-radius: 50%; }

    .post-img-container { position: relative; width: 100%; background: #efefef; }
    .post-img { width: 100%; display: block; object-fit: cover; max-height: 600px; }

    /* SHOP TAG VISIBILE E CLICCABILE */
    .shop-tag-overlay {
      position: absolute; bottom: 10px; left: 10px;
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 6px 10px; border-radius: 4px; font-size: 12px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; gap: 5px; z-index: 10;
    }

    .action-bar { display: flex; gap: 15px; padding: 10px; font-size: 24px; }
    .icon-btn { cursor: pointer; transition: transform 0.1s; }
    .icon-btn:active { transform: scale(0.9); }
    
    .likes-count { font-weight: 700; font-size: 14px; padding: 0 10px; margin-bottom: 5px; cursor: pointer; }
    .caption-box { padding: 0 10px 10px; font-size: 14px; }
    .caption-user { font-weight: 700; margin-right: 5px; cursor: pointer; }
    
    /* LOGIN PAGE */
    .split-layout { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; z-index: 200; display: flex; transition: transform 0.4s; }
    .visual-side { flex: 1; background: #fafafa; display: none; align-items: center; justify-content: center; }
    @media (min-width: 800px) { .visual-side { display: flex; } }
    .visual-side img { width: 80%; max-width: 400px; }
    
    .form-side { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
    .auth-box { border: 1px solid var(--border); padding: 40px; background: #fff; width: 100%; max-width: 350px; text-align: center; }
    .auth-input { width: 100%; background: #fafafa; border: 1px solid var(--border); padding: 9px; margin-bottom: 10px; font-size: 12px; border-radius: 3px; box-sizing: border-box; }
    .btn-blue { background: var(--accent); color: #fff; border: none; padding: 7px; width: 100%; font-weight: 600; border-radius: 4px; cursor: pointer; margin-top: 10px; }

    /* MODALS - CORREZIONE Z-INDEX */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.6); z-index: 1000; /* Molto alto per stare sopra la sidebar */
      display: flex; justify-content: center; align-items: center;
    }
    .glass-modal { background: #fff; border-radius: 12px; max-height: 90vh; width: 100%; max-width: 450px; display: flex; flex-direction: column; overflow: hidden; position: relative; }

    /* UPLOAD STYLES */
    .upload-area { border-bottom: 1px solid var(--border); padding: 10px; text-align: center; font-weight: 700; display: flex; justify-content: space-between; align-items: center;}
    .close-btn { font-size: 24px; cursor: pointer; padding: 0 10px; }

    /* CHAT & NOTIF */
    .gold-dot { width: 8px; height: 8px; background: red; border-radius: 50%; position: absolute; top: 10px; right: 8px; display: none; }
    .msg-bubble { padding: 8px 12px; border-radius: 20px; margin-bottom: 5px; max-width: 80%; font-size: 14px; }
    .msg-mine { background: #efefef; align-self: flex-end; }
    .msg-theirs { background: #fff; border: 1px solid var(--border); align-self: flex-start; }

    /* TOAST NOTIFICATION */
    .toast-box { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 5px; font-size: 14px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 3000; }
    .toast-active { opacity: 1; }

    /* LISTA PRODOTTI AGGIUNTI (UPLOAD) */
    .added-product-item { display: flex; justify-content: space-between; padding: 8px; background: #f0f0f0; margin-bottom: 5px; border-radius: 4px; font-size: 12px; }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
     <img src="https://static.cdninstagram.com/rsrc.php/v3/yM/r/8n91YnfPq0s.png" alt="App Preview">
  </div>
  <div class="form-side">
    <div class="auth-box">
      <h1 class="brand-logo" style="margin-bottom: 20px;">Hawenishland</h1>
      <div id="msg-box" class="hidden p-2 text-red-500 text-xs mb-2"></div>
      
      <div id="login-form">
        <input type="email" id="l-email" class="auth-input" placeholder="Numero di telefono, nome utente o email">
        <input type="password" id="l-pass" class="auth-input" placeholder="Password">
        <button onclick="faiLogin()" class="btn-blue">Accedi</button>
        <p onclick="vaiA('signup')" class="text-xs text-blue-500 mt-4 cursor-pointer font-bold">Non hai un account? Iscriviti</p>
      </div>

      <div id="signup-form" class="hidden">
        <input type="text" id="r-username" class="auth-input" placeholder="Username">
        <input type="text" id="r-nome" class="auth-input" placeholder="Nome">
        <input type="text" id="r-cognome" class="auth-input" placeholder="Cognome">
        <input type="date" id="r-nascita" class="auth-input">
        <input type="email" id="r-email" class="auth-input" placeholder="Email">
        <input type="password" id="r-pass" class="auth-input" placeholder="Password">
        <button onclick="faiRegistrazione()" class="btn-blue">Avanti</button>
        <p onclick="vaiA('login')" class="text-xs mt-4 cursor-pointer">Hai un account? Accedi</p>
      </div>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    
    <div class="sidebar">
      <div class="brand-logo" onclick="renderFeedView()">Hawenishland</div>
      
      <div class="nav-item active" onclick="renderFeedView()">
        <i class="fa-solid fa-house"></i> <span class="nav-text">Home</span>
      </div>
      <div class="nav-item" onclick="openSearchModal()">
        <i class="fa-solid fa-magnifying-glass"></i> <span class="nav-text">Cerca</span>
      </div>
      <div class="nav-item" onclick="openUploadModal()">
        <i class="fa-regular fa-square-plus"></i> <span class="nav-text">Crea</span>
      </div>
      <div class="nav-item relative" onclick="openNotificationsModal()">
        <div id="notif-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-heart"></i> <span class="nav-text">Notifiche</span>
      </div>
      <div class="nav-item relative" onclick="openInboxModal()">
        <div id="global-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-paper-plane"></i> <span class="nav-text">Messaggi</span>
      </div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)">
        <img id="mini-avatar" src="" class="w-6 h-6 rounded-full border border-gray-300"> <span class="nav-text ml-2">Profilo</span>
      </div>
      <div class="nav-item" style="margin-top:auto" onclick="logout()">
        <i class="fa-solid fa-bars"></i> <span class="nav-text">Altro</span>
      </div>
    </div>

    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="toast-notif" class="toast-box"></div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="glass-modal">
    <div class="upload-area">
        <span class="text-sm cursor-pointer" onclick="closeModal('upload-modal')">Annulla</span>
        <span>Crea nuovo post</span>
        <span class="text-sm text-blue-500 cursor-pointer" onclick="submitPost()" id="btn-publish-txt">Condividi</span>
    </div>
    
    <div class="flex flex-col h-full overflow-y-auto p-4">
      <div class="flex flex-col items-center justify-center border border-dashed border-gray-300 p-10 cursor-pointer hover:bg-gray-50 mb-4" onclick="document.getElementById('post-file').click()">
         <i class="fa-regular fa-image text-4xl mb-2"></i>
         <span class="text-sm">Trascina le foto qui</span>
         <button class="bg-blue-500 text-white px-3 py-1 rounded text-sm mt-2 font-bold">Seleziona dal computer</button>
      </div>
      <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">

      <img id="upload-preview" class="hidden w-full h-64 object-cover rounded mb-4">
      <div id="ai-loading" class="hidden text-center text-xs text-gray-500 mb-2">Analisi AI in corso...</div>
      <div id="ai-error-msg" class="hidden text-red-500 text-xs text-center mb-2">Immagine non valida per fashion.</div>

      <div id="upload-details-section" class="hidden">
         <textarea id="post-caption" rows="3" placeholder="Scrivi una didascalia..." class="w-full border p-2 rounded text-sm mb-4 outline-none resize-none"></textarea>
         
         <div class="border-t pt-4">
            <h4 class="font-bold text-sm mb-2">Tagga Prodotti (Obbligatorio)</h4>
            <div class="flex gap-2 mb-2">
                <input type="text" id="temp-prod-name" placeholder="Nome prodotto" class="flex-1 border p-2 text-xs rounded">
                <input type="url" id="temp-prod-link" placeholder="Link web" class="flex-1 border p-2 text-xs rounded">
            </div>
            <button onclick="addProdToUpload()" class="w-full border border-gray-300 p-1 text-xs rounded hover:bg-gray-100">+ Aggiungi Prodotto</button>
            <div id="upload-products-list" class="mt-2"></div>
         </div>
      </div>
    </div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden" style="z-index: 1050;">
  <div class="glass-modal" style="max-width: 900px; height: 80vh; flex-direction: row;">
    <div class="hidden md:flex flex-1 bg-black items-center justify-center">
        <img id="detail-img" src="" class="max-w-full max-h-full object-contain">
    </div>
    <div class="flex-1 flex flex-col bg-white w-full md:w-auto">
        <div class="p-3 border-b flex justify-between items-center">
            <div class="flex items-center gap-2">
                <img id="detail-avatar" src="" class="w-8 h-8 rounded-full border">
                <span id="detail-username" class="font-bold text-sm"></span>
            </div>
            <div class="flex gap-3">
                <div id="detail-delete-btn-container"></div>
                <i class="fa-solid fa-xmark cursor-pointer text-xl" onclick="closeModal('post-detail-modal')"></i>
            </div>
        </div>
        <div class="md:hidden h-64 bg-black flex items-center justify-center">
            <img id="detail-img-mobile" src="" class="max-w-full max-h-full object-contain">
        </div>
        <div id="detail-comments" class="flex-1 overflow-y-auto p-3 text-sm"></div>
        <div class="p-3 border-t">
            <div class="flex gap-3 text-2xl mb-2">
                <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer"></i>
                <i class="fa-regular fa-comment"></i>
            </div>
            <div class="font-bold text-sm mb-2"><span id="detail-likes-count">0</span> Mi piace</div>
            <div class="flex">
                <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="flex-1 text-sm outline-none">
                <button onclick="inviaCommento()" class="text-blue-500 font-bold text-sm">Pubblica</button>
            </div>
        </div>
    </div>
  </div>
</div>

<div id="shop-modal" class="modal-overlay hidden" style="z-index: 1100;">
  <div class="glass-modal p-4" style="max-width: 350px; height: auto;">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg">Prodotti</h3>
        <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('shop-modal')"></i>
    </div>
    <div id="shop-window-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
  </div>
</div>

<div id="share-modal" class="modal-overlay hidden" style="z-index: 1100;">
  <div class="glass-modal p-4" style="max-width: 350px; height: 400px;">
    <div class="flex justify-between items-center mb-4 pb-2 border-b">
        <h3 class="font-bold">Condividi</h3>
        <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('share-modal')"></i>
    </div>
    <div id="share-list-content" class="overflow-y-auto h-full"></div>
  </div>
</div>

<div id="generic-list-modal" class="modal-overlay hidden" style="z-index: 1100;">
  <div class="glass-modal p-0" style="max-width: 350px; height: 400px;">
    <div class="flex justify-between items-center p-3 border-b">
        <h3 class="font-bold" id="generic-title">Lista</h3>
        <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('generic-list-modal')"></i>
    </div>
    <div id="search-input-area" class="hidden p-2 border-b">
        <input type="text" id="search-query" class="w-full bg-gray-100 p-2 rounded text-sm outline-none" placeholder="Cerca..." onkeyup="performSearch()">
    </div>
    <div id="generic-content" class="overflow-y-auto p-2 h-full"></div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden" style="z-index: 1100;">
  <div class="glass-modal p-6" style="max-width: 350px; height: auto;">
    <h3 class="font-bold text-lg mb-4 text-center">Modifica Profilo</h3>
    <div class="flex flex-col items-center mb-4">
        <img id="edit-avatar-preview" class="w-20 h-20 rounded-full border mb-2 object-cover">
        <label class="text-blue-500 font-bold text-sm cursor-pointer">Cambia foto del profilo
            <input type="file" class="hidden" onchange="uploadAvatar(this)">
        </label>
    </div>
    <div class="space-y-3">
        <div><label class="text-xs text-gray-500">Username</label><input type="text" id="edit-username" class="w-full border-b py-1 outline-none"></div>
        <div><label class="text-xs text-gray-500">Nome</label><input type="text" id="edit-fullname" class="w-full border-b py-1 outline-none"></div>
        <button onclick="saveProfile()" class="w-full bg-blue-500 text-white rounded py-2 font-bold text-sm mt-2">Invia</button>
        <button onclick="closeModal('edit-profile-modal')" class="w-full text-center text-sm py-2">Annulla</button>
    </div>
  </div>
</div>

<div id="inbox-modal" class="modal-overlay hidden">
  <div class="glass-modal" style="height: 600px;">
    <div class="p-3 border-b flex justify-between font-bold"><span>Messaggi</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('inbox-modal')"></i></div>
    <div id="inbox-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="chat-modal" class="modal-overlay hidden">
  <div class="glass-modal" style="height: 600px;">
    <div class="p-3 border-b flex justify-between items-center bg-gray-50">
        <div class="flex items-center gap-2"><img id="chat-header-avatar" class="w-6 h-6 rounded-full"><span id="chat-header-name" class="font-bold">Chat</span></div>
        <i class="fa-solid fa-xmark cursor-pointer" onclick="closeChat()"></i>
    </div>
    <div id="chat-messages" class="flex-1 overflow-y-auto p-3 flex flex-col"></div>
    <div class="p-3 border-t flex gap-2">
        <input type="text" id="chat-input" class="flex-1 border rounded-full px-3 py-2 text-sm outline-none" placeholder="Scrivi..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()" class="text-blue-500 font-bold text-sm">Invia</button>
    </div>
  </div>
</div>

<div id="notifications-modal" class="modal-overlay hidden">
  <div class="glass-modal" style="height: 500px;">
    <div class="p-3 border-b flex justify-between font-bold"><span>Notifiche</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('notifications-modal')"></i></div>
    <div id="notifications-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<script>
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  
  let currentUser = null, currentPostId = null, activeChatId = null, chatSub = null;
  let currentFeedMode = 'following'; 
  let uploadProductsList = [];
  let sharePostId = null; 
  let classifierModel = null;

  // AI & Init
  window.addEventListener('load', async () => {
    try { 
        if(typeof mobilenet !== 'undefined') classifierModel = await mobilenet.load(); 
    } catch(e) { console.log("AI non caricata (non bloccante)"); }
    
    const { data: { session } } = await sb.auth.getSession();
    if (session) enterApp(session.user);
    else document.getElementById('auth-container').style.display = 'flex';
  });

  // Funzioni Base
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  function escapeHtml(t) { return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
  function showToast(msg) {
    const t = document.getElementById('toast-notif');
    t.innerText = msg; t.classList.add('toast-active');
    setTimeout(() => t.classList.remove('toast-active'), 3000);
  }

  // --- UPLOAD LOGIC CORRETTA ---
  function openUploadModal() {
    document.getElementById('upload-modal').classList.remove('hidden');
    // Reset inputs
    document.getElementById('post-file').value = "";
    document.getElementById('upload-preview').classList.add('hidden');
    document.getElementById('upload-details-section').classList.add('hidden');
    uploadProductsList = [];
    renderUploadProductsList();
  }

  function previewUpload(input) {
    if(input.files && input.files[0]) {
        const preview = document.getElementById('upload-preview');
        const details = document.getElementById('upload-details-section');
        const loading = document.getElementById('ai-loading');
        
        preview.src = URL.createObjectURL(input.files[0]);
        preview.classList.remove('hidden');
        loading.classList.remove('hidden');
        details.classList.add('hidden');

        // Simulazione AI rapida o reale
        setTimeout(async () => {
            let valid = true;
            if(classifierModel) {
                // Logica AI qui se necessario, per ora bypass per velocità
            }
            loading.classList.add('hidden');
            if(valid) details.classList.remove('hidden');
            else alert("Non è moda.");
        }, 500);
    }
  }

  function addProdToUpload() {
    const name = document.getElementById('temp-prod-name').value;
    const link = document.getElementById('temp-prod-link').value;
    if(name && link) {
        uploadProductsList.push({name, link});
        document.getElementById('temp-prod-name').value = "";
        document.getElementById('temp-prod-link').value = "";
        renderUploadProductsList();
    } else {
        alert("Inserisci Nome e Link prodotto.");
    }
  }

  function renderUploadProductsList() {
    const c = document.getElementById('upload-products-list');
    c.innerHTML = "";
    uploadProductsList.forEach((p, i) => {
        c.innerHTML += `<div class="added-product-item"><span>${escapeHtml(p.name)}</span><i class="fa-solid fa-trash cursor-pointer text-red-500" onclick="removeProdFromUpload(${i})"></i></div>`;
    });
  }
  
  function removeProdFromUpload(i) { uploadProductsList.splice(i, 1); renderUploadProductsList(); }

  async function submitPost() {
    const f = document.getElementById('post-file').files[0];
    const caption = document.getElementById('post-caption').value;
    
    // Check pending product input
    const pName = document.getElementById('temp-prod-name').value;
    const pLink = document.getElementById('temp-prod-link').value;
    if(pName && pLink) uploadProductsList.push({name: pName, link: pLink});

    if(!f) return alert("Manca la foto.");
    if(uploadProductsList.length === 0) return alert("Devi taggare almeno un prodotto (Nome + Link).");

    const btn = document.getElementById('btn-publish-txt');
    const oldTxt = btn.innerText;
    btn.innerText = "Pubblicazione...";
    
    try {
        const path = `${currentUser.id}/${Date.now()}`;
        await sb.storage.from('posts').upload(path, f);
        const { data: { publicUrl } } = sb.storage.from('posts').getPublicUrl(path);
        
        await sb.from('posts').insert([{
            user_id: currentUser.id,
            image_url: publicUrl,
            caption: caption,
            products: uploadProductsList
        }]);
        
        closeModal('upload-modal');
        renderFeedView();
        showToast("Post pubblicato!");
    } catch(e) {
        alert("Errore: " + e.message);
    }
    btn.innerText = oldTxt;
  }

  // --- FEED & POSTS ---
  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `
        <div class="feed-tabs-container">
            <div class="feed-tab ${currentFeedMode==='following'?'active':''}" onclick="switchFeedMode('following')">Seguiti</div>
            <div class="feed-tab ${currentFeedMode==='viral'?'active':''}" onclick="switchFeedMode('viral')">Esplora</div>
        </div>
        <div id="feed-list">Loading...</div>
    `;
    
    let query = sb.from('posts').select('*, profiles:user_id(username, avatar_url)').order('created_at', {ascending: false});
    
    if(currentFeedMode === 'following') {
        const {data: follows} = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
        const ids = follows.map(f => f.followed_id);
        if(ids.length > 0) query = query.in('user_id', ids);
        else {
            document.getElementById('feed-list').innerHTML = "<div class='text-center p-5'>Non segui nessuno. Vai su Esplora.</div>";
            return;
        }
    } else {
        query = query.limit(50);
    }

    const { data: posts } = await query;
    const list = document.getElementById('feed-list');
    list.innerHTML = "";
    
    if(!posts || posts.length === 0) { list.innerHTML = "<div class='text-center p-5'>Nessun post.</div>"; return; }

    for(const p of posts) {
        const user = p.profiles;
        const liked = await isLiked(p.id);
        const counts = await getCounts(p.id);
        
        let shopHtml = "";
        if(p.products && p.products.length > 0) {
            const json = encodeURIComponent(JSON.stringify(p.products));
            shopHtml = `<div class="shop-tag-overlay" onclick="openShopWindow('${json}')"><i class="fa-solid fa-bag-shopping"></i> Shop</div>`;
        }

        list.innerHTML += `
            <div class="post-card">
                <div class="post-header">
                    <div class="user-badge" onclick="openUserProfile('${p.user_id}')">
                        <img src="${user.avatar_url || 'https://via.placeholder.com/30'}" class="user-avatar">
                        <span>${user.username}</span>
                    </div>
                    ${p.user_id === currentUser.id ? `<i class="fa-solid fa-ellipsis cursor-pointer" onclick="deletePost('${p.id}')"></i>` : ''}
                </div>
                <div class="post-img-container">
                    <img src="${p.image_url}" class="post-img" ondblclick="toggleLike('${p.id}', this)" onclick="openPostDetail('${p.id}')">
                    ${shopHtml}
                </div>
                <div class="action-bar">
                    <div class="icon-btn" onclick="toggleLikeBtn('${p.id}', this)">
                        <i class="${liked ? 'fa-solid text-red-500' : 'fa-regular'} fa-heart"></i>
                    </div>
                    <div class="icon-btn" onclick="openPostDetail('${p.id}')"><i class="fa-regular fa-comment"></i></div>
                    <div class="icon-btn ml-auto" onclick="openShareModal('${p.id}')"><i class="fa-regular fa-paper-plane"></i></div>
                </div>
                <div class="likes-count" id="likes-count-${p.id}" onclick="openLikesList('${p.id}')">${counts.likes} Mi piace</div>
                <div class="caption-box">
                    <span class="caption-user" onclick="openUserProfile('${p.user_id}')">${user.username}</span> ${escapeHtml(p.caption)}
                </div>
            </div>
        `;
    }
  }

  function switchFeedMode(m) { currentFeedMode = m; renderFeedView(); }

  // --- ACTIONS ---
  async function isLiked(pid) {
    const {data} = await sb.from('likes').select('id').eq('post_id', pid).eq('user_id', currentUser.id);
    return data && data.length > 0;
  }
  async function getCounts(pid) {
    const {count: l} = await sb.from('likes').select('*', {count:'exact', head:true}).eq('post_id', pid);
    const {count: c} = await sb.from('comments').select('*', {count:'exact', head:true}).eq('post_id', pid);
    return {likes: l||0, comments: c||0};
  }
  
  async function toggleLikeBtn(pid, btn) {
    const icon = btn.querySelector('i');
    const span = document.getElementById(`likes-count-${pid}`);
    let n = parseInt(span.innerText);
    
    if(icon.classList.contains('fa-solid')) {
        icon.className = "fa-regular fa-heart";
        span.innerText = (n-1) + " Mi piace";
        await sb.from('likes').delete().eq('post_id', pid).eq('user_id', currentUser.id);
    } else {
        icon.className = "fa-solid fa-heart text-red-500";
        span.innerText = (n+1) + " Mi piace";
        await sb.from('likes').insert([{post_id: pid, user_id: currentUser.id}]);
    }
  }

  // --- DETAILS & MODALS LOGIC ---
  async function openPostDetail(pid) {
    currentPostId = pid;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    const {data: post} = await sb.from('posts').select('*, profiles:user_id(*)').eq('id', pid).single();
    
    document.getElementById('detail-img').src = post.image_url;
    document.getElementById('detail-img-mobile').src = post.image_url;
    document.getElementById('detail-username').innerText = post.profiles.username;
    document.getElementById('detail-avatar').src = post.profiles.avatar_url || "";
    
    loadComments(pid);
    const counts = await getCounts(pid);
    document.getElementById('detail-likes-count').innerText = counts.likes;
    
    // Check like status for detail view
    const liked = await isLiked(pid);
    const btn = document.getElementById('detail-like-btn');
    btn.className = liked ? "fa-solid fa-heart text-red-500 cursor-pointer" : "fa-regular fa-heart cursor-pointer";
    btn.onclick = () => { toggleLikeBtn(pid, {querySelector: ()=>btn}); }; // Wrapper per riusare logica
  }

  async function loadComments(pid) {
    const box = document.getElementById('detail-comments');
    box.innerHTML = "Caricamento...";
    const {data} = await sb.from('comments').select('*, profiles:user_id(username)').eq('post_id', pid);
    box.innerHTML = "";
    data.forEach(c => {
        box.innerHTML += `<div class="mb-2"><span class="font-bold mr-2">${c.profiles.username}</span><span>${escapeHtml(c.content)}</span></div>`;
    });
  }

  async function inviaCommento() {
    const txt = document.getElementById('new-comment').value;
    if(txt) {
        await sb.from('comments').insert([{post_id: currentPostId, user_id: currentUser.id, content: txt}]);
        document.getElementById('new-comment').value = "";
        loadComments(currentPostId);
    }
  }

  // --- SHOP WINDOW ---
  function openShopWindow(json) {
    const products = JSON.parse(decodeURIComponent(json));
    const list = document.getElementById('shop-window-list');
    list.innerHTML = "";
    products.forEach(p => {
        list.innerHTML += `
            <div class="flex justify-between items-center p-2 border rounded">
                <span class="font-bold text-sm">${escapeHtml(p.name)}</span>
                <a href="${p.link}" target="_blank" class="text-blue-500 font-bold text-sm">VAI ></a>
            </div>`;
    });
    document.getElementById('shop-modal').classList.remove('hidden');
  }

  // --- SEARCH & GENERIC LISTS ---
  function openSearchModal() {
    document.getElementById('generic-list-modal').classList.remove('hidden');
    document.getElementById('generic-title').innerText = "Cerca";
    document.getElementById('search-input-area').classList.remove('hidden');
    document.getElementById('generic-content').innerHTML = "";
  }
  
  async function performSearch() {
    const q = document.getElementById('search-query').value;
    if(q.length < 2) return;
    const {data} = await sb.from('profiles').select('*').ilike('username', `%${q}%`);
    const c = document.getElementById('generic-content');
    c.innerHTML = "";
    data.forEach(u => {
        c.innerHTML += `<div class="flex items-center gap-3 p-2 cursor-pointer hover:bg-gray-100" onclick="closeModal('generic-list-modal'); openUserProfile('${u.id}')"><img src="${u.avatar_url}" class="w-10 h-10 rounded-full border"><span>${u.username}</span></div>`;
    });
  }

  async function openLikesList(pid) {
      document.getElementById('generic-list-modal').classList.remove('hidden');
      document.getElementById('generic-title').innerText = "Mi piace";
      document.getElementById('search-input-area').classList.add('hidden');
      const {data} = await sb.from('likes').select('profiles:user_id(*)').eq('post_id', pid);
      const c = document.getElementById('generic-content');
      c.innerHTML = "";
      data.forEach(x => {
          c.innerHTML += `<div class="flex items-center gap-3 p-2 cursor-pointer" onclick="openUserProfile('${x.profiles.id}')"><img src="${x.profiles.avatar_url}" class="w-10 h-10 rounded-full"><span>${x.profiles.username}</span></div>`;
      });
  }

  // --- PROFILE & AUTH ---
  async function openUserProfile(uid) {
    const main = document.getElementById('main-content-area');
    main.innerHTML = '<div class="text-center mt-10"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>';
    
    const {data: user} = await sb.from('profiles').select('*').eq('id', uid).single();
    const {count: posts} = await sb.from('posts').select('*', {count:'exact'}).eq('user_id', uid);
    
    // Follow logic
    let followBtn = "";
    if(uid !== currentUser.id) {
        const {data} = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', uid);
        const isFollowing = data.length > 0;
        followBtn = `<button onclick="toggleFollow('${uid}')" class="px-4 py-1 rounded ${isFollowing ? 'border' : 'bg-blue-500 text-white'}">${isFollowing ? 'Seguito' : 'Segui'}</button>`;
        followBtn += ` <button onclick="openChat('${uid}','${user.username}','${user.avatar_url}')" class="px-4 py-1 border rounded">Msg</button>`;
    } else {
        followBtn = `<button onclick="openEditProfile()" class="px-4 py-1 border rounded font-bold text-sm">Modifica profilo</button>`;
    }

    const {data: userPosts} = await sb.from('posts').select('*').eq('user_id', uid).order('created_at', {ascending:false});

    main.innerHTML = `
        <div class="flex p-4 gap-4 border-b">
            <img src="${user.avatar_url||''}" class="w-20 h-20 rounded-full border">
            <div class="flex-1">
                <div class="text-2xl font-light mb-2">${user.username}</div>
                <div class="flex gap-2 mb-3">${followBtn}</div>
                <div class="flex gap-4 text-sm"><span><b>${posts}</b> post</span></div>
                <div class="text-sm mt-2 font-bold">${user.full_name||''}</div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-1 mt-1">
            ${userPosts.map(p => `<div class="aspect-square bg-gray-200 cursor-pointer" onclick="openPostDetail('${p.id}')"><img src="${p.image_url}" class="w-full h-full object-cover"></div>`).join('')}
        </div>
    `;
  }
  
  function openEditProfile() { document.getElementById('edit-profile-modal').classList.remove('hidden'); }
  
  async function saveProfile() {
      const u = document.getElementById('edit-username').value;
      const f = document.getElementById('edit-fullname').value;
      if(u) await sb.from('profiles').update({username: u, full_name: f}).eq('id', currentUser.id);
      closeModal('edit-profile-modal'); openUserProfile(currentUser.id);
  }
  
  async function uploadAvatar(input) {
      const f = input.files[0];
      if(!f) return;
      const path = `${currentUser.id}/avatar_${Date.now()}`;
      await sb.storage.from('avatars').upload(path, f);
      const {data} = sb.storage.from('avatars').getPublicUrl(path);
      await sb.from('profiles').update({avatar_url: data.publicUrl}).eq('id', currentUser.id);
      document.getElementById('edit-avatar-preview').src = data.publicUrl;
      document.getElementById('mini-avatar').src = data.publicUrl;
  }

  async function toggleFollow(uid) {
    const {data} = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', uid);
    if(data.length > 0) await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', uid);
    else await sb.from('follows').insert([{follower_id: currentUser.id, followed_id: uid}]);
    openUserProfile(uid);
  }

  // --- MESSAGES & NOTIF ---
  async function openInboxModal() {
      document.getElementById('inbox-modal').classList.remove('hidden');
      const {data: msgs} = await sb.from('messages').select('*').or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`).order('created_at', {ascending:false});
      const list = document.getElementById('inbox-list');
      list.innerHTML = "";
      
      const seen = new Set();
      for(const m of msgs) {
          const other = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
          if(seen.has(other)) continue;
          seen.add(other);
          const {data: u} = await sb.from('profiles').select('*').eq('id', other).single();
          list.innerHTML += `<div class="p-3 border-b cursor-pointer hover:bg-gray-50 flex items-center gap-3" onclick="closeModal('inbox-modal'); openChat('${u.id}', '${u.username}', '${u.avatar_url}')"><img src="${u.avatar_url}" class="w-10 h-10 rounded-full"><div><b>${u.username}</b><div class="text-xs text-gray-500 truncate w-40">${m.content}</div></div></div>`;
      }
  }

  async function openChat(uid, uname, uava) {
      activeChatId = uid;
      document.getElementById('chat-modal').classList.remove('hidden');
      document.getElementById('chat-header-name').innerText = uname;
      document.getElementById('chat-header-avatar').src = uava;
      const {data: msgs} = await sb.from('messages').select('*').or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${uid}),and(sender_id.eq.${uid},receiver_id.eq.${currentUser.id})`).order('created_at', {ascending:true});
      const box = document.getElementById('chat-messages');
      box.innerHTML = "";
      msgs.forEach(m => {
          box.innerHTML += `<div class="msg-bubble ${m.sender_id===currentUser.id?'msg-mine':'msg-theirs'}">${escapeHtml(m.content)}</div>`;
      });
  }

  async function sendMessage() {
      const t = document.getElementById('chat-input').value;
      if(t && activeChatId) {
          await sb.from('messages').insert([{sender_id: currentUser.id, receiver_id: activeChatId, content: t}]);
          document.getElementById('chat-input').value = "";
          const box = document.getElementById('chat-messages');
          box.innerHTML += `<div class="msg-bubble msg-mine">${escapeHtml(t)}</div>`;
          box.scrollTop = box.scrollHeight;
      }
  }

  function openShareModal(pid) {
      sharePostId = pid;
      document.getElementById('share-modal').classList.remove('hidden');
      // Carica lista utenti seguiti per condividere... (semplificato)
      document.getElementById('share-list-content').innerHTML = "<div class='p-2'>Funzione rapida: Invia link copiato.</div>";
  }

  async function deletePost(pid) {
      if(confirm("Eliminare?")) {
          await sb.from('posts').delete().eq('id', pid);
          renderFeedView();
      }
  }

  function enterApp(u) {
    currentUser = u;
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('app-interface').classList.remove('hidden');
    // Set Mini Avatar
    sb.from('profiles').select('avatar_url').eq('id', u.id).single().then(({data})=>{
        if(data) document.getElementById('mini-avatar').src = data.avatar_url || "";
    });
    renderFeedView();
  }

  function vaiA(t) { 
    document.getElementById('login-form').classList.toggle('hidden', t==='signup');
    document.getElementById('signup-form').classList.toggle('hidden', t==='login');
  }

  async function faiLogin() {
      const e = document.getElementById('l-email').value;
      const p = document.getElementById('l-pass').value;
      const {data, error} = await sb.auth.signInWithPassword({email:e, password:p});
      if(error) alert(error.message);
      else enterApp(data.user);
  }
  
  async function faiRegistrazione() {
      const e = document.getElementById('r-email').value;
      const p = document.getElementById('r-pass').value;
      const u = document.getElementById('r-username').value;
      const {data, error} = await sb.auth.signUp({email:e, password:p});
      if(error) alert(error.message);
      else {
          await sb.from('profiles').insert([{id: data.user.id, username: u}]);
          enterApp(data.user);
      }
  }
  
  async function logout() { await sb.auth.signOut(); location.reload(); }
</script>
</body>
</html>
