<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Editorial Shopping</title>

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://fonts.googleapis.com">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest" defer></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Playfair+Display:ital,wght@1,400;1,600&display=swap" rel="stylesheet">

  <style>
    /* --- NUOVO DESIGN SYSTEM: EDITORIAL LIGHT --- */
    :root {
      --bg-body: #ffffff;        /* Sfondo bianco puro */
      --bg-panel: #ffffff;       
      --text-main: #111111;      /* Nero quasi assoluto */
      --text-muted: #666666;     /* Grigio scuro per testi secondari */
      --gold: #bfa15f;           /* Oro più sobrio/elegante */
      --gold-glow: rgba(191, 161, 95, 0.15);
      --red-like: #ff3b30;
      --border-light: 1px solid #f0f0f0;
      --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.08);
    }

    body { 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      font-family: 'DM Sans', sans-serif; /* Font più leggibile */
      margin: 0; 
      overflow-x: hidden; 
      /* Rimossa la sfumatura scura, ora è pulito */
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    ::-webkit-scrollbar { width: 0px; background: transparent; } /* Scrollbar invisibile estetica */
    .hidden { display: none !important; }

    /* --- SIDEBAR ELEGANTE --- */
    .app-layout { display: flex; max-width: 1400px; margin: 0 auto; min-height: 100vh; }

    .sidebar { 
      width: 260px; /* Più larga per mostrare testo desktop */
      position: sticky; 
      top: 0; 
      height: 100vh;
      padding: 40px 30px;
      display: flex; 
      flex-direction: column; 
      background: var(--bg-panel);
      border-right: var(--border-light); /* Bordo destro invece di box fluttuante */
      z-index: 50;
    }

    .brand-logo-icon {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-style: italic;
      font-size: 28px;
      color: #000;
      margin-bottom: 50px;
      cursor: pointer;
      display: block;
      width: auto; height: auto;
      border: none; box-shadow: none;
      text-align: left;
    }
    .brand-logo-icon::after { content: "Hawenishland."; } /* Mostra nome intero */

    .nav-item { 
      width: 100%; height: 50px;
      display: flex; align-items: center; justify-content: flex-start;
      border-radius: 12px; 
      cursor: pointer; 
      transition: all 0.2s ease; 
      color: var(--text-muted);
      margin-bottom: 8px;
      font-size: 16px;
      padding-left: 10px;
      gap: 15px;
    }
    
    .nav-item i { width: 24px; text-align: center; font-size: 20px; }
    
    /* Aggiunge etichette di testo vicino alle icone */
    .nav-item::before { content: attr(title); font-weight: 500; }
    .nav-item:hover, .nav-item.active { 
      background: #f7f7f7; 
      color: #000; 
      font-weight: 700;
      transform: translateX(5px);
      box-shadow: none;
    }
    
    .nav-item:hover::after { display: none; } /* Rimuovi tooltip vecchio stile */

    /* --- FEED & POSTS --- */
    .main-content { flex: 1; padding: 40px; max-width: 600px; margin: 0 auto; }

    .feed-tabs-container {
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: var(--border-light);
      position: sticky; top: 0; background: rgba(255,255,255,0.95); z-index: 40; backdrop-filter: blur(10px);
    }

    .feed-tab {
      font-size: 15px;
      font-weight: 600;
      color: #aaa;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .feed-tab.active {
      color: #000;
    }

    .feed-tab.active::after {
      content: '';
      position: absolute;
      bottom: -17px;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      height: 2px;
      background: #000;
      box-shadow: none;
    }

    .post-card { 
      background: #fff;
      margin-bottom: 50px; 
      padding: 0; /* Padding rimosso per foto al vivo */
      border-radius: 0; /* Bordi non arrotondati stile Instagram/Magazine */
      border: none; border-bottom: 1px solid #f0f0f0;
      box-shadow: none;
      transition: none;
      padding-bottom: 30px;
      content-visibility: auto;
    }
    
    .post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
    .user-badge { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { 
      width: 38px; height: 38px; 
      border-radius: 50%; object-fit: cover; 
      border: 1px solid #eee;
    }
    .user-meta { display: flex; flex-direction: column; }
    .username { font-weight: 700; font-size: 14px; color: #000; }
    .post-date { font-size: 11px; color: #999; text-transform: none; letter-spacing: 0; }

    .post-img-container {
      position: relative;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #f0f0f0;
      background: #f9f9f9;
      aspect-ratio: 4/5; /* Formato verticale moderno */
    }
    .post-img { width: 100%; height: 100%; object-fit: cover; display: block; cursor: pointer; opacity: 0; transition: opacity 0.5s; }
    .post-img.loaded { opacity: 1; }

    /* SHOP TAG ELEGANT */
    .shop-tag-overlay {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(255, 255, 255, 0.95);
      color: #000;
      padding: 8px 14px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #eee;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .shop-tag-overlay:hover {
      background: #000;
      border-color: #000;
    }
    .shop-tag-overlay:hover span, .shop-tag-overlay:hover i { color: #fff; }
    
    .shop-tag-overlay span { font-size: 11px; font-weight: 700; color: #000; letter-spacing: 0.5px; }
    .shop-tag-overlay i { color: #000; font-size: 12px; }

    .action-bar { display: flex; gap: 20px; margin-top: 15px; padding: 0 4px; }
    .icon-btn { 
      font-size: 24px; cursor: pointer; transition: 0.2s; color: #000; opacity: 1; 
      display: flex; align-items: center; gap: 6px;
    }
    .icon-btn:hover { opacity: 0.6; transform: none; color: #000; }
    .likes-count-clickable { font-size: 14px; font-weight: 600; color: #000; cursor: pointer; }
    .likes-count-clickable:hover { text-decoration: underline; color: #000; }

    .caption-box { margin-top: 10px; padding: 0 4px; font-size: 14px; line-height: 1.5; color: #333; }
    .caption-user { font-weight: 700; color: #000; margin-right: 6px; cursor: pointer; }
    .heart-filled { color: var(--red-like) !important; opacity: 1 !important; }

    /* BUTTONS STYLE */
    .btn-gold {
      background: #000; /* Nero editoriale */
      color: #fff; padding: 14px 24px; border-radius: 8px;
      font-weight: 600; border: none; cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: 0.3s;
      text-transform: uppercase; font-size: 12px; letter-spacing: 1px;
    }
    .btn-gold:hover { background: #333; transform: translateY(-1px); }
    
    .btn-gold-outline {
      border: 1px solid #ddd;
      color: #000; padding: 8px 16px; border-radius: 6px;
      font-weight: 600; cursor: pointer; background: transparent; transition: 0.2s;
    }
    .btn-gold-outline:hover { background: #f9f9f9; border-color: #000; }
    
    .empty-feed-box {
      text-align: center; padding: 60px 20px;
      background: #fff; border: 1px solid #eee;
      border-radius: 12px; color: #999;
    }

    /* LOGIN SCREEN - STILE RIVISTA */
    .split-layout { display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:200; background:#fff; transition:transform .8s ease-in-out; }
    .visual-side { flex:1.2; position:relative; overflow:hidden; display:none; background:#f0f0f0 }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; filter:none; opacity:0; transition:opacity 1.5s ease; z-index:0; pointer-events:none; }
    .visual-side img.active{ opacity:1; z-index:1; pointer-events:auto; }
    
    .form-side{ flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; background:#fff; max-width:600px; margin:auto }
    
    .input-label { font-weight: 700; color: #000; font-size: 11px; }
    input.auth-input{ background:#fafafa; border:1px solid #eee; padding:15px; border-radius: 8px; color:#000; width:100%; outline:none; font-size:14px; margin-top: 5px; }
    input.auth-input:focus{ border-color:#000; background: #fff; }
    
    .btn-white{ background:#000; color:#fff; padding:18px; font-weight:600; text-transform:uppercase; letter-spacing: 1px; width:100%; cursor:pointer; border:none; border-radius: 8px; transition:.3s; margin-top:10px }
    .btn-white:hover{ background:#333; }
    .link-small{ text-align:center; margin-top:20px; font-size:12px; color:#666; cursor:pointer; }
    .link-small b { color: #000; }

    /* --- MODALS --- */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(255,255,255, 0.85); backdrop-filter: blur(8px); 
        z-index: 100; 
        display: flex; justify-content: center; align-items: center; 
    }
    
    #post-detail-modal { z-index: 150; }
    #shop-modal { z-index: 9999 !important; }

    .glass-modal { background: #fff; border: 1px solid #eee; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.1); color: #000; }
    
    .detail-layout { display: flex; width: 95vw; max-width: 1100px; height: 90vh; border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
    .detail-img-side { flex: 1.5; background: #fafafa; display: flex; align-items: center; justify-content: center; position: relative; }
    .detail-img-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .detail-info-side { flex: 1; display: flex; flex-direction: column; background: #fff; min-width: 350px; position: relative; border-left: 1px solid #eee; }
    
    @media (max-width: 800px) {
      .sidebar { 
        width: 100%; height: 60px; position: fixed; bottom: 0; top: auto; left: 0; margin: 0; 
        flex-direction: row; justify-content: space-around; padding: 0; border-radius: 0;
        background: rgba(255, 255, 255, 0.98); border-top: 1px solid #eee; border-right: none;
      }
      .brand-logo-icon { display: none; }
      .nav-item { width: auto; margin: 0; padding: 0; justify-content: center; }
      .nav-item::before { display: none; }
      .nav-item::after { display: none; }
      .main-content { padding: 20px 10px 100px 10px; }
      .detail-layout { flex-direction: column; height: 100%; border-radius: 0; width: 100%; }
      .app-layout { display: block; }
      .detail-info-side { border-left: none; }
    }

    /* CHAT & NOTIFICATIONS */
    .gold-dot { width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; position: absolute; top: 12px; right: 10px; box-shadow: none; display: none; z-index: 60; }
    
    .msg-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; font-size: 14px; line-height: 1.4; margin-bottom: 8px; position: relative; }
    .msg-mine { background: #000; color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .msg-theirs { background: #f0f0f0; color: #000; align-self: flex-start; border-bottom-left-radius: 4px; }
    
    .inbox-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: 0.2s; }
    .inbox-item:hover { background: #fafafa; }
    .unread-indicator { width: 8px; height: 8px; background: #ff3b30; border-radius: 50%; margin-left: auto; }

    /* SHARED POST */
    .shared-post-bubble {
        background: #fff !important; border: 1px solid #eee; border-radius: 12px !important;
        padding: 0 !important; overflow: hidden; cursor: pointer; transition: transform 0.2s; width: 200px;
    }
    .shared-post-bubble:hover { transform: scale(1.02); }
    .shared-post-img { width: 100%; height: 140px; object-fit: cover; }
    .shared-post-info { padding: 10px; text-align: center; font-size: 11px; color: #555; background: #fff; }

    /* TOAST */
    .toast-box { position: fixed; top: 20px; right: 20px; background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; color: #000; z-index: 2000; box-shadow: 0 10px 30px rgba(0,0,0,0.08); transform: translateX(200%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast-active { transform: translateX(0); }

    /* MULTI SHOP LIST */
    .added-product-item {
        display: flex; justify-content: space-between; align-items: center;
        background: #fafafa; padding: 10px; border-radius: 6px; margin-bottom: 5px;
        border: 1px solid #eee;
    }
    .added-product-item span { font-size: 12px; color: #333; }
    .shop-list-container { max-height: 300px; overflow-y: auto; padding-right: 5px; }
    
    /* ANALISI AI */
    .analyzing-box {
        position: absolute; inset: 0; background: rgba(255,255,255,0.9);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-radius: 12px; z-index: 10;
    }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=1200" class="active" loading="eager" style="object-position: top;">
    <img src="https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?q=80&w=1200" loading="lazy">
  </div>
  <div class="form-side">
    <h1 class="serif text-5xl mb-4 italic text-black" style="font-family: 'Playfair Display', serif;">Hawenishland.</h1>
    <p class="text-gray-500 mb-10 text-sm">Curated fashion platform.</p>
    <div id="msg-box" class="hidden p-3 text-center mb-4 text-xs border rounded bg-gray-50"></div>
    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass" class="auth-input"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>
    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username</label><input type="text" id="r-username" class="auth-input"></div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome" class="auth-input"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome" class="auth-input"></div>
      </div>
      <div class="input-group"><label class="input-label">Nascita</label><input type="date" id="r-nascita" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass" class="auth-input"></div>
      <button onclick="faiRegistrazione()" class="btn-white">Registrati</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    <div class="sidebar">
      <div class="brand-logo-icon" onclick="renderFeedView()" title="Home"></div>
      <div class="nav-item active" onclick="renderFeedView()" title="Home">
        <i class="fa-solid fa-house"></i>
      </div>
      <div class="nav-item" onclick="openSearchModal()" title="Cerca">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <div class="nav-item" onclick="openUploadModal()" title="Nuovo Post">
        <i class="fa-regular fa-square-plus"></i>
      </div>
      <div class="nav-item relative" onclick="openNotificationsModal()" title="Notifiche">
        <div id="notif-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-heart"></i>
      </div>
      <div class="nav-item relative" onclick="openInboxModal()" title="Messaggi">
        <div id="global-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-paper-plane"></i>
      </div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)" title="Profilo">
        <i class="fa-regular fa-circle-user"></i>
      </div>
      <div style="margin-top:auto"></div>
      <div class="nav-item text-red-500 hover:text-red-600" onclick="logout()" title="Esci">
        <i class="fa-solid fa-arrow-right-from-bracket"></i>
      </div>
    </div>
    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="toast-notif" class="toast-box">
  <div class="text-[#bfa15f] text-xl"><i class="fa-solid fa-bell"></i></div>
  <div>
    <h4 class="text-sm font-bold text-black">Novità</h4>
    <p class="text-xs text-gray-500" id="toast-msg">Notifica ricevuta.</p>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[450px]">
    <div class="flex justify-between items-center mb-6 pb-2 border-b border-gray-100">
      <h3 class="font-bold text-xl text-black font-serif italic">Nuovo Look</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400 hover:text-black" onclick="closeModal('upload-modal')"></i>
    </div>
    <div class="flex flex-col gap-4 max-h-[80vh] overflow-y-auto pr-1 relative">
      
      <label class="h-40 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-black hover:bg-gray-50 transition relative overflow-hidden">
        <i class="fa-solid fa-camera text-3xl mb-2 text-gray-300"></i>
        <span class="text-xs text-gray-500 font-bold uppercase">Carica Foto</span>
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
        <div id="ai-loading" class="hidden analyzing-box">
            <i class="fa-solid fa-circle-notch fa-spin text-3xl text-black mb-2"></i>
            <span class="text-xs text-black font-bold">Analisi AI...</span>
        </div>
      </label>
      
      <img id="upload-preview" class="hidden w-full h-40 object-cover rounded-xl shadow-sm border border-gray-200">
      
      <div id="ai-error-msg" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg text-red-500 text-xs text-center">
        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Ops! Non sembra un outfit.
      </div>

      <div id="upload-details-section" class="hidden">
          <div class="bg-gray-50 p-4 rounded-xl border border-gray-100 mb-4">
            <p class="text-gray-400 text-xs font-bold uppercase mb-2"><i class="fa-solid fa-tags mr-1"></i> Prodotti (Obbligatorio)</p>
            <div class="flex gap-2 mb-2">
               <input type="text" id="temp-prod-name" placeholder="Nome (es. Blazer)" class="flex-1 bg-white border border-gray-200 rounded-lg p-2 text-black text-xs outline-none focus:border-black">
               <input type="url" id="temp-prod-link" placeholder="Link..." class="flex-1 bg-white border border-gray-200 rounded-lg p-2 text-black text-xs outline-none focus:border-black">
            </div>
            <button onclick="addProdToUpload()" class="btn-gold-outline w-full text-xs py-2 mb-2">+ Aggiungi</button>
            <div id="upload-products-list" class="space-y-1"></div>
          </div>

          <textarea id="post-caption" rows="2" placeholder="Descrivi il tuo stile..." class="w-full bg-white border-none rounded-xl p-3 text-black focus:ring-1 focus:ring-black outline-none mb-4 text-sm"></textarea>
          <button id="btn-publish" onclick="submitPost()" class="btn-gold w-full">PUBBLICA</button>
      </div>
    </div>
  </div>
</div>

<div id="share-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between font-bold text-black">
      <span>Invia a...</span>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400" onclick="closeModal('share-modal')"></i>
    </div>
    <div id="share-list-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="shop-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[380px] p-8 text-center relative">
    <i class="fa-solid fa-xmark absolute top-4 right-4 text-gray-400 cursor-pointer text-xl hover:text-black" onclick="closeModal('shop-modal')"></i>
    <h3 class="text-black font-serif text-3xl mb-1 italic" style="font-family: 'Playfair Display', serif;">Shop the Look</h3>
    <div class="w-8 h-0.5 bg-black mx-auto mb-6 mt-2"></div>
    <div id="shop-window-list" class="shop-list-container space-y-3 text-left"></div>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[450px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <i class="fa-solid fa-magnifying-glass text-gray-400 mr-3"></i>
      <input type="text" id="search-query" class="bg-transparent text-black w-full outline-none placeholder-gray-400 text-lg" placeholder="Cerca utenti..." onkeyup="performSearch()">
      <i class="fa-solid fa-xmark cursor-pointer ml-3 text-gray-400" onclick="closeModal('search-modal')"></i>
    </div>
    <div id="search-results" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between font-bold text-black">
      <span id="ul-title">Lista</span>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400" onclick="closeModal('user-list-modal')"></i>
    </div>
    <div id="ul-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="likes-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between font-bold text-black">
      <span>Mi piace</span>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400" onclick="closeModal('likes-list-modal')"></i>
    </div>
    <div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="glass-modal detail-layout">
    <div class="detail-img-side">
      <img id="detail-img" src="">
      <div id="detail-noimg" class="hidden text-gray-400">Solo Testo</div>
      <div id="detail-shop-btn"></div>
    </div>
    <div class="detail-info-side">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center">
        <div class="flex items-center gap-3 cursor-pointer" id="detail-user-link">
          <img id="detail-avatar" src="" class="w-8 h-8 rounded-full object-cover border border-gray-200">
          <span id="detail-username" class="font-bold text-sm text-black"></span>
        </div>
        <div class="flex items-center gap-4">
          <div id="detail-delete-btn-container"></div>
          <i class="fa-solid fa-xmark cursor-pointer text-lg text-gray-400 hover:text-black" onclick="closeModal('post-detail-modal')"></i>
        </div>
      </div>
      <div id="detail-comments" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
      <div class="p-4 border-t border-gray-100 bg-white">
        <div class="flex gap-4 text-2xl mb-2 items-center text-black">
          <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer transition"></i>
          <i class="fa-regular fa-comment"></i>
          <i id="detail-shop-icon" class="fa-solid fa-bag-shopping cursor-pointer hidden"></i>
        </div>
        <div class="font-bold text-sm mb-3 text-black">
            <span id="detail-likes-count" class="cursor-pointer hover:underline">0</span> Mi piace
        </div>
        <div class="flex gap-2">
          <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="flex-1 bg-transparent outline-none text-black text-sm">
          <button onclick="inviaCommento()" class="text-blue-600 font-bold text-sm">Pubblica</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <h2 class="text-xl font-bold mb-4 text-center text-black">Modifica Profilo</h2>
    <div class="flex flex-col items-center mb-6">
      <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border border-gray-200 mb-2">
      <label class="text-blue-600 text-sm font-bold cursor-pointer hover:underline">Cambia Foto<input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar(this)"></label>
    </div>
    <div class="space-y-4">
      <div><label class="text-xs text-gray-500 uppercase font-bold">Username</label><input id="edit-username" type="text" class="w-full bg-gray-50 p-2 rounded text-black border border-gray-200"></div>
      <div><label class="text-xs text-gray-500 uppercase font-bold">Nome Completo</label><input id="edit-fullname" type="text" class="w-full bg-gray-50 p-2 rounded text-black border border-gray-200"></div>
      <div class="flex gap-3 pt-2">
        <button onclick="saveProfile()" class="flex-1 btn-gold">Salva</button>
        <button onclick="closeModal('edit-profile-modal')" class="flex-1 border border-gray-300 py-2 rounded-lg text-black hover:bg-gray-50">Annulla</button>
      </div>
    </div>
  </div>
</div>

<div id="inbox-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[550px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
      <h3 class="font-bold text-lg text-black">Messaggi</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400" onclick="closeModal('inbox-modal')"></i>
    </div>
    <div id="inbox-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="notifications-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[550px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
      <h3 class="font-bold text-lg text-black">Notifiche</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400" onclick="closeModal('notifications-modal')"></i>
    </div>
    <div id="notifications-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="chat-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[550px] flex flex-col">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white z-10">
      <div class="flex items-center gap-3">
        <img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200">
        <span id="chat-header-name" class="font-bold text-black">Chat</span>
      </div>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400" onclick="closeChat()"></i>
    </div>
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-gray-50"></div>
    <div class="p-4 border-t border-gray-100 flex gap-2 bg-white">
      <input type="text" id="chat-input" placeholder="Scrivi un messaggio..." class="flex-1 bg-gray-100 border-none rounded-full px-4 py-2 text-black outline-none" onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="font-bold text-blue-600 px-2">Invia</button>
    </div>
  </div>
</div>

<script>
  // --- TUTTO IL JAVASCRIPT ORIGINALE ---
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  let sb = null;
  
  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';
  
  let currentUser = null;
  let currentPostId = null;
  let activeChatId = null;
  let chatSub = null;
  let currentFeedMode = 'following'; 
  let uploadProductsList = []; 
  let sharePostId = null;
  let allPostsCache = {}; 
  let classifierModel = null;
  const FASHION_KEYWORDS = [
    'shirt', 'pants', 'jean', 'dress', 'suit', 'shoe', 'boot', 'sandal', 'hat', 
    'sunglasses', 'jacket', 'coat', 'sweater', 'jersey', 'cardigan', 'skirt', 
    'tie', 't-shirt', 'blouse', 'trousers', 'shorts', 'footwear', 'outerwear',
    'miniskirt', 'maillot', 'tank suit', 'bikini', 'kimono', 'abaya', 'gown',
    'cloak', 'lab coat', 'pajama', 'velvet', 'wool', 'tie', 'bow tie', 'apron',
    'stole', 'necklace', 'wardrobe', 'closet', 'fashion', 'person', 'groom', 'bride',
    'uniform', 'vestment', 'trench coat', 'sweatshirt', 'Loafer', 'clog', 'bag', 'purse'
  ];

  document.addEventListener('DOMContentLoaded', async () => {
    if(window.supabase) {
        initApp();
    } else {
        window.addEventListener('load', initApp);
    }
    startLoginCarousel();
  });

  async function initApp() {
    if(!sb) sb = window.supabase.createClient(SB_URL, SB_KEY);
    const { data: { session }, error } = await sb.auth.getSession();
    if (session && !error) {
        enterApp(session.user);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
    }
    setTimeout(loadAIModel, 2000);
  }

  function startLoginCarousel() {
    let i = 0; 
    const imgs = document.querySelectorAll('.visual-side img');
    if (imgs.length) { 
        setInterval(() => { 
            imgs[i].classList.remove('active'); 
            i = (i + 1) % imgs.length; 
            imgs[i].classList.add('active'); 
        }, 5000); 
    }
  }

  async function loadAIModel() {
      try {
        if (typeof mobilenet !== 'undefined') {
            classifierModel = await mobilenet.load();
        }
      } catch(e) { console.error("AI Loading deferred error (non-critical):", e); }
  }

  function mess(t,e){
      const b=document.getElementById('msg-box');
      b.innerText=t;
      b.classList.remove('hidden');
      b.style.borderColor=e?'red':'green';
      b.style.color=e?'red':'green';
  }

  function vaiA(m){ 
      document.getElementById('login-form').classList.toggle('hidden',m==='signup'); 
      document.getElementById('signup-form').classList.toggle('hidden',m==='login'); 
  }

  async function faiLogin() { 
      const {data,error}=await sb.auth.signInWithPassword({ 
          email:document.getElementById('l-email').value, 
          password:document.getElementById('l-pass').value 
      }); 
      if(error) mess(error.message,true); 
      else enterApp(data.user); 
  }

  async function faiRegistrazione() { 
      const {data,error}=await sb.auth.signUp({ 
          email:document.getElementById('r-email').value, 
          password:document.getElementById('r-pass').value 
      }); 
      if(error) return mess(error.message,true); 
      if(data.user) {
          await sb.from('profiles').insert([{ 
              id:data.user.id, 
              username:document.getElementById('r-username').value 
          }]); 
      }
      mess("Registrazione OK!"); 
  }

  async function logout() { 
      await sb.auth.signOut(); 
      location.reload(); 
  }

  async function recuperoPassword() {
    const email = document.getElementById('l-email').value;
    if(!email) return alert("Inserisci l'email per il recupero");
    const { error } = await sb.auth.resetPasswordForEmail(email);
    alert(error ? error.message : "Email di recupero inviata!");
  }

  function enterApp(u) { 
    currentUser=u; 
    document.getElementById('auth-container').style.transform = "translateY(-100vh)"; 
    setTimeout(async ()=>{ 
      document.getElementById('auth-container').classList.add('hidden'); 
      document.getElementById('app-interface').classList.remove('hidden'); 
      
      renderFeedView(); 
      checkNotifications(); 
      checkAppNotifications(); 

      sb.channel('global-updates')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          if(payload.new.receiver_id === currentUser.id) checkNotifications();
        })
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'notifications',
          filter: `recipient_id=eq.${currentUser.id}`
        }, payload => {
          if (!payload?.new) return;
          if (payload.new.type === 'like') showToast("Nuovo like!");
          if (payload.new.type === 'comment') showToast("Nuovo commento!");
          if (payload.new.type === 'follow') showToast("Nuovo follower!");
          checkAppNotifications();
        })
        .subscribe();
    },600); 
  }

  function closeModal(id) { 
      document.getElementById(id).classList.add('hidden'); 
  }
  function openUploadModal() { 
      document.getElementById('upload-modal').classList.remove('hidden'); 
      if(!classifierModel) loadAIModel();
  }
  function openSearchModal() { 
      document.getElementById('search-modal').classList.remove('hidden'); 
      document.getElementById('search-query').focus(); 
  }

  async function checkImageContent(imgElement) {
    if (!classifierModel) {
        try {
             if (typeof mobilenet !== 'undefined') {
                classifierModel = await mobilenet.load();
             } else {
                 return true; 
             }
        } catch(e) { return true; }
    }
    try {
        const predictions = await classifierModel.classify(imgElement);
        return predictions.some(p => {
            const terms = p.className.toLowerCase().split(','); 
            return terms.some(term => FASHION_KEYWORDS.some(k => term.trim().includes(k) || k.includes(term.trim())));
        });
    } catch (e) { return true; }
  }

  function previewUpload(input) { 
    if(input.files && input.files[0]) { 
        const loadingBox = document.getElementById('ai-loading');
        const previewImg = document.getElementById('upload-preview');
        const detailsSection = document.getElementById('upload-details-section');
        const errorMsg = document.getElementById('ai-error-msg');
        
        previewImg.classList.add('hidden'); 
        detailsSection.classList.add('hidden'); 
        errorMsg.classList.add('hidden'); 
        loadingBox.classList.remove('hidden');

        const r = new FileReader(); 
        r.onload = async (e) => { 
            previewImg.src = e.target.result; 
            previewImg.onload = async () => {
                try {
                    const isApproved = await checkImageContent(previewImg);
                    loadingBox.classList.add('hidden'); 
                    previewImg.classList.remove('hidden');
                    if (isApproved) {
                        detailsSection.classList.remove('hidden');
                    } else { 
                        errorMsg.classList.remove('hidden'); 
                        input.value = ""; 
                    }
                } catch (err) {
                    loadingBox.classList.add('hidden'); 
                    previewImg.classList.remove('hidden'); 
                    detailsSection.classList.remove('hidden');
                }
            };
        }; 
        r.readAsDataURL(input.files[0]); 
    } 
  }

  function addProdToUpload() {
    const n = document.getElementById('temp-prod-name');
    const l = document.getElementById('temp-prod-link');
    if(!n.value.trim() || !l.value.trim()) return alert("Inserisci nome e link.");
    
    uploadProductsList.push({ name: n.value.trim(), link: l.value.trim() });
    n.value = ''; 
    l.value = ''; 
    renderUploadProductsList();
  }

  function removeProdFromUpload(index) { 
      uploadProductsList.splice(index, 1); 
      renderUploadProductsList(); 
  }

  function renderUploadProductsList() {
    const c = document.getElementById('upload-products-list'); 
    c.innerHTML = '';
    uploadProductsList.forEach((p, i) => {
        c.insertAdjacentHTML('beforeend', `
            <div class="added-product-item">
                <div class="truncate mr-2">
                    <div class="text-black font-bold text-xs">${escapeHtml(p.name)}</div>
                    <div class="text-[10px] text-gray-500 truncate">${escapeHtml(p.link)}</div>
                </div>
                <i class="fa-solid fa-trash text-gray-400 hover:text-red-500 cursor-pointer text-xs" onclick="removeProdFromUpload(${i})"></i>
            </div>
        `);
    });
  }

  async function submitPost() { 
    const f = document.getElementById('post-file').files[0];
    const c = document.getElementById('post-caption').value; 
    
    const pn = document.getElementById('temp-prod-name').value.trim();
    const pl = document.getElementById('temp-prod-link').value.trim();
    if(pn && pl) uploadProductsList.push({ name: pn, link: pl });

    if(!uploadProductsList.length) return alert("Devi inserire almeno un prodotto (Nome e Link).");
    if(!f) return alert("Foto obbligatoria.");
    
    document.getElementById('btn-publish').innerText = "Pubblicazione...";
    try {
        const n = `${currentUser.id}/${Date.now()}`; 
        const { error: ue } = await sb.storage.from(BUCKET_POSTS).upload(n, f); 
        if(ue) throw ue;
        const { data: { publicUrl } } = sb.storage.from(BUCKET_POSTS).getPublicUrl(n);
        
        const { error: ie } = await sb.from('posts').insert([{ 
            user_id: currentUser.id, 
            image_url: publicUrl, 
            caption: c, 
            products: uploadProductsList 
        }]); 
        if(ie) throw ie;
        
        uploadProductsList = [];
        document.getElementById('upload-products-list').innerHTML = '';
        document.getElementById('post-caption').value = '';
        document.getElementById('post-file').value = '';
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-details-section').classList.add('hidden');

        closeModal('upload-modal'); 
        renderFeedView();
    } catch(err) { 
        alert("Errore: " + err.message); 
    }
    document.getElementById('btn-publish').innerText = "PUBBLICA";
  }

  function openShopWindow(postId, event) {
    if(event) event.stopPropagation();
    const post = allPostsCache[postId];
    if (!post) return;

    let p = [];
    if (post.products && Array.isArray(post.products) && post.products.length > 0) {
        p = post.products;
    } else if (post.product_link) {
        p.push({name: post.product_name || 'Prodotto', link: post.product_link});
    }

    const c = document.getElementById('shop-window-list'); 
    c.innerHTML = '';
    
    if(!p.length) return;
    
    p.forEach(x => {
        let lnk = x.link;
        if(!lnk.startsWith('http')) lnk = 'https://' + lnk;
        c.insertAdjacentHTML('beforeend', `
            <div class="bg-gray-50 p-3 rounded-lg border border-gray-100 flex items-center justify-between">
                <div class="text-left overflow-hidden mr-2">
                    <div class="font-bold text-black text-sm truncate">${escapeHtml(x.name)}</div>
                    <div class="text-[10px] text-gray-500">Shop now</div>
                </div>
                <a href="${lnk}" target="_blank" class="bg-black text-white px-3 py-1 rounded-full text-xs font-bold hover:opacity-80 transition flex-shrink-0 z-50 relative" style="pointer-events:auto">
                    VAI
                </a>
            </div>
        `);
    });
    
    document.getElementById('shop-modal').classList.remove('hidden');
  }

  function switchFeedMode(mode) { 
      if (currentFeedMode !== mode) { 
          currentFeedMode = mode; 
          renderFeedView(); 
      } 
  }

  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    if(document.getElementById('view-profile-active')) document.getElementById('view-profile-active').remove();
    
    main.innerHTML = `
        <div class="feed-tabs-container">
            <div class="feed-tab ${currentFeedMode === 'following' ? 'active' : ''}" onclick="switchFeedMode('following')">Seguiti</div>
            <div class="feed-tab ${currentFeedMode === 'viral' ? 'active' : ''}" onclick="switchFeedMode('viral')">Per Te</div>
        </div>
        <div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-gray-300"></i></div>
    `;

    let posts = [], error = null;
    
    if (currentFeedMode === 'following') {
        const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
        const ids = follows ? follows.map(f => f.followed_id) : [];
        if (ids.length) { 
            const res = await sb.from('posts').select(`*, profiles:user_id (username, avatar_url)`).in('user_id', ids).order('created_at', { ascending: false }); 
            posts = res.data; error = res.error; 
        }
    } else {
        const res = await sb.from('posts').select(`*, profiles:user_id (username, avatar_url)`).order('created_at', { ascending: false }).limit(50); 
        posts = res.data; error = res.error;
    }

    if (error) return main.innerHTML += `<p class="text-center text-red-500 mt-10">Errore feed.</p>`;
    if (!posts || !posts.length) return main.innerHTML += `<div class="empty-feed-box"><i class="fa-solid fa-user-plus text-4xl mb-4 text-gray-300"></i><h2 class="text-xl font-bold mb-2">Feed Vuoto</h2><p class="text-gray-400 mb-6">Segui qualcuno per iniziare.</p></div>`;

    const spinner = main.querySelector('.fa-spinner').parentNode;
    if(spinner) spinner.remove();

    posts.forEach(p => allPostsCache[p.id] = p);

    const fragment = document.createDocumentFragment();
    for (const post of posts) {
      const counts = await getPostCounts(post.id);
      const likedByMe = await isLikedByMe(post.id);
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = createPostHTML(post, counts, likedByMe);
      fragment.appendChild(tempDiv.firstElementChild);
    }
    main.appendChild(fragment);
    
    setTimeout(() => {
        document.querySelectorAll('.post-img').forEach(img => img.classList.add('loaded'));
    }, 100);
  }

  function createPostHTML(post, counts, liked) {
    const user = post.profiles || { username: 'Utente', avatar_url: null };
    const dateStr = post.created_at ? new Date(post.created_at).toLocaleDateString('it-IT') : '';
    
    let countProds = 0;
    if (post.products && Array.isArray(post.products)) countProds = post.products.length;
    else if (post.product_link) countProds = 1;
    
    const shopTag = countProds > 0 ? `<div class="shop-tag-overlay" onclick="openShopWindow('${post.id}', event)"><span>SHOP LOOK (${countProds})</span></div>` : '';
    const deleteIcon = (post.user_id === currentUser.id) ? `<i class="fa-solid fa-ellipsis text-gray-400 hover:text-black cursor-pointer ml-auto transition" onclick="deletePost('${post.id}')" title="Elimina"></i>` : '';

    return `
        <div class="post-card">
            <div class="post-header">
                <div class="user-badge" onclick="openUserProfile('${post.user_id}')">
                    <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" class="user-avatar" loading="lazy">
                    <div class="user-meta"><span class="username">${user.username}</span><span class="post-date">${dateStr}</span></div>
                </div>
                ${deleteIcon}
            </div>
            <div class="post-img-container">
                ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openPostDetail('${post.id}')" loading="lazy">` : ''}
                ${shopTag}
            </div>
            <div class="action-bar">
                <div class="icon-btn">
                    <i class="${liked ? 'fa-solid fa-heart text-red-500' : 'fa-regular fa-heart'}" onclick="toggleLike('${post.id}', this.parentNode)"></i>
                    <span class="likes-count-clickable ml-2" id="feed-likes-count-${post.id}" onclick="openLikesModal('${post.id}')">${counts.likes}</span>
                </div>
                <div class="icon-btn" onclick="openPostDetail('${post.id}')"><i class="fa-regular fa-comment"></i><span class="text-sm ml-2">${counts.comments}</span></div>
                <div class="icon-btn ml-auto" onclick="openShareModal('${post.id}')"><i class="fa-regular fa-paper-plane"></i></div>
            </div>
            <div class="caption-box">
                <span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>
                ${escapeHtml(post.caption)}
            </div>
        </div>`;
  }

  async function deletePost(postId) {
    if(!confirm("Vuoi davvero eliminare questo post?")) return;
    const { error } = await sb.from('posts').delete().eq('id', postId).eq('user_id', currentUser.id);
    if(error) alert("Errore: " + error.message);
    else { 
        closeModal('post-detail-modal'); 
        if(document.getElementById('view-profile-active')) openUserProfile(currentUser.id); 
        else renderFeedView(); 
    }
  }

  async function openLikesModal(postId) {
    document.getElementById('likes-list-modal').classList.remove('hidden');
    const c = document.getElementById('likes-list-content'); 
    c.innerHTML = '<div class="text-center mt-4 text-gray-300"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>';
    
    const { data: likes } = await sb.from('likes').select('user_id').eq('post_id', postId);
    if (!likes || !likes.length) return c.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun mi piace.</p>';
    
    const { data: profiles } = await sb.from('profiles').select('id, username, avatar_url').in('id', likes.map(l => l.user_id));
    c.innerHTML = '';
    profiles.forEach(u => {
        c.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer rounded" onclick="closeModal('likes-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                <div class="font-bold text-black">${escapeHtml(u.username)}</div>
            </div>
        `);
    });
  }

  async function toggleLike(postId, btn) {
    const icon = btn.querySelector('i');
    const span = document.getElementById(`feed-likes-count-${postId}`);
    let count = parseInt(span.innerText);
    
    if (icon.classList.contains('fa-solid')) {
      icon.className = 'fa-regular fa-heart'; 
      span.innerText = Math.max(0, count - 1);
      await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      icon.className = 'fa-solid fa-heart text-red-500'; 
      span.innerText = count + 1;
      await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
    }
  }

  async function getPostCounts(id) {
    const l = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', id);
    const c = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', id);
    return { likes: l.count || 0, comments: c.count || 0 };
  }
    
  async function isLikedByMe(id) { 
      const { data } = await sb.from('likes').select('id').eq('post_id', id).eq('user_id', currentUser.id); 
      return data && data.length > 0; 
  }
  
  async function openUserProfile(userId) {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div id="view-profile-active" class="hidden"></div><div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-gray-300"></i></div>`;
    
    const { data: p } = await sb.from('profiles').select('*').eq('id', userId).single();
    if (!p) return main.innerHTML = "<p class='text-center mt-10 text-black'>Utente non trovato.</p>";

    const pc = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const fc = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const fing = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
    
    let isFollowing = false;
    if (userId !== currentUser.id) {
      const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
      isFollowing = data && data.length > 0;
    }

    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    const isMe = userId === currentUser.id;
    
    const btn = isMe ? 
        `<button onclick="openEditProfile()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm text-black hover:bg-gray-50 transition">Modifica</button>` : 
        `<div class="flex gap-2"><button onclick="toggleFollow('${userId}')" id="follow-btn" class="px-6 py-2 rounded-lg text-sm font-bold transition ${isFollowing ? 'border border-gray-300 text-gray-500' : 'bg-black text-white shadow-lg hover:opacity-80'}">${isFollowing ? 'Seguito' : 'Segui'}</button><button onclick="openChat('${userId}', '${p.username}', '${p.avatar_url}')" class="px-4 py-2 border border-gray-300 text-black rounded-lg hover:bg-gray-50 transition"><i class="fa-regular fa-comment-dots"></i></button></div>`;

    if (posts) posts.forEach(p => allPostsCache[p.id] = p);

    const postsHtml = posts ? posts.map(po => {
        return `<div class="relative aspect-[4/5] group cursor-pointer overflow-hidden bg-gray-100" onclick="openPostDetail('${po.id}')">${po.image_url ? `<img src="${po.image_url}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center text-xs p-4 text-center text-gray-500 group-hover:bg-gray-200 transition">${escapeHtml(po.caption).substring(0,40)}...</div>`}<div class="absolute inset-0 bg-black/20 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-white font-bold z-20"><i class="fa-solid fa-heart"></i></div></div>`;
    }).join('') : '';

    main.innerHTML = `
        <div id="view-profile-active" class="hidden"></div>
        <div class="bg-white rounded-3xl p-6 mb-8 flex flex-col md:flex-row items-center gap-8 border border-gray-100">
            <img src="${p.avatar_url || 'https://via.placeholder.com/150'}" class="w-32 h-32 rounded-full object-cover border p-1">
            <div class="flex-1 text-center md:text-left">
                <div class="flex flex-col md:flex-row items-center gap-4 mb-4"><h2 class="text-3xl font-light text-black">${p.username}</h2>${btn}</div>
                <div class="flex justify-center md:justify-start gap-8 text-gray-500 mb-4">
                    <div class="text-center"><span class="block font-bold text-black text-lg">${pc.count||0}</span><span class="text-xs uppercase">Post</span></div>
                    <div class="text-center cursor-pointer hover:text-black" onclick="showUserList('followers','${userId}')"><span class="block font-bold text-black text-lg" id="p-followers">${fc.count||0}</span><span class="text-xs uppercase">Follower</span></div>
                    <div class="text-center cursor-pointer hover:text-black" onclick="showUserList('following','${userId}')"><span class="block font-bold text-black text-lg">${fing.count||0}</span><span class="text-xs uppercase">Seguiti</span></div>
                </div>
                <div class="text-gray-600 font-medium">${p.full_name || ''}</div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-1">${postsHtml}</div>
    `;
  }

  async function toggleFollow(targetId) {
    const btn = document.getElementById('follow-btn'); if (!btn) return;
    const isFollow = btn.innerText === 'Seguito'; 
    btn.innerText = "..."; 
    btn.disabled = true;
    
    const op = isFollow ? sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', targetId) : sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
    const { error } = await op;
    
    if (error) { 
        alert("Errore follow"); 
        btn.innerText = isFollow ? "Seguito" : "Segui"; 
        btn.disabled = false; 
    } else {
        openUserProfile(targetId);
    }
  }

  async function performSearch() {
      const q = document.getElementById('search-query').value.trim();
      const r = document.getElementById('search-results');
      if(q.length < 2) return r.innerHTML = '';
      const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
      r.innerHTML = '';
      data?.forEach(u => {
          r.insertAdjacentHTML('beforeend', `
            <div class="flex items-center justify-between p-3 hover:bg-gray-50 cursor-pointer rounded-lg" onclick="closeModal('search-modal'); openUserProfile('${u.id}')">
                <div class="flex items-center gap-3">
                    <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-gray-200">
                    <span class="text-black font-bold">${u.username}</span>
                </div>
            </div>
          `);
      });
  }

  async function showUserList(type, userId) {
      document.getElementById('user-list-modal').classList.remove('hidden');
      document.getElementById('ul-title').innerText = type === 'followers' ? 'Followers' : 'Seguiti';
      const c = document.getElementById('ul-content'); 
      c.innerHTML = '<div class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin text-gray-300"></i></div>';
      
      let res;
      if (type === 'followers') {
          res = await sb.from('follows').select(`profiles!follows_follower_id_fkey(*)`).eq('followed_id', userId);
      } else {
          res = await sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`).eq('follower_id', userId);
      }
      
      c.innerHTML = '';
      if(!res.data || !res.data.length) return c.innerHTML = '<p class="text-center text-gray-500 mt-4">Lista vuota.</p>';
      
      res.data.forEach(x => {
          const u = x.profiles;
          c.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer rounded-lg" onclick="closeModal('user-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-gray-200">
                <span class="text-black font-bold">${u.username}</span>
            </div>
          `);
      });
  }

  async function openPostDetail(postId) {
      currentPostId = postId;
      document.getElementById('post-detail-modal').classList.remove('hidden');
      document.getElementById('detail-img').src = ''; 
      
      const { data: post } = await sb.from('posts').select(`*, profiles:user_id(*)`).eq('id', postId).single();
      allPostsCache[post.id] = post; 

      const { data: comments } = await sb.from('comments').select(`*, profiles:user_id(*)`).eq('post_id', postId).order('created_at', { ascending: true });
      const likes = await getPostCounts(postId);
      const amILiking = await isLikedByMe(postId);

      const shopBtnContainer = document.getElementById('detail-shop-btn');
      const shopIcon = document.getElementById('detail-shop-icon');
      
      let countProds = 0;
      if (post.products && Array.isArray(post.products)) countProds = post.products.length;
      else if (post.product_link) countProds = 1;

      if (countProds > 0) {
        shopBtnContainer.innerHTML = `<div class="shop-tag-overlay" style="bottom: 20px; left: 20px;" onclick="openShopWindow('${post.id}', event)"><span>SHOP (${countProds})</span></div>`;
        shopIcon.classList.remove('hidden');
        shopIcon.onclick = (e) => openShopWindow(post.id, e);
      } else {
        shopBtnContainer.innerHTML = '';
        shopIcon.classList.add('hidden');
      }

      if(post.image_url) {
          document.getElementById('detail-img').src = post.image_url;
          document.getElementById('detail-img').classList.remove('hidden');
          document.getElementById('detail-noimg').classList.add('hidden');
      } else {
          document.getElementById('detail-img').classList.add('hidden');
          document.getElementById('detail-noimg').classList.remove('hidden');
      }

      document.getElementById('detail-avatar').src = post.profiles.avatar_url || 'https://via.placeholder.com/40';
      document.getElementById('detail-username').innerText = post.profiles.username;
      document.getElementById('detail-user-link').onclick = () => { closeModal('post-detail-modal'); openUserProfile(post.user_id); };
      
      document.getElementById('detail-delete-btn-container').innerHTML = (post.user_id === currentUser.id) ? `<i class="fa-solid fa-trash text-red-500 cursor-pointer text-xl" onclick="deletePost('${post.id}')"></i>` : '';

      const cBox = document.getElementById('detail-comments');
      cBox.innerHTML = `<div class="mb-4 text-sm text-gray-700"><span class="font-bold text-black mr-2">${post.profiles.username}</span>${escapeHtml(post.caption)}</div>`;
      
      comments?.forEach(c => {
          cBox.insertAdjacentHTML('beforeend', `
            <div class="mb-2 text-sm">
                <span class="font-bold text-black mr-2 cursor-pointer hover:underline" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')">${c.profiles.username}</span>
                <span class="text-gray-600">${escapeHtml(c.content)}</span>
            </div>
          `);
      });

      document.getElementById('detail-likes-count').innerText = likes.likes;
      const likeBtn = document.getElementById('detail-like-btn');
      likeBtn.className = amILiking ? 'fa-solid fa-heart text-red-500 cursor-pointer' : 'fa-regular fa-heart cursor-pointer text-black';
      likeBtn.onclick = () => toggleLikeDetail(postId);
  }

  async function toggleLikeDetail(postId) {
      const btn = document.getElementById('detail-like-btn');
      const isLiked = btn.classList.contains('fa-solid');
      if(isLiked) {
          await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
          btn.className = 'fa-regular fa-heart cursor-pointer text-black';
          document.getElementById('detail-likes-count').innerText = parseInt(document.getElementById('detail-likes-count').innerText) - 1;
      } else {
          await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
          btn.className = 'fa-solid fa-heart text-red-500 cursor-pointer';
          document.getElementById('detail-likes-count').innerText = parseInt(document.getElementById('detail-likes-count').innerText) + 1;
      }
      renderFeedView();
  }

  async function inviaCommento() {
      const input = document.getElementById('new-comment');
      const txt = input.value.trim();
      if(!txt || !currentPostId) return;
      
      const { error } = await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
      if(error) alert("Errore commento");
      else { 
          input.value = ''; 
          openPostDetail(currentPostId); 
      }
  }

  async function openInboxModal() {
    document.getElementById('inbox-modal').classList.remove('hidden'); 
    const container = document.getElementById('inbox-list'); 
    container.innerHTML = '<div class="text-center text-gray-400 mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
    
    const { data: msgs } = await sb.from('messages').select('*')
        .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
        .order('created_at', { ascending: false });
        
    if (!msgs || !msgs.length) return container.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun messaggio.</p>';
    
    const seen = new Set(); 
    container.innerHTML = '';
    
    for (const m of msgs) {
      const other = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
      if (!seen.has(other)) {
        seen.add(other);
        const { data: u } = await sb.from('profiles').select('*').eq('id', other).single();
        const dot = (m.receiver_id === currentUser.id && !m.is_read) ? `<div class="unread-indicator"></div>` : '';
        
        container.insertAdjacentHTML('beforeend', `
            <div class="inbox-item" onclick="closeModal('inbox-modal'); openChat('${u.id}', '${u.username}', '${u.avatar_url}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                <div class="flex-1 overflow-hidden">
                    <div class="font-bold text-black text-sm flex justify-between">
                        ${u.username}
                        <i class="fa-solid fa-trash text-gray-400 hover:text-red-500 transition text-xs p-1" onclick="deleteChat('${u.id}', event)"></i>
                    </div>
                    <div class="text-gray-500 text-xs truncate">${escapeHtml(m.content)}</div>
                </div>
                ${dot}
            </div>
        `);
      }
    }
  }

  async function deleteChat(targetId, event) {
      if(event) event.stopPropagation(); 
      if(!confirm("Eliminare conversazione?")) return;
      await sb.from('messages').delete().or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetId}),and(sender_id.eq.${targetId},receiver_id.eq.${currentUser.id})`);
      openInboxModal(); 
  }

  async function openChat(userId, username, avatar) {
    if (userId === currentUser.id) return;
    activeChatId = userId;
    
    document.getElementById('chat-modal').classList.remove('hidden'); 
    document.getElementById('chat-header-name').innerText = username; 
    document.getElementById('chat-header-avatar').src = avatar || 'https://via.placeholder.com/40';
    
    await loadMessages(); 
    await markAsRead(userId);
    
    if (chatSub) chatSub.unsubscribe();
    chatSub = sb.channel('chat-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => { 
        if ((p.new.sender_id === activeChatId && p.new.receiver_id === currentUser.id) || 
            (p.new.sender_id === currentUser.id && p.new.receiver_id === activeChatId)) { 
            loadMessages(); 
            if (p.new.receiver_id === currentUser.id) markAsRead(activeChatId); 
        } 
    }).subscribe();
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !activeChatId) return; 
    input.value = '';
    const { error } = await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: activeChatId, content: text }]);
    if (!error) loadMessages();
  }

  async function loadMessages() {
    const { data: msgs } = await sb.from('messages').select('*')
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatId}),and(sender_id.eq.${activeChatId},receiver_id.eq.${currentUser.id})`)
        .order('created_at', { ascending: true });
        
    const box = document.getElementById('chat-messages'); 
    box.innerHTML = '';
    
    msgs?.forEach(m => {
      let content = escapeHtml(m.content);
      if (m.content.startsWith('{') && m.content.includes('share_post')) {
          try { 
              const d = JSON.parse(m.content); 
              content = `
                <div class="shared-post-bubble" onclick="openPostDetail('${d.postId}')">
                    <img src="${d.img}" class="shared-post-img">
                    <div class="shared-post-info">
                        <b>Post Condiviso</b><br>${escapeHtml(d.caption)}
                    </div>
                </div>`; 
          } catch(e){}
      }
      box.insertAdjacentHTML('beforeend', `<div class="msg-bubble ${m.sender_id === currentUser.id ? 'msg-mine' : 'msg-theirs'}">${content}</div>`);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function markAsRead(senderId) { 
      await sb.from('messages').update({ is_read: true }).eq('sender_id', senderId).eq('receiver_id', currentUser.id); 
      checkNotifications(); 
  }
  
  function closeChat() { 
      document.getElementById('chat-modal').classList.add('hidden'); 
      activeChatId = null; 
      if (chatSub) chatSub.unsubscribe(); 
      checkNotifications(); 
  }

  function openShareModal(postId) {
      sharePostId = postId;
      document.getElementById('share-modal').classList.remove('hidden');
      const container = document.getElementById('share-list-content');
      container.innerHTML = '<div class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin text-gray-300"></i></div>';
      
      sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`)
        .eq('follower_id', currentUser.id)
        .then(({ data }) => {
            container.innerHTML = '';
            if(!data || data.length === 0) return container.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">Non segui nessuno a cui inviare.</p>';
            data.forEach(x => {
                const u = x.profiles;
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-lg cursor-pointer">
                        <div class="flex items-center gap-3">
                            <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-gray-200">
                            <span class="text-black font-bold">${u.username}</span>
                        </div>
                        <button onclick="sendPostToChat('${u.id}', this)" class="bg-black text-white px-4 py-1 rounded-full text-xs font-bold hover:opacity-80 transition">Invia</button>
                    </div>
                `);
            });
        });
  }

  async function sendPostToChat(receiverId, btn) {
      if(!sharePostId) return;
      btn.innerText = "Inviato"; btn.disabled = true; btn.classList.add('opacity-50');
      
      const { data: post } = await sb.from('posts').select('image_url, caption').eq('id', sharePostId).single();
      const messageContent = JSON.stringify({ 
          type: 'share_post', 
          postId: sharePostId, 
          img: post.image_url, 
          caption: post.caption ? post.caption.substring(0, 30) + '...' : 'Post condiviso' 
      });
      
      await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: receiverId, content: messageContent }]);
      setTimeout(() => closeModal('share-modal'), 500);
  }

  async function openNotificationsModal() {
    document.getElementById('notifications-modal').classList.remove('hidden'); 
    document.getElementById('notif-gold-dot').style.display = 'none';
    
    const c = document.getElementById('notifications-list'); 
    c.innerHTML = '<div class="text-center text-gray-400 mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
    
    const { data: rows } = await sb.from('notifications').select('id, created_at, type, actor_id, post_id, comment_id, is_read').eq('recipient_id', currentUser.id).order('created_at', { ascending: false }).limit(50);
    
    await sb.from('notifications').update({ is_read: true }).eq('recipient_id', currentUser.id).eq('is_read', false);
    
    c.innerHTML = '';
    if (!rows || !rows.length) return c.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessuna notifica.</p>';
    
    for (const n of rows) {
      const { data: actor } = await sb.from('profiles').select('username, avatar_url').eq('id', n.actor_id).single();
      let clickAction = n.type === 'follow' ? `closeModal('notifications-modal'); openUserProfile('${n.actor_id}')` : `closeModal('notifications-modal'); openPostDetail('${n.post_id}')`;
      let txt = n.type === 'follow' ? 'ti ha seguito' : (n.type === 'like' ? 'ha messo like' : 'ha commentato');
      
      c.insertAdjacentHTML('beforeend', `
        <div class="flex items-center gap-3 p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer transition" onclick="${clickAction}">
            <img src="${actor?.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-gray-200">
            <div class="flex-1">
                <div class="text-sm text-black">
                    <span class="font-bold">${actor?.username || 'User'}</span> 
                    <span class="text-xs text-gray-500">${txt}</span>
                </div>
            </div>
        </div>
      `);
    }
    checkAppNotifications();
  }

  async function checkNotifications() { 
      const { count } = await sb.from('messages').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUser.id).eq('is_read', false); 
      document.getElementById('global-gold-dot').style.display = (count > 0) ? 'block' : 'none'; 
  }
  
  async function checkAppNotifications() { 
      const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true }).eq('recipient_id', currentUser.id).eq('is_read', false); 
      document.getElementById('notif-gold-dot').style.display = (count > 0) ? 'block' : 'none'; 
  }
  
  function showToast(msg) { 
      const t = document.getElementById('toast-notif'); 
      document.getElementById('toast-msg').innerText = msg; 
      t.classList.add('toast-active'); 
      setTimeout(() => t.classList.remove('toast-active'), 4000); 
      document.getElementById('notif-gold-dot').style.display = 'block'; 
  }

  function openEditProfile() { 
      document.getElementById('edit-profile-modal').classList.remove('hidden'); 
      sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data})=>{ 
          document.getElementById('edit-username').value=data.username; 
          document.getElementById('edit-fullname').value=data.full_name; 
          document.getElementById('edit-avatar-preview').src=data.avatar_url||'https://via.placeholder.com/150'; 
      }); 
  }

  async function saveProfile() { 
      await sb.from('profiles').update({ 
          username:document.getElementById('edit-username').value, 
          full_name:document.getElementById('edit-fullname').value 
      }).eq('id', currentUser.id); 
      closeModal('edit-profile-modal'); 
      openUserProfile(currentUser.id); 
  }

  async function uploadAvatar(i) { 
      const f=i.files[0]; 
      if(!f)return; 
      const n=`${currentUser.id}/avatar_${Date.now()}`; 
      await sb.storage.from(BUCKET_AVATARS).upload(n, f); 
      const {data}=sb.storage.from(BUCKET_AVATARS).getPublicUrl(n); 
      document.getElementById('edit-avatar-preview').src=data.publicUrl; 
      await sb.from('profiles').update({ avatar_url:data.publicUrl }).eq('id',currentUser.id); 
  }

  function escapeHtml(t) { 
      return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; 
  }
</script>
</body>
</html>
