<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HAWENISHLAND — Official</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* CONFIGURAZIONE BASE */
        :root {
            --bg-body: #000000;
            --bg-card: #121212;
            --border: #262626;
            --text-main: #fff;
            --accent: #fff;
        }

        body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; padding: 0; height: 100vh; overflow: hidden; }
        .serif { font-family: 'Playfair Display', serif; }
        .hidden { display: none !important; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* LOGIN: SLIDESHOW SFONDO */
        #auth-container { position: fixed; inset: 0; z-index: 9999; background: #000; display: flex; justify-content: center; align-items: center; }
        .slideshow-bg { position: absolute; inset: 0; z-index: 1; overflow: hidden; }
        .slide-img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 1.5s ease; filter: brightness(0.6); }
        .slide-img.active { opacity: 1; }

        .auth-box { 
            position: relative; z-index: 10; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); 
            padding: 40px; width: 90%; max-width: 420px; border: 1px solid #333; text-align: center; border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
        }
        .input-field { width: 100%; background: #1a1a1a; border: 1px solid #333; padding: 14px; color: #fff; margin-bottom: 15px; outline: none; border-radius: 4px; }
        .btn-main { width: 100%; background: #fff; color: #000; padding: 14px; font-weight: 700; text-transform: uppercase; cursor: pointer; border-radius: 4px; border: none; }
        
        /* APP LAYOUT */
        #app-interface { display: none; width: 100%; height: 100%; }
        
        .top-bar { 
            position: fixed; top: 0; left: 0; width: 100%; height: 60px; 
            background: rgba(0,0,0,0.95); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; z-index: 50; 
        }

        .sidebar { 
            position: fixed; top: 0; left: 0; height: 100%; width: 260px; background: #000; 
            border-right: 1px solid var(--border); z-index: 100; transform: translateX(-100%); 
            transition: 0.3s; padding: 40px 20px; display: flex; flex-direction: column;
        }
        .sidebar.active { transform: translateX(0); }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 90; display: none; }
        .sidebar-overlay.active { display: block; }

        .nav-item { padding: 15px; cursor: pointer; color: #aaa; font-size: 1.1rem; display: flex; gap: 15px; align-items: center; }
        .nav-item:hover { color: #fff; }

        .main-area { padding-top: 60px; height: 100%; overflow-y: auto; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px 15px 100px; }

        /* POST CARD STILE INSTAGRAM */
        .post-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 30px; }
        
        .post-header { padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #1a1a1a; }
        .user-link { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .u-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
        .u-name { font-weight: 600; font-size: 14px; }

        .post-img { width: 100%; display: block; max-height: 750px; object-fit: cover; }
        
        .post-actions { padding: 12px 15px 5px; display: flex; gap: 20px; font-size: 24px; }
        .act-icon { cursor: pointer; transition: 0.2s; color: #fff; }
        .act-icon:hover { color: #ccc; }
        .act-icon.liked { color: #ef4444; }

        .post-data { padding: 0 15px 15px; font-size: 14px; }
        .likes-bold { font-weight: 700; display: block; margin-bottom: 5px; }
        .caption { line-height: 1.4; color: #eee; }
        .comm-link { color: #888; margin-top: 5px; cursor: pointer; display: block; font-size: 13px; }

        /* PROFILO */
        .profile-head { text-align: center; padding: 20px 0; }
        .prof-avatar { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333; margin: 0 auto 10px; object-fit: cover; cursor: pointer; }
        .stats { display: flex; justify-content: center; gap: 30px; margin: 20px 0; border-top: 1px solid #222; border-bottom: 1px solid #222; padding: 15px 0; }
        .stat-box { text-align: center; cursor: pointer; }
        .stat-num { font-weight: 700; font-size: 18px; display: block; }
        .stat-lbl { font-size: 11px; text-transform: uppercase; color: #888; }
        
        .action-btn { background: transparent; border: 1px solid #444; color: #fff; padding: 8px 25px; border-radius: 4px; font-weight: 600; cursor: pointer; }
        .action-btn.primary { background: #fff; color: #000; border-color: #fff; }

        /* MODALI */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-box { background: #111; border: 1px solid #333; width: 95%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; border-radius: 8px; }
        .modal-head { padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; font-weight: bold; }
        .modal-body { flex: 1; overflow-y: auto; padding: 15px; }

        .comment-row { display: flex; gap: 10px; margin-bottom: 15px; font-size: 13px; }
        .comm-input { padding: 15px; border-top: 1px solid #222; display: flex; gap: 10px; }
        
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="slideshow-bg" id="slideshow"></div>
        <div class="auth-box">
            <h1 class="serif italic text-5xl mb-2">Hawenish</h1>
            <p class="text-gray-500 text-xs tracking-widest uppercase mb-8">Official Fashion Society</p>
            <div id="auth-msg" class="mb-4 text-sm hidden"></div>

            <div id="login-form">
                <input type="email" id="l-email" class="input-field" placeholder="Email">
                <input type="password" id="l-pass" class="input-field" placeholder="Password">
                <button onclick="faiLogin()" class="btn-main">Accedi</button>
                <div class="mt-4 text-xs text-gray-400 flex justify-between">
                    <span class="cursor-pointer hover:text-white" onclick="toggleView('signup')">Registrati</span>
                    <span class="cursor-pointer hover:text-white" onclick="resetPass()">Password persa?</span>
                </div>
            </div>

            <div id="signup-form" class="hidden">
                <input type="text" id="r-user" class="input-field" placeholder="Username (es. @mario)">
                <input type="text" id="r-name" class="input-field" placeholder="Nome Completo">
                <input type="email" id="r-email" class="input-field" placeholder="Email">
                <input type="password" id="r-pass" class="input-field" placeholder="Password">
                <button onclick="faiSignup()" class="btn-main">Crea Account</button>
                <div class="mt-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="toggleView('login')">Torna al Login</div>
            </div>
        </div>
    </div>

    <div id="app-interface">
        <div class="top-bar">
            <i class="fa-solid fa-bars text-xl cursor-pointer" onclick="openSidebar()"></i>
            <span class="serif italic text-xl font-bold">Hawenishland</span>
            <i class="fa-regular fa-square-plus text-xl cursor-pointer" onclick="openModal('modal-create')"></i>
        </div>

        <div class="sidebar-overlay" id="overlay" onclick="closeSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <h2 class="serif italic text-2xl mb-8 pl-4">Menu</h2>
            <div class="nav-item" onclick="goTo('feed')"><i class="fa-solid fa-house"></i> Feed</div>
            <div class="nav-item" onclick="openModal('modal-search')"><i class="fa-solid fa-magnifying-glass"></i> Cerca</div>
            <div class="nav-item" onclick="goTo('profile')"><i class="fa-regular fa-user"></i> Profilo</div>
            <div class="nav-item text-red-500 mt-auto" onclick="doLogout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Esci</div>
        </div>

        <div class="main-area" id="scroll-area">
            
            <div id="view-feed" class="container">
                <div id="feed-target"></div>
            </div>

            <div id="view-profile" class="container hidden">
                <div class="profile-head">
                    <div id="back-btn" class="text-left text-gray-400 mb-4 cursor-pointer text-sm hidden" onclick="goTo('feed')"> <i class="fa-solid fa-arrow-left"></i> Torna indietro</div>
                    
                    <img id="p-img" src="" class="prof-avatar" onclick="clickAvatar()">
                    <input type="file" id="file-avatar" class="hidden" onchange="uploadAvatar()">
                    
                    <h1 id="p-user" class="text-2xl font-serif italic mb-1"></h1>
                    <p id="p-name" class="text-sm text-gray-500 font-bold"></p>

                    <div class="stats">
                        <div class="stat-box" onclick="showFollows('followers')"><span class="stat-num" id="s-foll">0</span><span class="stat-lbl">Follower</span></div>
                        <div class="stat-box" onclick="showFollows('following')"><span class="stat-num" id="s-fing">0</span><span class="stat-lbl">Seguiti</span></div>
                        <div class="stat-box"><span class="stat-num" id="s-post">0</span><span class="stat-lbl">Post</span></div>
                    </div>

                    <div id="p-actions"></div>
                </div>
                
                <div id="p-grid"></div>
            </div>

        </div>
    </div>

    <div id="modal-create" class="modal">
        <div class="modal-box">
            <div class="modal-head"><span>Nuovo Post</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-create')"></i></div>
            <div class="modal-body">
                <textarea id="post-cap" class="input-field" rows="3" placeholder="Scrivi..."></textarea>
                <input type="file" id="post-img" class="input-field">
                <button onclick="publishPost()" class="btn-main mt-2">Pubblica</button>
            </div>
        </div>
    </div>

    <div id="modal-list" class="modal">
        <div class="modal-box" style="height:60vh">
            <div class="modal-head"><span id="list-title">Cerca</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-list')"></i></div>
            <div class="p-2 border-b border-gray-800"><input id="search-in" class="w-full bg-transparent outline-none text-white p-2" placeholder="Cerca persone..." onkeyup="doSearch()"></div>
            <div id="list-res" class="modal-body"></div>
        </div>
    </div>
    <div id="modal-search" class="hidden"></div> 

    <div id="modal-detail" class="modal">
        <div class="modal-box" style="height:80vh">
            <div class="modal-head"><span>Commenti</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-detail')"></i></div>
            <div class="modal-body" id="comm-list"></div>
            <div class="comm-input">
                <input id="comm-txt" class="flex-1 bg-transparent outline-none text-white" placeholder="Commenta...">
                <button onclick="sendComm()" class="text-blue-500 font-bold">Invia</button>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURAZIONE
        const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
        const sb = window.supabase.createClient(SB_URL, SB_KEY);

        let me = null;
        let viewingId = null;
        let activePostId = null;

        const SLIDES = [
            'https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=1200',
            'https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=1200',
            'https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200',
            'https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1200'
        ];

        window.onload = async () => {
            startSlides();
            const {data} = await sb.auth.getSession();
            if(data.session) startApp(data.session.user);
        };

        function startSlides() {
            const c = document.getElementById('slideshow');
            SLIDES.forEach((u,i) => {
                const img = document.createElement('img'); img.src=u; img.className=`slide-img ${i==0?'active':''}`;
                c.appendChild(img);
            });
            let idx=0; const imgs=document.querySelectorAll('.slide-img');
            setInterval(()=>{ imgs[idx].classList.remove('active'); idx=(idx+1)%imgs.length; imgs[idx].classList.add('active'); }, 4000);
        }

        function toggleView(v) {
            document.getElementById('login-form').classList.toggle('hidden', v!=='login');
            document.getElementById('signup-form').classList.toggle('hidden', v!=='signup');
        }

        async function faiLogin() {
            const e=document.getElementById('l-email').value, p=document.getElementById('l-pass').value;
            const {data, error} = await sb.auth.signInWithPassword({email:e, password:p});
            if(error) alert(error.message); else startApp(data.user);
        }
        async function faiSignup() {
            const e=document.getElementById('r-email').value, p=document.getElementById('r-pass').value;
            const u=document.getElementById('r-user').value, n=document.getElementById('r-name').value;
            if(!u||!n) return alert("Compila tutto");
            const {data, error} = await sb.auth.signUp({email:e, password:p, options:{data:{first_name:n}}});
            if(error) return alert(error.message);
            if(data.user) await sb.from('profiles').upsert([{id:data.user.id, username:u, full_name:n}]);
            alert("Registrato! Accedi."); toggleView('login');
        }
        async function resetPass(){ const m=prompt("Email:"); if(m) sb.auth.resetPasswordForEmail(m); }
        function doLogout(){ sb.auth.signOut(); location.reload(); }

        function startApp(user) {
            me = user;
            document.getElementById('auth-container').style.display='none';
            document.getElementById('app-interface').style.display='block';
            goTo('feed');
        }

        // NAV
        function openSidebar(){ document.getElementById('sidebar').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
        function closeSidebar(){ document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        function openModal(id){ 
            if(id==='modal-search') { document.getElementById('modal-list').classList.add('active'); document.getElementById('list-title').innerText='Cerca'; document.getElementById('list-res').innerHTML=''; }
            else document.getElementById(id).classList.add('active'); 
        }
        function closeModal(id){ document.getElementById(id).classList.remove('active'); }

        function goTo(page) {
            closeSidebar();
            document.getElementById('view-feed').classList.add('hidden');
            document.getElementById('view-profile').classList.add('hidden');
            document.getElementById('scroll-area').scrollTop=0;
            if(page==='feed'){ document.getElementById('view-feed').classList.remove('hidden'); loadFeed(); }
            if(page==='profile'){ document.getElementById('view-profile').classList.remove('hidden'); loadProfile(me.id); }
            if(page==='search'){ openModal('modal-search'); }
        }

        // LOGICA CORE (Feed & Profile)
        async function loadFeed() {
            const c = document.getElementById('feed-target'); c.innerHTML='<div class="text-center p-10 text-gray-500">Caricamento...</div>';
            
            // 1. Prendo chi seguo
            const {data:foll} = await sb.from('follows').select('followed_id').eq('follower_id', me.id);
            let ids = [me.id];
            if(foll) ids = [...ids, ...foll.map(x=>x.followed_id)];

            // 2. QUERY CORRETTA CON JOIN ESPLICITO (!posts_user_id_fkey)
            let q = sb.from('posts').select(`*, profiles!posts_user_id_fkey(username, avatar_url), likes(count), comments(count)`).order('created_at', {ascending:false}).limit(50);
            
            // Se seguo qualcuno, filtro, altrimenti global
            if(ids.length > 1) q = q.in('user_id', ids);

            const {data:posts} = await q;

            // Se vuoto, fallback discovery
            if(!posts || posts.length===0) {
                const {data:glob} = await sb.from('posts').select(`*, profiles!posts_user_id_fkey(username, avatar_url), likes(count), comments(count)`).order('created_at', {ascending:false}).limit(20);
                renderPosts(glob, c, "Esplora (Segui qualcuno per vedere i loro post)");
            } else {
                renderPosts(posts, c);
            }
        }

        async function loadProfile(uid) {
            viewingId = uid;
            const isMe = (uid === me.id);
            document.getElementById('back-btn').classList.toggle('hidden', isMe);
            
            // Dati Utente
            const {data:p} = await sb.from('profiles').select('*').eq('id', uid).single();
            if(p) {
                document.getElementById('p-user').innerText = '@'+p.username;
                document.getElementById('p-name').innerText = p.full_name;
                document.getElementById('p-img').src = p.avatar_url || 'https://via.placeholder.com/150';
            }

            // Stats
            const {count:cFoll} = await sb.from('follows').select('*', {count:'exact', head:true}).eq('followed_id', uid);
            const {count:cFing} = await sb.from('follows').select('*', {count:'exact', head:true}).eq('follower_id', uid);
            const {count:cPost} = await sb.from('posts').select('*', {count:'exact', head:true}).eq('user_id', uid);
            
            document.getElementById('s-foll').innerText = cFoll||0;
            document.getElementById('s-fing').innerText = cFing||0;
            document.getElementById('s-post').innerText = cPost||0;

            // Bottoni
            const acts = document.getElementById('p-actions'); acts.innerHTML='';
            if(isMe) {
                acts.innerHTML = `<button class="action-btn" onclick="document.getElementById('file-avatar').click()">Cambia Foto</button>`;
            } else {
                const {data:rel} = await sb.from('follows').select('*').eq('follower_id', me.id).eq('followed_id', uid);
                const isF = rel&&rel.length>0;
                acts.innerHTML = `<button class="action-btn ${isF?'':'primary'}" onclick="toggleFollow('${uid}', ${isF})">${isF?'Segui già':'Segui'}</button>`;
            }

            // Post Profilo (CON LO STESSO RENDERER DEL FEED)
            const grid = document.getElementById('p-grid'); grid.innerHTML='Loading...';
            const {data:posts} = await sb.from('posts').select(`*, profiles!posts_user_id_fkey(username, avatar_url), likes(count), comments(count)`).eq('user_id', uid).order('created_at', {ascending:false});
            
            if(!posts || posts.length === 0) grid.innerHTML = '<div class="text-center py-10 text-gray-500">Nessun post pubblicato.</div>';
            else renderPosts(posts, grid);

            // Mostra Vista
            document.getElementById('view-feed').classList.add('hidden');
            document.getElementById('view-profile').classList.remove('hidden');
        }

        function renderPosts(list, container, msg) {
            container.innerHTML = msg ? `<div class="p-4 text-center text-gray-500 text-xs uppercase">${msg}</div>` : '';
            if(!list) return;

            list.forEach(p => {
                const u = p.profiles; 
                if(!u) return; // Skip broken records
                
                const lk = p.likes?.[0]?.count || 0;
                const cm = p.comments?.[0]?.count || 0;

                container.insertAdjacentHTML('beforeend', `
                    <div class="post-card">
                        <div class="post-header">
                            <div class="user-link" onclick="loadProfile('${p.user_id}')">
                                <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="u-avatar">
                                <span class="u-name">@${u.username}</span>
                            </div>
                            ${p.user_id===me.id ? `<i class="fa-solid fa-trash text-gray-500 cursor-pointer" onclick="delPost('${p.id}')"></i>` : ''}
                        </div>
                        ${p.image_url ? `<img src="${p.image_url}" class="post-img" ondblclick="toggleLike('${p.id}')">` : ''}
                        <div class="post-actions">
                            <i class="fa-regular fa-heart act-icon" id="btn-lk-${p.id}" onclick="toggleLike('${p.id}')"></i>
                            <i class="fa-regular fa-comment act-icon" onclick="openDetail('${p.id}')"></i>
                        </div>
                        <div class="post-data">
                            <span class="likes-bold"><span id="cnt-lk-${p.id}">${lk}</span> Mi piace</span>
                            <div class="caption">
                                <span class="font-bold mr-1 cursor-pointer" onclick="loadProfile('${p.user_id}')">@${u.username}</span>
                                ${p.caption || ''}
                            </div>
                            ${cm>0 ? `<span class="comm-link" onclick="openDetail('${p.id}')">Mostra tutti e ${cm} i commenti</span>` : ''}
                        </div>
                    </div>
                `);
                checkLike(p.id);
            });
        }

        // AZIONI
        async function toggleFollow(uid, isF){
            if(isF) await sb.from('follows').delete().eq('follower_id', me.id).eq('followed_id', uid);
            else await sb.from('follows').insert([{follower_id:me.id, followed_id:uid}]);
            loadProfile(uid);
        }

        async function checkLike(pid){
            const {data} = await sb.from('likes').select('*').eq('post_id', pid).eq('user_id', me.id);
            const btn = document.getElementById(`btn-lk-${pid}`);
            if(btn && data.length) { btn.classList.add('liked', 'fa-solid'); btn.classList.remove('fa-regular'); }
        }
        async function toggleLike(pid){
            const btn = document.getElementById(`btn-lk-${pid}`);
            const cnt = document.getElementById(`cnt-lk-${pid}`);
            const isL = btn.classList.contains('liked');
            let n = parseInt(cnt.innerText);

            if(isL) {
                btn.classList.remove('liked', 'fa-solid'); btn.classList.add('fa-regular');
                cnt.innerText = Math.max(0, n-1);
                await sb.from('likes').delete().eq('post_id', pid).eq('user_id', me.id);
            } else {
                btn.classList.add('liked', 'fa-solid'); btn.classList.remove('fa-regular');
                cnt.innerText = n+1;
                await sb.from('likes').insert([{post_id:pid, user_id:me.id}]);
            }
        }

        async function openDetail(pid){
            activePostId = pid;
            openModal('modal-detail');
            const box = document.getElementById('comm-list'); box.innerHTML='Loading...';
            const {data:comms} = await sb.from('comments').select(`*, profiles!comments_user_id_fkey(username, avatar_url)`).eq('post_id', pid).order('created_at', {ascending:true});
            
            box.innerHTML='';
            if(!comms || comms.length===0) box.innerHTML='<div class="text-gray-500 text-center mt-4">Nessun commento.</div>';
            else comms.forEach(c => {
                box.insertAdjacentHTML('beforeend', `
                    <div class="comment-row">
                        <img src="${c.profiles.avatar_url||'https://via.placeholder.com/30'}" class="u-avatar" onclick="closeModal('modal-detail'); loadProfile('${c.user_id}')">
                        <div>
                            <span class="font-bold mr-1 cursor-pointer" onclick="closeModal('modal-detail'); loadProfile('${c.user_id}')">@${c.profiles.username}</span>
                            <span class="text-gray-300">${c.content}</span>
                        </div>
                    </div>
                `);
            });
        }
        async function sendComm(){
            const t = document.getElementById('comm-txt').value; if(!t)return;
            await sb.from('comments').insert([{post_id:activePostId, user_id:me.id, content:t}]);
            document.getElementById('comm-txt').value='';
            openDetail(activePostId);
        }

        // UPLOAD & POST
        async function publishPost(){
            const c = document.getElementById('post-cap').value;
            const f = document.getElementById('post-img').files[0];
            if(!c && !f) return alert("Metti foto o testo");
            
            let url = null;
            if(f) {
                const path = `${me.id}/${Date.now()}`;
                await sb.storage.from('posts').upload(path, f);
                const {data} = sb.storage.from('posts').getPublicUrl(path);
                url = data.publicUrl;
            }
            await sb.from('posts').insert([{user_id:me.id, caption:c, image_url:url}]);
            closeModal('modal-create');
            document.getElementById('post-cap').value='';
            goTo('profile');
        }

        async function delPost(pid){ if(confirm("Eliminare?")) { await sb.from('posts').delete().eq('id', pid); goTo('profile'); } }

        function clickAvatar(){ if(viewingId===me.id) document.getElementById('file-avatar').click(); }
        async function uploadAvatar(){
            const f=document.getElementById('file-avatar').files[0]; if(!f) return;
            const path=`${me.id}/avatar_${Date.now()}`;
            await sb.storage.from('avatars').upload(path, f);
            const {data} = sb.storage.from('avatars').getPublicUrl(path);
            await sb.from('profiles').update({avatar_url:data.publicUrl}).eq('id', me.id);
            loadProfile(me.id);
        }

        // RICERCA
        async function doSearch(){
            const q = document.getElementById('search-in').value; if(q.length<2) return;
            const {data} = await sb.from('profiles').select('*').ilike('username', `%${q}%`);
            const box = document.getElementById('list-res'); box.innerHTML='';
            data.forEach(u => {
                box.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center gap-3 p-2 border-b border-gray-800 cursor-pointer" onclick="closeModal('modal-list'); loadProfile('${u.id}')">
                        <img src="${u.avatar_url||'https://via.placeholder.com/40'}" class="u-avatar">
                        <span class="font-bold">@${u.username}</span>
                    </div>
                `);
            });
        }
        async function showFollows(type){
            openModal('modal-search'); document.getElementById('list-title').innerText=type;
            const tCol=type==='followers'?'follower_id':'followed_id';
            const sCol=type==='followers'?'followed_id':'follower_id';
            const {data} = await sb.from('follows').select(tCol).eq(sCol, viewingId);
            const ids = data.map(x=>x[tCol]);
            const {data:users} = await sb.from('profiles').select('*').in('id', ids);
            const box = document.getElementById('list-res'); box.innerHTML='';
            users.forEach(u => {
                box.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center gap-3 p-2 border-b border-gray-800 cursor-pointer" onclick="closeModal('modal-list'); loadProfile('${u.id}')">
                        <img src="${u.avatar_url||'https://via.placeholder.com/40'}" class="u-avatar">
                        <span class="font-bold">@${u.username}</span>
                    </div>
                `);
            });
        }

    </script>
</body>
</html>
