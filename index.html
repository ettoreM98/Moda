<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Professional Social</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* BASE STYLES & RESET */
    body { background-color: #000; color: #e5e5e5; font-family: 'Inter', sans-serif; margin: 0; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }
    .hidden { display: none !important; }
    
    /* UTILITY */
    .btn-primary {
      background: #fff; color: #000; padding: 8px 16px; border-radius: 8px; 
      font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;
      text-align: center; border: 1px solid #fff;
    }
    .btn-primary:hover { background: #ccc; border-color: #ccc; }
    
    .btn-secondary {
      background: transparent; color: #fff; padding: 8px 16px; border-radius: 8px;
      font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s;
      border: 1px solid #333; text-align: center;
    }
    .btn-secondary:hover { background: #1a1a1a; border-color: #666; }

    .btn-danger { color: #ef4444; cursor: pointer; font-size: 12px; }
    .btn-danger:hover { text-decoration: underline; }

    /* LAYOUT */
    .app-wrapper { display: flex; min-height: 100vh; max-width: 1300px; margin: 0 auto; }
    
    /* SIDEBAR */
    .sidebar { 
      width: 245px; height: 100vh; position: sticky; top: 0; 
      border-right: 1px solid #262626; padding: 20px 12px;
      display: flex; flex-direction: column; background: #000; z-index: 50;
    }
    .nav-link {
      display: flex; align-items: center; gap: 16px; padding: 16px;
      border-radius: 8px; cursor: pointer; transition: 0.2s;
      font-size: 16px; color: #f5f5f5; margin-bottom: 4px;
    }
    .nav-link:hover { background-color: #121212; }
    .nav-link i { font-size: 20px; width: 24px; text-align: center; }
    .brand-logo { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 24px; margin-bottom: 30px; padding-left: 16px; letter-spacing: -1px; }

    /* FEED */
    .main-feed { flex: 1; max-width: 630px; margin: 0 auto; padding: 20px 0; width: 100%; }
    
    /* POST CARD */
    .post-card { border-bottom: 1px solid #262626; padding-bottom: 20px; margin-bottom: 20px; }
    .post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding: 0 4px; }
    .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .avatar-sm { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #222; border: 1px solid #333; }
    .username-bold { font-weight: 600; font-size: 14px; color: #fff; }
    .time-ago { color: #737373; font-size: 12px; }
    
    .post-image { 
      width: 100%; border-radius: 4px; border: 1px solid #262626; 
      object-fit: cover; cursor: pointer; aspect-ratio: 1/1; /* Square posts style */
      background: #050505;
    }
    .post-actions { display: flex; gap: 16px; margin-top: 12px; font-size: 22px; padding: 0 4px; }
    .action-btn { cursor: pointer; transition: 0.2s; color: #fff; }
    .action-btn:hover { color: #a8a8a8; }
    .like-active { color: #ff3040 !important; animation: pop 0.2s ease-in-out; }
    .post-stats { font-weight: 600; font-size: 14px; margin-top: 8px; padding: 0 4px; cursor: pointer; }
    .post-caption { margin-top: 6px; padding: 0 4px; font-size: 14px; }
    .caption-user { font-weight: 600; margin-right: 6px; cursor: pointer; }
    .view-comments { color: #737373; font-size: 14px; margin-top: 6px; padding: 0 4px; cursor: pointer; }

    /* PROFILE PAGE */
    .profile-header { padding: 30px 20px; border-bottom: 1px solid #262626; display: flex; gap: 30px; align-items: flex-start; }
    .profile-avatar-lg { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 1px solid #333; cursor: pointer; }
    .profile-info { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .profile-top { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .profile-username { font-size: 20px; font-weight: 400; }
    .profile-stats { display: flex; gap: 30px; font-size: 16px; }
    .stat-item { cursor: pointer; }
    .stat-value { font-weight: 700; color: #fff; }
    .profile-bio { font-size: 14px; }
    .profile-fullname { font-weight: 600; }
    
    .posts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 20px; }
    .grid-item { position: relative; aspect-ratio: 1/1; cursor: pointer; group: hover; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; }
    .grid-overlay { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; 
      opacity: 0; transition: 0.2s; gap: 15px; color: #fff; font-weight: bold;
    }
    .grid-item:hover .grid-overlay { opacity: 1; }

    /* MODALS */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.85); z-index: 100; 
      display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px);
    }
    .modal-content { background: #262626; border-radius: 12px; overflow: hidden; max-height: 85vh; display: flex; flex-direction: column; }
    
    /* Post Detail Modal Specifics */
    .post-modal-layout { display: flex; width: 90vw; max-width: 1000px; height: 85vh; background: #000; border: 1px solid #333; border-radius: 4px; }
    .pm-image-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; border-right: 1px solid #262626; }
    .pm-image-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .pm-info-side { flex: 1; display: flex; flex-direction: column; min-width: 300px; }
    .pm-header { padding: 14px; border-bottom: 1px solid #262626; display: flex; align-items: center; justify-content: space-between; }
    .pm-comments-list { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 12px; }
    .comment-row { display: flex; gap: 10px; font-size: 14px; }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; cursor: pointer; }
    .pm-footer { padding: 14px; border-top: 1px solid #262626; }

    /* AUTH SCREEN (Keep existing functionality, enhance look) */
    .auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; background: #000; display: flex; }
    .auth-visual { flex: 1; position: relative; display: none; }
    @media(min-width: 800px) { .auth-visual { display: block; } }
    .auth-visual img { width: 100%; height: 100%; object-fit: cover; }
    .auth-form-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; }
    .auth-box { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 15px; }
    .input-field { background: #121212; border: 1px solid #333; padding: 10px; border-radius: 4px; color: #fff; width: 100%; font-size: 14px; }
    .input-field:focus { border-color: #777; outline: none; }

    /* User List Modal (Followers/Search) */
    .user-list-modal { width: 400px; max-width: 90vw; background: #262626; border-radius: 12px; overflow: hidden; border: 1px solid #333; max-height: 400px; display: flex; flex-direction: column; }
    .ul-header { padding: 12px; text-align: center; border-bottom: 1px solid #363636; font-weight: 600; position: relative; }
    .ul-close { position: absolute; right: 12px; top: 12px; cursor: pointer; }
    .ul-body { overflow-y: auto; flex: 1; }
    .user-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 16px; hover: bg-white/5; }
    .user-row:hover { background: rgba(255,255,255,0.05); }

    @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
    @media (max-width: 768px) {
      .sidebar { width: 70px; padding: 10px; }
      .nav-link span, .brand-logo { display: none; }
      .nav-link i { font-size: 24px; margin: 0 auto; }
      .post-modal-layout { flex-direction: column; width: 100%; height: 100%; border: none; }
      .pm-image-side { flex: 1; background: #111; }
      .pm-info-side { flex: 1; }
      .app-wrapper { justify-content: center; }
    }
  </style>
</head>
<body>

<div id="auth-container" class="auth-container transition-transform duration-700">
  <div class="auth-visual">
    <img src="https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=1964&auto=format&fit=crop" alt="Cover">
  </div>
  <div class="auth-form-wrapper">
    <div class="auth-box">
      <h1 class="text-3xl font-bold mb-6 text-center italic">Hawenishland</h1>
      <div id="msg-box" class="hidden text-xs text-center p-2 mb-2 border rounded"></div>

      <div id="login-form">
        <input type="email" id="l-email" placeholder="Email" class="input-field mb-2">
        <input type="password" id="l-pass" placeholder="Password" class="input-field mb-4">
        <button onclick="faiLogin()" class="btn-primary w-full">Accedi</button>
        <div class="mt-6 text-center text-xs text-gray-500">
          <p class="cursor-pointer hover:text-white mb-2" onclick="recuperoPassword()">Password dimenticata?</p>
          <p class="cursor-pointer hover:text-white" onclick="vaiA('signup')">Non hai un account? <span class="font-bold text-blue-400">Iscriviti</span></p>
        </div>
      </div>

      <div id="signup-form" class="hidden">
        <input type="text" id="r-username" placeholder="Username" class="input-field mb-2">
        <div class="flex gap-2 mb-2">
          <input type="text" id="r-nome" placeholder="Nome" class="input-field">
          <input type="text" id="r-cognome" placeholder="Cognome" class="input-field">
        </div>
        <input type="date" id="r-nascita" class="input-field mb-2" style="color-scheme: dark;">
        <input type="email" id="r-email" placeholder="Email" class="input-field mb-2">
        <input type="password" id="r-pass" placeholder="Password" class="input-field mb-4">
        <button id="btn-reg" onclick="faiRegistrazione()" class="btn-primary w-full">Iscriviti</button>
        <p class="mt-4 text-center text-xs cursor-pointer hover:text-white" onclick="vaiA('login')">Hai già un account? <span class="font-bold text-blue-400">Accedi</span></p>
      </div>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-wrapper">
    
    <nav class="sidebar">
      <div class="brand-logo italic cursor-pointer" onclick="goHome()">Hawenishland</div>
      <div class="nav-link" onclick="goHome()">
        <i class="fa-solid fa-house"></i> <span>Home</span>
      </div>
      <div class="nav-link" onclick="openSearchModal()">
        <i class="fa-solid fa-magnifying-glass"></i> <span>Cerca</span>
      </div>
      <div class="nav-link" onclick="openUploadModal()">
        <i class="fa-regular fa-square-plus"></i> <span>Crea</span>
      </div>
      <div class="nav-link" onclick="goToMyProfile()">
        <i class="fa-regular fa-user"></i> <span>Profilo</span>
      </div>
      <div class="mt-auto nav-link text-red-500 hover:bg-red-900/20" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i> <span>Esci</span>
      </div>
    </nav>

    <main class="main-feed" id="main-content-area">
      </main>

  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="bg-[#262626] rounded-xl p-4 w-[400px] border border-[#333]">
    <div class="text-center font-bold border-b border-[#333] pb-3 mb-3 relative">
      Crea nuovo post
      <i class="fa-solid fa-xmark absolute right-0 top-0 cursor-pointer" onclick="closeModal('upload-modal')"></i>
    </div>
    <div class="flex flex-col gap-3">
      <label class="flex flex-col items-center justify-center h-48 border-2 border-dashed border-[#444] rounded-lg cursor-pointer hover:bg-[#333]">
        <i class="fa-solid fa-image text-2xl mb-2 text-gray-400"></i>
        <span class="text-sm text-gray-400">Trascina foto o clicca</span>
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
      </label>
      <img id="upload-preview" class="hidden w-full h-48 object-cover rounded-lg">
      <textarea id="post-caption" rows="2" placeholder="Scrivi una didascalia..." class="input-field resize-none"></textarea>
      <button onclick="submitPost()" class="btn-primary w-full">Condividi</button>
    </div>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="user-list-modal">
    <div class="ul-header">
      Cerca
      <i class="fa-solid fa-xmark ul-close" onclick="closeModal('search-modal')"></i>
    </div>
    <div class="p-3 border-b border-[#333]">
      <input type="text" id="search-query" class="input-field" placeholder="Cerca utenti..." onkeyup="performSearch()">
    </div>
    <div id="search-results" class="ul-body"></div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="user-list-modal">
    <div class="ul-header">
      <span id="ul-title">Lista</span>
      <i class="fa-solid fa-xmark ul-close" onclick="closeModal('user-list-modal')"></i>
    </div>
    <div id="ul-content" class="ul-body"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="post-modal-layout">
    <div class="pm-image-side">
      <img id="detail-img" src="">
      <div id="detail-noimg" class="hidden text-gray-500">Solo Testo</div>
    </div>
    <div class="pm-info-side bg-black relative">
      <div class="pm-header">
        <div class="flex items-center gap-3 cursor-pointer" id="detail-user-link">
          <img id="detail-avatar" src="" class="avatar-sm">
          <span id="detail-username" class="font-bold text-sm"></span>
        </div>
        <i class="fa-solid fa-xmark cursor-pointer text-lg" onclick="closeModal('post-detail-modal')"></i>
      </div>
      
      <div class="pm-comments-list" id="detail-comments">
        </div>

      <div class="pm-footer bg-black">
        <div class="flex gap-4 text-2xl mb-2">
          <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer hover:text-gray-400"></i>
          <i class="fa-regular fa-comment cursor-pointer"></i>
        </div>
        <div class="font-bold text-sm mb-2"><span id="detail-likes-count">0</span> Mi piace</div>
        <div class="flex gap-2">
          <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="bg-transparent text-sm w-full outline-none text-white">
          <button onclick="inviaCommento()" class="text-blue-500 font-semibold text-sm">Pubblica</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="bg-[#262626] rounded-xl p-6 w-[400px] border border-[#333]">
    <h2 class="text-xl font-bold mb-4">Modifica Profilo</h2>
    <div class="flex flex-col gap-4">
      <div class="text-center">
        <img id="edit-avatar-preview" src="" class="w-20 h-20 rounded-full mx-auto mb-2 object-cover border border-gray-600">
        <label class="text-blue-500 text-sm font-bold cursor-pointer hover:text-white">
          Cambia foto profilo
          <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar(this)">
        </label>
      </div>
      <div>
        <label class="text-xs text-gray-500 uppercase">Username</label>
        <input id="edit-username" type="text" class="input-field">
      </div>
      <div>
        <label class="text-xs text-gray-500 uppercase">Nome Completo</label>
        <input id="edit-fullname" type="text" class="input-field">
      </div>
      <div class="flex gap-2 mt-2">
        <button onclick="saveProfile()" class="btn-primary flex-1">Salva</button>
        <button onclick="closeModal('edit-profile-modal')" class="btn-secondary flex-1">Annulla</button>
      </div>
    </div>
  </div>
</div>

<script>
  // CONFIGURAZIONE SUPABASE
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';

  // STATO APPLICAZIONE
  let currentUser = null;
  let currentPostId = null;
  let viewingUserId = null; // Chi stiamo guardando nel profilo

  // INIT
  window.addEventListener('load', async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      enterApp(session.user);
    } else {
      document.getElementById('auth-container').style.display = 'flex';
    }
  });

  // --- LOGICA DI NAVIGAZIONE ---
  
  function goHome() {
    renderFeedView();
  }

  function goToMyProfile() {
    openUserProfile(currentUser.id);
  }

  function openSearchModal() {
    document.getElementById('search-modal').classList.remove('hidden');
    document.getElementById('search-query').focus();
  }

  function openUploadModal() {
    document.getElementById('upload-modal').classList.remove('hidden');
    document.getElementById('upload-preview').classList.add('hidden');
    document.getElementById('post-file').value = "";
  }

  function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
  }

  // --- LOGICA FEED ---

  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-gray-500"></i></div>`;
    
    // Ottieni chi seguo
    const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
    const followingIds = follows ? follows.map(f => f.followed_id) : [];
    followingIds.push(currentUser.id); // Includo me stesso

    // Fetch posts
    const { data: posts, error } = await sb.from('posts')
      .select(`*, profiles:user_id (username, avatar_url, full_name)`)
      .in('user_id', followingIds)
      .order('created_at', { ascending: false });

    if (error) return main.innerHTML = `<div class="text-center mt-10 text-red-500">Errore caricamento feed</div>`;
    if (!posts || posts.length === 0) {
      return main.innerHTML = `
        <div class="text-center mt-20 text-gray-500">
          <i class="fa-regular fa-compass text-4xl mb-4"></i>
          <p>Il feed è vuoto. Cerca utenti da seguire!</p>
          <button onclick="openSearchModal()" class="btn-primary mt-4">Cerca Persone</button>
        </div>`;
    }

    main.innerHTML = '';
    // Per ogni post, renderizzo
    for (const post of posts) {
      const counts = await getPostCounts(post.id); // Ottengo like e commenti
      const likedByMe = await isLikedByMe(post.id);
      main.insertAdjacentHTML('beforeend', createPostHTML(post, counts, likedByMe));
    }
  }

  function createPostHTML(post, counts, liked) {
    const user = post.profiles || { username: 'Unknown', avatar_url: null };
    const avatar = user.avatar_url || 'https://via.placeholder.com/150';
    const likeClass = liked ? 'fa-solid text-red-500' : 'fa-regular';
    const hasImg = post.image_url;
    
    return `
      <div class="post-card">
        <div class="post-header">
          <div class="user-info" onclick="openUserProfile('${post.user_id}')">
            <img src="${avatar}" class="avatar-sm">
            <span class="username-bold">${user.username}</span>
          </div>
          <i class="fa-solid fa-ellipsis text-gray-500 cursor-pointer"></i>
        </div>
        
        ${hasImg ? `<img src="${post.image_url}" class="post-image" onclick="openPostDetail('${post.id}')">` : ''}

        <div class="post-actions">
          <i class="${likeClass} fa-heart action-btn" id="feed-like-${post.id}" onclick="toggleLike('${post.id}', this)"></i>
          <i class="fa-regular fa-comment action-btn" onclick="openPostDetail('${post.id}')"></i>
          <i class="fa-regular fa-paper-plane action-btn"></i>
        </div>

        <div class="post-stats" onclick="openPostDetail('${post.id}')">
          <span id="feed-likes-count-${post.id}">${counts.likes}</span> Mi piace
        </div>

        <div class="post-caption">
          <span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>
          ${escapeHtml(post.caption)}
        </div>

        <div class="view-comments" onclick="openPostDetail('${post.id}')">
          Mostra tutti i ${counts.comments} commenti
        </div>
      </div>
    `;
  }

  // --- LOGICA PROFILO COMPLETO ---

  async function openUserProfile(userId) {
    viewingUserId = userId;
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>`;

    // Fetch Profile Data
    const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
    if (!profile) return main.innerHTML = "Utente non trovato";

    // Stats
    const { count: postsCount } = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const { count: followersCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const { count: followingCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);

    // Am I following?
    let isFollowing = false;
    if (userId !== currentUser.id) {
      const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
      isFollowing = data && data.length > 0;
    }

    // Grid Posts
    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });

    // Render Template
    const isMe = userId === currentUser.id;
    const actionBtn = isMe 
      ? `<button onclick="openEditProfile()" class="btn-secondary">Modifica profilo</button>` 
      : `<button onclick="toggleFollow('${userId}')" id="follow-btn" class="btn-primary ${isFollowing ? '!bg-transparent !text-white !border-gray-600' : ''}">${isFollowing ? 'Già segui' : 'Segui'}</button>`;

    main.innerHTML = `
      <div class="profile-header">
        <img src="${profile.avatar_url || 'https://via.placeholder.com/150'}" class="profile-avatar-lg" onclick="${isMe ? 'openEditProfile()' : ''}">
        <div class="profile-info">
          <div class="profile-top">
            <span class="profile-username">${profile.username}</span>
            ${actionBtn}
            ${isMe ? '<i class="fa-solid fa-gear text-xl cursor-pointer" onclick="logout()"></i>' : ''}
          </div>
          <div class="profile-stats">
            <div class="stat-item"><span class="stat-value">${postsCount || 0}</span> post</div>
            <div class="stat-item" onclick="showUserList('followers', '${userId}')"><span class="stat-value" id="p-followers">${followersCount || 0}</span> follower</div>
            <div class="stat-item" onclick="showUserList('following', '${userId}')"><span class="stat-value">${followingCount || 0}</span> seguiti</div>
          </div>
          <div class="profile-bio">
            <div class="profile-fullname">${profile.full_name || ''}</div>
          </div>
        </div>
      </div>
      <div class="posts-grid">
        ${posts.map(p => `
          <div class="grid-item" onclick="openPostDetail('${p.id}')">
            ${p.image_url 
              ? `<img src="${p.image_url}">` 
              : `<div class="w-full h-full bg-gray-900 flex items-center justify-center text-xs p-2 text-center text-gray-500">${escapeHtml(p.caption).substring(0,30)}...</div>`}
            <div class="grid-overlay">
              <span><i class="fa-solid fa-heart"></i> Info</span>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  // --- ACTIONS ---

  async function toggleFollow(targetId) {
    const btn = document.getElementById('follow-btn');
    const isFollowing = btn.innerText === 'Già segui';
    
    if (isFollowing) {
      // Unfollow
      await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', targetId);
      btn.innerText = 'Segui';
      btn.classList.remove('!bg-transparent', '!text-white', '!border-gray-600');
    } else {
      // Follow
      await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
      btn.innerText = 'Già segui';
      btn.classList.add('!bg-transparent', '!text-white', '!border-gray-600');
    }
    // Update count visual
    const countEl = document.getElementById('p-followers');
    if(countEl) {
      let val = parseInt(countEl.innerText);
      countEl.innerText = isFollowing ? val - 1 : val + 1;
    }
  }

  async function toggleLike(postId, btnElement) {
    const isLiked = btnElement.classList.contains('fa-solid');
    const countSpan = document.getElementById(`feed-likes-count-${postId}`);
    let currentCount = parseInt(countSpan.innerText);

    if (isLiked) {
      await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
      btnElement.classList.remove('fa-solid', 'text-red-500');
      btnElement.classList.add('fa-regular');
      countSpan.innerText = Math.max(0, currentCount - 1);
    } else {
      await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
      btnElement.classList.remove('fa-regular');
      btnElement.classList.add('fa-solid', 'text-red-500', 'like-active');
      countSpan.innerText = currentCount + 1;
      setTimeout(() => btnElement.classList.remove('like-active'), 200);
    }
  }

  // --- DETTAGLIO POST (Modale) ---

  async function openPostDetail(postId) {
    currentPostId = postId;
    const modal = document.getElementById('post-detail-modal');
    modal.classList.remove('hidden');
    
    // Reset view
    document.getElementById('detail-img').src = '';
    document.getElementById('detail-comments').innerHTML = '<div class="text-center text-gray-500 mt-5">Caricamento...</div>';

    // Fetch Post info
    const { data: post } = await sb.from('posts').select(`*, profiles:user_id(*)`).eq('id', postId).single();
    
    // Setup Image side
    if (post.image_url) {
      document.getElementById('detail-img').src = post.image_url;
      document.getElementById('detail-img').classList.remove('hidden');
      document.getElementById('detail-noimg').classList.add('hidden');
    } else {
      document.getElementById('detail-img').classList.add('hidden');
      document.getElementById('detail-noimg').classList.remove('hidden');
    }

    // Setup User Info
    const user = post.profiles;
    document.getElementById('detail-avatar').src = user.avatar_url || 'https://via.placeholder.com/32';
    document.getElementById('detail-username').innerText = user.username;
    document.getElementById('detail-user-link').onclick = () => { closeModal('post-detail-modal'); openUserProfile(post.user_id); };

    // Setup Likes Status
    const liked = await isLikedByMe(postId);
    const likeBtn = document.getElementById('detail-like-btn');
    likeBtn.className = liked ? "fa-solid fa-heart cursor-pointer text-red-500" : "fa-regular fa-heart cursor-pointer hover:text-gray-400";
    likeBtn.onclick = () => { toggleLike(postId, likeBtn); refreshDetailCounts(postId); };

    // Load Caption & Comments
    const commentList = document.getElementById('detail-comments');
    commentList.innerHTML = '';
    
    // Add Caption as first "comment"
    if (post.caption) {
      commentList.insertAdjacentHTML('beforeend', `
        <div class="comment-row mb-4">
          <img src="${user.avatar_url || 'https://via.placeholder.com/32'}" class="comment-avatar" onclick="closeModal('post-detail-modal'); openUserProfile('${post.user_id}')">
          <div>
            <span class="font-bold mr-2 text-sm cursor-pointer" onclick="closeModal('post-detail-modal'); openUserProfile('${post.user_id}')">${user.username}</span>
            <span class="text-sm">${escapeHtml(post.caption)}</span>
          </div>
        </div>
      `);
    }

    // Fetch Real Comments
    const { data: comments } = await sb.from('comments')
      .select(`*, profiles:user_id(username, avatar_url)`)
      .eq('post_id', postId)
      .order('created_at', { ascending: true });

    comments.forEach(c => {
      const u = c.profiles;
      commentList.insertAdjacentHTML('beforeend', `
        <div class="comment-row">
          <img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="comment-avatar" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')">
          <div>
            <span class="font-bold mr-2 cursor-pointer hover:text-gray-300" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')">${u.username}</span>
            <span>${escapeHtml(c.content)}</span>
          </div>
        </div>
      `);
    });

    refreshDetailCounts(postId);
  }

  async function refreshDetailCounts(postId) {
    const counts = await getPostCounts(postId);
    document.getElementById('detail-likes-count').innerText = counts.likes;
  }

  async function inviaCommento() {
    const txt = document.getElementById('new-comment').value.trim();
    if (!txt) return;
    await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
    document.getElementById('new-comment').value = '';
    openPostDetail(currentPostId); // Reload to show new comment
  }

  // --- LISTE UTENTI (Followers/Following/Search) ---

  async function showUserList(type, userId) {
    const modal = document.getElementById('user-list-modal');
    modal.classList.remove('hidden');
    document.getElementById('ul-title').innerText = type === 'followers' ? 'Follower' : 'Seguiti';
    const content = document.getElementById('ul-content');
    content.innerHTML = '<div class="p-4 text-center">Caricamento...</div>';

    let query;
    if (type === 'followers') {
      // Chi segue userId -> select follower_id
      query = sb.from('follows').select(`profiles!follows_follower_id_fkey(*)`).eq('followed_id', userId);
    } else {
      // Chi userId segue -> select followed_id
      query = sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`).eq('follower_id', userId);
    }

    const { data, error } = await query;
    if (error) return console.error(error); // Gestione errore semplificata
    
    content.innerHTML = '';
    const users = data.map(x => x.profiles);
    
    if(users.length === 0) content.innerHTML = '<div class="p-4 text-center text-gray-500">Nessun utente trovato.</div>';

    users.forEach(u => {
      content.insertAdjacentHTML('beforeend', `
        <div class="user-row cursor-pointer" onclick="closeModal('user-list-modal'); openUserProfile('${u.id}')">
          <div class="flex items-center gap-3">
            <img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="w-10 h-10 rounded-full bg-gray-800 object-cover">
            <div>
              <div class="font-bold text-sm">${u.username}</div>
              <div class="text-xs text-gray-400">${u.full_name || ''}</div>
            </div>
          </div>
        </div>
      `);
    });
  }

  async function performSearch() {
    const q = document.getElementById('search-query').value.trim();
    const resDiv = document.getElementById('search-results');
    if (q.length < 2) return resDiv.innerHTML = '';

    const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
    resDiv.innerHTML = '';
    data.forEach(u => {
      resDiv.insertAdjacentHTML('beforeend', `
        <div class="user-row cursor-pointer" onclick="closeModal('search-modal'); openUserProfile('${u.id}')">
          <div class="flex items-center gap-3">
            <img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="w-10 h-10 rounded-full bg-gray-800 object-cover">
            <div class="font-bold text-sm">${u.username}</div>
          </div>
        </div>
      `);
    });
  }

  // --- UTILS & HELPERS ---

  async function getPostCounts(postId) {
    // In un'app reale useremmo SQL Views o .select(count), qui facciamo fetch leggere
    const { count: l } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    const { count: c } = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    return { likes: l || 0, comments: c || 0 };
  }

  async function isLikedByMe(postId) {
    const { data } = await sb.from('likes').select('id').eq('post_id', postId).eq('user_id', currentUser.id);
    return data && data.length > 0;
  }

  // Preview immagine upload
  function previewUpload(input) {
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const img = document.getElementById('upload-preview');
        img.src = e.target.result;
        img.classList.remove('hidden');
      }
      reader.readAsDataURL(input.files[0]);
    }
  }

  // Submit Post
  async function submitPost() {
    const file = document.getElementById('post-file').files[0];
    const caption = document.getElementById('post-caption').value;
    if (!file && !caption) return alert("Aggiungi foto o testo");

    let publicUrl = null;
    if (file) {
      const fileName = `${currentUser.id}/${Date.now()}`;
      await sb.storage.from(BUCKET_POSTS).upload(fileName, file);
      const { data } = sb.storage.from(BUCKET_POSTS).getPublicUrl(fileName);
      publicUrl = data.publicUrl;
    }

    await sb.from('posts').insert([{ user_id: currentUser.id, image_url: publicUrl, caption: caption }]);
    closeModal('upload-modal');
    renderFeedView();
  }

  // Edit Profile Logic
  function openEditProfile() {
    document.getElementById('edit-profile-modal').classList.remove('hidden');
    // Pre-fill data
    sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data}) => {
      document.getElementById('edit-username').value = data.username;
      document.getElementById('edit-fullname').value = data.full_name;
      document.getElementById('edit-avatar-preview').src = data.avatar_url || 'https://via.placeholder.com/150';
    });
  }

  async function saveProfile() {
    const username = document.getElementById('edit-username').value;
    const fullName = document.getElementById('edit-fullname').value;
    
    await sb.from('profiles').update({ username, full_name: fullName }).eq('id', currentUser.id);
    closeModal('edit-profile-modal');
    openUserProfile(currentUser.id); // Refresh
  }

  async function uploadAvatar(input) {
    const file = input.files[0];
    if (!file) return;
    const fileName = `${currentUser.id}/avatar_${Date.now()}`;
    await sb.storage.from(BUCKET_AVATARS).upload(fileName, file);
    const { data } = sb.storage.from(BUCKET_AVATARS).getPublicUrl(fileName);
    
    // Aggiorna preview
    document.getElementById('edit-avatar-preview').src = data.publicUrl;
    // Aggiorna DB immediatamente
    await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
  }

  // AUTH HELPERS (Legacy)
  function mess(t,e){const b=document.getElementById('msg-box');b.innerText=t;b.classList.remove('hidden');b.style.borderColor=e?'red':'green';b.style.color=e?'red':'green';}
  function vaiA(m){
    document.getElementById('login-form').classList.toggle('hidden',m==='signup');
    document.getElementById('signup-form').classList.toggle('hidden',m==='login');
  }
  function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
  
  // Auth Functions (Preserved logic)
  async function faiLogin() {
    const { data, error } = await sb.auth.signInWithPassword({
      email: document.getElementById('l-email').value,
      password: document.getElementById('l-pass').value
    });
    if(error) mess(error.message, true);
    else enterApp(data.user);
  }
  async function faiRegistrazione() {
    const email = document.getElementById('r-email').value;
    const pass = document.getElementById('r-pass').value;
    const username = document.getElementById('r-username').value;
    // ... validation logic simplified for brevity but functionally standard
    const { data, error } = await sb.auth.signUp({email, password: pass});
    if(error) return mess(error.message, true);
    // Create Profile
    if(data.user) {
      await sb.from('profiles').insert([{ id: data.user.id, username: username }]);
    }
    mess("Registrazione ok, controlla email!");
  }
  async function logout() { await sb.auth.signOut(); location.reload(); }
  function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-container').classList.add('-translate-y-full');
    setTimeout(() => {
      document.getElementById('auth-container').classList.add('hidden');
      document.getElementById('app-interface').classList.remove('hidden');
      goHome();
    }, 500);
  }
</script>
</body>
</html>
