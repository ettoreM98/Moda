<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Social Network</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* ================= STILI GENERALI ================= */
    body { background:#0a0a0a; color:#fff; font-family:'Inter',sans-serif; margin:0; height:100vh; overflow-x: hidden; }
    .serif { font-family:'Playfair Display',serif }
    .hidden { display:none!important }
    
    /* ================= LOGIN ANIMATO ================= */
    .split-layout { display:flex; height:100vh; width: 100vw; position: fixed; top:0; left:0; z-index: 50; background:#0a0a0a; transition: transform 0.8s ease-in-out; }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }
    
    .visual-side img{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; filter:grayscale(100%); opacity:0; transition:opacity 1.5s ease, filter .8s ease; z-index:0 }
    .visual-side img.active{ opacity:1; z-index:1 }
    
    .form-side{ flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; background:#0a0a0a; max-width:600px; margin:auto }
    
    /* INPUT STYLE */
    .input-group{ margin-bottom:25px }
    .input-label{ display:block; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:#555; margin-bottom:8px }
    input{ background:transparent; border-bottom:1px solid #222; padding:10px 0; color:#fff; width:100%; outline:none; font-size:14px }
    input:focus{ border-bottom-color:#fff }
    
    /* BOTTONI */
    .btn-white{ background:#fff; color:#000; padding:18px; font-weight:500; text-transform:uppercase; width:100%; cursor:pointer; border:1px solid #fff; transition:.3s; margin-top:10px }
    .btn-white:hover{ background:#000; color:#fff }
    .link-small{ text-align:center; margin-top:20px; font-size:10px; color:#555; cursor:pointer; text-transform:uppercase; letter-spacing:1px }
    
    #msg-box{ display:none; padding:12px; border:1px solid #333; font-size:11px; text-transform:uppercase; margin-bottom:20px; text-align:center }

    /* ================= INTERFACCIA SOCIAL ================= */
    #app-interface { display: none; min-height: 100vh; background: #000; }
    .app-layout { display: flex; max-width: 1400px; margin: 0 auto; min-height: 100vh; }
    
    /* SIDEBAR SINISTRA */
    .sidebar { width: 250px; border-right: 1px solid #262626; height: 100vh; position: sticky; top: 0; padding: 20px; display: flex; flex-direction: column; }
    .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: #f5f5f5; margin-bottom: 5px; }
    .nav-item:hover { background: #1a1a1a; }
    .nav-item i { font-size: 20px; width: 25px; }

    /* CONTENUTO CENTRALE */
    .main-content { flex: 1; padding: 40px; overflow-y: auto; }
    
    /* FEED POST */
    .feed-container { max-width: 600px; margin: 0 auto; }
    .post-card { margin-bottom: 40px; border-bottom: 1px solid #262626; padding-bottom: 20px; }
    .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; background: #333; }
    .post-img { width: 100%; border-radius: 4px; border: 1px solid #262626; margin-top: 5px; }
    .post-actions { display: flex; gap: 20px; margin-top: 12px; font-size: 22px; }
    .action-btn { cursor: pointer; transition: 0.2s; }
    .action-btn:hover { color: #888; }
    
    /* DASHBOARD PERSONALE */
    .dashboard-header { display: flex; align-items: center; gap: 30px; margin-bottom: 40px; border-bottom: 1px solid #262626; padding-bottom: 40px; }
    .dashboard-avatar { width: 130px; height: 130px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 50px; }
    .grid-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; cursor: pointer; transition: 0.3s; background: #111; }
    .grid-img:hover { opacity: 0.7; }

    /* MODALI (POPUP) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .modal-box { background: #1a1a1a; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; border: 1px solid #333; position: relative; }
    .avatar-preview { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #333; margin: 0 auto 15px auto; display: block; }
  </style>
</head>

<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>
  
  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic">Hawenishland</h1>
    <div id="msg-box"></div>

    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>

    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username (Pubblico)</label><input type="text" id="r-username"></div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome"></div>
      </div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email"></div>
      <div class="grid grid-cols-2 gap-4">
        <div><label class="input-label">Password</label><input type="password" id="r-pass"></div>
        <div><label class="input-label">Conferma Psw</label><input type="password" id="r-pass-conf"></div>
      </div>
      <button onclick="faiRegistrazione()" class="btn-white">Crea Account</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface">
  <div class="app-layout">
    
    <div class="sidebar">
      <h1 class="serif italic text-2xl mb-8 pl-4 cursor-pointer hover:text-gray-300" onclick="switchView('feed')">Hawenishland</h1>
      
      <div class="nav-item" onclick="switchView('feed')">
        <i class="fa-solid fa-house"></i><span>Home Feed</span>
      </div>
      
      <div class="nav-item" onclick="openSearch()">
        <i class="fa-solid fa-magnifying-glass"></i><span>Cerca Utenti</span>
      </div>
      
      <div class="nav-item" onclick="openUploadModal()">
        <i class="fa-regular fa-square-plus"></i><span>Nuovo Post</span>
      </div>
      
      <div class="nav-item" onclick="switchView('dashboard')">
        <i class="fa-regular fa-user"></i><span>Il Mio Profilo</span>
      </div>
      
      <div class="nav-item" onclick="switchView('settings')">
        <i class="fa-solid fa-gear"></i><span>Impostazioni</span>
      </div>
      
      <div class="mt-auto nav-item text-red-500" onclick="logout()">
        <i class="fa-solid fa-arrow-right-from-bracket"></i><span>Esci</span>
      </div>
    </div>

    <div class="main-content">
      
      <div id="view-feed" class="view-section">
        <h2 class="serif text-2xl mb-6 italic">Ultime Novità</h2>
        <div class="feed-container" id="posts-feed">
          </div>
      </div>

      <div id="view-dashboard" class="view-section hidden">
        <div class="dashboard-header">
          <img id="dash-avatar" src="https://via.placeholder.com/150" class="dashboard-avatar">
          <div>
            <h2 id="dash-username" class="text-2xl font-light mb-1">...</h2>
            <p id="dash-fullname" class="font-bold text-gray-400 text-sm mb-4">...</p>
            
            <div class="flex gap-6 text-sm">
              <span id="stat-posts"><b>0</b> Post</span>
              <span><b>0</b> Follower</span>
              <button onclick="switchView('settings')" class="border border-white px-4 py-1 text-xs rounded hover:bg-white hover:text-black transition uppercase font-bold">Modifica</button>
            </div>
          </div>
        </div>
        
        <h3 class="text-xs uppercase tracking-widest text-gray-500 mb-6 text-center border-t border-gray-800 pt-4">La tua griglia</h3>
        <div id="dash-grid" class="dashboard-grid">
          </div>
      </div>

      <div id="view-settings" class="view-section hidden">
        <div class="max-w-md mx-auto bg-[#111] p-8 rounded-lg border border-[#333]">
          <h2 class="serif text-2xl mb-6 text-center italic">Modifica Profilo</h2>
          
          <div class="mb-8 text-center border-b border-gray-800 pb-6">
             <img id="set-avatar-preview" src="" class="avatar-preview">
             <label class="cursor-pointer text-blue-400 text-xs font-bold uppercase hover:text-white border border-blue-400 px-3 py-2 rounded">
               Carica Nuova Foto
               <input type="file" id="set-avatar-file" class="hidden" accept="image/*">
             </label>
          </div>

          <div class="input-group">
            <label class="input-label">Username (Pubblico)</label>
            <input type="text" id="set-username">
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div><label class="input-label">Nome</label><input type="text" id="set-nome"></div>
            <div><label class="input-label">Cognome</label><input type="text" id="set-cognome"></div>
          </div>
          <div class="input-group">
            <label class="input-label">Email Privata</label>
            <input type="email" id="set-email">
          </div>
          
          <button onclick="salvaImpostazioni()" class="btn-white">Salva Modifiche</button>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-xl hover:text-red-500" onclick="closeModal('upload-modal')"></i>
    <h2 class="serif text-xl mb-6 italic">Crea Nuovo Post</h2>
    
    <label class="block mb-4 cursor-pointer bg-[#222] p-4 rounded text-center hover:bg-[#333] transition">
      <i class="fa-solid fa-camera text-2xl mb-2 block"></i>
      <span class="text-xs uppercase text-gray-400">Clicca per selezionare foto</span>
      <input type="file" id="post-file" class="hidden" accept="image/*">
    </label>
    
    <input type="text" id="post-caption" placeholder="Scrivi una didascalia..." class="mb-4 w-full bg-[#111] p-3 rounded text-white border border-[#333] outline-none focus:border-white">
    
    <button onclick="submitPost()" class="btn-white">Pubblica Ora</button>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="modal-box">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer text-xl hover:text-red-500" onclick="closeModal('search-modal')"></i>
    <h2 class="serif text-xl mb-4 italic">Cerca Persone</h2>
    <input type="text" id="search-query" placeholder="Cerca Nome, Cognome o Username..." class="w-full bg-[#111] border border-[#333] p-3 rounded mb-4 text-white outline-none focus:border-white" onkeyup="performSearch()">
    
    <div id="search-results" class="max-h-60 overflow-y-auto space-y-2 pr-2">
      </div>
  </div>
</div>


<script>
  // CONFIGURAZIONE SUPABASE
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  let currentUser = null;

  /* --- AVVIO APP --- */
  window.addEventListener('load', async () => {
    // Controllo se utente è già loggato
    const { data: { session } } = await sb.auth.getSession();
    if (session) {
      enterApp(session.user);
    }
    
    // Attiva slider immagini login
    let idx = 0;
    const imgs = document.querySelectorAll('.visual-side img');
    if(imgs.length > 0) {
      setInterval(() => {
        imgs[idx].classList.remove('active');
        idx = (idx + 1) % imgs.length;
        imgs[idx].classList.add('active');
      }, 5000);
    }
  });

  // Funzione transizione da Login a App
  async function enterApp(user) {
    currentUser = user;
    // Animazione scorrimento verso l'alto
    document.getElementById('auth-container').style.transform = "translateY(-100vh)";
    setTimeout(() => {
      document.getElementById('auth-container').style.display = 'none';
      document.getElementById('app-interface').style.display = 'block';
      loadUserData(); // Carica dati base
      switchView('feed'); // Apre la home
    }, 600);
  }

  /* --- GESTIONE LOGIN / REGISTRAZIONE --- */
  function mess(t, err=false) {
    const b = document.getElementById('msg-box');
    b.innerText = t; b.style.display = 'block'; b.style.color = err ? '#ff4444' : '#44ff44';
  }

  function vaiA(m) {
    document.getElementById('login-form').classList.toggle('hidden', m === 'signup');
    document.getElementById('signup-form').classList.toggle('hidden', m === 'login');
    document.getElementById('msg-box').style.display = 'none';
  }

  async function faiRegistrazione() {
    const u = document.getElementById('r-username').value.trim();
    const e = document.getElementById('r-email').value.trim();
    const p = document.getElementById('r-pass').value;
    const pc = document.getElementById('r-pass-conf').value;
    const n = document.getElementById('r-nome').value.trim();
    const c = document.getElementById('r-cognome').value.trim();

    if(!u || !e || !p || !n) return mess("Tutti i campi sono obbligatori.", true);
    if(p !== pc) return mess("Le password non coincidono.", true);

    try {
      const { data, error } = await sb.auth.signUp({ email: e, password: p });
      if(error) throw error;
      
      // Creazione Profilo Pubblico
      if(data.user) {
        await sb.from('profiles').insert([{
          id: data.user.id,
          username: u.toLowerCase(),
          full_name: `${n} ${c}`,
          avatar_url: 'https://via.placeholder.com/150'
        }]);
      }
      mess("Registrazione OK! Controlla l'email.");
      setTimeout(() => vaiA('login'), 2000);
    } catch(err) { mess("Errore: " + err.message, true); }
  }

  async function faiLogin() {
    const e = document.getElementById('l-email').value.trim();
    const p = document.getElementById('l-pass').value;
    const { data, error } = await sb.auth.signInWithPassword({ email: e, password: p });
    if(error) mess("Credenziali errate.", true); 
    else enterApp(data.user);
  }

  async function logout() { await sb.auth.signOut(); location.reload(); }

  /* --- NAVIGAZIONE INTERNA --- */
  function switchView(name) {
    // Nasconde tutte le viste
    ['view-feed','view-dashboard','view-settings'].forEach(id => document.getElementById(id).classList.add('hidden'));
    // Mostra quella richiesta
    document.getElementById(`view-${name}`).classList.remove('hidden');
    
    // Carica i dati specifici per quella vista
    if(name === 'feed') loadFeed();
    if(name === 'dashboard') loadMyDashboard();
    if(name === 'settings') loadSettingsData();
  }

  /* --- FUNZIONI CORE SOCIAL --- */

  // 1. CARICAMENTO FEED
  async function loadFeed() {
    const c = document.getElementById('posts-feed');
    c.innerHTML = '<p class="text-center text-gray-500 mt-10">Aggiornamento feed...</p>';
    
    const { data } = await sb.from('posts')
      .select('*, profiles(username, avatar_url)')
      .order('created_at', {ascending:false});
      
    c.innerHTML = '';
    if(!data || !data.length) {
      c.innerHTML = '<p class="text-center text-gray-500">Nessun post. Sii il primo!</p>';
      return;
    }
    
    data.forEach(p => {
      c.innerHTML += `
        <div class="post-card">
          <div class="post-header">
            <img src="${p.profiles?.avatar_url || 'https://via.placeholder.com/30'}" class="user-avatar">
            <span class="font-bold text-sm">${p.profiles?.username || 'Utente'}</span>
          </div>
          <img src="${p.image_url}" class="post-img">
          <div class="post-actions">
            <i class="fa-regular fa-heart action-btn"></i>
            <i class="fa-regular fa-comment action-btn"></i>
          </div>
          <div class="mt-2 text-sm text-gray-300">
            <span class="font-bold text-white">${p.profiles?.username}</span> ${p.caption || ''}
          </div>
        </div>
      `;
    });
  }

  // 2. CARICAMENTO BACHECA UTENTE (Dashboard)
  async function loadMyDashboard() {
    // Info Utente
    const { data: prof } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(prof) {
      document.getElementById('dash-username').innerText = prof.username;
      document.getElementById('dash-fullname').innerText = prof.full_name;
      document.getElementById('dash-avatar').src = prof.avatar_url;
    }

    // Griglia Post
    const { data: posts } = await sb.from('posts')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', {ascending:false});
    
    document.getElementById('stat-posts').innerHTML = `<b>${posts?.length||0}</b> Post`;
    
    const grid = document.getElementById('dash-grid');
    grid.innerHTML = '';
    
    if(!posts || !posts.length) {
      grid.innerHTML = '<p class="col-span-3 text-center text-gray-500 text-xs py-10">Non hai ancora pubblicato nulla.</p>';
    } else {
      posts.forEach(p => {
        grid.innerHTML += `<img src="${p.image_url}" class="grid-img">`;
      });
    }
  }

  // 3. IMPOSTAZIONI (Gestione Foto Profilo & Dati)
  async function loadSettingsData() {
    const { data } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(data) {
      document.getElementById('set-username').value = data.username;
      document.getElementById('set-email').value = currentUser.email;
      document.getElementById('set-avatar-preview').src = data.avatar_url;
      
      const names = (data.full_name || '').split(' ');
      document.getElementById('set-nome').value = names[0] || '';
      document.getElementById('set-cognome').value = names.slice(1).join(' ') || '';
    }
  }

  async function salvaImpostazioni() {
    const u = document.getElementById('set-username').value.trim();
    const n = document.getElementById('set-nome').value.trim();
    const c = document.getElementById('set-cognome').value.trim();
    const file = document.getElementById('set-avatar-file').files[0];

    alert("Salvataggio in corso...");

    let updates = {
      username: u,
      full_name: `${n} ${c}`
    };

    // Upload Nuova Foto Profilo
    if(file) {
      const fileName = `avatar_${currentUser.id}_${Date.now()}`;
      // Usiamo il bucket 'posts' che è già configurato pubblico
      const { error: upErr } = await sb.storage.from('posts').upload(fileName, file);
      
      if(upErr) return alert("Errore upload foto: " + upErr.message);
      
      const { data: pubUrl } = sb.storage.from('posts').getPublicUrl(fileName);
      updates.avatar_url = pubUrl.publicUrl;
    }

    // Aggiorna Database
    const { error } = await sb.from('profiles').update(updates).eq('id', currentUser.id);
    
    if(error) alert("Errore salvataggio: " + error.message);
    else {
      alert("Profilo aggiornato con successo!");
      loadUserData(); // Aggiorna sidebar
      loadSettingsData(); // Aggiorna preview
    }
  }

  // 4. UPLOAD NUOVO POST
  function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  async function submitPost() {
    const file = document.getElementById('post-file').files[0];
    const caption = document.getElementById('post-caption').value;
    
    if(!file) return alert("Devi selezionare una foto!");

    const fileName = `post_${currentUser.id}_${Date.now()}`;
    
    // 1. Upload immagine
    const { error: upErr } = await sb.storage.from('posts').upload(fileName, file);
    if(upErr) return alert("Errore upload: " + upErr.message);

    // 2. Prendi Link
    const { data: urlData } = sb.storage.from('posts').getPublicUrl(fileName);

    // 3. Salva nel DB
    const { error: dbErr } = await sb.from('posts').insert([{
      user_id: currentUser.id,
      image_url: urlData.publicUrl,
      caption: caption
    }]);

    if(dbErr) alert("Errore DB: " + dbErr.message);
    else {
      closeModal('upload-modal');
      // Resetta form
      document.getElementById('post-file').value = '';
      document.getElementById('post-caption').value = '';
      // Porta l'utente al suo profilo per vedere il post
      switchView('dashboard');
    }
  }

  // 5. RICERCA UTENTI (NOME O USERNAME) & FOLLOW
  function openSearch() { document.getElementById('search-modal').classList.remove('hidden'); }
  
  async function performSearch() {
    const q = document.getElementById('search-query').value;
    if(q.length < 2) return;

    // Cerca su username OPPURE full_name
    const { data } = await sb.from('profiles')
      .select('*')
      .or(`username.ilike.%${q}%,full_name.ilike.%${q}%`)
      .limit(10);

    const res = document.getElementById('search-results');
    res.innerHTML = '';
    
    if(!data || data.length === 0) {
      res.innerHTML = '<p class="text-gray-500 text-xs text-center">Nessun utente trovato.</p>';
      return;
    }
    
    data.forEach(u => {
      if(u.id === currentUser.id) return; // Nascondi me stesso
      
      res.innerHTML += `
        <div class="flex items-center justify-between p-3 bg-[#1a1a1a] border border-[#333] rounded hover:border-gray-500 transition">
           <div class="flex items-center gap-3">
             <img src="${u.avatar_url}" class="w-10 h-10 rounded-full object-cover bg-gray-800">
             <div class="flex flex-col">
               <span class="font-bold text-sm text-white">${u.username}</span>
               <span class="text-xs text-gray-500">${u.full_name}</span>
             </div>
           </div>
           <button onclick="followUser('${u.id}')" class="bg-white text-black text-xs px-4 py-1 rounded font-bold hover:bg-gray-200 uppercase tracking-wider">Segui</button>
        </div>`;
    });
  }

  async function followUser(targetId) {
    const { error } = await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
    
    if(error) {
      if(error.code === '23505') alert("Segui già questo utente.");
      else alert("Errore follow.");
    } else {
      alert("Ora segui questo utente!");
    }
  }

  // Helper per dati utente
  async function loadUserData() {
    // Qui potremmo aggiornare dati globali
  }

</script>
</body>
</html>
