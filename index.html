<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAWENISHLAND — Enterprise Architecture</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --gold: #d4af37; --text: #f8fafc; }
        body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; overflow-x: hidden; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Toast Notification System */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { background: rgba(30, 41, 59, 0.95); border-left: 4px solid var(--gold); padding: 15px 25px; border-radius: 4px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); color: white; min-width: 300px; transform: translateX(100%); transition: transform 0.3s ease; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-left-color: #ef4444; }
        .toast.success { border-left-color: #22c55e; }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="toast-container"></div>

<script>
/**
 * ==================================================================================
 * CORE FRAMEWORK LAYER (Simulazione di React/Vue + Redux in Vanilla JS)
 * Questo livello gestisce il rendering, lo stato globale e il routing.
 * ==================================================================================
 */

// 1. STATE MANAGEMENT (Store Pattern - Singleton)
class Store {
    constructor() {
        if (Store.instance) return Store.instance;
        this.state = {
            user: null,
            feed: [],
            notifications: [],
            loading: false,
            error: null,
            route: 'auth' // auth, feed, profile, post_detail
        };
        this.subscribers = [];
        Store.instance = this;
    }

    getState() { return this.state; }

    dispatch(action, payload) {
        console.log(`[DISPATCH] ${action}`, payload);
        const prevState = { ...this.state };
        
        // Reducer Logic
        switch(action) {
            case 'SET_USER': this.state.user = payload; break;
            case 'SET_LOADING': this.state.loading = payload; break;
            case 'SET_FEED': this.state.feed = payload; break;
            case 'ADD_POST': this.state.feed = [payload, ...this.state.feed]; break;
            case 'UPDATE_POST_LIKE': 
                this.state.feed = this.state.feed.map(p => p.id === payload.id ? {...p, ...payload.changes} : p);
                break;
            case 'SET_ROUTE': this.state.route = payload; break;
            case 'SET_ERROR': this.state.error = payload; break;
        }

        this.notify(prevState);
    }

    subscribe(callback) {
        this.subscribers.push(callback);
        return () => { this.subscribers = this.subscribers.filter(cb => cb !== callback); };
    }

    notify(prevState) {
        this.subscribers.forEach(cb => cb(this.state, prevState));
    }
}

// 2. COMPONENT SYSTEM (Base Class)
class Component {
    constructor(props = {}) {
        this.props = props;
        this.state = {};
        this.element = null;
    }

    setState(newState) {
        this.state = { ...this.state, ...newState };
        this.update();
    }

    render() { throw new Error("Component must implement render method"); }

    mount(container) {
        this.element = this.render();
        if (container) container.appendChild(this.element);
        this.componentDidMount();
        return this.element;
    }

    update() {
        const newElement = this.render();
        if (this.element && this.element.parentNode) {
            this.element.parentNode.replaceChild(newElement, this.element);
        }
        this.element = newElement;
    }

    componentDidMount() {}
}

// 3. SERVICE LAYER (API Calls Abstracted)
const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
const supabase = window.supabase.createClient(SB_URL, SB_KEY);

class AuthService {
    static async login(email, password) {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        return data.user;
    }
    static async signup(email, password, username) {
        const { data, error } = await supabase.auth.signUp({ email, password });
        if (error) throw error;
        if (data.user) {
            await supabase.from('profiles').insert([{ id: data.user.id, username }]);
        }
        return data.user;
    }
    static async logout() { await supabase.auth.signOut(); }
    static async getSession() { const { data } = await supabase.auth.getSession(); return data.session?.user; }
}

class PostService {
    static async getFeed() {
        const { data, error } = await supabase.from('posts')
            .select('*, profiles:user_id(*), likes(user_id), comments(count)')
            .order('created_at', { ascending: false });
        if (error) throw error;
        return data.map(post => ({
            ...post,
            likeCount: post.likes.length,
            isLiked: post.likes.some(l => l.user_id === store.getState().user?.id),
            commentCount: post.comments[0]?.count || 0
        }));
    }

    static async toggleLike(postId, userId) {
        // Optimistic Update logic handled in Controller
        const { data } = await supabase.from('likes').select('*').eq('post_id', postId).eq('user_id', userId).maybeSingle();
        if (data) {
            await supabase.from('likes').delete().eq('id', data.id);
            return false;
        } else {
            await supabase.from('likes').insert([{ post_id: postId, user_id: userId }]);
            return true;
        }
    }
}

// 4. UTILS (Toast System)
class Toaster {
    static show(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');
        el.className = `toast ${type}`;
        el.innerText = message;
        container.appendChild(el);
        setTimeout(() => el.classList.add('show'), 10);
        setTimeout(() => {
            el.classList.remove('show');
            setTimeout(() => el.remove(), 300);
        }, 3000);
    }
}

/**
 * ==================================================================================
 * APPLICATION LAYER (Components)
 * Qui costruiamo la UI usando le classi del Core Framework.
 * ==================================================================================
 */

const store = new Store();

// --- ATOMIC COMPONENTS ---

class Button extends Component {
    constructor(props) { super(props); }
    render() {
        const btn = document.createElement('button');
        btn.className = `w-full py-3 rounded font-bold uppercase tracking-wider transition transform active:scale-95 ${this.props.variant === 'outline' ? 'border border-white text-white hover:bg-white hover:text-black' : 'bg-[#d4af37] text-black hover:bg-[#b8952b]'}`;
        btn.innerText = this.props.text;
        if(this.props.onClick) btn.onclick = this.props.onClick;
        if(this.props.disabled) { btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); }
        return btn;
    }
}

class Input extends Component {
    constructor(props) { super(props); }
    render() {
        const div = document.createElement('div');
        div.className = "mb-4";
        if(this.props.label) {
            const label = document.createElement('label');
            label.className = "block text-xs uppercase text-gray-500 mb-1 tracking-widest";
            label.innerText = this.props.label;
            div.appendChild(label);
        }
        const inp = document.createElement('input');
        inp.type = this.props.type || 'text';
        inp.className = "w-full bg-transparent border-b border-gray-700 p-2 text-white outline-none focus:border-[#d4af37] transition";
        inp.placeholder = this.props.placeholder || '';
        if(this.props.onInput) inp.oninput = (e) => this.props.onInput(e.target.value);
        div.appendChild(inp);
        return div;
    }
}

// --- COMPLEX COMPONENTS ---

class PostCard extends Component {
    constructor(props) { super(props); }

    async handleLike() {
        const { id, isLiked, likeCount } = this.props.post;
        // Optimistic UI Update (Aggiorna subito l'interfaccia prima del server)
        store.dispatch('UPDATE_POST_LIKE', { 
            id, 
            changes: { isLiked: !isLiked, likeCount: isLiked ? likeCount - 1 : likeCount + 1 } 
        });

        try {
            await PostService.toggleLike(id, store.getState().user.id);
        } catch (e) {
            // Revert on error
            store.dispatch('UPDATE_POST_LIKE', { 
                id, 
                changes: { isLiked: isLiked, likeCount: likeCount } 
            });
            Toaster.show("Errore like", "error");
        }
    }

    render() {
        const p = this.props.post;
        const card = document.createElement('div');
        card.className = "bg-slate-800/50 border border-gray-700 rounded-xl p-4 mb-6 fade-in";
        
        const header = `
            <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-full bg-gray-700 overflow-hidden border border-[#d4af37]">
                    <img src="${p.profiles?.avatar_url || 'https://via.placeholder.com/40'}" class="w-full h-full object-cover">
                </div>
                <div>
                    <div class="font-bold text-white">${p.profiles?.username || 'Unknown'}</div>
                    <div class="text-xs text-gray-500">${new Date(p.created_at).toLocaleDateString()}</div>
                </div>
            </div>
        `;

        const image = p.image_url ? `<div class="rounded-lg overflow-hidden mb-3 border border-gray-700"><img src="${p.image_url}" class="w-full object-cover"></div>` : '';
        
        const actions = document.createElement('div');
        actions.className = "flex items-center gap-6 text-xl text-gray-300";
        
        // Like Button Logic
        const likeBtn = document.createElement('button');
        likeBtn.className = `flex items-center gap-2 transition ${p.isLiked ? 'text-[#ef4444]' : 'hover:text-[#d4af37]'}`;
        likeBtn.innerHTML = `<i class="${p.isLiked ? 'fa-solid' : 'fa-regular'} fa-heart"></i> <span class="text-sm font-bold">${p.likeCount}</span>`;
        likeBtn.onclick = () => this.handleLike();

        actions.appendChild(likeBtn);
        actions.innerHTML += `<button class="flex items-center gap-2 hover:text-[#d4af37]"><i class="fa-regular fa-comment"></i> <span class="text-sm font-bold">${p.commentCount}</span></button>`;

        card.innerHTML = header + image;
        
        const caption = document.createElement('div');
        caption.className = "mt-3 text-sm leading-relaxed";
        caption.innerHTML = `<span class="font-bold text-[#d4af37] mr-2">${p.profiles?.username}</span>${p.caption}`;
        
        card.appendChild(actions);
        card.appendChild(caption);

        return card;
    }
}

class FeedView extends Component {
    constructor(props) { 
        super(props);
        // Subscribe to store updates to re-render when feed changes
        this.unsubscribe = store.subscribe((state, prevState) => {
            if (state.feed !== prevState.feed) this.update();
        });
    }

    componentDidMount() {
        this.loadData();
    }

    async loadData() {
        if(store.getState().feed.length > 0) return; // Cache check
        store.dispatch('SET_LOADING', true);
        try {
            const posts = await PostService.getFeed();
            store.dispatch('SET_FEED', posts);
        } catch(e) {
            Toaster.show("Impossibile caricare il feed", "error");
        } finally {
            store.dispatch('SET_LOADING', false);
        }
    }

    render() {
        const container = document.createElement('div');
        container.className = "max-w-2xl mx-auto pb-20 pt-6 px-4";
        
        const state = store.getState();

        if (state.loading && state.feed.length === 0) {
            container.innerHTML = `<div class="flex justify-center mt-20"><div class="w-10 h-10 border-4 border-[#d4af37] border-t-transparent rounded-full spin"></div></div>`;
            return container;
        }

        if (state.feed.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-500 mt-20">Nessun post trovato.</div>`;
            return container;
        }

        state.feed.forEach(post => {
            const card = new PostCard({ post });
            card.mount(container);
        });

        return container;
    }
}

class Sidebar extends Component {
    render() {
        const nav = document.createElement('nav');
        nav.className = "fixed bottom-0 left-0 w-full md:w-20 md:h-screen bg-[#0f172a]/95 backdrop-blur border-t md:border-t-0 md:border-r border-gray-800 flex md:flex-col justify-around md:justify-center items-center py-3 md:py-0 z-50";
        
        const items = [
            { icon: 'fa-house', action: () => store.dispatch('SET_ROUTE', 'feed') },
            { icon: 'fa-magnifying-glass', action: () => Toaster.show("Funzione Cerca: Coming Soon") },
            { icon: 'fa-plus', action: () => Toaster.show("Upload: Coming Soon") },
            { icon: 'fa-user', action: () => Toaster.show("Profilo: Coming Soon") },
            { icon: 'fa-power-off', color: 'text-red-500', action: () => AuthController.logout() }
        ];

        items.forEach(item => {
            const btn = document.createElement('div');
            btn.className = `p-3 text-xl cursor-pointer hover:bg-white/5 rounded-full transition ${item.color || 'text-gray-400 hover:text-[#d4af37]'}`;
            btn.innerHTML = `<i class="fa-solid ${item.icon}"></i>`;
            btn.onclick = item.action;
            nav.appendChild(btn);
        });

        return nav;
    }
}

class AuthView extends Component {
    constructor() {
        super();
        this.state = { mode: 'login', email: '', password: '', username: '' };
    }

    toggleMode() {
        this.setState({ mode: this.state.mode === 'login' ? 'signup' : 'login' });
    }

    async handleSubmit() {
        try {
            if (this.state.mode === 'login') {
                const user = await AuthService.login(this.state.email, this.state.password);
                store.dispatch('SET_USER', user);
                Toaster.show("Benvenuto!", "success");
            } else {
                await AuthService.signup(this.state.email, this.state.password, this.state.username);
                Toaster.show("Registrato! Controlla la mail.", "success");
            }
        } catch (e) {
            Toaster.show(e.message, "error");
        }
    }

    render() {
        const container = document.createElement('div');
        container.className = "min-h-screen flex items-center justify-center p-6 relative overflow-hidden";
        
        // Background Effect
        const bg = document.createElement('div');
        bg.className = "absolute inset-0 z-0 opacity-20";
        bg.style.background = "radial-gradient(circle at center, #1e293b 0%, #000 100%)";
        container.appendChild(bg);

        const formBox = document.createElement('div');
        formBox.className = "w-full max-w-md bg-black/50 backdrop-blur-md p-8 rounded-2xl border border-gray-800 shadow-2xl z-10 fade-in";
        
        const title = document.createElement('h1');
        title.className = "text-4xl font-light text-center mb-8 text-white";
        title.innerHTML = "Hawenish<span class='text-[#d4af37] font-bold'>Land</span>";
        formBox.appendChild(title);

        if (this.state.mode === 'signup') {
            const userInp = new Input({ 
                placeholder: 'Username', 
                label: 'Nome Utente',
                onInput: (v) => this.state.username = v 
            });
            userInp.mount(formBox);
        }

        const emailInp = new Input({ 
            type: 'email', placeholder: 'nome@esempio.com', label: 'Email',
            onInput: (v) => this.state.email = v
        });
        const passInp = new Input({ 
            type: 'password', placeholder: '••••••••', label: 'Password',
            onInput: (v) => this.state.password = v
        });

        emailInp.mount(formBox);
        passInp.mount(formBox);

        const btn = new Button({
            text: this.state.mode === 'login' ? 'Accedi' : 'Registrati',
            onClick: () => this.handleSubmit()
        });
        formBox.appendChild(btn.render()); // Direct render for simplicity here

        const toggle = document.createElement('p');
        toggle.className = "text-center text-sm text-gray-500 mt-6 cursor-pointer hover:text-white transition";
        toggle.innerText = this.state.mode === 'login' ? "Non hai un account? Registrati" : "Hai già un account? Accedi";
        toggle.onclick = () => this.toggleMode();
        formBox.appendChild(toggle);

        container.appendChild(formBox);
        return container;
    }
}

class MainLayout extends Component {
    constructor() {
        super();
        store.subscribe(() => this.update()); // Rerender on route/user change
    }

    render() {
        const root = document.createElement('div');
        const state = store.getState();

        if (!state.user) {
            const auth = new AuthView();
            return auth.render();
        }

        // App Layout
        const layout = document.createElement('div');
        layout.className = "md:pl-20 min-h-screen";

        const sidebar = new Sidebar();
        layout.appendChild(sidebar.render());

        const content = document.createElement('main');
        
        // Router Switch Logic
        switch(state.route) {
            case 'feed':
                const feed = new FeedView();
                feed.mount(content);
                break;
            default:
                content.innerText = "404 Not Found";
        }

        layout.appendChild(content);
        return layout;
    }
}

// 5. BOOTSTRAPPER (Init)
const AuthController = {
    async init() {
        const user = await AuthService.getSession();
        store.dispatch('SET_USER', user);
        
        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
            store.dispatch('SET_USER', session?.user || null);
        });

        const app = new MainLayout();
        app.mount(document.getElementById('root'));
    }
};

// Start App
AuthController.init();

</script>
</body>
</html>
