<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Gold Edition</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@1,400&display=swap" rel="stylesheet">

  <style>
    /* DESIGN SYSTEM */
    :root {
      --bg-deep: #0f172a;       
      --bg-panel: rgba(15, 23, 42, 0.95); 
      --text-main: #f8fafc;     
      --text-muted: #94a3b8;    
      --gold: #d4af37;          
      --gold-glow: rgba(212, 175, 55, 0.2);
      --red-like: #ef4444;
      --glass-border: 1px solid rgba(212, 175, 55, 0.3);
    }

    body { background: radial-gradient(circle at top center, #1e293b 0%, #020617 80%); color: var(--text-main); font-family: 'Outfit', sans-serif; margin: 0; min-height: 100vh; overflow-x: hidden; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }
    .hidden { display: none !important; }

    /* LAYOUT */
    .app-layout { display: flex; max-width: 1200px; margin: 0 auto; min-height: 100vh; }
    .sidebar { width: 80px; position: sticky; top: 20px; height: calc(100vh - 40px); margin-left: 10px; padding: 30px 0; display: flex; flex-direction: column; align-items: center; background: var(--bg-panel); backdrop-filter: blur(12px); border: var(--glass-border); border-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 50; }
    .brand-logo-icon { font-family: 'Playfair Display', serif; font-weight: bold; font-size: 24px; color: var(--gold); margin-bottom: 40px; cursor: pointer; border: 1px solid var(--gold); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 0 10px var(--gold-glow); }
    .nav-item { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; transition: all 0.3s ease; color: var(--text-muted); margin-bottom: 20px; font-size: 20px; position: relative; }
    .nav-item:hover, .nav-item.active { background: rgba(212, 175, 55, 0.15); color: var(--gold); box-shadow: 0 0 15px var(--gold-glow); transform: scale(1.1); }
    
    /* FEED */
    .main-content { flex: 1; padding: 40px; max-width: 700px; margin: 0 auto; }
    .post-card { background: rgba(30, 41, 59, 0.4); margin-bottom: 40px; padding: 20px; border-radius: 20px; border: 1px solid var(--gold); box-shadow: 0 0 20px var(--gold-glow); transition: transform 0.3s ease; }
    .post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .user-badge { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .user-avatar { width: 42px; height: 42px; border-radius: 50%; object-fit: cover; border: 2px solid var(--gold); }
    .user-meta { display: flex; flex-direction: column; }
    .username { font-weight: 600; font-size: 15px; color: #fff; }
    .post-date { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    .post-img { width: 100%; border-radius: 12px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); }
    .action-bar { display: flex; gap: 24px; margin-top: 20px; padding: 0 5px; }
    .icon-btn { font-size: 24px; cursor: pointer; transition: 0.2s; color: var(--text-main); opacity: 0.8; display: flex; align-items: center; gap: 8px; }
    .icon-btn:hover { opacity: 1; transform: translateY(-2px); color: var(--gold); }
    
    /* STILE LIKE ATTIVO */
    .fa-solid.fa-heart.text-red-500 { color: #ef4444 !important; opacity: 1 !important; }

    .likes-count { font-size: 14px; font-weight: 600; color: #fff; }
    .caption-box { margin-top: 15px; padding: 0 5px; font-size: 15px; line-height: 1.6; color: #cbd5e1; }
    .caption-user { font-weight: 700; color: var(--gold); margin-right: 8px; cursor: pointer; }
    .empty-feed-box { text-align: center; padding: 60px 20px; background: rgba(255,255,255,0.03); border: 1px dashed var(--gold); border-radius: 20px; color: #ccc; }

    /* AUTH & UI */
    .split-layout { display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:200; background:#0a0a0a; transition:transform .8s ease-in-out; }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; filter:grayscale(100%); opacity:0; transition:opacity 1.5s ease, filter .8s ease; z-index:0; pointer-events:none; }
    .visual-side img.active{ opacity:1; z-index:1; pointer-events:auto; }
    .visual-side img.active:hover{ filter:grayscale(0%); cursor:crosshair; }
    .form-side{ flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; background:#0a0a0a; max-width:600px; margin:auto }
    .input-group{ margin-bottom:25px }
    .input-label{ display:block; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:#555; margin-bottom:8px }
    input.auth-input{ background:transparent; border-bottom:1px solid #222; padding:10px 0; color:#fff; width:100%; outline:none; font-size:14px; border-top:none; border-left:none; border-right:none; border-radius:0; }
    .btn-white{ background:#fff; color:#000; padding:18px; font-weight:500; text-transform:uppercase; width:100%; cursor:pointer; border:1px solid #fff; transition:.3s; margin-top:10px }
    .btn-gold { background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%); color: #000; padding: 12px 24px; border-radius: 12px; font-weight: 700; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(248, 181, 0, 0.4); transition: 0.3s; }
    .link-small{ text-align:center; margin-top:20px; font-size:10px; color:#555; cursor:pointer; text-transform:uppercase; letter-spacing:1px }

    /* MODALS */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0, 0.9); backdrop-filter: blur(5px); z-index: 100; display: flex; justify-content: center; align-items: center; }
    .glass-modal { background: #1e293b; border: 1px solid var(--gold); border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }
    .detail-layout { display: flex; width: 90vw; max-width: 1100px; height: 85vh; }
    .detail-img-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; }
    .detail-img-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .detail-info-side { flex: 1; display: flex; flex-direction: column; background: #1e293b; min-width: 350px; }

    @media (max-width: 800px) {
      .sidebar { width: 100%; height: 60px; position: fixed; bottom: 0; top: auto; left: 0; margin: 0; flex-direction: row; justify-content: space-around; padding: 0; border-radius: 20px 20px 0 0; background: rgba(15, 23, 42, 0.98); border-top: 1px solid var(--gold); border: none; }
      .brand-logo-icon { display: none; } .nav-item { margin: 0; }
      .main-content { padding: 20px 10px 100px 10px; }
      .detail-layout { flex-direction: column; height: 100%; border-radius: 0; width: 100%; }
    }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>
  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic text-white" style="font-family: 'Playfair Display', serif;">Hawenishland</h1>
    <div id="msg-box" class="hidden p-2 text-center mb-4 text-xs border border-gray-600 rounded"></div>
    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass" class="auth-input"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>
    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username</label><input type="text" id="r-username" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass" class="auth-input"></div>
      <button onclick="faiRegistrazione()" class="btn-white">Registrati</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    <div class="sidebar">
      <div class="brand-logo-icon" onclick="renderFeedView()">H</div>
      <div class="nav-item active" onclick="renderFeedView()"><i class="fa-solid fa-house"></i></div>
      <div class="nav-item" onclick="openSearchModal()"><i class="fa-solid fa-magnifying-glass"></i></div>
      <div class="nav-item" onclick="openUploadModal()"><i class="fa-solid fa-plus"></i></div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)"><i class="fa-solid fa-user"></i></div>
      <div style="margin-top:auto"></div>
      <div class="nav-item text-red-400 hover:text-red-500" onclick="logout()"><i class="fa-solid fa-power-off"></i></div>
    </div>
    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg text-white">Crea Post</h3><i class="fa-solid fa-xmark cursor-pointer text-white" onclick="closeModal('upload-modal')"></i></div>
    <label class="block mb-4 h-48 border-2 border-dashed border-gray-600 rounded-xl flex items-center justify-center cursor-pointer">
      <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
      <img id="upload-preview" class="hidden h-full w-full object-cover rounded-xl">
      <span id="upload-placeholder" class="text-gray-400 text-sm">Clicca per foto</span>
    </label>
    <textarea id="post-caption" class="w-full bg-slate-800 p-3 text-white rounded mb-4" placeholder="Scrivi..."></textarea>
    <button onclick="submitPost()" class="btn-gold w-full">Pubblica</button>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex items-center gap-2">
      <input type="text" id="search-query" class="bg-transparent text-white w-full outline-none" placeholder="Cerca..." onkeyup="performSearch()">
      <i class="fa-solid fa-xmark cursor-pointer text-white" onclick="closeModal('search-modal')"></i>
    </div>
    <div id="search-results" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="glass-modal detail-layout">
    <div class="detail-img-side"><img id="detail-img" src=""><div id="detail-noimg" class="hidden text-gray-500">Solo Testo</div></div>
    <div class="detail-info-side">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <div class="flex items-center gap-3 cursor-pointer" id="detail-user-link">
          <img id="detail-avatar" class="w-8 h-8 rounded-full border border-[#d4af37]">
          <span id="detail-username" class="font-bold text-sm text-white"></span>
        </div>
        <div class="flex items-center gap-3">
          <div id="detail-delete-btn"></div>
          <i class="fa-solid fa-xmark cursor-pointer text-white" onclick="closeModal('post-detail-modal')"></i>
        </div>
      </div>
      <div id="detail-comments" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
      <div class="p-4 border-t border-gray-700">
        <div class="flex gap-4 text-2xl mb-2 text-white">
          <div id="detail-like-btn" class="cursor-pointer icon-btn"></div>
          <i class="fa-regular fa-comment"></i>
        </div>
        <div class="font-bold text-sm mb-3 text-white"><span id="detail-likes-count">0</span> Mi piace</div>
        <div class="flex gap-2">
          <input type="text" id="new-comment" placeholder="Commenta..." class="flex-1 bg-transparent text-white outline-none">
          <button onclick="inviaCommento()" class="text-[#d4af37] font-bold text-sm">INVIA</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between font-bold text-white"><span id="ul-title">Lista</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('user-list-modal')"></i></div>
    <div id="ul-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <h2 class="text-xl font-bold mb-4 text-center text-white">Modifica Profilo</h2>
    <div class="flex flex-col items-center mb-6">
      <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border-4 border-[#d4af37] mb-2">
      <label class="text-[#d4af37] text-sm font-bold cursor-pointer hover:text-white">Cambia Foto<input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar(this)"></label>
    </div>
    <div class="space-y-4">
      <div><label class="text-xs text-gray-500 uppercase font-bold">Username</label><input id="edit-username" type="text" class="w-full bg-slate-800 p-2 rounded text-white border border-slate-700"></div>
      <div><label class="text-xs text-gray-500 uppercase font-bold">Nome Completo</label><input id="edit-fullname" type="text" class="w-full bg-slate-800 p-2 rounded text-white border border-slate-700"></div>
      <div class="flex gap-3 pt-2">
        <button onclick="saveProfile()" class="flex-1 btn-gold">Salva</button>
        <button onclick="closeModal('edit-profile-modal')" class="flex-1 border border-gray-600 py-2 rounded-lg text-white hover:bg-white/10">Annulla</button>
      </div>
    </div>
  </div>
</div>

<script>
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';
  let currentUser = null, currentPostId = null;

  window.addEventListener('load', async () => {
    let i=0; const imgs=document.querySelectorAll('.visual-side img');
    if(imgs.length) setInterval(()=>{ imgs[i].classList.remove('active'); i=(i+1)%imgs.length; imgs[i].classList.add('active'); }, 5000);
    const { data: { session } } = await sb.auth.getSession();
    if(session) enterApp(session.user);
    else document.getElementById('auth-container').style.display='flex';
  });

  // --- LOGICA FEED & LIKE ---
  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    // Rimuovo flag profilo
    if(document.getElementById('view-profile-active')) document.getElementById('view-profile-active').remove();
    
    main.innerHTML = `<div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-[#d4af37]"></i></div>`;

    // 1. Chi seguo?
    const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
    const followingIds = follows ? follows.map(f => f.followed_id) : [];

    if (followingIds.length === 0) {
      return main.innerHTML = `<div class="empty-feed-box"><i class="fa-solid fa-user-plus text-4xl mb-4 text-[#d4af37]"></i><h2 class="text-xl font-bold mb-2">Home Vuota</h2><p class="text-gray-400 mb-6">Non segui ancora nessuno.</p><button onclick="openSearchModal()" class="btn-gold">Cerca Persone</button></div>`;
    }

    // 2. Prendi i post
    const { data: posts, error } = await sb.from('posts').select(`*, profiles:user_id (username, avatar_url)`).in('user_id', followingIds).order('created_at', { ascending: false });

    if (error || !posts || posts.length === 0) {
      return main.innerHTML = `<div class="empty-feed-box"><i class="fa-solid fa-ghost text-4xl mb-4 text-[#d4af37]"></i><h2 class="text-xl font-bold mb-2">Tutto tace...</h2><p class="text-gray-400 mb-6">Nessun post dai tuoi contatti.</p><button onclick="openSearchModal()" class="btn-gold">Cerca altri utenti</button></div>`;
    }

    main.innerHTML = '';
    
    // 3. Renderizza ogni post
    for (const post of posts) {
      const counts = await getPostCounts(post.id);
      const isLiked = await isLikedByMe(post.id);
      
      const dateStr = new Date(post.created_at).toLocaleDateString('it-IT');
      const user = post.profiles || { username: 'Unknown', avatar_url: '' };
      
      // Costruisci icona Like iniziale in base al DB
      const heartIcon = isLiked 
        ? '<i class="fa-solid fa-heart text-red-500"></i>' 
        : '<i class="fa-regular fa-heart"></i>';
      
      // Stato iniziale per la logica JS
      const likedState = isLiked ? 'true' : 'false';
      
      main.insertAdjacentHTML('beforeend', `
        <div class="post-card">
          <div class="post-header">
            <div class="user-badge" onclick="openUserProfile('${post.user_id}')">
              <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" class="user-avatar">
              <div class="user-meta"><span class="username">${user.username}</span><span class="post-date">${dateStr}</span></div>
            </div>
          </div>
          <img src="${post.image_url}" class="post-img" onclick="openPostDetail('${post.id}')">
          <div class="action-bar">
            <div class="icon-btn" onclick="toggleLike('${post.id}', this)" data-liked="${likedState}">
              ${heartIcon}
              <span class="likes-count text-sm ml-2" id="likes-count-${post.id}">${counts.likes}</span>
            </div>
            <div class="icon-btn" onclick="openPostDetail('${post.id}')"><i class="fa-regular fa-comment"></i><span class="text-sm ml-2">${counts.comments}</span></div>
            <div class="icon-btn ml-auto" onclick="sharePost('${post.caption}')"><i class="fa-regular fa-paper-plane"></i></div>
          </div>
          <div class="caption-box"><span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>${escapeHtml(post.caption)}</div>
        </div>
      `);
    }
  }

  // --- LOGICA LIKE INFALLIBILE ---
  async function toggleLike(postId, btn) {
    const countSpan = btn.querySelector('.likes-count') || document.getElementById(`likes-count-${postId}`) || document.getElementById('detail-likes-count');
    let count = parseInt(countSpan.innerText);
    
    // Leggi stato attuale
    const isLiked = btn.getAttribute('data-liked') === 'true';

    // 1. UI IMMEDIATA (Ottimistica)
    if (isLiked) {
      // Tolgo il like
      btn.setAttribute('data-liked', 'false');
      btn.querySelector('i').className = 'fa-regular fa-heart'; // Diventa vuoto
      countSpan.innerText = Math.max(0, count - 1);
    } else {
      // Metto il like
      btn.setAttribute('data-liked', 'true');
      btn.querySelector('i').className = 'fa-solid fa-heart text-red-500'; // Diventa pieno rosso
      countSpan.innerText = count + 1;
    }

    // 2. AGGIORNAMENTO DB
    try {
      if (isLiked) {
        await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
      } else {
        const { error } = await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
        // Se errore duplicato, ignora
        if (error && error.code !== '23505') throw error;
      }
    } catch (err) {
      console.error("Errore Like:", err);
      // Rollback in caso di errore vero
      if (isLiked) {
        btn.setAttribute('data-liked', 'true');
        btn.querySelector('i').className = 'fa-solid fa-heart text-red-500';
        countSpan.innerText = count;
      } else {
        btn.setAttribute('data-liked', 'false');
        btn.querySelector('i').className = 'fa-regular fa-heart';
        countSpan.innerText = count;
      }
    }
  }

  // --- FUNZIONI DI SUPPORTO ---
  async function getPostCounts(postId) {
    const { count: l } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    const { count: c } = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    return { likes: l || 0, comments: c || 0 };
  }
  async function isLikedByMe(postId) {
    const { data } = await sb.from('likes').select('id').eq('post_id', postId).eq('user_id', currentUser.id);
    return data && data.length > 0;
  }
  function sharePost(text) {
    if(navigator.share) navigator.share({ title:'Hawenishland', text });
    else { navigator.clipboard.writeText(text); alert("Link copiato!"); }
  }
  
  // Funzione Delete corretta
  async function deletePost(postId) {
    if(!confirm("Vuoi davvero eliminare questo post?")) return;
    const { error } = await sb.from('posts').delete().eq('id', postId);
    if (error) alert("Errore: " + error.message);
    else {
      closeModal('post-detail-modal');
      // Se sono nel profilo, ricarico il profilo, altrimenti feed
      if(document.getElementById('view-profile-active')) openUserProfile(currentUser.id);
      else renderFeedView();
    }
  }

  // --- MODALI ---
  async function openPostDetail(postId) {
    currentPostId = postId;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    document.getElementById('detail-comments').innerHTML = 'Caricamento...';
    
    // Pulisci bottone delete
    document.getElementById('detail-delete-btn').innerHTML = '';

    const { data: post } = await sb.from('posts').select(`*, profiles:user_id(*)`).eq('id', postId).single();
    
    // Img
    const imgEl = document.getElementById('detail-img');
    const noImgEl = document.getElementById('detail-noimg');
    if (post.image_url) { imgEl.src = post.image_url; imgEl.classList.remove('hidden'); noImgEl.classList.add('hidden'); }
    else { imgEl.classList.add('hidden'); noImgEl.classList.remove('hidden'); }

    // User
    const u = post.profiles;
    document.getElementById('detail-avatar').src = u.avatar_url || 'https://via.placeholder.com/32';
    document.getElementById('detail-username').innerText = u.username;
    document.getElementById('detail-user-link').onclick = () => { closeModal('post-detail-modal'); openUserProfile(post.user_id); };

    // DELETE BUTTON (Solo se il post è mio)
    if(post.user_id === currentUser.id) {
      document.getElementById('detail-delete-btn').innerHTML = 
        `<i class="fa-solid fa-trash text-gray-400 hover:text-red-500 cursor-pointer" onclick="deletePost('${post.id}')" title="Elimina"></i>`;
    }

    // Like (Inizializzazione)
    const counts = await getPostCounts(postId);
    const isLiked = await isLikedByMe(postId);
    const likeBtn = document.getElementById('detail-like-btn');
    
    // Set iniziale
    const heartIcon = isLiked ? '<i class="fa-solid fa-heart text-red-500"></i>' : '<i class="fa-regular fa-heart"></i>';
    likeBtn.setAttribute('data-liked', isLiked ? 'true' : 'false');
    likeBtn.innerHTML = heartIcon;
    document.getElementById('detail-likes-count').innerText = counts.likes;
    
    // Bind click
    likeBtn.onclick = () => toggleLike(postId, likeBtn);

    // Commenti
    const list = document.getElementById('detail-comments'); list.innerHTML = '';
    // Caption
    if(post.caption) list.insertAdjacentHTML('beforeend', `<div class="mb-4 text-sm"><span class="font-bold text-[#d4af37] mr-2">${u.username}</span><span class="text-gray-300">${escapeHtml(post.caption)}</span></div>`);
    // Fetch
    const { data: coms } = await sb.from('comments').select(`*, profiles:user_id(username)`).eq('post_id', postId).order('created_at', { ascending: true });
    coms.forEach(c => {
      list.insertAdjacentHTML('beforeend', `<div class="mb-2 text-sm"><span class="font-bold text-white mr-2">${c.profiles.username}</span><span class="text-gray-400">${escapeHtml(c.content)}</span></div>`);
    });
  }

  async function inviaCommento() {
    const txt = document.getElementById('new-comment').value.trim();
    if(!txt) return;
    await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
    document.getElementById('new-comment').value = '';
    openPostDetail(currentPostId);
  }

  // --- PROFILO ---
  async function openUserProfile(userId) {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div id="view-profile-active" class="hidden"></div><div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-[#d4af37]"></i></div>`;
    
    const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
    if(!profile) return main.innerHTML = "Utente non trovato";

    // Stats
    const { count: pc } = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const { count: fc } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const { count: fing } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
    const { data: isF } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
    const isFollowing = isF && isF.length > 0;

    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });

    const btn = (userId === currentUser.id) 
      ? `<button class="btn-white text-xs py-1 px-3" onclick="openEditProfile()">Modifica</button>`
      : `<button class="btn-gold text-xs py-1 px-3" onclick="toggleFollow('${userId}')">${isFollowing ? 'Seguito' : 'Segui'}</button>`;

    main.innerHTML = `
      <div class="mb-8 flex items-center gap-6">
        <img src="${profile.avatar_url || 'https://via.placeholder.com/150'}" class="w-24 h-24 rounded-full border-2 border-[#d4af37] object-cover">
        <div>
          <div class="flex items-center gap-4 mb-2"><h2 class="text-2xl text-white">${profile.username}</h2>${btn}</div>
          <div class="flex gap-6 text-sm text-gray-400">
            <span><b class="text-white">${pc||0}</b> Post</span>
            <span class="cursor-pointer" onclick="showUsers('followers','${userId}')"><b class="text-white">${fc||0}</b> Follower</span>
            <span class="cursor-pointer" onclick="showUsers('following','${userId}')"><b class="text-white">${fing||0}</b> Seguiti</span>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-1">
        ${posts.map(p => `<div class="aspect-square bg-gray-800 cursor-pointer overflow-hidden relative" onclick="openPostDetail('${p.id}')">
          ${p.image_url ? `<img src="${p.image_url}" class="w-full h-full object-cover">` : `<div class="flex items-center justify-center h-full text-xs text-gray-500">Testo</div>`}
        </div>`).join('')}
      </div>
    `;
  }

  async function toggleFollow(uid) {
    const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', uid);
    if(data.length) await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', uid);
    else await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: uid }]);
    openUserProfile(uid);
  }

  async function showUsers(type, uid) {
    const m = document.getElementById('user-list-modal'); m.classList.remove('hidden');
    const c = document.getElementById('ul-content'); c.innerHTML = 'Caricamento...';
    const field = type === 'followers' ? 'followed_id' : 'follower_id';
    const { data } = await sb.from('follows').select('*').eq(field, uid);
    c.innerHTML = `<div class="text-center p-4 text-gray-400">${data.length} Utenti (Lista semplificata)</div>`;
  }

  // --- UTILS ---
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  function openSearchModal() { document.getElementById('search-modal').classList.remove('hidden'); }
  function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }
  function previewUpload(input) { 
    if(input.files && input.files[0]) {
      const r = new FileReader();
      r.onload = (e) => { 
        document.getElementById('upload-preview').src=e.target.result; 
        document.getElementById('upload-preview').classList.remove('hidden');
      };
      r.readAsDataURL(input.files[0]);
    }
  }
  async function submitPost() {
    const f = document.getElementById('post-file').files[0];
    const c = document.getElementById('post-caption').value;
    if(!f && !c) return alert("Metti foto o testo.");
    let url = null;
    if(f) {
      const name = `${currentUser.id}/${Date.now()}`;
      await sb.storage.from(BUCKET_POSTS).upload(name, f);
      const { data } = sb.storage.from(BUCKET_POSTS).getPublicUrl(name);
      url = data.publicUrl;
    }
    await sb.from('posts').insert([{ user_id: currentUser.id, image_url: url, caption: c }]);
    closeModal('upload-modal');
    renderFeedView();
  }
  async function performSearch() {
    const q = document.getElementById('search-query').value;
    const res = document.getElementById('search-results');
    if(q.length<2) return res.innerHTML='';
    const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`);
    res.innerHTML = data.map(u => `<div class="p-2 border-b border-gray-700 cursor-pointer flex items-center gap-2" onclick="closeModal('search-modal'); openUserProfile('${u.id}')"><img src="${u.avatar_url||'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full border border-gray-600">${u.username}</div>`).join('');
  }
  function openEditProfile() { document.getElementById('edit-profile-modal').classList.remove('hidden'); }
  async function saveProfile() { await sb.from('profiles').update({ username:document.getElementById('edit-username').value, full_name:document.getElementById('edit-fullname').value }).eq('id', currentUser.id); closeModal('edit-profile-modal'); openUserProfile(currentUser.id); }
  async function uploadAvatar(i) { const f=i.files[0]; if(!f)return; const n=`${currentUser.id}/avatar_${Date.now()}`; await sb.storage.from(BUCKET_AVATARS).upload(n, f); const {data}=sb.storage.from(BUCKET_AVATARS).getPublicUrl(n); document.getElementById('edit-avatar-preview').src=data.publicUrl; await sb.from('profiles').update({ avatar_url:data.publicUrl }).eq('id',currentUser.id); }

  // --- AUTH BASE ---
  function mess(t,e){ const b=document.getElementById('msg-box'); b.innerText=t; b.style.display='block'; b.style.color=e?'red':'green'; }
  function vaiA(m){ document.getElementById('login-form').classList.toggle('hidden',m==='signup'); document.getElementById('signup-form').classList.toggle('hidden',m==='login'); }
  function escapeHtml(t) { return t?t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"):""; }
  async function faiLogin() { const {data,error}=await sb.auth.signInWithPassword({ email:document.getElementById('l-email').value, password:document.getElementById('l-pass').value }); if(error)mess(error.message,true); else enterApp(data.user); }
  async function faiRegistrazione() { const {data,error}=await sb.auth.signUp({ email:document.getElementById('r-email').value, password:document.getElementById('r-pass').value }); if(error)return mess(error.message,true); if(data.user) await sb.from('profiles').insert([{ id:data.user.id, username:document.getElementById('r-username').value }]); mess("Registrazione OK!"); }
  async function logout() { await sb.auth.signOut(); location.reload(); }
  function enterApp(u) { currentUser=u; document.getElementById('auth-container').style.transform = "translateY(-100vh)"; setTimeout(()=>{ document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-interface').classList.remove('hidden'); renderFeedView(); },600); }
</script>
</body>
</html>
