<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HAWENISHLAND — Official Society</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        /* =========================================
           ENTERPRISE CSS RESET & VARIABLES
           ========================================= */
        :root {
            --bg-body: #050505;
            --bg-card: #0f0f0f;
            --bg-input: #141414;
            --border: #262626;
            --text: #ffffff;
            --text-muted: #888888;
            --font-ui: 'Inter', sans-serif;
            --font-brand: 'Playfair Display', serif;
            --header-h: 70px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: var(--bg-body); color: var(--text);
            font-family: var(--font-ui); margin: 0; padding: 0;
            height: 100vh; overflow: hidden;
        }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }

        .serif { font-family: var(--font-brand); }
        .hidden { display: none !important; }

        /* =========================================
           1. AUTH LAYER (SLIDESHOW & FORMS)
           ========================================= */
        #auth-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: #000; display: flex; align-items: center; justify-content: center;
        }

        .auth-slideshow {
            position: absolute; inset: 0; z-index: 1; overflow: hidden;
        }
        .auth-slide {
            position: absolute; inset: 0; width: 100%; height: 100%;
            object-fit: cover; opacity: 0; transform: scale(1.1);
            transition: opacity 2s ease-in-out, transform 8s ease-out;
            filter: brightness(0.4) grayscale(20%);
        }
        .auth-slide.active { opacity: 1; transform: scale(1); }

        .auth-modal {
            position: relative; z-index: 10; width: 90%; max-width: 420px;
            background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1); padding: 45px;
            text-align: center; border-radius: 4px; box-shadow: 0 40px 100px rgba(0,0,0,1);
        }

        .brand-lg { font-size: 3.8rem; font-style: italic; line-height: 1; margin-bottom: 10px; }
        .tagline { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 4px; color: var(--text-muted); margin-bottom: 40px; }

        .input-box { margin-bottom: 20px; text-align: left; }
        .lbl-sm { font-size: 0.7rem; text-transform: uppercase; color: #666; display: block; margin-bottom: 6px; }
        .inp-auth {
            width: 100%; background: var(--bg-input); border: 1px solid #222;
            padding: 15px; color: #fff; border-radius: 4px; transition: 0.3s;
        }
        .inp-auth:focus { border-color: #666; background: #000; }

        .btn-gold {
            width: 100%; background: #fff; color: #000; padding: 16px;
            font-weight: 700; text-transform: uppercase; border: none; cursor: pointer;
            border-radius: 4px; transition: 0.3s; margin-top: 15px;
        }
        .btn-gold:hover { background: #d0d0d0; }

        #auth-status { margin-bottom: 20px; padding: 12px; font-size: 0.85rem; border-radius: 4px; display: none; }
        .err { background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid #7f1d1d; }
        .ok { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid #064e3b; }

        /* =========================================
           2. MAIN APP FRAMEWORK
           ========================================= */
        #app-root { display: none; width: 100%; height: 100%; position: relative; }

        /* Navigation Header */
        .app-nav {
            position: fixed; top: 0; left: 0; width: 100%; height: var(--header-h);
            background: rgba(5, 5, 5, 0.98); backdrop-filter: blur(15px);
            border-bottom: 1px solid var(--border); display: flex;
            align-items: center; justify-content: space-between; padding: 0 30px; z-index: 500;
        }
        .logo-nav { font-size: 1.5rem; font-style: italic; font-weight: 700; cursor: pointer; }

        /* Sidebar System */
        .sb-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 600; opacity: 0; pointer-events: none; transition: 0.3s; }
        .sb-overlay.active { opacity: 1; pointer-events: auto; }

        .sb-drawer {
            position: fixed; top: 0; left: 0; height: 100%; width: 320px;
            background: #000; border-right: 1px solid #1a1a1a; z-index: 700;
            transform: translateX(-100%); transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column; padding: 40px 30px;
        }
        .sb-drawer.active { transform: translateX(0); }

        .nav-link {
            display: flex; align-items: center; gap: 20px; padding: 20px 15px;
            color: #999; font-size: 1.1rem; font-weight: 500; cursor: pointer;
            border-radius: 8px; transition: 0.3s; margin-bottom: 10px;
        }
        .nav-link:hover { color: #fff; background: rgba(255,255,255,0.05); transform: translateX(10px); }
        .nav-link i { width: 25px; text-align: center; }
        .nav-link.exit { margin-top: auto; color: #ef4444; }

        /* Viewport Engine */
        .main-shell {
            width: 100%; height: 100%; padding-top: var(--header-h);
            overflow-y: auto; background: var(--bg-body);
        }
        .view-content { max-width: 720px; margin: 0 auto; padding: 40px 20px 150px; }

        /* =========================================
           3. POST & CARD STYLING
           ========================================= */
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 40px; overflow: hidden; }
        .card-top { padding: 18px 20px; display: flex; align-items: center; justify-content: space-between; }
        .card-user { display: flex; align-items: center; gap: 14px; cursor: pointer; }
        .p-av-sm { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 1px solid #222; }
        
        .card-img-box { width: 100%; background: #000; display: flex; align-items: center; justify-content: center; min-height: 400px; }
        .card-img { width: 100%; display: block; object-fit: cover; max-height: 850px; }

        .card-actions { padding: 16px 20px 8px; display: flex; gap: 25px; }
        .btn-icon { font-size: 1.7rem; cursor: pointer; transition: 0.2s; color: #fff; }
        .btn-icon:hover { opacity: 0.6; transform: scale(1.1); }
        .btn-icon.liked { color: #ef4444; }

        .card-info { padding: 0 20px 20px; font-size: 1rem; line-height: 1.6; }
        .num-likes { font-weight: 700; margin-bottom: 8px; display: block; }
        .caption { color: #eee; }
        .author-inline { font-weight: 700; margin-right: 8px; cursor: pointer; }

        /* =========================================
           4. PROFILE STYLING (FIXED RATIO)
           ========================================= */
        .p-hero { text-align: center; margin-bottom: 50px; }
        .p-av-box { 
            width: 140px; height: 140px; margin: 0 auto 25px; position: relative; 
            border-radius: 50%; border: 4px solid #1a1a1a; padding: 4px; overflow: hidden;
        }
        .p-av-xl { 
            width: 100%; height: 100%; border-radius: 50%; 
            object-fit: cover; /* Garantisce che la foto non si tagli o distorca */
            cursor: pointer; transition: 0.3s; background: #222;
        }
        .p-name { font-size: 2.6rem; font-weight: 700; margin: 0; letter-spacing: -1px; }
        .p-fullname { color: #777; font-weight: 600; font-size: 1rem; margin-top: 10px; }

        .p-stats-bar { display: flex; justify-content: center; gap: 50px; margin: 40px 0; border-y: 1px solid #1a1a1a; padding: 30px 0; }
        .s-val { font-size: 1.5rem; font-weight: 700; display: block; color: #fff; }
        .s-lbl { font-size: 0.75rem; text-transform: uppercase; color: #555; letter-spacing: 2px; }

        .p-action-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 50px; }
        .btn-ui { padding: 12px 40px; border-radius: 6px; font-weight: 700; border: 1px solid #333; background: transparent; color: #fff; cursor: pointer; transition: 0.3s; }
        .btn-ui:hover { background: #fff; color: #000; border-color: #fff; }
        .btn-ui.fill { background: #fff; color: #000; }

        /* SETTINGS & SECURITY */
        .p-settings { background: #0a0a0a; border: 1px solid #1a1a1a; border-radius: 15px; padding: 35px; margin-top: 30px; text-align: left; }
        .p-settings h3 { font-size: 1.2rem; margin-bottom: 30px; border-bottom: 1px solid #222; padding-bottom: 15px; }
        .sec-row { display: flex; align-items: center; justify-content: space-between; padding: 20px 0; border-bottom: 1px solid #111; }

        /* =========================================
           5. MODALS ENGINE
           ========================================= */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.96);
            backdrop-filter: blur(15px); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }

        .modal-inner {
            background: #080808; border: 1px solid #222; border-radius: 15px;
            width: 95%; max-width: 550px; max-height: 85vh;
            display: flex; flex-direction: column; box-shadow: 0 50px 150px rgba(0,0,0,1);
        }

        .m-head { padding: 20px 25px; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; align-items: center; }
        .m-body { flex: 1; overflow-y: auto; padding: 20px; }

        .upload-zone { border: 2px dashed #222; border-radius: 12px; padding: 60px 20px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-zone:hover { border-color: #fff; background: #111; }

        .comm-input-zone { padding: 25px; border-top: 1px solid #1a1a1a; display: flex; gap: 15px; background: #0a0a0a; }
        .comm-field { flex: 1; background: #1a1a1a; border: none; padding: 15px 20px; color: #fff; border-radius: 40px; }
    </style>
</head>

<body>

    <div id="auth-overlay">
        <div class="auth-slideshow" id="slideshow-container"></div>
        
        <div class="auth-modal">
            <h1 class="serif brand-lg">Hawenish</h1>
            <p class="tagline">Official Society</p>

            <div id="auth-status"></div>

            <div id="view-login">
                <div class="input-box">
                    <span class="lbl-sm">Email</span>
                    <input type="email" id="log-email" class="inp-auth" placeholder="iltuonome@email.it">
                </div>
                <div class="input-box">
                    <span class="lbl-sm">Password</span>
                    <input type="password" id="log-pass" class="inp-auth" placeholder="••••••••">
                </div>
                <button class="btn-gold" onclick="apiLogin()">Entra nel Club</button>
                <div class="flex justify-between mt-8 font-medium text-xs text-gray-500">
                    <span class="cursor-pointer hover:text-white" onclick="authSwitch('reg')">Registrati</span>
                    <span class="cursor-pointer hover:text-white" onclick="apiRecoverPassword()">Perso Password?</span>
                </div>
            </div>

            <div id="view-signup" class="hidden">
                <div class="input-box">
                    <span class="lbl-sm">Username</span>
                    <input type="text" id="reg-user" class="inp-auth" placeholder="@username">
                </div>
                <div class="input-box">
                    <span class="lbl-sm">Nome Completo</span>
                    <input type="text" id="reg-name" class="inp-auth" placeholder="Mario Rossi">
                </div>
                <div class="input-box">
                    <span class="lbl-sm">Email</span>
                    <input type="email" id="reg-email" class="inp-auth" placeholder="nome@email.it">
                </div>
                <div class="input-box">
                    <span class="lbl-sm">Password</span>
                    <input type="password" id="reg-pass" class="inp-auth" placeholder="Min. 8 caratteri">
                </div>
                <button class="btn-gold" onclick="apiSignup()">Crea Profilo</button>
                <div class="mt-8 text-center font-medium text-xs text-gray-500">
                    <span class="cursor-pointer hover:text-white" onclick="authSwitch('log')">Torna al Login</span>
                </div>
            </div>
        </div>
    </div>

    <div id="app-root">
        
        <header class="app-nav">
            <i class="fa-solid fa-bars-staggered text-xl cursor-pointer" onclick="uiSidebar(true)"></i>
            <span class="serif logo-nav" onclick="uiView('feed')">Hawenishland</span>
            <div class="flex items-center gap-8">
                <i class="fa-solid fa-magnifying-glass text-xl cursor-pointer hover:text-gray-400" onclick="uiModal('modal-search')"></i>
                <i class="fa-regular fa-square-plus text-2xl cursor-pointer hover:text-gray-400" onclick="uiModal('modal-create')"></i>
            </div>
        </header>

        <div class="sb-overlay" id="overlay-ui" onclick="uiSidebar(false)"></div>
        <aside class="sb-drawer" id="sidebar-ui">
            <div class="mb-12 serif text-3xl italic font-bold px-4">Hawenishland</div>
            <div class="nav-link" onclick="uiView('feed')"><i class="fa-solid fa-house"></i> Home Feed</div>
            <div class="nav-link" onclick="uiModal('modal-search')"><i class="fa-solid fa-users"></i> Esplora Membri</div>
            <div class="nav-link" onclick="uiModal('modal-create')"><i class="fa-regular fa-plus-square"></i> Nuovo Post</div>
            <div class="nav-link" onclick="uiView('profile')"><i class="fa-regular fa-user-circle"></i> Mio Profilo</div>
            
            <div class="nav-link exit" onclick="apiLogout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Esci</div>
        </aside>

        <main class="main-shell" id="app-viewport">
            
            <section id="page-feed" class="view-content">
                <div id="feed-loader" class="text-center p-12 text-gray-700 hidden"><i class="fa-solid fa-spinner fa-spin fa-3x"></i></div>
                <div id="feed-render"></div>
            </section>

            <section id="page-profile" class="view-content hidden">
                <div class="p-hero">
                    <div id="btn-back" class="hidden text-left mb-8 text-sm text-gray-500 cursor-pointer" onclick="uiView('feed')">
                        <i class="fa-solid fa-chevron-left mr-2"></i> Torna alla Home
                    </div>

                    <div class="p-av-box">
                        <img id="p-img" src="" class="p-av-xl" onclick="uiTriggerAvatar()">
                        <input type="file" id="av-file" class="hidden" accept="image/*" onchange="apiAvatarUpload()">
                    </div>
                    
                    <h1 id="p-user" class="p-name">@username</h1>
                    <p id="p-realname" class="p-fullname">Andrea Raimondi</p>

                    <div class="p-stats-bar">
                        <div class="stat-item" onclick="apiShowFollowers('followers')">
                            <span class="s-val" id="st-followers">0</span>
                            <span class="s-lbl">Follower</span>
                        </div>
                        <div class="stat-item" onclick="apiShowFollowers('following')">
                            <span class="s-val" id="st-following">0</span>
                            <span class="s-lbl">Seguiti</span>
                        </div>
                        <div class="stat-item">
                            <span class="s-val" id="st-posts">0</span>
                            <span class="s-lbl">Post</span>
                        </div>
                    </div>

                    <div id="p-actions" class="p-action-row"></div>

                    <div id="p-settings-box" class="p-settings hidden">
                        <h3>Gestione Profilo</h3>
                        <div class="mb-8">
                            <span class="lbl-sm">Nome Visualizzato</span>
                            <input id="upd-name" class="inp-auth mb-4">
                            <span class="lbl-sm">Username Personale</span>
                            <input id="upd-user" class="inp-auth mb-6">
                            <button class="btn-gold py-3 text-sm" onclick="apiUpdateMetadata()">Applica Modifiche</button>
                        </div>

                        <div class="pt-8 border-t border-gray-900">
                            <h3>Sicurezza & Accesso</h3>
                            <div class="sec-row">
                                <div><p class="font-bold text-sm">Email Account</p><p id="curr-email" class="text-xs text-gray-600">andrea@mail.it</p></div>
                                <button class="text-blue-500 font-bold text-xs uppercase" onclick="apiInitEmailChange()">Modifica</button>
                            </div>
                            <div class="sec-row">
                                <div><p class="font-bold text-sm">Protezione Password</p><p class="text-xs text-gray-600">Verifica tramite link sicuro</p></div>
                                <button class="text-red-500 font-bold text-xs uppercase" onclick="apiInitPasswordReset()">Reset via Email</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="p-posts-grid" class="mt-12 border-t border-gray-900 pt-12"></div>
            </section>
        </main>
    </div>

    <div id="modal-create" class="modal">
        <div class="modal-inner">
            <div class="m-head"><span>Nuova Creazione</span><i class="fa-solid fa-xmark cursor-pointer" onclick="uiCloseModal('modal-create')"></i></div>
            <div class="p-8">
                <textarea id="c-caption" class="inp-auth mb-6 resize-none" rows="4" placeholder="Cosa hai in mente?"></textarea>
                <label class="upload-zone block">
                    <i class="fa-solid fa-cloud-arrow-up text-4xl text-gray-600 mb-4"></i>
                    <p class="text-sm text-gray-500">Trascina o clicca per caricare foto</p>
                    <input type="file" id="c-file" class="hidden" accept="image/*">
                </label>
                <button class="btn-gold" onclick="apiPublish()">Pubblica Post</button>
            </div>
        </div>
    </div>

    <div id="modal-search" class="modal">
        <div class="modal-inner h-[70vh]">
            <div class="m-head">
                <div class="flex-1 mr-6 bg-black border border-gray-800 rounded-full px-5 flex items-center">
                    <i class="fa-solid fa-magnifying-glass text-gray-600 mr-4"></i>
                    <input id="s-input" class="bg-transparent border-none py-3 text-white w-full text-sm outline-none" placeholder="Cerca persone per nome o username..." onkeyup="apiHandleSearch()">
                </div>
                <i class="fa-solid fa-xmark cursor-pointer" onclick="uiCloseModal('modal-search')"></i>
            </div>
            <div id="s-results" class="m-body"></div>
        </div>
    </div>

    <div id="modal-list" class="modal">
        <div class="modal-inner h-[60vh]">
            <div class="m-head"><span id="l-title" class="font-bold">Membri</span><i class="fa-solid fa-xmark cursor-pointer" onclick="uiCloseModal('modal-list')"></i></div>
            <div id="l-results" class="m-body"></div>
        </div>
    </div>

    <div id="modal-detail" class="modal">
        <div class="modal-inner h-[90vh] max-w-[680px]">
            <div class="m-head"><span>Dettagli Post</span><i class="fa-solid fa-xmark cursor-pointer" onclick="uiCloseModal('modal-detail')"></i></div>
            <div class="m-body" id="d-scroll">
                <div class="p-8 border-b border-gray-900 bg-[#070707] flex gap-5">
                    <div class="font-bold text-sm" id="d-user-top"></div>
                    <p class="text-sm text-gray-400" id="d-caption-top"></p>
                </div>
                <div id="d-comments" class="p-6"></div>
            </div>
            <div class="comm-input-zone">
                <input id="d-input" class="comm-field outline-none" placeholder="Lascia un commento professionale...">
                <button class="text-blue-500 font-bold px-4" onclick="apiSubmitComment()">Invia</button>
            </div>
        </div>
    </div>

    <script>
        // CORE DB CONNECTION
        const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
        const _db = window.supabase.createClient(SB_URL, SB_KEY);

        // GLOBAL APP STATE
        let SESSION = null;
        let VIEW_PROFILE_ID = null;
        let ACTIVE_POST_ID = null;

        // FASHION ASSETS
        const SLIDES = [
            'https://images.unsplash.com/photo-1539109136881-3be0616acf4b?q=80&w=1600', // Donna Fashion
            'https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1600', // Uomo Fashion
            'https://images.unsplash.com/photo-1490481651871-ab68de25d43d?q=80&w=1600', // Donna 2
            'https://images.unsplash.com/photo-1507679799987-c73779587ccf?q=80&w=1600'  // Uomo 2
        ];

        /* --- BOOTSTRAP --- */
        window.addEventListener('load', async () => {
            initSlides();
            const { data: { session } } = await _db.auth.getSession();
            if (session) bootApp(session.user);
        });

        function initSlides() {
            const container = document.getElementById('slideshow-container');
            SLIDES.forEach((url, i) => {
                const img = document.createElement('img');
                img.src = url; img.className = `auth-slide ${i === 0 ? 'active' : ''}`;
                container.appendChild(img);
            });
            let cur = 0; const imgs = document.querySelectorAll('.auth-slide');
            setInterval(() => {
                imgs[cur].classList.remove('active');
                cur = (cur + 1) % imgs.length;
                imgs[cur].classList.add('active');
            }, 5000);
        }

        /* --- AUTH SYSTEM --- */
        function authSwitch(mode) {
            document.getElementById('view-login').classList.toggle('hidden', mode === 'reg');
            document.getElementById('view-signup').classList.toggle('hidden', mode === 'log');
            uiStatus('', false);
        }

        function uiStatus(t, err = true) {
            const b = document.getElementById('auth-status');
            if (!t) { b.style.display = 'none'; return; }
            b.innerText = t; b.style.display = 'block';
            b.className = err ? 'err' : 'ok';
        }

        async function apiLogin() {
            const e = document.getElementById('log-email').value, p = document.getElementById('log-pass').value;
            if(!e || !p) return uiStatus('Inserisci le credenziali.');
            const { data, error } = await _db.auth.signInWithPassword({ email: e, password: p });
            if (error) return uiStatus(error.message);
            bootApp(data.user);
        }

        async function apiSignup() {
            const u = document.getElementById('reg-user').value.trim(), n = document.getElementById('reg-name').value.trim();
            const e = document.getElementById('reg-email').value, p = document.getElementById('reg-pass').value;
            if(!u || !n || !e || !p) return uiStatus('Compila tutti i campi.');
            const { data, error } = await _db.auth.signUp({ email: e, password: p, options: { data: { first_name: n } } });
            if (error) return uiStatus(error.message);
            if (data.user) {
                await _db.from('profiles').upsert([{ id: data.user.id, username: u.toLowerCase(), full_name: n }]);
            }
            uiStatus('Iscrizione completata! Verifica la tua mail.', false);
            setTimeout(() => authSwitch('log'), 3000);
        }

        async function apiRecoverPassword() {
            const m = prompt("Inserisci la tua email di registrazione:");
            if (m) {
                const { error } = await _db.auth.resetPasswordForEmail(m);
                alert(error ? error.message : "Controlla la tua posta per il link di reset.");
            }
        }

        async function apiLogout() { await _db.auth.signOut(); location.reload(); }

        function bootApp(user) {
            SESSION = user;
            document.getElementById('auth-overlay').style.transform = 'translateY(-100%)';
            setTimeout(() => {
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('app-root').style.display = 'block';
                uiView('feed');
            }, 600);
        }

        /* --- UI & NAVIGATION ENGINE --- */
        function uiSidebar(open) {
            document.getElementById('sidebar-ui').classList.toggle('active', open);
            document.getElementById('overlay-ui').classList.toggle('active', open);
        }

        function uiView(target) {
            uiSidebar(false);
            // RESET ALL PAGES
            document.getElementById('page-feed').classList.add('hidden');
            document.getElementById('page-profile').classList.add('hidden');
            document.getElementById('app-viewport').scrollTop = 0;

            if (target === 'feed') {
                document.getElementById('page-feed').classList.remove('hidden');
                apiLoadFeed();
            } else if (target === 'profile') {
                document.getElementById('page-profile').classList.remove('hidden');
                apiLoadProfile(SESSION.id);
            }
        }

        function uiModal(id) { document.getElementById(id).classList.add('active'); }
        function uiCloseModal(id) { document.getElementById(id).classList.remove('active'); }
        function uiSafe(s) { return (s || '').replace(/&/g,"&amp;").replace(/</g,"&lt;"); }

        /* --- FEED ENGINE --- */
        async function apiLoadFeed() {
            const container = document.getElementById('feed-render'), loader = document.getElementById('feed-loader');
            container.innerHTML = ''; loader.classList.remove('hidden');

            const { data: follows } = await _db.from('follows').select('followed_id').eq('follower_id', SESSION.id);
            let ids = [SESSION.id];
            if(follows) ids = [...ids, ...follows.map(f => f.followed_id)];

            let query = _db.from('posts').select(`*, profiles(username, avatar_url), likes(count), comments(count)`).order('created_at', { ascending: false }).limit(50);
            if (ids.length > 1) query = query.in('user_id', ids);

            const { data: posts } = await query;
            loader.classList.add('hidden');

            if (!posts || posts.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-10">Inizia a seguire qualcuno per vedere i suoi post.</div>';
                const { data: glob } = await _db.from('posts').select(`*, profiles(username, avatar_url), likes(count), comments(count)`).order('created_at', { ascending: false }).limit(20);
                if (glob) renderPosts(glob, container);
            } else {
                renderPosts(posts, container);
            }
        }

        function renderPosts(data, container) {
            data.forEach(p => {
                const u = p.profiles || { username: 'user', avatar_url: null };
                const lk = p.likes?.[0]?.count || 0, cm = p.comments?.[0]?.count || 0;
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-top">
                        <div class="card-user" onclick="apiLoadProfile('${p.user_id}')">
                            <img src="${u.avatar_url || 'https://via.placeholder.com/50'}" class="p-av-sm">
                            <span class="font-bold text-sm">@${uiSafe(u.username)}</span>
                        </div>
                        ${p.user_id === SESSION.id ? `<i class="fa-solid fa-trash-can text-gray-700 hover:text-red-500 cursor-pointer" onclick="apiKillPost('${p.id}')"></i>` : ''}
                    </div>
                    ${p.image_url ? `<div class="card-img-box"><img src="${p.image_url}" class="card-img" ondblclick="apiHeart('${p.id}')"></div>` : ''}
                    <div class="card-actions">
                        <i class="fa-regular fa-heart btn-icon" id="h-btn-${p.id}" onclick="apiHeart('${p.id}')"></i>
                        <i class="fa-regular fa-comment btn-icon" onclick="apiInspectPost('${p.id}')"></i>
                    </div>
                    <div class="card-info">
                        <span class="num-likes"><span id="h-num-${p.id}">${lk}</span> Mi piace</span>
                        <div class="caption">
                            <span class="author-inline" onclick="apiLoadProfile('${p.user_id}')">@${uiSafe(u.username)}</span>
                            ${uiSafe(p.caption)}
                        </div>
                        ${cm > 0 ? `<span class="p-comm-trigger" onclick="apiInspectPost('${p.id}')">Mostra commenti (${cm})</span>` : ''}
                    </div>
                `;
                container.appendChild(div);
                syncHeart(p.id);
            });
        }

        /* --- PROFILE & SECURITY ENGINE --- */
        async function apiLoadProfile(uid) {
            VIEW_PROFILE_ID = uid;
            const isMe = (uid === SESSION.id);
            document.getElementById('btn-back').classList.toggle('hidden', isMe);
            document.getElementById('p-settings-box').classList.add('hidden');

            const { data: pData } = await _db.from('profiles').select('*').eq('id', uid).single();
            if (pData) {
                document.getElementById('p-img').src = pData.avatar_url || 'https://via.placeholder.com/150';
                document.getElementById('p-user').innerText = '@' + pData.username;
                document.getElementById('p-realname').innerText = pData.full_name;
                if (isMe) {
                    document.getElementById('upd-name').value = pData.full_name;
                    document.getElementById('upd-user').value = pData.username;
                    document.getElementById('curr-email').innerText = SESSION.email;
                }
            }

            const { count: followers } = await _db.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', uid);
            const { count: following } = await _db.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', uid);
            const { count: pc } = await _db.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', uid);
            document.getElementById('st-followers').innerText = followers || 0;
            document.getElementById('st-following').innerText = following || 0;
            document.getElementById('st-posts').innerText = pc || 0;

            const actions = document.getElementById('p-actions'); actions.innerHTML = '';
            if (!isMe) {
                const { data: r } = await _db.from('follows').select('*').eq('follower_id', SESSION.id).eq('followed_id', uid);
                const isF = r && r.length > 0;
                const b = document.createElement('button'); b.className = isF ? 'btn-ui' : 'btn-ui fill';
                b.innerText = isF ? 'Segui già' : 'Segui Profilo'; b.onclick = () => apiExecFollow(uid, isF); actions.appendChild(b);
            } else {
                const b = document.createElement('button'); b.className = 'btn-ui'; b.innerText = 'Impostazioni';
                b.onclick = () => { document.getElementById('p-settings-box').classList.toggle('hidden'); }; actions.appendChild(b);
            }

            const grid = document.getElementById('p-posts-grid'); grid.innerHTML = '';
            const { data: uPosts } = await _db.from('posts').select(`*, profiles(username, avatar_url), likes(count), comments(count)`).eq('user_id', uid).order('created_at', { ascending: false });
            if (!uPosts || uPosts.length === 0) grid.innerHTML = '<div class="text-center text-gray-700 py-16">Nessun contenuto nel portfolio.</div>';
            else renderPosts(uPosts, grid);

            document.getElementById('page-feed').classList.add('hidden');
            document.getElementById('page-profile').classList.remove('hidden');
        }

        function uiTriggerAvatar() { if (VIEW_PROFILE_ID === SESSION.id) document.getElementById('av-file').click(); }
        async function apiAvatarUpload() {
            const f = document.getElementById('av-file').files[0]; if (!f) return;
            const path = `${SESSION.id}/${Date.now()}`; await _db.storage.from('avatars').upload(path, f);
            const { data } = _db.storage.from('avatars').getPublicUrl(path);
            await _db.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', SESSION.id);
            apiLoadProfile(SESSION.id);
        }

        async function apiUpdateMetadata() {
            const f = document.getElementById('upd-name').value, u = document.getElementById('upd-user').value;
            await _db.from('profiles').update({ full_name: f, username: u.toLowerCase() }).eq('id', SESSION.id);
            alert('Dati aggiornati con successo.'); apiLoadProfile(SESSION.id);
        }

        /* --- ADVANCED SECURITY ENGINE --- */
        async function apiInitEmailChange() {
            const m = prompt("Inserisci il nuovo indirizzo email per l'account:");
            if (m) {
                const { error } = await _db.auth.updateUser({ email: m });
                if (error) alert(error.message);
                else alert("Una mail di conferma è stata inviata al nuovo indirizzo. Devi cliccare sul link per confermare.");
            }
        }
        async function apiInitPasswordReset() {
            if (confirm("Vuoi ricevere una mail sicura per reimpostare la tua password?")) {
                const { error } = await _db.auth.resetPasswordForEmail(SESSION.email);
                alert(error ? error.message : "Email di ripristino inviata.");
            }
        }

        /* --- INTERACTIONS ENGINE --- */
        async function apiHeart(pid) {
            const b = document.getElementById(`h-btn-${pid}`), n = document.getElementById(`h-num-${pid}`);
            const act = b.classList.contains('liked'); let v = parseInt(n.innerText);
            if (act) {
                b.classList.remove('liked', 'fa-solid'); b.classList.add('fa-regular'); n.innerText = Math.max(0, v - 1);
                await _db.from('likes').delete().eq('post_id', pid).eq('user_id', SESSION.id);
            } else {
                b.classList.add('liked', 'fa-solid'); b.classList.remove('fa-regular'); n.innerText = v + 1;
                await _db.from('likes').insert([{ post_id: pid, user_id: SESSION.id }]);
            }
        }
        async function syncHeart(pid) {
            const { data } = await _db.from('likes').select('*').eq('post_id', pid).eq('user_id', SESSION.id);
            const b = document.getElementById(`h-btn-${pid}`);
            if (b && data.length > 0) { b.classList.add('liked', 'fa-solid'); b.classList.remove('fa-regular'); }
        }

        async function apiInspectPost(pid) {
            ACTIVE_POST_ID = pid; uiModal('modal-detail');
            const box = document.getElementById('d-comments'); box.innerHTML = 'Caricamento interazioni...';
            const { data: p } = await _db.from('posts').select(`caption, profiles(username)`).eq('id', pid).single();
            if (p) {
                document.getElementById('d-user-top').innerText = '@' + p.profiles.username;
                document.getElementById('d-caption-top').innerText = p.caption;
            }
            const { data: c } = await _db.from('comments').select(`*, profiles(username, avatar_url)`).eq('post_id', pid).order('created_at', { ascending: true });
            box.innerHTML = ''; if (!c || c.length === 0) box.innerHTML = '<p class="text-center py-10 text-gray-600">Nessun commento presente.</p>';
            else c.forEach(x => {
                box.insertAdjacentHTML('beforeend', `
                    <div class="comm-row">
                        <img src="${x.profiles.avatar_url || 'https://via.placeholder.com/40'}" class="comm-avatar cursor-pointer" onclick="uiCloseModal('modal-detail'); apiLoadProfile('${x.user_id}')">
                        <div class="comm-text"><span class="font-bold mr-2 cursor-pointer" onclick="uiCloseModal('modal-detail'); apiLoadProfile('${x.user_id}')">@${uiSafe(x.profiles.username)}</span><span>${uiSafe(x.content)}</span></div>
                    </div>
                `);
            });
            setTimeout(() => { const s = document.getElementById('d-scroll'); s.scrollTop = s.scrollHeight; }, 100);
        }

        async function apiSubmitComment() {
            const f = document.getElementById('d-input'); const t = f.value.trim(); if (!t) return;
            await _db.from('comments').insert([{ post_id: ACTIVE_POST_ID, user_id: SESSION.id, content: t }]);
            f.value = ''; apiInspectPost(ACTIVE_POST_ID);
        }

        /* --- MEMBER EXPLORATION ENGINE --- */
        async function apiHandleSearch() {
            const q = document.getElementById('s-input').value.trim(), o = document.getElementById('s-results');
            if (q.length < 2) { o.innerHTML = ''; return; }
            const { data } = await _db.from('profiles').select('*').ilike('username', `%${q}%`).limit(15);
            o.innerHTML = ''; data.forEach(u => {
                o.insertAdjacentHTML('beforeend', `
                    <div class="search-item" onclick="uiCloseModal('modal-search'); apiLoadProfile('${u.id}')">
                        <img src="${u.avatar_url || 'https://via.placeholder.com/50'}" class="p-av-sm">
                        <span class="font-bold text-sm">@${uiSafe(u.username)}</span>
                        <span class="text-xs text-gray-600 ml-auto">${uiSafe(u.full_name)}</span>
                    </div>
                `);
            });
        }

        async function apiShowFollowers(type) {
            uiModal('modal-list'); document.getElementById('l-title').innerText = type === 'followers' ? 'Membri Follower' : 'Seguiti dal Profilo';
            const o = document.getElementById('l-results'); o.innerHTML = 'Interrogazione database...';
            const t = type === 'followers' ? 'follower_id' : 'followed_id', s = type === 'followers' ? 'followed_id' : 'follower_id';
            const { data: r } = await _db.from('follows').select(t).eq(s, VIEW_PROFILE_ID);
            if (!r || r.length === 0) { o.innerHTML = '<p class="text-center py-10 text-gray-600">Nessun membro trovato.</p>'; return; }
            const ids = r.map(x => x[t]); const { data: users } = await _db.from('profiles').select('*').in('id', ids);
            o.innerHTML = ''; users.forEach(u => {
                o.insertAdjacentHTML('beforeend', `
                    <div class="search-item" onclick="uiCloseModal('modal-list'); apiLoadProfile('${u.id}')">
                        <img src="${u.avatar_url || 'https://via.placeholder.com/50'}" class="p-av-sm">
                        <span class="font-bold text-sm">@${uiSafe(u.username)}</span>
                    </div>
                `);
            });
        }

        /* --- PUBLISHING ENGINE --- */
        async function apiPublish() {
            const cap = document.getElementById('c-caption').value, file = document.getElementById('c-file').files[0];
            if (!cap && !file) return alert("Inserisci contenuti per il post.");
            let url = null;
            if (file) {
                const p = `${SESSION.id}/post_${Date.now()}`; await _db.storage.from('posts').upload(p, file);
                url = _db.storage.from('posts').getPublicUrl(p).data.publicUrl;
            }
            const { error } = await _db.from('posts').insert([{ user_id: SESSION.id, image_url: url, caption: cap }]);
            if (error) alert("Errore di rete."); else { uiCloseModal('modal-create'); apiLoadProfile(SESSION.id); }
        }

        async function apiKillPost(pid) { if (confirm("Sei sicuro di voler rimuovere questa creazione dal tuo portfolio?")) { await _db.from('posts').delete().eq('id', pid); apiLoadProfile(SESSION.id); } }
        async function apiExecFollow(uid, f) {
            if (f) await _db.from('follows').delete().eq('follower_id', SESSION.id).eq('followed_id', uid);
            else await _db.from('follows').insert([{ follower_id: SESSION.id, followed_id: uid }]);
            apiLoadProfile(uid);
        }
    </script>
</body>
</html>
