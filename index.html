<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — AI Fashion & Shopping</title>

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://fonts.googleapis.com">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest" defer></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@1,400&display=swap" rel="stylesheet">

  <style>
    /* --- VARIABILI DESIGN --- */
    :root {
      --bg-deep: #0f172a;        
      --bg-panel: rgba(15, 23, 42, 0.95); 
      --text-main: #f8fafc;      
      --text-muted: #94a3b8;    
      --gold: #d4af37;          
      --gold-glow: rgba(212, 175, 55, 0.2);
      --red-like: #ef4444;
      --glass-border: 1px solid rgba(212, 175, 55, 0.3);
    }

    body { 
      background-color: var(--bg-deep); 
      color: var(--text-main); 
      font-family: 'Outfit', sans-serif; 
      margin: 0; 
      overflow-x: hidden; 
      background: radial-gradient(circle at top center, #1e293b 0%, #020617 80%);
      min-height: 100vh;
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg-deep); }
    ::-webkit-scrollbar-thumb { background: var(--gold); border-radius: 10px; }
    .hidden { display: none !important; }

    /* --- SIDEBAR --- */
    .app-layout { display: flex; max-width: 1200px; margin: 0 auto; min-height: 100vh; }

    .sidebar { 
      width: 80px; 
      position: sticky; 
      top: 20px; 
      height: calc(100vh - 40px);
      margin-left: 10px;
      padding: 30px 0;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      background: var(--bg-panel);
      backdrop-filter: blur(12px);
      border: var(--glass-border);
      border-radius: 40px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      z-index: 50;
      /* Ottimizzazione rendering */
      will-change: transform;
    }

    .brand-logo-icon {
      font-family: 'Playfair Display', serif;
      font-weight: bold;
      font-size: 24px;
      color: var(--gold);
      margin-bottom: 40px;
      cursor: pointer;
      border: 1px solid var(--gold);
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      box-shadow: 0 0 10px var(--gold-glow);
    }

    .nav-item { 
      width: 48px; height: 48px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%; 
      cursor: pointer; 
      transition: all 0.3s ease; 
      color: var(--text-muted);
      margin-bottom: 20px;
      font-size: 20px;
      position: relative;
    }
    
    .nav-item:hover, .nav-item.active { 
      background: rgba(212, 175, 55, 0.15); 
      color: var(--gold); 
      box-shadow: 0 0 15px var(--gold-glow);
      transform: scale(1.1);
    }
    
    .nav-item:hover::after {
      content: attr(title);
      position: absolute;
      left: 60px;
      background: var(--gold);
      color: #000;
      padding: 4px 8px;
      font-size: 10px;
      border-radius: 4px;
      font-weight: bold;
      white-space: nowrap;
      opacity: 1;
      pointer-events: none;
    }

    /* --- FEED & POSTS --- */
    .main-content { flex: 1; padding: 40px; max-width: 700px; margin: 0 auto; }

    .feed-tabs-container {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 30px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .feed-tab {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      padding: 5px 10px;
      transition: all 0.3s ease;
      position: relative;
    }

    .feed-tab.active {
      color: #fff;
      text-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
    }

    .feed-tab.active::after {
      content: '';
      position: absolute;
      bottom: -12px;
      left: 50%;
      transform: translateX(-50%);
      width: 25px;
      height: 3px;
      background: var(--gold);
      border-radius: 2px;
      box-shadow: 0 0 10px var(--gold);
    }

    .post-card { 
      background: rgba(30, 41, 59, 0.4);
      margin-bottom: 40px; 
      padding: 20px;
      border-radius: 20px;
      border: 1px solid var(--gold);
      box-shadow: 0 0 20px var(--gold-glow);
      transition: transform 0.3s ease;
      /* Ottimizzazione */
      content-visibility: auto; 
    }
    
    .post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .user-badge { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .user-avatar { 
      width: 42px; height: 42px; 
      border-radius: 50%; object-fit: cover; 
      border: 2px solid var(--gold);
    }
    .user-meta { display: flex; flex-direction: column; }
    .username { font-weight: 600; font-size: 15px; color: #fff; }
    .post-date { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

    .post-img-container {
      position: relative;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.1);
      background: #000; /* Placeholder colore */
      min-height: 200px;
    }
    .post-img { width: 100%; display: block; cursor: pointer; opacity: 0; transition: opacity 0.5s; }
    .post-img.loaded { opacity: 1; }

    /* SHOP TAG */
    .shop-tag-overlay {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      padding: 8px 12px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid var(--gold);
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 10;
    }
    .shop-tag-overlay:hover {
      background: var(--gold);
      transform: scale(1.05);
      box-shadow: 0 0 15px var(--gold-glow);
    }
    .shop-tag-overlay span { font-size: 12px; font-weight: bold; color: white; }
    .shop-tag-overlay i { color: var(--gold); font-size: 14px; }

    .action-bar { display: flex; gap: 24px; margin-top: 20px; padding: 0 5px; }
    .icon-btn { 
      font-size: 24px; cursor: pointer; transition: 0.2s; color: var(--text-main); opacity: 0.7; 
      display: flex; align-items: center; gap: 8px;
    }
    .icon-btn:hover { opacity: 1; transform: translateY(-2px); color: var(--gold); }
    .likes-count-clickable { font-size: 14px; font-weight: 600; color: #fff; cursor: pointer; }
    .likes-count-clickable:hover { text-decoration: underline; color: var(--gold); }

    .caption-box { margin-top: 15px; padding: 0 5px; font-size: 15px; line-height: 1.6; color: #cbd5e1; }
    .caption-user { font-weight: 700; color: var(--gold); margin-right: 8px; cursor: pointer; }
    .heart-filled { color: var(--red-like) !important; opacity: 1 !important; }

    /* BUTTONS */
    .btn-gold {
      background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);
      color: #000; padding: 12px 24px; border-radius: 12px;
      font-weight: 700; border: none; cursor: pointer;
      box-shadow: 0 4px 15px rgba(248, 181, 0, 0.4);
      transition: 0.3s;
    }
    .btn-gold:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(248, 181, 0, 0.6); }
    .btn-gold-outline {
      border: 1px solid var(--gold);
      color: var(--gold); padding: 8px 16px; border-radius: 8px;
      font-weight: 600; cursor: pointer; background: transparent; transition: 0.2s;
    }
    .btn-gold-outline:hover { background: rgba(212, 175, 55, 0.1); }
    .empty-feed-box {
      text-align: center; padding: 60px 20px;
      background: rgba(255,255,255,0.03); border: 1px dashed var(--gold);
      border-radius: 20px; color: #ccc;
    }

    /* LOGIN SCREEN - OTTIMIZZATO */
    .split-layout { 
      display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:200; 
      background:#0a0a0a; 
      transition: transform 0.6s cubic-bezier(0.22, 1, 0.36, 1); /* Animazione più fluida */
      will-change: transform;
    }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{ 
      position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; 
      filter:grayscale(100%); opacity:0; transition:opacity 1.5s ease, filter .8s ease; 
      z-index:0; pointer-events:none; 
    }
    .visual-side img.active{ opacity:1; z-index:1; pointer-events:auto; }
    .visual-side img.active:hover{ filter:grayscale(0%); cursor:crosshair; }
    
    .form-side{ flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; background:#0a0a0a; max-width:600px; margin:auto }
    .input-group{ margin-bottom:25px }
    .input-label{ display:block; font-size:10px; text-transform:uppercase; letter-spacing:2px; color:#555; margin-bottom:8px }
    input.auth-input{ background:transparent; border-bottom:1px solid #222; padding:10px 0; color:#fff; width:100%; outline:none; font-size:14px; border-top:none; border-left:none; border-right:none; border-radius:0; }
    input.auth-input:focus{ border-bottom-color:#fff }
    .btn-white{ background:#fff; color:#000; padding:18px; font-weight:500; text-transform:uppercase; width:100%; cursor:pointer; border:1px solid #fff; transition:.3s; margin-top:10px }
    .btn-white:hover{ background:#000; color:#fff }
    .link-small{ text-align:center; margin-top:20px; font-size:10px; color:#555; cursor:pointer; text-transform:uppercase; letter-spacing:1px }

    /* --- MODALS & Z-INDEX FIX --- */
    .modal-overlay { 
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(0,0,0, 0.9); backdrop-filter: blur(5px); 
        z-index: 100; /* LIVELLO BASE */
        display: flex; justify-content: center; align-items: center; 
    }
    
    /* Z-INDEX GERARCHIA: Shop deve essere sopra il Dettaglio */
    #post-detail-modal { z-index: 150; }
    #shop-modal { z-index: 9999 !important; } /* FORZIAMO SOPRA TUTTO */

    .glass-modal { background: #1e293b; border: 1px solid var(--gold); border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(212, 175, 55, 0.2); }
    
    .detail-layout { display: flex; width: 90vw; max-width: 1100px; height: 85vh; }
    .detail-img-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
    .detail-img-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .detail-info-side { flex: 1; display: flex; flex-direction: column; background: #1e293b; min-width: 350px; position: relative; }
    
    @media (max-width: 800px) {
      .sidebar { 
        width: 100%; height: 60px; position: fixed; bottom: 0; top: auto; left: 0; margin: 0; 
        flex-direction: row; justify-content: space-around; padding: 0; border-radius: 20px 20px 0 0;
        background: rgba(15, 23, 42, 0.98); border-top: 1px solid var(--gold); border: none;
      }
      .brand-logo-icon { display: none; }
      .nav-item { margin: 0; }
      .nav-item::after { display: none; }
      .main-content { padding: 20px 10px 100px 10px; }
      .detail-layout { flex-direction: column; height: 100%; border-radius: 0; width: 100%; }
      .app-layout { display: block; }
    }

    /* CHAT & NOTIFICATIONS */
    .gold-dot { width: 10px; height: 10px; background: var(--gold); border-radius: 50%; position: absolute; top: 10px; right: 10px; box-shadow: 0 0 8px var(--gold); display: none; z-index: 60; }
    .msg-bubble { max-width: 75%; padding: 10px 15px; border-radius: 15px; font-size: 14px; line-height: 1.4; margin-bottom: 8px; position: relative; }
    .msg-mine { background: var(--gold); color: #000; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-theirs { background: rgba(255,255,255,0.1); color: #fff; align-self: flex-start; border-bottom-left-radius: 2px; }
    .inbox-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
    .inbox-item:hover { background: rgba(255,255,255,0.05); }
    .unread-indicator { width: 8px; height: 8px; background: var(--gold); border-radius: 50%; margin-left: auto; }

    /* SHARED POST */
    .shared-post-bubble {
        background: #000 !important; border: 1px solid var(--gold); border-radius: 12px !important;
        padding: 0 !important; overflow: hidden; cursor: pointer; transition: transform 0.2s; width: 200px;
    }
    .shared-post-bubble:hover { transform: scale(1.02); }
    .shared-post-img { width: 100%; height: 150px; object-fit: cover; }
    .shared-post-info { padding: 8px; text-align: center; font-size: 10px; color: #ccc; background: rgba(255,255,255,0.1); }

    /* TOAST */
    .toast-box { position: fixed; top: 20px; right: 20px; background: rgba(15, 23, 42, 0.95); border: 1px solid var(--gold); padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; color: #fff; z-index: 2000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); transform: translateX(200%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toast-active { transform: translateX(0); }

    /* MULTI SHOP LIST */
    .added-product-item {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; margin-bottom: 5px;
        border: 1px solid rgba(255,255,255,0.1);
    }
    .added-product-item span { font-size: 12px; color: #ddd; }
    .shop-list-container { max-height: 300px; overflow-y: auto; padding-right: 5px; }
    
    /* ANALISI AI */
    .analyzing-box {
        position: absolute; inset: 0; background: rgba(0,0,0,0.8);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-radius: 12px; z-index: 10;
    }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active" loading="eager">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200" loading="lazy">
  </div>
  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic text-white" style="font-family: 'Playfair Display', serif;">Hawenishland</h1>
    <div id="msg-box" class="hidden p-2 text-center mb-4 text-xs border border-gray-600 rounded"></div>
    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass" class="auth-input"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small">Non hai un account? <b>Iscriviti</b></p>
    </div>
    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username</label><input type="text" id="r-username" class="auth-input"></div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome" class="auth-input"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome" class="auth-input"></div>
      </div>
      <div class="input-group"><label class="input-label">Nascita</label><input type="date" id="r-nascita" class="auth-input" style="color-scheme:dark"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass" class="auth-input"></div>
      <button onclick="faiRegistrazione()" class="btn-white">Registrati</button>
      <p onclick="vaiA('login')" class="link-small">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    <div class="sidebar">
      <div class="brand-logo-icon" onclick="renderFeedView()" title="Home">H</div>
      <div class="nav-item active" onclick="renderFeedView()" title="Feed">
        <i class="fa-solid fa-house"></i>
      </div>
      <div class="nav-item" onclick="openSearchModal()" title="Cerca">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <div class="nav-item" onclick="openUploadModal()" title="Nuovo Post">
        <i class="fa-solid fa-plus"></i>
      </div>
      <div class="nav-item relative" onclick="openNotificationsModal()" title="Notifiche">
        <div id="notif-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-bell"></i>
      </div>
      <div class="nav-item relative" onclick="openInboxModal()" title="Messaggi">
        <div id="global-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-envelope"></i>
      </div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)" title="Profilo">
        <i class="fa-solid fa-user"></i>
      </div>
      <div style="margin-top:auto"></div>
      <div class="nav-item text-red-400 hover:text-red-500" onclick="logout()" title="Esci">
        <i class="fa-solid fa-power-off"></i>
      </div>
    </div>
    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="toast-notif" class="toast-box">
  <div class="text-[#d4af37] text-xl"><i class="fa-solid fa-bolt"></i></div>
  <div>
    <h4 class="text-sm font-bold text-[#d4af37]">New Activity</h4>
    <p class="text-xs text-gray-300" id="toast-msg">Someone interacted with you.</p>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
      <h3 class="font-bold text-lg text-white">Crea Outfit</h3>
      <i class="fa-solid fa-xmark cursor-pointer hover:text-white text-gray-400" onclick="closeModal('upload-modal')"></i>
    </div>
    <div class="flex flex-col gap-4 max-h-[80vh] overflow-y-auto pr-1 relative">
      
      <label class="h-32 border-2 border-dashed border-gray-600 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-[#d4af37] hover:bg-white/5 transition relative overflow-hidden">
        <i class="fa-solid fa-camera text-2xl mb-2 text-[#d4af37]"></i>
        <span class="text-xs text-gray-400">Carica Foto Outfit</span>
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
        <div id="ai-loading" class="hidden analyzing-box">
            <i class="fa-solid fa-brain fa-spin text-3xl text-[#d4af37] mb-2"></i>
            <span class="text-xs text-white font-bold">L'AI sta giudicando...</span>
        </div>
      </label>
      
      <img id="upload-preview" class="hidden w-full h-32 object-cover rounded-xl shadow-lg border border-gray-600">
      
      <div id="ai-error-msg" class="hidden p-3 bg-red-500/20 border border-red-500 rounded-lg text-red-200 text-xs text-center">
        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Ops! Questa foto non sembra riguardare la moda.
      </div>

      <div id="upload-details-section" class="hidden">
          <div class="bg-slate-800/50 p-3 rounded-xl border border-dashed border-gray-600 mb-4">
            <p class="text-[#d4af37] text-xs font-bold uppercase mb-2"><i class="fa-solid fa-tags mr-1"></i> Tagga Prodotti (OBBLIGATORIO)</p>
            <div class="flex gap-2 mb-2">
               <input type="text" id="temp-prod-name" placeholder="Nome (es. Scarpe Nike)" class="flex-1 bg-slate-900 border border-gray-700 rounded-lg p-2 text-white text-xs focus:border-[#d4af37] outline-none">
               <input type="url" id="temp-prod-link" placeholder="Link..." class="flex-1 bg-slate-900 border border-gray-700 rounded-lg p-2 text-white text-xs focus:border-[#d4af37] outline-none">
            </div>
            <button onclick="addProdToUpload()" class="btn-gold-outline w-full text-xs py-2 mb-2">+ Aggiungi al Look</button>
            <div id="upload-products-list" class="space-y-1"></div>
          </div>

          <textarea id="post-caption" rows="2" placeholder="Descrivi il tuo stile..." class="w-full bg-slate-800 border-none rounded-xl p-3 text-white focus:ring-1 focus:ring-[#d4af37] outline-none mb-4"></textarea>
          <button id="btn-publish" onclick="submitPost()" class="btn-gold w-full">PUBBLICA LOOK</button>
      </div>
    </div>
  </div>
</div>

<div id="share-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between font-bold text-white">
      <span>Invia a...</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('share-modal')"></i>
    </div>
    <div id="share-list-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="shop-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[380px] p-6 text-center relative">
    <i class="fa-solid fa-xmark absolute top-4 right-4 text-white cursor-pointer text-xl" onclick="closeModal('shop-modal')"></i>
    <div class="inline-flex items-center justify-center w-14 h-14 rounded-full bg-[#d4af37]/20 mb-3 border border-[#d4af37]">
      <i class="fa-solid fa-bag-shopping text-xl text-[#d4af37]"></i>
    </div>
    <h3 class="text-white font-serif text-2xl mb-1 italic" style="font-family: 'Playfair Display', serif;">Shop the Look</h3>
    <div class="w-10 h-0.5 bg-[#d4af37] mx-auto mb-6"></div>
    <div id="shop-window-list" class="shop-list-container bg-slate-800/50 p-2 rounded-xl border border-white/10 mb-4 space-y-3"></div>
    <p class="text-[10px] text-gray-500">I link portano a siti esterni.</p>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
      <input type="text" id="search-query" class="bg-transparent text-white w-full outline-none placeholder-gray-500 text-lg" placeholder="Cerca persone..." onkeyup="performSearch()">
      <i class="fa-solid fa-xmark cursor-pointer ml-2 text-white" onclick="closeModal('search-modal')"></i>
    </div>
    <div id="search-results" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between font-bold text-white">
      <span id="ul-title">Lista</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('user-list-modal')"></i>
    </div>
    <div id="ul-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="likes-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between font-bold text-white">
      <span>Mi piace</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('likes-list-modal')"></i>
    </div>
    <div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="glass-modal detail-layout">
    <div class="detail-img-side">
      <img id="detail-img" src="">
      <div id="detail-noimg" class="hidden text-gray-500">Solo Testo</div>
      <div id="detail-shop-btn"></div>
    </div>
    <div class="detail-info-side">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <div class="flex items-center gap-3 cursor-pointer" id="detail-user-link">
          <img id="detail-avatar" src="" class="w-8 h-8 rounded-full object-cover border border-[#d4af37]">
          <span id="detail-username" class="font-bold text-sm text-white"></span>
        </div>
        <div class="flex items-center gap-4">
          <div id="detail-delete-btn-container"></div>
          <i class="fa-solid fa-xmark cursor-pointer text-lg hover:text-white text-gray-400" onclick="closeModal('post-detail-modal')"></i>
        </div>
      </div>
      <div id="detail-comments" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
      <div class="p-4 border-t border-gray-700 bg-slate-900">
        <div class="flex gap-4 text-2xl mb-3 items-center">
          <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer transition text-white"></i>
          <i class="fa-regular fa-comment text-white"></i>
          <i id="detail-shop-icon" class="fa-solid fa-bag-shopping text-[#d4af37] cursor-pointer hidden"></i>
        </div>
        <div class="font-bold text-sm mb-3 text-white">
            <span id="detail-likes-count" class="cursor-pointer hover:underline hover:text-[#d4af37]">0</span> Mi piace
        </div>
        <div class="flex gap-2">
          <input type="text" id="new-comment" placeholder="Commenta..." class="flex-1 bg-transparent outline-none text-white text-sm">
          <button onclick="inviaCommento()" class="text-[#d4af37] font-bold text-sm">INVIA</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <h2 class="text-xl font-bold mb-4 text-center text-white">Modifica Profilo</h2>
    <div class="flex flex-col items-center mb-6">
      <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border-4 border-[#d4af37] mb-2">
      <label class="text-[#d4af37] text-sm font-bold cursor-pointer hover:text-white">Cambia Foto<input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar(this)"></label>
    </div>
    <div class="space-y-4">
      <div><label class="text-xs text-gray-500 uppercase font-bold">Username</label><input id="edit-username" type="text" class="w-full bg-slate-800 p-2 rounded text-white border border-slate-700"></div>
      <div><label class="text-xs text-gray-500 uppercase font-bold">Nome Completo</label><input id="edit-fullname" type="text" class="w-full bg-slate-800 p-2 rounded text-white border border-slate-700"></div>
      <div class="flex gap-3 pt-2">
        <button onclick="saveProfile()" class="flex-1 btn-gold">Salva</button>
        <button onclick="closeModal('edit-profile-modal')" class="flex-1 border border-gray-600 py-2 rounded-lg text-white hover:bg-white/10">Annulla</button>
      </div>
    </div>
  </div>
</div>

<div id="inbox-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[550px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
      <h3 class="font-bold text-lg text-white">Messaggi</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-white" onclick="closeModal('inbox-modal')"></i>
    </div>
    <div id="inbox-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="notifications-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[550px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between items-center">
      <h3 class="font-bold text-lg text-white">Notifiche</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-white" onclick="closeModal('notifications-modal')"></i>
    </div>
    <div id="notifications-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="chat-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[550px] flex flex-col">
    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-slate-900/50">
      <div class="flex items-center gap-3">
        <img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full border border-[#d4af37]">
        <span id="chat-header-name" class="font-bold text-white">Chat</span>
      </div>
      <i class="fa-solid fa-xmark cursor-pointer text-white" onclick="closeChat()"></i>
    </div>
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-slate-900/20"></div>
    <div class="p-4 border-t border-gray-700 flex gap-2">
      <input type="text" id="chat-input" placeholder="Scrivi un messaggio..." class="flex-1 bg-slate-800 border-none rounded-xl p-3 text-white outline-none focus:ring-1 focus:ring-[#d4af37]" onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="btn-gold !p-3 !rounded-full w-12 h-12 flex items-center justify-center"><i class="fa-regular fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<script>
  // --- CONFIGURAZIONE SUPABASE ---
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  // Nota: sb verrà inizializzato in initApp perché lo script è defer
  let sb = null;
  
  // --- COSTANTI E VARIABILI GLOBALI ---
  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';
  
  let currentUser = null;
  let currentPostId = null;
  let activeChatId = null;
  let chatSub = null;
  let currentFeedMode = 'following'; 
  let uploadProductsList = []; 
  let sharePostId = null;
  let allPostsCache = {}; // Cache per i post
   
  // --- AI CONFIGURATION ---
  let classifierModel = null;
  const FASHION_KEYWORDS = [
    'shirt', 'pants', 'jean', 'dress', 'suit', 'shoe', 'boot', 'sandal', 'hat', 
    'sunglasses', 'jacket', 'coat', 'sweater', 'jersey', 'cardigan', 'skirt', 
    'tie', 't-shirt', 'blouse', 'trousers', 'shorts', 'footwear', 'outerwear',
    'miniskirt', 'maillot', 'tank suit', 'bikini', 'kimono', 'abaya', 'gown',
    'cloak', 'lab coat', 'pajama', 'velvet', 'wool', 'tie', 'bow tie', 'apron',
    'stole', 'necklace', 'wardrobe', 'closet', 'fashion', 'person', 'groom', 'bride',
    'uniform', 'vestment', 'trench coat', 'sweatshirt', 'Loafer', 'clog', 'bag', 'purse'
  ];

  // --- INIT (OPTIMIZED) ---
  // Usiamo DOMContentLoaded invece di load per rendere tutto molto più veloce
  document.addEventListener('DOMContentLoaded', async () => {
    // 1. Inizializza Supabase subito se lo script è caricato, altrimenti aspetta un attimo
    if(window.supabase) {
        initApp();
    } else {
        // Fallback nel caso lo script sia lento
        window.addEventListener('load', initApp);
    }
    
    // 2. Carosello Login (Indipendente)
    startLoginCarousel();
  });

  async function initApp() {
    if(!sb) sb = window.supabase.createClient(SB_URL, SB_KEY);
    
    // Check Sessione IMMEDIATAMENTE - non aspettare l'AI
    const { data: { session }, error } = await sb.auth.getSession();
    if (session && !error) {
        enterApp(session.user);
    } else {
        document.getElementById('auth-container').style.display = 'flex';
    }

    // 3. Carica l'AI in BACKGROUND dopo 2 secondi, così non blocca il login
    setTimeout(loadAIModel, 2000);
  }

  function startLoginCarousel() {
    let i = 0; 
    const imgs = document.querySelectorAll('.visual-side img');
    if (imgs.length) { 
        setInterval(() => { 
            imgs[i].classList.remove('active'); 
            i = (i + 1) % imgs.length; 
            imgs[i].classList.add('active'); 
        }, 5000); 
    }
  }

  async function loadAIModel() {
      try {
        if (typeof mobilenet !== 'undefined') {
            classifierModel = await mobilenet.load();
            console.log("AI Model Loaded in Background");
        }
      } catch(e) { 
        console.error("AI Loading deferred error (non-critical):", e); 
      }
  }

  // --- GESTIONE AUTH ---
  function mess(t,e){
      const b=document.getElementById('msg-box');
      b.innerText=t;
      b.classList.remove('hidden');
      b.style.borderColor=e?'red':'green';
      b.style.color=e?'red':'green';
  }

  function vaiA(m){ 
      document.getElementById('login-form').classList.toggle('hidden',m==='signup'); 
      document.getElementById('signup-form').classList.toggle('hidden',m==='login'); 
  }

  async function faiLogin() { 
      const {data,error}=await sb.auth.signInWithPassword({ 
          email:document.getElementById('l-email').value, 
          password:document.getElementById('l-pass').value 
      }); 
      if(error) mess(error.message,true); 
      else enterApp(data.user); 
  }

  async function faiRegistrazione() { 
      const {data,error}=await sb.auth.signUp({ 
          email:document.getElementById('r-email').value, 
          password:document.getElementById('r-pass').value 
      }); 
      if(error) return mess(error.message,true); 
      if(data.user) {
          await sb.from('profiles').insert([{ 
              id:data.user.id, 
              username:document.getElementById('r-username').value 
          }]); 
      }
      mess("Registrazione OK!"); 
  }

  async function logout() { 
      await sb.auth.signOut(); 
      location.reload(); 
  }

  async function recuperoPassword() {
    const email = document.getElementById('l-email').value;
    if(!email) return alert("Inserisci l'email per il recupero");
    const { error } = await sb.auth.resetPasswordForEmail(email);
    alert(error ? error.message : "Email di recupero inviata!");
  }

  function enterApp(u) { 
    currentUser=u; 
    document.getElementById('auth-container').style.transform = "translateY(-100vh)"; 
    setTimeout(async ()=>{ 
      document.getElementById('auth-container').classList.add('hidden'); 
      document.getElementById('app-interface').classList.remove('hidden'); 
      
      renderFeedView(); 
      checkNotifications(); 
      checkAppNotifications(); 

      // Realtime Listeners
      sb.channel('global-updates')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          if(payload.new.receiver_id === currentUser.id) checkNotifications();
        })
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'notifications',
          filter: `recipient_id=eq.${currentUser.id}`
        }, payload => {
          if (!payload?.new) return;
          if (payload.new.type === 'like') showToast("Someone liked your post!");
          if (payload.new.type === 'comment') showToast("New comment on your post!");
          if (payload.new.type === 'follow') showToast("Nuovo follower!");
          checkAppNotifications();
        })
        .subscribe();
    },600); 
  }

  // --- GESTIONE UI (MODALI) ---
  function closeModal(id) { 
      document.getElementById(id).classList.add('hidden'); 
  }
  function openUploadModal() { 
      document.getElementById('upload-modal').classList.remove('hidden'); 
      // Se l'AI non si è ancora caricata per qualche motivo, riprova ora
      if(!classifierModel) loadAIModel();
  }
  function openSearchModal() { 
      document.getElementById('search-modal').classList.remove('hidden'); 
      document.getElementById('search-query').focus(); 
  }

  // --- AI CHECK ---
  async function checkImageContent(imgElement) {
    if (!classifierModel) {
        // Se il modello non è pronto, prova a caricarlo al volo
        try {
             if (typeof mobilenet !== 'undefined') {
                classifierModel = await mobilenet.load();
             } else {
                 return true; // Se fallisce, lasciamo passare (fail open)
             }
        } catch(e) { return true; }
    }
    
    try {
        const predictions = await classifierModel.classify(imgElement);
        return predictions.some(p => {
            const terms = p.className.toLowerCase().split(','); 
            return terms.some(term => FASHION_KEYWORDS.some(k => term.trim().includes(k) || k.includes(term.trim())));
        });
    } catch (e) { return true; }
  }

  function previewUpload(input) { 
    if(input.files && input.files[0]) { 
        const loadingBox = document.getElementById('ai-loading');
        const previewImg = document.getElementById('upload-preview');
        const detailsSection = document.getElementById('upload-details-section');
        const errorMsg = document.getElementById('ai-error-msg');
        
        previewImg.classList.add('hidden'); 
        detailsSection.classList.add('hidden'); 
        errorMsg.classList.add('hidden'); 
        loadingBox.classList.remove('hidden');

        const r = new FileReader(); 
        r.onload = async (e) => { 
            previewImg.src = e.target.result; 
            previewImg.onload = async () => {
                try {
                    const isApproved = await checkImageContent(previewImg);
                    loadingBox.classList.add('hidden'); 
                    previewImg.classList.remove('hidden');
                    if (isApproved) {
                        detailsSection.classList.remove('hidden');
                    } else { 
                        errorMsg.classList.remove('hidden'); 
                        input.value = ""; 
                    }
                } catch (err) {
                    loadingBox.classList.add('hidden'); 
                    previewImg.classList.remove('hidden'); 
                    detailsSection.classList.remove('hidden');
                }
            };
        }; 
        r.readAsDataURL(input.files[0]); 
    } 
  }

  // --- GESTIONE PRODOTTI (SHOP) E UPLOAD ---
  function addProdToUpload() {
    const n = document.getElementById('temp-prod-name');
    const l = document.getElementById('temp-prod-link');
    if(!n.value.trim() || !l.value.trim()) return alert("Inserisci nome e link.");
    
    uploadProductsList.push({ name: n.value.trim(), link: l.value.trim() });
    n.value = ''; 
    l.value = ''; 
    renderUploadProductsList();
  }

  function removeProdFromUpload(index) { 
      uploadProductsList.splice(index, 1); 
      renderUploadProductsList(); 
  }

  function renderUploadProductsList() {
    const c = document.getElementById('upload-products-list'); 
    c.innerHTML = '';
    uploadProductsList.forEach((p, i) => {
        c.insertAdjacentHTML('beforeend', `
            <div class="added-product-item">
                <div class="truncate mr-2">
                    <div class="text-[#d4af37] font-bold text-xs">${escapeHtml(p.name)}</div>
                    <div class="text-[10px] text-gray-500 truncate">${escapeHtml(p.link)}</div>
                </div>
                <i class="fa-solid fa-trash text-gray-400 hover:text-red-500 cursor-pointer text-xs" onclick="removeProdFromUpload(${i})"></i>
            </div>
        `);
    });
  }

  async function submitPost() { 
    const f = document.getElementById('post-file').files[0];
    const c = document.getElementById('post-caption').value; 
    
    const pn = document.getElementById('temp-prod-name').value.trim();
    const pl = document.getElementById('temp-prod-link').value.trim();
    if(pn && pl) uploadProductsList.push({ name: pn, link: pl });

    if(!uploadProductsList.length) return alert("Devi inserire almeno un prodotto (Nome e Link).");
    if(!f) return alert("Foto obbligatoria.");
    
    document.getElementById('btn-publish').innerText = "Pubblicazione...";
    try {
        const n = `${currentUser.id}/${Date.now()}`; 
        const { error: ue } = await sb.storage.from(BUCKET_POSTS).upload(n, f); 
        if(ue) throw ue;
        const { data: { publicUrl } } = sb.storage.from(BUCKET_POSTS).getPublicUrl(n);
        
        const { error: ie } = await sb.from('posts').insert([{ 
            user_id: currentUser.id, 
            image_url: publicUrl, 
            caption: c, 
            products: uploadProductsList 
        }]); 
        if(ie) throw ie;
        
        // Reset Form
        uploadProductsList = [];
        document.getElementById('upload-products-list').innerHTML = '';
        document.getElementById('post-caption').value = '';
        document.getElementById('post-file').value = '';
        document.getElementById('upload-preview').classList.add('hidden');
        document.getElementById('upload-details-section').classList.add('hidden');

        closeModal('upload-modal'); 
        renderFeedView();
    } catch(err) { 
        alert("Errore: " + err.message); 
    }
    document.getElementById('btn-publish').innerText = "PUBBLICA LOOK";
  }

  // --- NUOVA LOGICA APERTURA SHOP ---
  function openShopWindow(postId, event) {
    if(event) event.stopPropagation();
    
    // Recupera il post dalla cache
    const post = allPostsCache[postId];
    if (!post) return;

    let p = [];
    if (post.products && Array.isArray(post.products) && post.products.length > 0) {
        p = post.products;
    } else if (post.product_link) {
        p.push({name: post.product_name || 'Prodotto', link: post.product_link});
    }

    const c = document.getElementById('shop-window-list'); 
    c.innerHTML = '';
    
    if(!p.length) return;
    
    p.forEach(x => {
        let lnk = x.link;
        if(!lnk.startsWith('http')) lnk = 'https://' + lnk;
        c.insertAdjacentHTML('beforeend', `
            <div class="bg-black/30 p-3 rounded-lg border border-white/5 flex items-center justify-between">
                <div class="text-left overflow-hidden mr-2">
                    <div class="font-bold text-white text-sm truncate">${escapeHtml(x.name)}</div>
                    <div class="text-[10px] text-gray-400">Clicca per acquistare</div>
                </div>
                <a href="${lnk}" target="_blank" class="bg-[#d4af37] text-black px-3 py-1 rounded text-xs font-bold hover:scale-105 transition flex-shrink-0 z-50 relative" style="pointer-events:auto">
                    GO <i class="fa-solid fa-arrow-right ml-1"></i>
                </a>
            </div>
        `);
    });
    
    document.getElementById('shop-modal').classList.remove('hidden');
  }

  // --- FEED E POSTS ---
  function switchFeedMode(mode) { 
      if (currentFeedMode !== mode) { 
          currentFeedMode = mode; 
          renderFeedView(); 
      } 
  }

  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    if(document.getElementById('view-profile-active')) document.getElementById('view-profile-active').remove();
    
    main.innerHTML = `
        <div class="feed-tabs-container">
            <div class="feed-tab ${currentFeedMode === 'following' ? 'active' : ''}" onclick="switchFeedMode('following')">Seguiti</div>
            <div class="feed-tab ${currentFeedMode === 'viral' ? 'active' : ''}" onclick="switchFeedMode('viral')">Per Te</div>
        </div>
        <div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-[#d4af37]"></i></div>
    `;

    let posts = [], error = null;
    
    if (currentFeedMode === 'following') {
        const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
        const ids = follows ? follows.map(f => f.followed_id) : [];
        if (ids.length) { 
            const res = await sb.from('posts').select(`*, profiles:user_id (username, avatar_url)`).in('user_id', ids).order('created_at', { ascending: false }); 
            posts = res.data; error = res.error; 
        }
    } else {
        const res = await sb.from('posts').select(`*, profiles:user_id (username, avatar_url)`).order('created_at', { ascending: false }).limit(50); 
        posts = res.data; error = res.error;
    }

    if (error) return main.innerHTML += `<p class="text-center text-red-500 mt-10">Errore caricamento feed.</p>`;
    if (!posts || !posts.length) return main.innerHTML += `<div class="empty-feed-box"><i class="fa-solid fa-user-plus text-4xl mb-4 text-[#d4af37]"></i><h2 class="text-xl font-bold mb-2">Feed Vuoto</h2><p class="text-gray-400 mb-6">Nessun post da mostrare.</p></div>`;

    // Rimuovi spinner
    const spinner = main.querySelector('.fa-spinner').parentNode;
    if(spinner) spinner.remove();

    // Aggiorna cache
    posts.forEach(p => allPostsCache[p.id] = p);

    // Usiamo un frammento per minimizzare i reflow
    const fragment = document.createDocumentFragment();
    for (const post of posts) {
      const counts = await getPostCounts(post.id);
      const likedByMe = await isLikedByMe(post.id);
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = createPostHTML(post, counts, likedByMe);
      fragment.appendChild(tempDiv.firstElementChild);
    }
    main.appendChild(fragment);
    
    // Attiva le immagini con fade-in
    setTimeout(() => {
        document.querySelectorAll('.post-img').forEach(img => img.classList.add('loaded'));
    }, 100);
  }

  function createPostHTML(post, counts, liked) {
    const user = post.profiles || { username: 'Utente', avatar_url: null };
    const dateStr = post.created_at ? new Date(post.created_at).toLocaleDateString('it-IT') : '';
    
    let countProds = 0;
    if (post.products && Array.isArray(post.products)) countProds = post.products.length;
    else if (post.product_link) countProds = 1;
    
    const shopTag = countProds > 0 ? `<div class="shop-tag-overlay" onclick="openShopWindow('${post.id}', event)"><i class="fa-solid fa-bag-shopping"></i><span>SHOP (${countProds})</span></div>` : '';
    const deleteIcon = (post.user_id === currentUser.id) ? `<i class="fa-solid fa-trash text-gray-600 hover:text-red-500 cursor-pointer ml-auto transition" onclick="deletePost('${post.id}')" title="Elimina"></i>` : '';

    return `
        <div class="post-card">
            <div class="post-header">
                <div class="user-badge" onclick="openUserProfile('${post.user_id}')">
                    <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" class="user-avatar" loading="lazy">
                    <div class="user-meta"><span class="username">${user.username}</span><span class="post-date">${dateStr}</span></div>
                </div>
                ${deleteIcon}
            </div>
            <div class="post-img-container">
                ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openPostDetail('${post.id}')" loading="lazy">` : ''}
                ${shopTag}
            </div>
            <div class="action-bar">
                <div class="icon-btn">
                    <i class="${liked ? 'fa-solid fa-heart text-red-500' : 'fa-regular fa-heart'}" onclick="toggleLike('${post.id}', this.parentNode)"></i>
                    <span class="likes-count-clickable ml-2" id="feed-likes-count-${post.id}" onclick="openLikesModal('${post.id}')">${counts.likes}</span>
                </div>
                <div class="icon-btn" onclick="openPostDetail('${post.id}')"><i class="fa-regular fa-comment"></i><span class="text-sm ml-2">${counts.comments}</span></div>
                <div class="icon-btn ml-auto" onclick="openShareModal('${post.id}')"><i class="fa-regular fa-paper-plane"></i></div>
            </div>
            <div class="caption-box">
                <span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>
                ${escapeHtml(post.caption)}
            </div>
        </div>`;
  }

  // --- AZIONI POST ---
  async function deletePost(postId) {
    if(!confirm("Vuoi davvero eliminare questo post?")) return;
    const { error } = await sb.from('posts').delete().eq('id', postId).eq('user_id', currentUser.id);
    if(error) alert("Errore: " + error.message);
    else { 
        closeModal('post-detail-modal'); 
        if(document.getElementById('view-profile-active')) openUserProfile(currentUser.id); 
        else renderFeedView(); 
    }
  }

  async function openLikesModal(postId) {
    document.getElementById('likes-list-modal').classList.remove('hidden');
    const c = document.getElementById('likes-list-content'); 
    c.innerHTML = '<div class="text-center mt-4 text-[#d4af37]"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>';
    
    const { data: likes } = await sb.from('likes').select('user_id').eq('post_id', postId);
    if (!likes || !likes.length) return c.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun mi piace.</p>';
    
    const { data: profiles } = await sb.from('profiles').select('id, username, avatar_url').in('id', likes.map(l => l.user_id));
    c.innerHTML = '';
    profiles.forEach(u => {
        c.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-2 hover:bg-white/5 cursor-pointer rounded" onclick="closeModal('likes-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full object-cover border border-[#d4af37]">
                <div class="font-bold text-white">${escapeHtml(u.username)}</div>
            </div>
        `);
    });
  }

  async function toggleLike(postId, btn) {
    const icon = btn.querySelector('i');
    const span = document.getElementById(`feed-likes-count-${postId}`);
    let count = parseInt(span.innerText);
    
    if (icon.classList.contains('fa-solid')) {
      icon.className = 'fa-regular fa-heart'; 
      span.innerText = Math.max(0, count - 1);
      await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      icon.className = 'fa-solid fa-heart text-red-500'; 
      span.innerText = count + 1;
      await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
    }
  }

  async function getPostCounts(id) {
    const l = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', id);
    const c = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', id);
    return { likes: l.count || 0, comments: c.count || 0 };
  }
    
  async function isLikedByMe(id) { 
      const { data } = await sb.from('likes').select('id').eq('post_id', id).eq('user_id', currentUser.id); 
      return data && data.length > 0; 
  }
  
  // --- PROFILO & SEARCH ---
  async function openUserProfile(userId) {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div id="view-profile-active" class="hidden"></div><div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-[#d4af37]"></i></div>`;
    
    const { data: p } = await sb.from('profiles').select('*').eq('id', userId).single();
    if (!p) return main.innerHTML = "<p class='text-center mt-10 text-white'>Utente non trovato.</p>";

    const pc = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const fc = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const fing = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
    
    let isFollowing = false;
    if (userId !== currentUser.id) {
      const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
      isFollowing = data && data.length > 0;
    }

    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    const isMe = userId === currentUser.id;
    
    const btn = isMe ? 
        `<button onclick="openEditProfile()" class="px-4 py-2 border border-gray-600 rounded-lg text-sm text-white hover:bg-white/10 transition">Modifica</button>` : 
        `<div class="flex gap-2"><button onclick="toggleFollow('${userId}')" id="follow-btn" class="px-6 py-2 rounded-lg text-sm font-bold transition ${isFollowing ? 'border border-gray-500 text-gray-300' : 'bg-[#d4af37] text-black shadow-lg hover:scale-105'}">${isFollowing ? 'Seguito' : 'Segui'}</button><button onclick="openChat('${userId}', '${p.username}', '${p.avatar_url}')" class="px-4 py-2 border border-[#d4af37] text-[#d4af37] rounded-lg hover:bg-[#d4af37]/10 transition"><i class="fa-regular fa-comment-dots"></i></button></div>`;

    if (posts) posts.forEach(p => allPostsCache[p.id] = p);

    const postsHtml = posts ? posts.map(po => {
        let countProds = 0;
        if (po.products && Array.isArray(po.products)) countProds = po.products.length;
        else if (po.product_link) countProds = 1;
        
        const iconHtml = countProds > 0 ? `<div class="absolute top-2 right-2 bg-black/50 p-1 rounded-full border border-[#d4af37] z-10"><i class="fa-solid fa-bag-shopping text-[#d4af37] text-xs"></i></div>` : '';
        return `<div class="relative aspect-square group cursor-pointer overflow-hidden bg-slate-800" onclick="openPostDetail('${po.id}')">${po.image_url ? `<img src="${po.image_url}" class="w-full h-full object-cover transition duration-500 group-hover:scale-110" loading="lazy">` : `<div class="w-full h-full flex items-center justify-center text-xs p-4 text-center text-gray-500 group-hover:bg-slate-700 transition">${escapeHtml(po.caption).substring(0,40)}...</div>`}${iconHtml}<div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-[#d4af37] font-bold backdrop-blur-sm z-20"><i class="fa-solid fa-eye mr-2"></i> Vedi</div></div>`;
    }).join('') : '';

    main.innerHTML = `
        <div id="view-profile-active" class="hidden"></div>
        <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-3xl p-8 mb-8 flex items-center gap-8 shadow-2xl">
            <img src="${p.avatar_url || 'https://via.placeholder.com/150'}" class="w-32 h-32 rounded-full object-cover border-4 border-[#d4af37] shadow-xl cursor-pointer hover:scale-105 transition" onclick="${isMe?'openEditProfile()':''}">
            <div class="flex-1">
                <div class="flex items-center gap-4 mb-4"><h2 class="text-3xl font-light text-white">${p.username}</h2>${btn}</div>
                <div class="flex gap-8 text-gray-300 mb-4">
                    <div class="text-center"><span class="block font-bold text-white text-lg">${pc.count||0}</span><span class="text-xs uppercase">Post</span></div>
                    <div class="text-center cursor-pointer hover:text-[#d4af37]" onclick="showUserList('followers','${userId}')"><span class="block font-bold text-white text-lg" id="p-followers">${fc.count||0}</span><span class="text-xs uppercase">Follower</span></div>
                    <div class="text-center cursor-pointer hover:text-[#d4af37]" onclick="showUserList('following','${userId}')"><span class="block font-bold text-white text-lg">${fing.count||0}</span><span class="text-xs uppercase">Seguiti</span></div>
                </div>
                <div class="text-gray-400 font-medium">${p.full_name || ''}</div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-1">${postsHtml}</div>
    `;
  }

  async function toggleFollow(targetId) {
    const btn = document.getElementById('follow-btn'); if (!btn) return;
    const isFollow = btn.innerText === 'Seguito'; 
    btn.innerText = "..."; 
    btn.disabled = true;
    
    const op = isFollow ? sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', targetId) : sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
    const { error } = await op;
    
    if (error) { 
        alert("Errore follow"); 
        btn.innerText = isFollow ? "Seguito" : "Segui"; 
        btn.disabled = false; 
    } else {
        openUserProfile(targetId);
    }
  }

  async function performSearch() {
      const q = document.getElementById('search-query').value.trim();
      const r = document.getElementById('search-results');
      if(q.length < 2) return r.innerHTML = '';
      const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
      r.innerHTML = '';
      data?.forEach(u => {
          r.insertAdjacentHTML('beforeend', `
            <div class="flex items-center justify-between p-3 hover:bg-white/5 cursor-pointer" onclick="closeModal('search-modal'); openUserProfile('${u.id}')">
                <div class="flex items-center gap-3">
                    <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-[#d4af37]">
                    <span class="text-white">${u.username}</span>
                </div>
            </div>
          `);
      });
  }

  async function showUserList(type, userId) {
      document.getElementById('user-list-modal').classList.remove('hidden');
      document.getElementById('ul-title').innerText = type === 'followers' ? 'Followers' : 'Seguiti';
      const c = document.getElementById('ul-content'); 
      c.innerHTML = '<div class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin text-[#d4af37]"></i></div>';
      
      let res;
      if (type === 'followers') {
          res = await sb.from('follows').select(`profiles!follows_follower_id_fkey(*)`).eq('followed_id', userId);
      } else {
          res = await sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`).eq('follower_id', userId);
      }
      
      c.innerHTML = '';
      if(!res.data || !res.data.length) return c.innerHTML = '<p class="text-center text-gray-500 mt-4">Lista vuota.</p>';
      
      res.data.forEach(x => {
          const u = x.profiles;
          c.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer" onclick="closeModal('user-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-[#d4af37]">
                <span class="text-white font-bold">${u.username}</span>
            </div>
          `);
      });
  }

  // --- DETTAGLIO POST & COMMENTI ---
  async function openPostDetail(postId) {
      currentPostId = postId;
      document.getElementById('post-detail-modal').classList.remove('hidden');
      document.getElementById('detail-img').src = ''; 
      
      const { data: post } = await sb.from('posts').select(`*, profiles:user_id(*)`).eq('id', postId).single();
      allPostsCache[post.id] = post; // Update cache

      const { data: comments } = await sb.from('comments').select(`*, profiles:user_id(*)`).eq('post_id', postId).order('created_at', { ascending: true });
      const likes = await getPostCounts(postId);
      const amILiking = await isLikedByMe(postId);

      // --- LOGICA SHOP ---
      const shopBtnContainer = document.getElementById('detail-shop-btn');
      const shopIcon = document.getElementById('detail-shop-icon');
      
      let countProds = 0;
      if (post.products && Array.isArray(post.products)) countProds = post.products.length;
      else if (post.product_link) countProds = 1;

      // 1. Bottone sulla foto
      if (countProds > 0) {
        shopBtnContainer.innerHTML = `<div class="shop-tag-overlay" style="bottom: 20px; left: 20px;" onclick="openShopWindow('${post.id}', event)"><i class="fa-solid fa-bag-shopping"></i><span>SHOP (${countProds})</span></div>`;
        // 2. Icona sidebar (riserva)
        shopIcon.classList.remove('hidden');
        shopIcon.onclick = (e) => openShopWindow(post.id, e);
      } else {
        shopBtnContainer.innerHTML = '';
        shopIcon.classList.add('hidden');
      }

      // Immagine
      if(post.image_url) {
          document.getElementById('detail-img').src = post.image_url;
          document.getElementById('detail-img').classList.remove('hidden');
          document.getElementById('detail-noimg').classList.add('hidden');
      } else {
          document.getElementById('detail-img').classList.add('hidden');
          document.getElementById('detail-noimg').classList.remove('hidden');
      }

      document.getElementById('detail-avatar').src = post.profiles.avatar_url || 'https://via.placeholder.com/40';
      document.getElementById('detail-username').innerText = post.profiles.username;
      document.getElementById('detail-user-link').onclick = () => { closeModal('post-detail-modal'); openUserProfile(post.user_id); };
      
      document.getElementById('detail-delete-btn-container').innerHTML = (post.user_id === currentUser.id) ? `<i class="fa-solid fa-trash text-red-500 cursor-pointer text-xl" onclick="deletePost('${post.id}')"></i>` : '';

      const cBox = document.getElementById('detail-comments');
      cBox.innerHTML = `<div class="mb-4 text-sm text-gray-300"><span class="font-bold text-[#d4af37] mr-2">${post.profiles.username}</span>${escapeHtml(post.caption)}</div>`;
      
      comments?.forEach(c => {
          cBox.insertAdjacentHTML('beforeend', `
            <div class="mb-2 text-sm">
                <span class="font-bold text-white mr-2 cursor-pointer hover:underline" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')">${c.profiles.username}</span>
                <span class="text-gray-300">${escapeHtml(c.content)}</span>
            </div>
          `);
      });

      document.getElementById('detail-likes-count').innerText = likes.likes;
      const likeBtn = document.getElementById('detail-like-btn');
      likeBtn.className = amILiking ? 'fa-solid fa-heart text-red-500 cursor-pointer' : 'fa-regular fa-heart cursor-pointer text-white';
      likeBtn.onclick = () => toggleLikeDetail(postId);
  }

  async function toggleLikeDetail(postId) {
      const btn = document.getElementById('detail-like-btn');
      const isLiked = btn.classList.contains('fa-solid');
      if(isLiked) {
          await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
          btn.className = 'fa-regular fa-heart cursor-pointer text-white';
          document.getElementById('detail-likes-count').innerText = parseInt(document.getElementById('detail-likes-count').innerText) - 1;
      } else {
          await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
          btn.className = 'fa-solid fa-heart text-red-500 cursor-pointer';
          document.getElementById('detail-likes-count').innerText = parseInt(document.getElementById('detail-likes-count').innerText) + 1;
      }
      renderFeedView();
  }

  async function inviaCommento() {
      const input = document.getElementById('new-comment');
      const txt = input.value.trim();
      if(!txt || !currentPostId) return;
      
      const { error } = await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
      if(error) alert("Errore commento");
      else { 
          input.value = ''; 
          openPostDetail(currentPostId); 
      }
  }

  // --- MESSAGGI & CONDIVISIONE ---
  async function openInboxModal() {
    document.getElementById('inbox-modal').classList.remove('hidden'); 
    const container = document.getElementById('inbox-list'); 
    container.innerHTML = '<div class="text-center text-gray-500 mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
    
    const { data: msgs } = await sb.from('messages').select('*')
        .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
        .order('created_at', { ascending: false });
        
    if (!msgs || !msgs.length) return container.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun messaggio.</p>';
    
    const seen = new Set(); 
    container.innerHTML = '';
    
    for (const m of msgs) {
      const other = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
      if (!seen.has(other)) {
        seen.add(other);
        const { data: u } = await sb.from('profiles').select('*').eq('id', other).single();
        const dot = (m.receiver_id === currentUser.id && !m.is_read) ? `<div class="unread-indicator"></div>` : '';
        
        container.insertAdjacentHTML('beforeend', `
            <div class="inbox-item" onclick="closeModal('inbox-modal'); openChat('${u.id}', '${u.username}', '${u.avatar_url}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover border border-[#d4af37]">
                <div class="flex-1 overflow-hidden">
                    <div class="font-bold text-white text-sm flex justify-between">
                        ${u.username}
                        <i class="fa-solid fa-trash text-gray-500 hover:text-red-500 transition text-xs p-1" onclick="deleteChat('${u.id}', event)"></i>
                    </div>
                    <div class="text-gray-400 text-xs truncate">${escapeHtml(m.content)}</div>
                </div>
                ${dot}
            </div>
        `);
      }
    }
  }

  async function deleteChat(targetId, event) {
      if(event) event.stopPropagation(); 
      if(!confirm("Eliminare conversazione?")) return;
      await sb.from('messages').delete().or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetId}),and(sender_id.eq.${targetId},receiver_id.eq.${currentUser.id})`);
      openInboxModal(); 
  }

  async function openChat(userId, username, avatar) {
    if (userId === currentUser.id) return;
    activeChatId = userId;
    
    document.getElementById('chat-modal').classList.remove('hidden'); 
    document.getElementById('chat-header-name').innerText = username; 
    document.getElementById('chat-header-avatar').src = avatar || 'https://via.placeholder.com/40';
    
    await loadMessages(); 
    await markAsRead(userId);
    
    if (chatSub) chatSub.unsubscribe();
    chatSub = sb.channel('chat-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => { 
        if ((p.new.sender_id === activeChatId && p.new.receiver_id === currentUser.id) || 
            (p.new.sender_id === currentUser.id && p.new.receiver_id === activeChatId)) { 
            loadMessages(); 
            if (p.new.receiver_id === currentUser.id) markAsRead(activeChatId); 
        } 
    }).subscribe();
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !activeChatId) return; 
    input.value = '';
    const { error } = await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: activeChatId, content: text }]);
    if (!error) loadMessages();
  }

  async function loadMessages() {
    const { data: msgs } = await sb.from('messages').select('*')
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatId}),and(sender_id.eq.${activeChatId},receiver_id.eq.${currentUser.id})`)
        .order('created_at', { ascending: true });
        
    const box = document.getElementById('chat-messages'); 
    box.innerHTML = '';
    
    msgs?.forEach(m => {
      let content = escapeHtml(m.content);
      if (m.content.startsWith('{') && m.content.includes('share_post')) {
          try { 
              const d = JSON.parse(m.content); 
              content = `
                <div class="shared-post-bubble" onclick="openPostDetail('${d.postId}')">
                    <img src="${d.img}" class="shared-post-img">
                    <div class="shared-post-info">
                        <b>Post Condiviso</b><br>${escapeHtml(d.caption)}
                    </div>
                </div>`; 
          } catch(e){}
      }
      box.insertAdjacentHTML('beforeend', `<div class="msg-bubble ${m.sender_id === currentUser.id ? 'msg-mine' : 'msg-theirs'}">${content}</div>`);
    });
    box.scrollTop = box.scrollHeight;
  }

  async function markAsRead(senderId) { 
      await sb.from('messages').update({ is_read: true }).eq('sender_id', senderId).eq('receiver_id', currentUser.id); 
      checkNotifications(); 
  }
  
  function closeChat() { 
      document.getElementById('chat-modal').classList.add('hidden'); 
      activeChatId = null; 
      if (chatSub) chatSub.unsubscribe(); 
      checkNotifications(); 
  }

  // --- SHARE MODAL ---
  function openShareModal(postId) {
      sharePostId = postId;
      document.getElementById('share-modal').classList.remove('hidden');
      const container = document.getElementById('share-list-content');
      container.innerHTML = '<div class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin text-[#d4af37]"></i></div>';
      
      sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`)
        .eq('follower_id', currentUser.id)
        .then(({ data }) => {
            container.innerHTML = '';
            if(!data || data.length === 0) return container.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">Non segui nessuno a cui inviare.</p>';
            data.forEach(x => {
                const u = x.profiles;
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 hover:bg-white/5 rounded-lg cursor-pointer">
                        <div class="flex items-center gap-3">
                            <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-[#d4af37]">
                            <span class="text-white font-bold">${u.username}</span>
                        </div>
                        <button onclick="sendPostToChat('${u.id}', this)" class="bg-[#d4af37] text-black px-4 py-1 rounded-full text-xs font-bold hover:scale-105 transition">Invia</button>
                    </div>
                `);
            });
        });
  }

  async function sendPostToChat(receiverId, btn) {
      if(!sharePostId) return;
      btn.innerText = "Inviato"; btn.disabled = true; btn.classList.add('opacity-50');
      
      const { data: post } = await sb.from('posts').select('image_url, caption').eq('id', sharePostId).single();
      const messageContent = JSON.stringify({ 
          type: 'share_post', 
          postId: sharePostId, 
          img: post.image_url, 
          caption: post.caption ? post.caption.substring(0, 30) + '...' : 'Post condiviso' 
      });
      
      await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: receiverId, content: messageContent }]);
      setTimeout(() => closeModal('share-modal'), 500);
  }

  // --- NOTIFICHE (FULL) ---
  async function openNotificationsModal() {
    document.getElementById('notifications-modal').classList.remove('hidden'); 
    document.getElementById('notif-gold-dot').style.display = 'none';
    
    const c = document.getElementById('notifications-list'); 
    c.innerHTML = '<div class="text-center text-gray-500 mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
    
    const { data: rows } = await sb.from('notifications').select('id, created_at, type, actor_id, post_id, comment_id, is_read').eq('recipient_id', currentUser.id).order('created_at', { ascending: false }).limit(50);
    
    await sb.from('notifications').update({ is_read: true }).eq('recipient_id', currentUser.id).eq('is_read', false);
    
    c.innerHTML = '';
    if (!rows || !rows.length) return c.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessuna notifica.</p>';
    
    for (const n of rows) {
      const { data: actor } = await sb.from('profiles').select('username, avatar_url').eq('id', n.actor_id).single();
      let clickAction = n.type === 'follow' ? `closeModal('notifications-modal'); openUserProfile('${n.actor_id}')` : `closeModal('notifications-modal'); openPostDetail('${n.post_id}')`;
      let txt = n.type === 'follow' ? 'ti ha seguito' : (n.type === 'like' ? 'ha messo like' : 'ha commentato');
      
      c.insertAdjacentHTML('beforeend', `
        <div class="flex items-center gap-3 p-3 border-b border-gray-800 hover:bg-white/5 cursor-pointer transition" onclick="${clickAction}">
            <img src="${actor?.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-[#d4af37]">
            <div class="flex-1">
                <div class="text-sm text-white">
                    <span class="font-bold">${actor?.username || 'User'}</span> 
                    <span class="text-xs text-gray-400">${txt}</span>
                </div>
            </div>
        </div>
      `);
    }
    checkAppNotifications();
  }

  async function checkNotifications() { 
      const { count } = await sb.from('messages').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUser.id).eq('is_read', false); 
      document.getElementById('global-gold-dot').style.display = (count > 0) ? 'block' : 'none'; 
  }
  
  async function checkAppNotifications() { 
      const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true }).eq('recipient_id', currentUser.id).eq('is_read', false); 
      document.getElementById('notif-gold-dot').style.display = (count > 0) ? 'block' : 'none'; 
  }
  
  function showToast(msg) { 
      const t = document.getElementById('toast-notif'); 
      document.getElementById('toast-msg').innerText = msg; 
      t.classList.add('toast-active'); 
      setTimeout(() => t.classList.remove('toast-active'), 4000); 
      document.getElementById('notif-gold-dot').style.display = 'block'; 
  }

  // --- SETTINGS PROFILO ---
  function openEditProfile() { 
      document.getElementById('edit-profile-modal').classList.remove('hidden'); 
      sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data})=>{ 
          document.getElementById('edit-username').value=data.username; 
          document.getElementById('edit-fullname').value=data.full_name; 
          document.getElementById('edit-avatar-preview').src=data.avatar_url||'https://via.placeholder.com/150'; 
      }); 
  }

  async function saveProfile() { 
      await sb.from('profiles').update({ 
          username:document.getElementById('edit-username').value, 
          full_name:document.getElementById('edit-fullname').value 
      }).eq('id', currentUser.id); 
      closeModal('edit-profile-modal'); 
      openUserProfile(currentUser.id); 
  }

  async function uploadAvatar(i) { 
      const f=i.files[0]; 
      if(!f)return; 
      const n=`${currentUser.id}/avatar_${Date.now()}`; 
      await sb.storage.from(BUCKET_AVATARS).upload(n, f); 
      const {data}=sb.storage.from(BUCKET_AVATARS).getPublicUrl(n); 
      document.getElementById('edit-avatar-preview').src=data.publicUrl; 
      await sb.from('profiles').update({ avatar_url:data.publicUrl }).eq('id',currentUser.id); 
  }

  function escapeHtml(t) { 
      return t ? t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; 
  }
</script>
</body>
</html>
