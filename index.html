<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HAWENISHLAND — AI Fashion & Shopping</title>

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest" defer></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- MODERN DESIGN SYSTEM --- */
    :root {
      /* Colori più freschi e profondi */
      --bg-deep: #050505;        
      --bg-card: #121212;
      --bg-glass: rgba(20, 20, 20, 0.7);
      
      --text-main: #ffffff;      
      --text-muted: #a1a1aa;    
      
      /* Nuovo Oro "Champagne" (più elegante, meno giallo) */
      --gold: #e2c275;           
      --gold-dim: #bfa360;
      --gold-glow: rgba(226, 194, 117, 0.15);
      
      --red-like: #f43f5e;
      
      /* Bordi sottili moderni */
      --border-light: 1px solid rgba(255, 255, 255, 0.08);
      --border-gold: 1px solid rgba(226, 194, 117, 0.4);
      
      --radius-xl: 24px;
      --radius-lg: 16px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
      background-color: var(--bg-deep); 
      color: var(--text-main); 
      font-family: 'Outfit', sans-serif; 
      margin: 0; 
      overflow-x: hidden; 
      /* Sfumatura di sfondo più morbida e moderna */
      background: radial-gradient(circle at 50% 0%, #1a1a2e 0%, #050505 60%);
      min-height: 100vh;
      scroll-behavior: smooth;
    }

    /* Scrollbar minimalista */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--gold-dim); }
    
    .hidden { display: none !important; }

    /* --- LAYOUT --- */
    .app-layout { 
      display: flex; 
      max-width: 1280px; 
      margin: 0 auto; 
      min-height: 100vh; 
      position: relative;
    }

    /* --- SIDEBAR FLUTTUANTE --- */
    .sidebar { 
      width: 80px; 
      position: sticky; 
      top: 24px; 
      height: calc(100vh - 48px);
      margin-left: 16px;
      padding: 30px 0;
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: var(--border-light);
      border-radius: var(--radius-xl); 
      z-index: 50;
      transition: all 0.3s ease;
    }

    .brand-logo-icon {
      font-family: 'Playfair Display', serif;
      font-weight: 600;
      font-size: 26px;
      color: var(--gold);
      margin-bottom: 50px;
      cursor: pointer;
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      background: rgba(226, 194, 117, 0.1);
      border: 1px solid rgba(226, 194, 117, 0.2);
    }

    .nav-item { 
      width: 44px; height: 44px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 14px; 
      cursor: pointer; 
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
      color: var(--text-muted);
      margin-bottom: 16px;
      font-size: 19px;
      position: relative;
    }
     
    .nav-item:hover, .nav-item.active { 
      background: var(--gold); 
      color: #000; 
      transform: translateY(-2px);
      box-shadow: 0 4px 20px var(--gold-glow);
    }
     
    /* Tooltip moderni */
    .nav-item:hover::after {
      content: attr(title);
      position: absolute;
      left: 60px;
      background: #111;
      color: #fff;
      padding: 6px 10px;
      font-size: 11px;
      border-radius: 6px;
      font-weight: 500;
      white-space: nowrap;
      pointer-events: none;
      border: var(--border-light);
      opacity: 0;
      animation: fadeIn 0.2s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; left: 55px; } }

    /* --- FEED & POSTS --- */
    .main-content { flex: 1; padding: 40px; max-width: 680px; margin: 0 auto; }

    /* TABS */
    .feed-tabs-container {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 40px;
      background: rgba(255,255,255,0.03);
      padding: 6px;
      border-radius: 100px;
      width: fit-content;
      margin-left: auto; margin-right: auto;
      border: var(--border-light);
    }

    .feed-tab {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      cursor: pointer;
      padding: 8px 24px;
      border-radius: 100px;
      transition: all 0.3s ease;
    }

    .feed-tab.active {
      color: #000;
      background: var(--gold);
      font-weight: 600;
      box-shadow: 0 0 20px var(--gold-glow);
    }

    /* CARD DESIGN AGGIORNATO */
    .post-card { 
      background: var(--bg-card);
      margin-bottom: 30px; 
      padding: 0; /* Full bleed image logic */
      border-radius: var(--radius-xl);
      border: var(--border-light);
      overflow: hidden;
      box-shadow: 0 10px 40px -10px rgba(0,0,0,0.5);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .post-card:hover { border-color: rgba(255,255,255,0.15); }

    .post-header { 
      display: flex; align-items: center; justify-content: space-between; 
      padding: 16px;
    }
     
    .user-badge { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { 
      width: 40px; height: 40px; 
      border-radius: 50%; object-fit: cover; 
      border: 1px solid rgba(255,255,255,0.1);
    }

    .user-meta { display: flex; flex-direction: column; justify-content: center; }
    .username { font-weight: 600; font-size: 14px; color: #fff; letter-spacing: 0.3px; }
    .post-date { font-size: 10px; color: var(--text-muted); margin-top: 2px; }

    .post-img-container {
      position: relative;
      width: 100%;
      /* Rimozione bordi interni per look più pulito */
      background: #000;
    }

    .post-img { 
      width: 100%; 
      display: block;
      cursor: pointer; 
      min-height: 300px;
      object-fit: cover;
    }

    /* SHOPPING TAG PIU' PULITO */
    .shop-tag-overlay {
      position: absolute;
      bottom: 15px;
      left: 15px;
      background: rgba(10, 10, 10, 0.75);
      backdrop-filter: blur(8px);
      padding: 6px 14px;
      border-radius: 100px;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      cursor: pointer;
      transition: all 0.2s ease;
      z-index: 10;
    }
    .shop-tag-overlay:hover {
      background: #fff;
      transform: scale(1.02);
    }
    .shop-tag-overlay span { font-size: 11px; font-weight: 700; color: #fff; letter-spacing: 0.5px; }
    .shop-tag-overlay:hover span { color: #000; }
    .shop-tag-overlay i { color: var(--gold); font-size: 12px; }
    .shop-tag-overlay:hover i { color: #000; }

    .action-bar { display: flex; gap: 20px; padding: 16px 16px 8px 16px; }
    .icon-btn { 
      font-size: 22px; cursor: pointer; transition: 0.2s; color: #fff; 
      display: flex; align-items: center; gap: 6px;
    }
    .icon-btn:hover { color: var(--gold); transform: scale(1.1); }
     
    .likes-count-clickable { font-size: 14px; font-weight: 600; color: #fff; cursor: pointer; }
    
    .caption-box { padding: 0 16px 20px 16px; font-size: 14px; line-height: 1.6; color: #d4d4d8; }
    .caption-user { font-weight: 600; color: #fff; margin-right: 6px; cursor: pointer; }

    .heart-filled { color: var(--red-like) !important; animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    @keyframes pop { 50% { transform: scale(1.3); } }

    /* --- BUTTONS REFRESH --- */
    .btn-gold {
      background: linear-gradient(135deg, #e2c275 0%, #bfa360 100%);
      color: #000; padding: 12px 24px; border-radius: 12px;
      font-weight: 600; border: none; cursor: pointer;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    .btn-gold:hover { 
      filter: brightness(1.1);
      transform: translateY(-2px); 
      box-shadow: 0 8px 25px rgba(226, 194, 117, 0.25); 
    }

    .btn-gold-outline {
      border: 1px solid var(--gold);
      color: var(--gold); padding: 10px 20px; border-radius: 10px;
      font-weight: 500; cursor: pointer; background: transparent; transition: 0.2s;
    }
    .btn-gold-outline:hover { background: rgba(226, 194, 117, 0.08); }

    .empty-feed-box {
      text-align: center; padding: 80px 20px;
      border: 1px dashed rgba(255,255,255,0.1);
      border-radius: 20px; color: var(--text-muted);
    }

    /* --- LOGIN PAGE REFRESH --- */
    .split-layout { 
      display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:200; background:#000; 
      transition: transform 0.6s cubic-bezier(0.65, 0, 0.35, 1); /* Animazione fluida */
      will-change: transform;
    }
    .visual-side { flex:1.2; position:relative; overflow:hidden; display:none; }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; opacity:0; transition: opacity 2s ease; z-index:0; }
    .visual-side img.active{ opacity:0.6; z-index:1; } /* Meno luminose per eleganza */
    
    .form-side{ flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; background:#050505; max-width:550px; margin:auto; border-left: 1px solid rgba(255,255,255,0.05); }
    
    .input-group{ margin-bottom: 25px; position: relative; }
    .input-label{ font-size: 11px; font-weight: 600; text-transform:uppercase; letter-spacing: 1.5px; color: var(--gold); margin-bottom:8px; display: block;}
    
    input.auth-input{ 
      background: rgba(255,255,255,0.03); 
      border: 1px solid rgba(255,255,255,0.1); 
      padding: 14px 16px; 
      color:#fff; width:100%; outline:none; font-size:15px; 
      border-radius: 8px; 
      transition: all 0.3s;
    }
    input.auth-input:focus{ border-color: var(--gold); background: rgba(255,255,255,0.05); }
    
    .btn-white{ 
      background: #fff; color: #000; padding: 16px; 
      font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
      width: 100%; cursor: pointer; border: none; border-radius: 8px;
      transition: .3s; margin-top: 15px;
    }
    .btn-white:hover{ background: var(--gold); box-shadow: 0 0 20px var(--gold-glow); }

    /* --- MODALS GLASS --- */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0, 0.85); 
      backdrop-filter: blur(10px); /* Blur più forte per focus */
      -webkit-backdrop-filter: blur(10px);
      z-index: 100; display: flex; justify-content: center; align-items: center;
      opacity: 0; animation: fadeInModal 0.2s forwards;
    }
    @keyframes fadeInModal { to { opacity: 1; } }

    .glass-modal { 
      background: #121212; 
      border: 1px solid rgba(255,255,255,0.1); 
      border-radius: 20px; 
      overflow: hidden; 
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); 
      transform: scale(0.95); animation: zoomInModal 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes zoomInModal { to { transform: scale(1); } }
     
    .detail-layout { display: flex; width: 90vw; max-width: 1100px; height: 85vh; border: var(--border-light); }
    .detail-img-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
    .detail-info-side { flex: 1; display: flex; flex-direction: column; background: #121212; min-width: 350px; position: relative; }
     
    @media (max-width: 800px) {
      .sidebar { 
        width: 100%; height: 60px; position: fixed; bottom: 0; top: auto; left: 0; margin: 0; 
        flex-direction: row; justify-content: space-around; padding: 0; border-radius: 0;
        background: rgba(10, 10, 10, 0.95); border-top: 1px solid rgba(255,255,255,0.1); border-left: none; border-right: none;
        backdrop-filter: blur(15px);
      }
      .brand-logo-icon { display: none; }
      .nav-item { margin: 0; width: auto; height: auto; background: transparent !important; box-shadow: none !important; color: #666; }
      .nav-item.active { color: var(--gold); transform: none; }
      .nav-item::after { display: none; }
      
      .main-content { padding: 15px 10px 100px 10px; width: 100%; }
      .detail-layout { flex-direction: column; height: 100%; width: 100%; border: none; border-radius: 0; }
      .app-layout { display: block; }
      .glass-modal { width: 100%; height: 100%; border-radius: 0; border: none; }
      .post-card { border-radius: 0; border-left: none; border-right: none; }
    }

    /* --- CHAT & NOTIFICATIONS --- */
    .gold-dot { width: 8px; height: 8px; background: var(--red-like); border-radius: 50%; position: absolute; top: 10px; right: 10px; box-shadow: 0 0 8px var(--red-like); display: none; z-index: 60; }
    
    .msg-bubble { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; margin-bottom: 8px; position: relative; }
    .msg-mine { background: var(--gold); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; font-weight: 500; }
    .msg-theirs { background: #27272a; color: #fff; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
    
    .inbox-item { display: flex; align-items: center; gap: 14px; padding: 16px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; transition: 0.2s; }
    .inbox-item:hover { background: rgba(255,255,255,0.03); }

    /* TOAST */
    .toast-box { 
      position: fixed; top: 20px; right: 20px; 
      background: #18181b; border: 1px solid var(--gold); 
      padding: 16px 20px; border-radius: 12px; 
      display: flex; align-items: center; gap: 14px; color: #fff; z-index: 2000; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.5); 
      transform: translateX(150%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
    }
    .toast-active { transform: translateX(0); }

    /* Utility Helpers */
    .analyzing-box {
        position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        border-radius: 12px; z-index: 10;
    }
    
    /* Shared Post Bubble */
    .shared-post-bubble {
        background: #000 !important;
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 12px !important;
        overflow: hidden;
        cursor: pointer;
        width: 220px;
        transition: opacity 0.2s;
    }
    .shared-post-bubble:hover { opacity: 0.9; }
    .shared-post-info { padding: 10px; font-size: 11px; color: #999; background: #1a1a1a; }

    /* Products List */
    .added-product-item {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px; margin-bottom: 6px;
        border: 1px solid rgba(255,255,255,0.05);
    }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>
  <div class="form-side">
    <h1 class="serif text-6xl mb-12 italic text-white text-center md:text-left" style="font-family: 'Playfair Display', serif;">Hawenishland</h1>
    <div id="msg-box" class="hidden p-3 text-center mb-6 text-sm border border-gray-600 rounded bg-red-500/10"></div>
    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass" class="auth-input"></div>
      <button onclick="faiLogin()" class="btn-white">Entra</button>
      <p onclick="recuperoPassword()" class="link-small mt-6 hover:text-white transition">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small mt-2 hover:text-white transition">Non hai un account? <b class="text-[#e2c275]">Iscriviti</b></p>
    </div>
    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username</label><input type="text" id="r-username" class="auth-input"></div>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <div><label class="input-label">Nome</label><input type="text" id="r-nome" class="auth-input"></div>
        <div><label class="input-label">Cognome</label><input type="text" id="r-cognome" class="auth-input"></div>
      </div>
      <div class="input-group"><label class="input-label">Nascita</label><input type="date" id="r-nascita" class="auth-input" style="color-scheme:dark"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass" class="auth-input"></div>
      <button onclick="faiRegistrazione()" class="btn-white">Registrati</button>
      <p onclick="vaiA('login')" class="link-small mt-6 hover:text-white transition">Torna al Login</p>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    <div class="sidebar">
      <div class="brand-logo-icon" onclick="renderFeedView()" title="Home">H</div>
      <div class="nav-item active" onclick="renderFeedView()" title="Feed">
        <i class="fa-solid fa-house"></i>
      </div>
      <div class="nav-item" onclick="openSearchModal()" title="Cerca">
        <i class="fa-solid fa-magnifying-glass"></i>
      </div>
      <div class="nav-item" onclick="openUploadModal()" title="Nuovo Post">
        <i class="fa-solid fa-plus"></i>
      </div>
      <div class="nav-item relative" onclick="openNotificationsModal()" title="Notifiche">
        <div id="notif-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-bell"></i>
      </div>
      <div class="nav-item relative" onclick="openInboxModal()" title="Messaggi">
        <div id="global-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-envelope"></i>
      </div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)" title="Profilo">
        <i class="fa-solid fa-user"></i>
      </div>
      <div style="margin-top:auto"></div>
      <div class="nav-item text-red-400 hover:text-red-500" onclick="logout()" title="Esci">
        <i class="fa-solid fa-power-off"></i>
      </div>
    </div>
    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="toast-notif" class="toast-box">
  <div class="text-[#e2c275] text-xl"><i class="fa-solid fa-bolt"></i></div>
  <div>
    <h4 class="text-sm font-bold text-white">Notifica</h4>
    <p class="text-xs text-gray-400" id="toast-msg">...</p>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <div class="flex justify-between items-center mb-6">
      <h3 class="font-bold text-xl text-white font-serif italic">Crea Outfit</h3>
      <div class="w-8 h-8 flex items-center justify-center rounded-full bg-white/5 hover:bg-white/10 cursor-pointer transition" onclick="closeModal('upload-modal')">
        <i class="fa-solid fa-xmark text-gray-300"></i>
      </div>
    </div>
    <div class="flex flex-col gap-4 max-h-[75vh] overflow-y-auto pr-1 relative">
       
      <label class="h-40 border border-dashed border-gray-600 rounded-2xl flex flex-col items-center justify-center cursor-pointer hover:border-[#e2c275] hover:bg-white/5 transition relative overflow-hidden group">
        <i class="fa-solid fa-camera text-3xl mb-3 text-gray-500 group-hover:text-[#e2c275] transition"></i>
        <span class="text-xs text-gray-400">Carica Foto Outfit</span>
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
        <div id="ai-loading" class="hidden analyzing-box">
            <i class="fa-solid fa-brain fa-spin text-3xl text-[#e2c275] mb-2"></i>
            <span class="text-xs text-white font-bold">L'AI sta analizzando...</span>
        </div>
      </label>
       
      <img id="upload-preview" class="hidden w-full h-48 object-cover rounded-xl border border-gray-700">
       
      <div id="ai-error-msg" class="hidden p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-200 text-xs text-center">
        <i class="fa-solid fa-triangle-exclamation mr-1"></i> Ops! Questa foto non sembra riguardare la moda.
      </div>

      <div id="upload-details-section" class="hidden animate-[fadeIn_0.5s]">
          <div class="bg-white/5 p-4 rounded-xl border border-white/5 mb-4">
            <p class="text-[#e2c275] text-[10px] font-bold uppercase mb-3 tracking-widest"><i class="fa-solid fa-tags mr-1"></i> Tagga Prodotti (OBBLIGATORIO)</p>
            <div class="flex gap-2 mb-2">
               <input type="text" id="temp-prod-name" placeholder="Nome (es. Scarpe Nike)" class="flex-1 bg-black/30 border border-white/10 rounded-lg p-2.5 text-white text-xs focus:border-[#e2c275] outline-none transition">
               <input type="url" id="temp-prod-link" placeholder="Link..." class="flex-1 bg-black/30 border border-white/10 rounded-lg p-2.5 text-white text-xs focus:border-[#e2c275] outline-none transition">
            </div>
            <button onclick="addProdToUpload()" class="btn-gold-outline w-full text-xs py-2 mb-2 opacity-80 hover:opacity-100">+ Aggiungi</button>
            <div id="upload-products-list" class="space-y-1 mt-3"></div>
          </div>

          <textarea id="post-caption" rows="2" placeholder="Descrivi il tuo stile..." class="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-white focus:border-[#e2c275] outline-none mb-4 resize-none"></textarea>
          <button id="btn-publish" onclick="submitPost()" class="btn-gold w-full">PUBBLICA</button>
      </div>
    </div>
  </div>
</div>

<div id="share-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex justify-between font-bold text-white items-center">
      <span>Invia a...</span>
      <i class="fa-solid fa-xmark cursor-pointer p-2 text-gray-400 hover:text-white" onclick="closeModal('share-modal')"></i>
    </div>
    <div id="share-list-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="shop-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[380px] p-8 text-center relative bg-[#121212]">
    <i class="fa-solid fa-xmark absolute top-4 right-4 text-gray-400 hover:text-white cursor-pointer text-xl p-2" onclick="closeModal('shop-modal')"></i>
    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-[#e2c275]/10 mb-4 border border-[#e2c275]/30 shadow-[0_0_30px_rgba(226,194,117,0.1)]">
      <i class="fa-solid fa-bag-shopping text-2xl text-[#e2c275]"></i>
    </div>
    <h3 class="text-white font-serif text-3xl mb-2 italic">Shop the Look</h3>
    <div class="w-12 h-0.5 bg-[#e2c275] mx-auto mb-8 opacity-50"></div>
    <div id="shop-window-list" class="shop-list-container space-y-3 max-h-[350px] overflow-y-auto"></div>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex justify-between items-center">
      <input type="text" id="search-query" class="bg-transparent text-white w-full outline-none placeholder-gray-600 text-lg font-light" placeholder="Cerca persone..." onkeyup="performSearch()">
      <i class="fa-solid fa-xmark cursor-pointer ml-4 text-gray-400 hover:text-white" onclick="closeModal('search-modal')"></i>
    </div>
    <div id="search-results" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex justify-between font-bold text-white">
      <span id="ul-title">Lista</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('user-list-modal')"></i>
    </div>
    <div id="ul-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="likes-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] max-h-[500px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex justify-between font-bold text-white">
      <span>Mi piace</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('likes-list-modal')"></i>
    </div>
    <div id="likes-list-content" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="glass-modal detail-layout">
    <div class="detail-img-side bg-black">
      <img id="detail-img" src="">
      <div id="detail-noimg" class="hidden text-gray-500">Solo Testo</div>
    </div>
    <div class="detail-info-side">
      <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#121212]">
        <div class="flex items-center gap-3 cursor-pointer" id="detail-user-link">
          <img id="detail-avatar" src="" class="w-9 h-9 rounded-full object-cover border border-gray-700">
          <span id="detail-username" class="font-bold text-sm text-white hover:text-[#e2c275] transition"></span>
        </div>
        <div class="flex items-center gap-4">
          <div id="detail-delete-btn-container"></div>
          <i class="fa-solid fa-xmark cursor-pointer text-xl hover:text-white text-gray-500 p-1" onclick="closeModal('post-detail-modal')"></i>
        </div>
      </div>
      <div id="detail-comments" class="flex-1 overflow-y-auto p-5 space-y-5 bg-[#0a0a0a]"></div>
      <div class="p-4 border-t border-gray-800 bg-[#121212]">
        <div class="flex gap-5 text-2xl mb-3">
          <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer transition hover:scale-110 text-white"></i>
          <i class="fa-regular fa-comment text-white"></i>
        </div>
        <div class="font-bold text-sm mb-3 text-white">
            <span id="detail-likes-count" class="cursor-pointer hover:underline">0</span> Mi piace
        </div>
        <div class="flex gap-3 items-center">
          <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="flex-1 bg-transparent outline-none text-white text-sm placeholder-gray-600">
          <button onclick="inviaCommento()" class="text-[#e2c275] font-bold text-xs hover:text-white transition">PUBBLICA</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <h2 class="text-xl font-bold mb-6 text-center text-white font-serif italic">Modifica Profilo</h2>
    <div class="flex flex-col items-center mb-8">
      <div class="relative group cursor-pointer">
          <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border border-[#e2c275] mb-2 group-hover:opacity-70 transition">
          <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><i class="fa-solid fa-camera text-white"></i></div>
          <input type="file" id="avatar-upload" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" onchange="uploadAvatar(this)">
      </div>
      <span class="text-[#e2c275] text-xs font-bold mt-2">Cambia Foto</span>
    </div>
    <div class="space-y-5">
      <div><label class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1 block">Username</label><input id="edit-username" type="text" class="w-full bg-black/30 p-3 rounded-lg text-white border border-gray-700 focus:border-[#e2c275] outline-none"></div>
      <div><label class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1 block">Nome Completo</label><input id="edit-fullname" type="text" class="w-full bg-black/30 p-3 rounded-lg text-white border border-gray-700 focus:border-[#e2c275] outline-none"></div>
      <div class="flex gap-3 pt-4">
        <button onclick="saveProfile()" class="flex-1 btn-gold">Salva</button>
        <button onclick="closeModal('edit-profile-modal')" class="flex-1 border border-gray-600 py-3 rounded-xl text-white hover:bg-white/5 transition font-medium text-sm">Annulla</button>
      </div>
    </div>
  </div>
</div>

<div id="inbox-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[600px] flex flex-col">
    <div class="p-5 border-b border-gray-800 flex justify-between items-center">
      <h3 class="font-bold text-lg text-white">Messaggi</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400 hover:text-white" onclick="closeModal('inbox-modal')"></i>
    </div>
    <div id="inbox-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="notifications-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[600px] flex flex-col">
    <div class="p-5 border-b border-gray-800 flex justify-between items-center">
      <h3 class="font-bold text-lg text-white">Notifiche</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400 hover:text-white" onclick="closeModal('notifications-modal')"></i>
    </div>
    <div id="notifications-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="chat-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[600px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#18181b]">
      <div class="flex items-center gap-3">
        <img id="chat-header-avatar" src="" class="w-9 h-9 rounded-full border border-gray-600">
        <span id="chat-header-name" class="font-bold text-white text-sm">Chat</span>
      </div>
      <i class="fa-solid fa-xmark cursor-pointer text-gray-400 hover:text-white p-2" onclick="closeChat()"></i>
    </div>
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-[#050505]"></div>
    <div class="p-3 border-t border-gray-800 flex gap-2 bg-[#18181b] items-center">
      <input type="text" id="chat-input" placeholder="Scrivi..." class="flex-1 bg-[#27272a] border-none rounded-full px-4 py-2.5 text-white outline-none focus:ring-1 focus:ring-[#e2c275] text-sm" onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="w-10 h-10 rounded-full bg-[#e2c275] text-black flex items-center justify-center hover:scale-105 transition"><i class="fa-regular fa-paper-plane text-sm"></i></button>
    </div>
  </div>
</div>

<script>
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';
  let currentUser = null, currentPostId = null, activeChatId = null, chatSub = null;
  let currentFeedMode = 'following'; 
  let uploadProductsList = [];
  let sharePostId = null; 
   
  // AI VARIABLES
  let classifierModel = null;
  const FASHION_KEYWORDS = [
    'shirt', 'pants', 'jean', 'dress', 'suit', 'shoe', 'boot', 'sandal', 'hat', 
    'sunglasses', 'jacket', 'coat', 'sweater', 'jersey', 'cardigan', 'skirt', 
    'tie', 't-shirt', 'blouse', 'trousers', 'shorts', 'footwear', 'outerwear',
    'miniskirt', 'maillot', 'tank suit', 'bikini', 'kimono', 'abaya', 'gown',
    'cloak', 'lab coat', 'pajama', 'velvet', 'wool', 'tie', 'bow tie', 'apron',
    'stole', 'necklace', 'wardrobe', 'closet', 'fashion', 'person', 'groom', 'bride',
    'uniform', 'vestment', 'trench coat', 'sweatshirt', 'Loafer', 'clog'
  ];

  window.addEventListener('load', async () => {
    try {
        console.log("Sto caricando il cervello AI...");
        if (typeof mobilenet !== 'undefined') {
            classifierModel = await mobilenet.load();
            console.log("AI Fashion Caricata con successo!");
        } else {
            console.warn("Libreria MobileNet non trovata. Il controllo AI sarà disabilitato.");
        }
    } catch(e) { console.error("Errore caricamento AI", e); }

    let i = 0; const imgs = document.querySelectorAll('.visual-side img');
    if (imgs.length) { setInterval(() => { imgs[i].classList.remove('active'); i = (i + 1) % imgs.length; imgs[i].classList.add('active'); }, 5000); }
    const { data: { session }, error } = await sb.auth.getSession();
    if (session && !error) enterApp(session.user);
    else document.getElementById('auth-container').style.display = 'flex';
  });

  async function checkImageContent(imgElement) {
    if (!classifierModel) {
        console.log("Modello AI non pronto, bypass controllo.");
        return true; 
    }
    
    try {
        const predictions = await classifierModel.classify(imgElement);
        console.log("L'AI vede:", predictions);
        const isFashion = predictions.some(p => {
            const terms = p.className.toLowerCase().split(','); 
            return terms.some(term => {
                const cleanTerm = term.trim();
                return FASHION_KEYWORDS.some(k => cleanTerm.includes(k) || k.includes(cleanTerm));
            });
        });
        return isFashion;
    } catch (e) {
        console.error("Errore durante la classificazione:", e);
        return true; 
    }
  }

  function previewUpload(input) { 
    if(input.files && input.files[0]) { 
        const loadingBox = document.getElementById('ai-loading');
        const previewImg = document.getElementById('upload-preview');
        const detailsSection = document.getElementById('upload-details-section');
        const errorMsg = document.getElementById('ai-error-msg');
        
        previewImg.classList.add('hidden');
        detailsSection.classList.add('hidden'); 
        errorMsg.classList.add('hidden');
        loadingBox.classList.remove('hidden');

        const r = new FileReader(); 
        r.onload = async (e) => { 
            previewImg.src = e.target.result; 
            previewImg.onload = async () => {
                try {
                    const isApproved = await checkImageContent(previewImg);
                    loadingBox.classList.add('hidden');
                    previewImg.classList.remove('hidden');

                    if (isApproved) {
                        detailsSection.classList.remove('hidden');
                    } else {
                        errorMsg.classList.remove('hidden');
                        input.value = ""; 
                    }
                } catch (err) {
                    console.error("Errore fatale preview:", err);
                    loadingBox.classList.add('hidden');
                    previewImg.classList.remove('hidden');
                    detailsSection.classList.remove('hidden');
                }
            };
        }; 
        r.readAsDataURL(input.files[0]); 
    } 
  }

  function openShareModal(postId) {
      sharePostId = postId;
      document.getElementById('share-modal').classList.remove('hidden');
      const container = document.getElementById('share-list-content');
      container.innerHTML = '<div class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin text-[#e2c275]"></i></div>';
      
      sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`)
        .eq('follower_id', currentUser.id)
        .then(({ data }) => {
            container.innerHTML = '';
            if(!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">Non segui nessuno a cui inviare.</p>';
                return;
            }
            data.forEach(x => {
                const u = x.profiles;
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 hover:bg-white/5 rounded-lg cursor-pointer transition">
                        <div class="flex items-center gap-3">
                            <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-gray-600">
                            <span class="text-white font-bold text-sm">${u.username}</span>
                        </div>
                        <button onclick="sendPostToChat('${u.id}', this)" class="bg-[#e2c275] text-black px-4 py-1.5 rounded-full text-xs font-bold hover:scale-105 transition">Invia</button>
                    </div>
                `);
            });
        });
  }

  async function sendPostToChat(receiverId, btn) {
      if(!sharePostId) return;
      btn.innerText = "Inviato";
      btn.disabled = true;
      btn.classList.add('opacity-50');

      const { data: post } = await sb.from('posts').select('image_url, caption').eq('id', sharePostId).single();
      
      const messageContent = JSON.stringify({
          type: 'share_post',
          postId: sharePostId,
          img: post.image_url,
          caption: post.caption ? post.caption.substring(0, 30) + '...' : 'Post condiviso'
      });

      await sb.from('messages').insert([{ 
          sender_id: currentUser.id, 
          receiver_id: receiverId, 
          content: messageContent 
      }]);
      
      setTimeout(() => closeModal('share-modal'), 500);
  }

  async function recuperoPassword() {
    const email = document.getElementById('l-email').value;
    if(!email) return alert("Inserisci l'email per il recupero");
    const { error } = await sb.auth.resetPasswordForEmail(email);
    if(error) alert(error.message);
    else alert("Email di recupero inviata!");
  }

  async function deletePost(postId) {
    if(!confirm("Vuoi davvero eliminare questo post?")) return;
    const { error } = await sb.from('posts').delete().eq('id', postId).eq('user_id', currentUser.id);
    if(error) alert("Errore: " + error.message);
    else {
      closeModal('post-detail-modal'); 
      if(document.getElementById('view-profile-active')) openUserProfile(currentUser.id); 
      else renderFeedView(); 
    }
  }

  function addProdToUpload() {
    const nameInput = document.getElementById('temp-prod-name');
    const linkInput = document.getElementById('temp-prod-link');
    const name = nameInput.value.trim();
    const link = linkInput.value.trim();

    if(!name || !link) return alert("Inserisci nome e link del prodotto.");
    
    uploadProductsList.push({ name, link });
    nameInput.value = '';
    linkInput.value = '';
    renderUploadProductsList();
  }

  function removeProdFromUpload(index) {
    uploadProductsList.splice(index, 1);
    renderUploadProductsList();
  }

  function renderUploadProductsList() {
    const container = document.getElementById('upload-products-list');
    container.innerHTML = '';
    uploadProductsList.forEach((prod, idx) => {
        container.insertAdjacentHTML('beforeend', `
            <div class="added-product-item">
                <div class="truncate mr-2">
                    <div class="text-[#e2c275] font-bold text-xs">${escapeHtml(prod.name)}</div>
                    <div class="text-[10px] text-gray-500 truncate">${escapeHtml(prod.link)}</div>
                </div>
                <i class="fa-solid fa-trash text-gray-500 hover:text-red-500 cursor-pointer text-xs" onclick="removeProdFromUpload(${idx})"></i>
            </div>
        `);
    });
  }

  function openShopWindow(productsJson, event) {
    if(event) event.stopPropagation();
    const container = document.getElementById('shop-window-list');
    container.innerHTML = '';
    
    let products = [];
    try {
        products = JSON.parse(decodeURIComponent(productsJson));
    } catch(e) { console.error("Errore parsing prodotti", e); return; }

    if(!products || products.length === 0) return;

    products.forEach(p => {
        container.insertAdjacentHTML('beforeend', `
            <div class="bg-[#1a1a1a] p-3 rounded-lg border border-white/5 flex items-center justify-between hover:bg-white/5 transition">
                <div class="text-left">
                    <div class="font-bold text-white text-sm">${escapeHtml(p.name)}</div>
                    <div class="text-[10px] text-gray-400">Clicca per acquistare</div>
                </div>
                <a href="${p.link}" target="_blank" class="bg-[#e2c275] text-black px-3 py-1.5 rounded-md text-xs font-bold hover:scale-105 transition shadow-lg">
                    GO <i class="fa-solid fa-arrow-right ml-1"></i>
                </a>
            </div>
        `);
    });
    document.getElementById('shop-modal').classList.remove('hidden');
  }
  
  function switchFeedMode(mode) {
    if (currentFeedMode === mode) return; 
    currentFeedMode = mode;
    renderFeedView();
  }

  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    if(document.getElementById('view-profile-active')) document.getElementById('view-profile-active').remove();

    const tabsHtml = `
      <div class="feed-tabs-container">
        <div class="feed-tab ${currentFeedMode === 'following' ? 'active' : ''}" onclick="switchFeedMode('following')">Seguiti</div>
        <div class="feed-tab ${currentFeedMode === 'viral' ? 'active' : ''}" onclick="switchFeedMode('viral')">Per Te</div>
      </div>
    `;

    main.innerHTML = `${tabsHtml}<div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-[#e2c275]"></i></div>`;

    let posts = [];
    let error = null;

    if (currentFeedMode === 'following') {
        const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
        const followingIds = follows ? follows.map(f => f.followed_id) : [];

        if (followingIds.length > 0) {
            const res = await sb.from('posts')
                .select(`*, profiles:user_id (username, avatar_url)`)
                .in('user_id', followingIds)
                .order('created_at', { ascending: false });
            posts = res.data;
            error = res.error;
        } else {
            posts = []; 
        }
    } else {
        const res = await sb.from('posts')
            .select(`*, profiles:user_id (username, avatar_url)`)
            .order('created_at', { ascending: false })
            .limit(50);
        posts = res.data;
        error = res.error;
    }

    if (error) {
        return main.innerHTML = `${tabsHtml}<p class="text-center text-red-500 mt-10">Errore caricamento feed.</p>`;
    }

    if (!posts || posts.length === 0) {
        if (currentFeedMode === 'following') {
            return main.innerHTML = `
                ${tabsHtml}
                <div class="empty-feed-box">
                  <i class="fa-solid fa-user-plus text-4xl mb-4 text-[#e2c275] opacity-50"></i>
                  <h2 class="text-xl font-bold mb-2 text-white">Feed Vuoto</h2>
                  <p class="text-gray-500 mb-6">Non segui ancora nessuno.</p>
                  <button onclick="switchFeedMode('viral')" class="btn-gold">Vai su "Per Te"</button>
                </div>
            `;
        } else {
            return main.innerHTML = `${tabsHtml}<div class="empty-feed-box"><p>Nessun post trovato su Hawenishland.</p></div>`;
        }
    }

    main.innerHTML = tabsHtml;
    for (const post of posts) {
      const counts = await getPostCounts(post.id);
      const likedByMe = await isLikedByMe(post.id);
      main.insertAdjacentHTML('beforeend', createPostHTML(post, counts, likedByMe));
    }
  }

  function createPostHTML(post, counts, liked) {
    const user = post.profiles || { username: 'Utente', avatar_url: null };
    const dateStr = post.created_at ? new Date(post.created_at).toLocaleDateString('it-IT') : '';
    const heartIcon = liked ? 'fa-solid fa-heart text-[#f43f5e]' : 'fa-regular fa-heart';
    const deleteIcon = (post.user_id === currentUser.id) 
      ? `<i class="fa-solid fa-trash text-gray-600 hover:text-red-500 cursor-pointer ml-auto transition" onclick="deletePost('${post.id}')" title="Elimina"></i>` : '';

    let shopTag = '';
    let products = [];
    
    if(post.products && post.products.length > 0) {
        products = post.products; 
    } else if (post.product_link) {
        products = [{ name: post.product_name || 'Prodotto', link: post.product_link }];
    }

    if (products.length > 0) {
      const jsonStr = encodeURIComponent(JSON.stringify(products));
      shopTag = `
        <div class="shop-tag-overlay" onclick="openShopWindow('${jsonStr}', event)">
           <i class="fa-solid fa-bag-shopping"></i>
           <span>SHOP (${products.length})</span>
        </div>
      `;
    }

    return `
      <div class="post-card">
        <div class="post-header">
          <div class="user-badge" onclick="openUserProfile('${post.user_id}')">
            <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" class="user-avatar">
            <div class="user-meta"><span class="username">${user.username}</span><span class="post-date">${dateStr}</span></div>
          </div>
          ${deleteIcon}
        </div>
        
        <div class="post-img-container">
            ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openPostDetail('${post.id}')">` : ''}
            ${shopTag}
        </div>

        <div class="action-bar">
          <div class="icon-btn">
            <i class="${heartIcon}" onclick="toggleLike('${post.id}', this.parentNode)"></i>
            <span class="likes-count-clickable ml-2" id="feed-likes-count-${post.id}" onclick="openLikesModal('${post.id}')">${counts.likes}</span>
          </div>
          <div class="icon-btn" onclick="openPostDetail('${post.id}')"><i class="fa-regular fa-comment"></i><span class="text-sm ml-2">${counts.comments}</span></div>
          <div class="icon-btn ml-auto" onclick="openShareModal('${post.id}')"><i class="fa-regular fa-paper-plane"></i></div>
        </div>
        <div class="caption-box">
            <span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>
            ${escapeHtml(post.caption)}
        </div>
      </div>
    `;
  }

  async function openLikesModal(postId) {
    document.getElementById('likes-list-modal').classList.remove('hidden');
    const container = document.getElementById('likes-list-content');
    container.innerHTML = '<div class="text-center mt-4 text-[#e2c275]"><i class="fa-solid fa-spinner fa-spin text-2xl"></i></div>';
    
    const { data: rawLikes, error: err1 } = await sb.from('likes').select('user_id').eq('post_id', postId);
    if (err1) { container.innerHTML = '<p class="text-center text-red-500 mt-4">Errore caricamento lista.</p>'; return; }
    if (!rawLikes || rawLikes.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 mt-4">Ancora nessun mi piace.</p>'; return; }
    const userIds = rawLikes.map(item => item.user_id);
    const { data: profiles, error: err2 } = await sb.from('profiles').select('id, username, avatar_url').in('id', userIds);
    if (err2) { container.innerHTML = '<p class="text-center text-red-500 mt-4">Errore caricamento profili.</p>'; return; }

    container.innerHTML = '';
    profiles.forEach(u => {
        container.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-3 hover:bg-white/5 cursor-pointer rounded-lg transition" onclick="closeModal('likes-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full object-cover border border-gray-600">
                <div class="font-bold text-white text-sm">${escapeHtml(u.username)}</div>
            </div>`);
    });
  }

  async function toggleLike(postId, btnContainer) {
    const icon = btnContainer.querySelector('i');
    const countSpan = document.getElementById(`feed-likes-count-${postId}`);
    let currentCount = parseInt(countSpan.innerText);
    const isLiked = icon.classList.contains('fa-solid');

    if (isLiked) {
      icon.className = 'fa-regular fa-heart';
      countSpan.innerText = Math.max(0, currentCount - 1);
      await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      icon.className = 'fa-solid fa-heart text-[#f43f5e]';
      countSpan.innerText = currentCount + 1;
      await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
    }
  }

  async function getPostCounts(postId) {
    const { count: l } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    const { count: c } = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    return { likes: l || 0, comments: c || 0 };
  }
   
  async function isLikedByMe(postId) { 
    const { data } = await sb.from('likes').select('id').eq('post_id', postId).eq('user_id', currentUser.id); 
    return data && data.length > 0; 
  }
   
  async function openUserProfile(userId) {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div id="view-profile-active" class="hidden"></div><div class="flex justify-center mt-20"><i class="fa-solid fa-spinner fa-spin text-3xl text-[#e2c275]"></i></div>`;
    
    const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
    if (!profile) return main.innerHTML = "<p class='text-center mt-10 text-white'>Utente non trovato.</p>";

    const { count: postsCount } = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const { count: followersCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const { count: followingCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
    
    let isFollowing = false;
    if (userId !== currentUser.id) {
      const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
      isFollowing = data && data.length > 0;
    }

    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    const isMe = userId === currentUser.id;
    
    let chatButtonHtml = '';
    if (isFollowing) {
        chatButtonHtml = `<button onclick="openChat('${userId}', '${profile.username}', '${profile.avatar_url}')" class="px-4 py-2 border border-[#e2c275] text-[#e2c275] rounded-lg hover:bg-[#e2c275]/10 transition"><i class="fa-regular fa-comment-dots"></i></button>`;
    }

    const btn = isMe ? 
      `<button onclick="openEditProfile()" class="px-5 py-2 border border-gray-600 rounded-xl text-sm text-white hover:bg-white/10 transition font-medium">Modifica</button>` : 
      `<div class="flex gap-2">
         <button onclick="toggleFollow('${userId}')" id="follow-btn" class="px-6 py-2 rounded-xl text-sm font-bold transition shadow-lg ${isFollowing ? 'border border-gray-600 text-gray-400' : 'bg-[#e2c275] text-black hover:scale-105'}">${isFollowing ? 'Seguito' : 'Segui'}</button>
         ${chatButtonHtml}
       </div>`;

    main.innerHTML = `
      <div id="view-profile-active" class="hidden"></div>
      <div class="bg-[#121212] border border-gray-800 rounded-[30px] p-8 mb-8 flex flex-col md:flex-row items-center md:items-start gap-8 shadow-2xl relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-[#e2c275] to-transparent opacity-50"></div>
        <img src="${profile.avatar_url || 'https://via.placeholder.com/150'}" class="w-28 h-28 rounded-full object-cover border-4 border-[#e2c275] shadow-xl cursor-pointer hover:scale-105 transition" onclick="${isMe?'openEditProfile()':''}">
        <div class="flex-1 flex flex-col items-center md:items-start">
          <div class="flex flex-col md:flex-row items-center gap-4 mb-5"><h2 class="text-3xl font-light text-white font-serif italic">${profile.username}</h2>${btn}</div>
          <div class="flex gap-10 text-gray-400 mb-5">
            <div class="text-center"><span class="block font-bold text-white text-xl">${postsCount||0}</span><span class="text-[10px] uppercase tracking-wider">Post</span></div>
            <div class="text-center cursor-pointer hover:text-[#e2c275]" onclick="showUserList('followers','${userId}')"><span class="block font-bold text-white text-xl" id="p-followers">${followersCount||0}</span><span class="text-[10px] uppercase tracking-wider">Follower</span></div>
            <div class="text-center cursor-pointer hover:text-[#e2c275]" onclick="showUserList('following','${userId}')"><span class="block font-bold text-white text-xl">${followingCount||0}</span><span class="text-[10px] uppercase tracking-wider">Seguiti</span></div>
          </div>
          <div class="text-gray-300 font-medium text-sm">${profile.full_name || ''}</div>
        </div>
      </div>
      <div class="grid grid-cols-3 gap-1 rounded-2xl overflow-hidden">${posts ? posts.map(p => `
        <div class="relative aspect-square group cursor-pointer overflow-hidden bg-[#1a1a1a]" onclick="openPostDetail('${p.id}')">
            ${p.image_url ? `<img src="${p.image_url}" class="w-full h-full object-cover transition duration-700 ease-out group-hover:scale-105 group-hover:brightness-75">` : `<div class="w-full h-full flex items-center justify-center text-xs p-4 text-center text-gray-500 group-hover:bg-gray-800 transition">${escapeHtml(p.caption).substring(0,40)}...</div>`}
            ${(p.products && p.products.length>0) || p.product_link ? '<div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm p-1.5 rounded-full border border-white/10"><i class="fa-solid fa-bag-shopping text-[#e2c275] text-xs"></i></div>' : ''}
        </div>`).join('') : ''}
      </div>
    `;
  }

 async function toggleFollow(targetId) {
    const btn = document.getElementById('follow-btn');
    if (!btn) return;

    const isFollowing = btn.innerText === 'Seguito';
    const originalText = btn.innerText;
    
    btn.innerText = "...";
    btn.disabled = true;

    let error = null;

    try {
        if (isFollowing) {
            const { error: err } = await sb.from('follows')
                .delete()
                .eq('follower_id', currentUser.id)
                .eq('followed_id', targetId);
            error = err;
        } else {
            const { error: err } = await sb.from('follows')
                .insert([{ follower_id: currentUser.id, followed_id: targetId }]);
            error = err;
        }

        if (error) throw error;
        openUserProfile(targetId);

    } catch (err) {
        console.error("ERRORE FOLLOW:", err);
        alert("Errore: " + (err.message || "Impossibile completare l'azione"));
        btn.innerText = originalText;
        btn.disabled = false;
    }
  }

  async function submitPost() { 
    const f = document.getElementById('post-file').files[0]; 
    const c = document.getElementById('post-caption').value; 
    
    // Controlla testo pendente
    const pendingName = document.getElementById('temp-prod-name').value.trim();
    const pendingLink = document.getElementById('temp-prod-link').value.trim();
    if(pendingName && pendingLink) {
        uploadProductsList.push({ name: pendingName, link: pendingLink });
    }

    const btn = document.getElementById('btn-publish');
    const originalText = btn.innerText;

    // CONTROLLO OBBLIGATORIO PRODOTTI
    if(uploadProductsList.length === 0) {
        alert("Devi aggiungere almeno un prodotto all'outfit (Nome e Link).");
        return; 
    }

    if(!f) return alert("Devi caricare una foto dell'outfit.");

    btn.innerText = "Pubblicazione...";
    btn.disabled = true;

    try {
        let url = null; 
        if(f) { 
          const n = `${currentUser.id}/${Date.now()}`; 
          const { error: upErr } = await sb.storage.from(BUCKET_POSTS).upload(n, f); 
          if(upErr) throw upErr;
          const { data } = sb.storage.from(BUCKET_POSTS).getPublicUrl(n); 
          url = data.publicUrl; 
        } 

        const { error: insErr } = await sb.from('posts').insert([{ 
            user_id: currentUser.id, 
            image_url: url, 
            caption: c,
            products: uploadProductsList 
        }]); 

        if(insErr) throw insErr;
        
        closeModal('upload-modal'); 
        renderFeedView();
    } catch(err) {
        alert("Errore salvataggio: " + err.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
  }

  async function loadMessages() {
    const { data: msgs } = await sb.from('messages').select('*')
      .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatId}),and(sender_id.eq.${activeChatId},receiver_id.eq.${currentUser.id})`)
      .order('created_at', { ascending: true });

    const box = document.getElementById('chat-messages');
    box.innerHTML = '';
    msgs?.forEach(m => {
      const isMine = m.sender_id === currentUser.id;
      let contentHtml = escapeHtml(m.content);

      try {
          if (m.content.startsWith('{') && m.content.includes('share_post')) {
              const data = JSON.parse(m.content);
              contentHtml = `
                <div class="shared-post-bubble" onclick="openPostDetail('${data.postId}')">
                    <img src="${data.img}" class="w-full h-32 object-cover">
                    <div class="shared-post-info">
                        <b>Post Condiviso</b><br>
                        ${escapeHtml(data.caption)}
                    </div>
                </div>
              `;
          }
      } catch(e) {}

      box.insertAdjacentHTML('beforeend', `<div class="msg-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}">${contentHtml}</div>`);
    });
    box.scrollTop = box.scrollHeight;
  }

  function openEditProfile() { document.getElementById('edit-profile-modal').classList.remove('hidden'); sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data})=>{ document.getElementById('edit-username').value=data.username; document.getElementById('edit-fullname').value=data.full_name; document.getElementById('edit-avatar-preview').src=data.avatar_url||'https://via.placeholder.com/150'; }); }
  async function saveProfile() { await sb.from('profiles').update({ username:document.getElementById('edit-username').value, full_name:document.getElementById('edit-fullname').value }).eq('id', currentUser.id); closeModal('edit-profile-modal'); openUserProfile(currentUser.id); }
   
  async function uploadAvatar(i) { 
    const f=i.files[0]; if(!f)return; 
    const n=`${currentUser.id}/avatar_${Date.now()}`; 
    const { error: upErr } = await sb.storage.from(BUCKET_AVATARS).upload(n, f); 
    if(upErr) return alert("Errore upload avatar: " + upErr.message);
    const {data}=sb.storage.from(BUCKET_AVATARS).getPublicUrl(n); 
    document.getElementById('edit-avatar-preview').src=data.publicUrl; 
    await sb.from('profiles').update({ avatar_url:data.publicUrl }).eq('id',currentUser.id); 
  }

  async function checkNotifications() {
    const { count } = await sb.from('messages').select('*', { count: 'exact', head: true })
      .eq('receiver_id', currentUser.id)
      .eq('is_read', false);
    document.getElementById('global-gold-dot').style.display = (count > 0) ? 'block' : 'none';
  }

  async function checkAppNotifications() {
    const { count } = await sb.from('notifications')
      .select('*', { count: 'exact', head: true })
      .eq('recipient_id', currentUser.id)
      .eq('is_read', false);

    document.getElementById('notif-gold-dot').style.display = (count > 0) ? 'block' : 'none';
  }

  async function openNotificationsModal() {
    document.getElementById('notifications-modal').classList.remove('hidden');
    document.getElementById('notif-gold-dot').style.display = 'none';

    const c = document.getElementById('notifications-list');
    c.innerHTML = '<div class="text-center text-gray-500 mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';

    const { data: rows, error } = await sb.from('notifications')
      .select('id, created_at, type, actor_id, post_id, comment_id, is_read')
      .eq('recipient_id', currentUser.id)
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) {
      c.innerHTML = `<p class="text-center text-red-400 mt-4">Error: ${escapeHtml(error.message)}</p>`;
      return;
    }

    await sb.from('notifications').update({ is_read: true }).eq('recipient_id', currentUser.id).eq('is_read', false);

    c.innerHTML = '';
    if (!rows || rows.length === 0) {
      c.innerHTML = '<p class="text-center text-gray-500 mt-4">Non hai nuove notifiche.</p>';
      return;
    }

    for (const n of rows) {
      const { data: actor } = await sb.from('profiles').select('username, avatar_url').eq('id', n.actor_id).single();
      
      let icon, txt, clickAction, rightSideContent;
      
      if (n.type === 'follow') {
         icon = '<i class="fa-solid fa-user-plus text-blue-400"></i>';
         txt = 'ha iniziato a seguirti';
         clickAction = `closeModal('notifications-modal'); openUserProfile('${n.actor_id}')`;
         rightSideContent = ''; 
      } else {
         const { data: post } = await sb.from('posts').select('image_url').eq('id', n.post_id).single();
         icon = n.type === 'like' ? '<i class="fa-solid fa-heart text-[#f43f5e]"></i>' : '<i class="fa-regular fa-comment text-[#e2c275]"></i>';
         txt = n.type === 'like' ? 'ha messo like al tuo post' : 'ha commentato il tuo post';
         clickAction = `closeModal('notifications-modal'); openPostDetail('${n.post_id}')`;
         
         if(post?.image_url) {
             rightSideContent = `<img src="${post.image_url}" class="w-10 h-10 rounded object-cover ml-auto border border-gray-700">`;
         } else {
             rightSideContent = `<div class="w-10 h-10 bg-[#27272a] flex items-center justify-center text-[8px] ml-auto border border-gray-700 rounded text-gray-500">TEXT</div>`;
         }
      }

      const html = `
        <div class="flex items-center gap-3 p-3 border-b border-gray-800 hover:bg-white/5 cursor-pointer transition" onclick="${clickAction}">
          <img src="${actor?.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border border-gray-600">
          <div class="flex-1">
            <div class="text-sm text-white">
              <span class="font-bold">${actor?.username || 'User'}</span>
              <span class="text-xs text-gray-400 ml-2">${new Date(n.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
            <div class="text-xs text-gray-300 flex items-center gap-2 mt-1">${icon} ${txt}</div>
          </div>
          ${rightSideContent}
        </div>
      `;
      c.insertAdjacentHTML('beforeend', html);
    }
    checkAppNotifications();
  }

  function showToast(msg) {
    const t = document.getElementById('toast-notif');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('toast-active');
    setTimeout(() => t.classList.remove('toast-active'), 4000);
    document.getElementById('notif-gold-dot').style.display = 'block';
  }

  async function openInboxModal() {
    document.getElementById('inbox-modal').classList.remove('hidden');
    const container = document.getElementById('inbox-list');
    container.innerHTML = '<div class="text-center text-gray-500 mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';

    const { data: msgs } = await sb.from('messages').select('*')
      .or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`)
      .order('created_at', { ascending: false });

    if (!msgs || msgs.length === 0) {
      container.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun messaggio.</p>';
      return;
    }

    const uniqueUsers = new Set();
    const previews = [];

    for (const m of msgs) {
      const otherId = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
      if (!uniqueUsers.has(otherId)) {
        uniqueUsers.add(otherId);
        previews.push({ msg: m, otherId });
      }
    }

    container.innerHTML = '';
    
    for (const item of previews) {
      const { data: u } = await sb.from('profiles').select('*').eq('id', item.otherId).single();
      const isUnread = (item.msg.receiver_id === currentUser.id && !item.msg.is_read);
      const dotHtml = isUnread ? `<div class="w-2 h-2 rounded-full bg-[#e2c275]"></div>` : '';

      const html = `
        <div class="inbox-item" onclick="closeModal('inbox-modal'); openChat('${u.id}', '${u.username}', '${u.avatar_url}')">
          <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-12 h-12 rounded-full object-cover border border-gray-700">
          <div class="flex-1 overflow-hidden">
            <div class="font-bold text-white text-sm flex justify-between items-center">
                ${u.username}
                <i class="fa-solid fa-trash text-gray-600 hover:text-red-500 transition text-xs p-2" onclick="deleteChat('${u.id}', event)" title="Elimina chat"></i>
            </div>
            <div class="text-gray-400 text-xs truncate mt-1 ${isUnread ? 'font-bold text-white' : ''}">${item.msg.sender_id === currentUser.id ? 'Tu: ' : ''}${escapeHtml(item.msg.content)}</div>
          </div>
          ${dotHtml}
        </div>`;
      container.insertAdjacentHTML('beforeend', html);
    }
  }

  async function deleteChat(targetId, event) {
      if(event) event.stopPropagation();
      if(!confirm("Sei sicuro di voler eliminare l'intera conversazione?")) return;
      
      const { error } = await sb.from('messages').delete()
        .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetId}),and(sender_id.eq.${targetId},receiver_id.eq.${currentUser.id})`);
      
      if(error) alert("Errore cancellazione: " + error.message);
      else openInboxModal(); 
  }

  async function openChat(userId, username, avatar) {
    if (userId === currentUser.id) return;
    activeChatId = userId;
    
    document.getElementById('chat-modal').classList.remove('hidden');
    document.getElementById('chat-header-name').innerText = username;
    document.getElementById('chat-header-avatar').src = avatar || 'https://via.placeholder.com/40';
    
    await loadMessages();
    await markAsRead(userId);

    if (chatSub) chatSub.unsubscribe();
    chatSub = sb.channel('chat-room')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        if ((payload.new.sender_id === activeChatId && payload.new.receiver_id === currentUser.id) ||
            (payload.new.sender_id === currentUser.id && payload.new.receiver_id === activeChatId)) {
          loadMessages();
          if (payload.new.receiver_id === currentUser.id) markAsRead(activeChatId);
        }
      }).subscribe();
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !activeChatId) return;
    input.value = '';
    const { error } = await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: activeChatId, content: text }]);
    if (!error) loadMessages();
  }

  async function markAsRead(senderId) {
    await sb.from('messages').update({ is_read: true })
      .eq('sender_id', senderId)
      .eq('receiver_id', currentUser.id);
    checkNotifications(); 
  }

  function closeChat() {
    document.getElementById('chat-modal').classList.add('hidden');
    activeChatId = null;
    if (chatSub) chatSub.unsubscribe();
    checkNotifications();
  }

  function enterApp(u) { 
    currentUser=u; 
    document.getElementById('auth-container').style.transform = "translateY(-100vh)"; 
    setTimeout(async ()=>{ 
      document.getElementById('auth-container').classList.add('hidden'); 
      document.getElementById('app-interface').classList.remove('hidden'); 
      
      renderFeedView(); 
      checkNotifications(); 
      checkAppNotifications(); 

      sb.channel('global-updates')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          if(payload.new.receiver_id === currentUser.id) checkNotifications();
        })
        .on('postgres_changes', { 
          event: 'INSERT', 
          schema: 'public', 
          table: 'notifications',
          filter: `recipient_id=eq.${currentUser.id}`
        }, payload => {
          if (!payload?.new) return;
          if (payload.new.type === 'like') showToast("Nuovo Like!");
          if (payload.new.type === 'comment') showToast("Nuovo Commento!");
          if (payload.new.type === 'follow') showToast("Nuovo Follower!");
          checkAppNotifications();
        })
        .subscribe();

    },600); 
  }

  function mess(t,e){const b=document.getElementById('msg-box');b.innerText=t;b.classList.remove('hidden');b.style.borderColor=e?'red':'green';b.style.color=e?'#fca5a5':'#86efac';}
  function vaiA(m){ document.getElementById('login-form').classList.toggle('hidden',m==='signup'); document.getElementById('signup-form').classList.toggle('hidden',m==='login'); }
  function escapeHtml(t) { return t?t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"):""; }
  function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }

  async function faiLogin() { const {data,error}=await sb.auth.signInWithPassword({ email:document.getElementById('l-email').value, password:document.getElementById('l-pass').value }); if(error)mess(error.message,true); else enterApp(data.user); }
  async function faiRegistrazione() { const {data,error}=await sb.auth.signUp({ email:document.getElementById('r-email').value, password:document.getElementById('r-pass').value }); if(error)return mess(error.message,true); if(data.user) await sb.from('profiles').insert([{ id:data.user.id, username:document.getElementById('r-username').value }]); mess("Registrazione OK!"); }
  async function logout() { await sb.auth.signOut(); location.reload(); }
</script>
</body>
</html>
