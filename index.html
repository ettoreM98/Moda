<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HAWENISHLAND — Official</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- CORE VARIABLES & RESET --- */
    :root {
      --bg-body: #000000;
      --bg-card: #121212; /* Leggermente più chiaro per contrasto */
      --text-main: #ffffff;
      --text-muted: #a0a0a0;
      --border-color: #262626;
    }

    body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
    .serif { font-family: 'Playfair Display', serif; }
    .hidden { display: none !important; }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    /* --- 1. AUTH SCREEN (SLIDESHOW UOMO/DONNA FIXED) --- */
    .auth-wrapper {
      position: fixed; inset: 0; z-index: 999; background: #000;
      display: flex; /* Split verticale */
    }
    
    /* Contenitori Slideshow Laterali */
    .auth-side {
        flex: 1; position: relative; overflow: hidden;
        display: none; /* Nascosti su mobile */
    }
    @media (min-width: 768px) { .auth-side { display: block; } }

    .auth-slide-img {
        position: absolute; inset: 0; width: 100%; height: 100%;
        object-fit: cover; opacity: 0; transition: opacity 2s ease-in-out;
        filter: grayscale(30%) brightness(0.7);
    }
    .auth-slide-img.active { opacity: 1; }

    /* Form Centrale */
    .auth-form-overlay {
      position: absolute; inset: 0;
      display: flex; justify-content: center; align-items: center;
      z-index: 10; pointer-events: none; /* Lascia cliccare sotto se serve */
    }

    .auth-form-box {
      background: rgba(10, 10, 10, 0.95); /* Quasi opaco */
      padding: 40px; border: 1px solid var(--border-color);
      width: 90%; max-width: 450px; text-align: center;
      pointer-events: auto; /* Riattiva click */
      backdrop-filter: blur(10px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    }

    .brand-title { font-family: 'Playfair Display', serif; font-size: 3rem; margin-bottom: 10px; font-style: italic; }
    .input-field {
      width: 100%; background: #222; border: 1px solid var(--border-color);
      padding: 12px 15px; color: #fff; font-size: 14px; outline: none; margin-bottom: 15px;
      border-radius: 4px;
    }
    .input-field:focus { border-color: #555; background: #000; }
    .btn-auth {
      background: #fff; color: #000; padding: 12px; width: 100%; font-weight: 700;
      text-transform: uppercase; border: none; cursor: pointer; transition: 0.2s;
    }
    .btn-auth:hover { background: #ddd; }

    /* --- 2. APP LAYOUT --- */
    #app-interface { display: none; height: 100vh; width: 100vw; overflow: hidden; position: relative; }

    .mobile-header {
      display: flex; align-items: center; justify-content: space-between;
      height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border-color);
      position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px); z-index: 50;
    }

    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100;
      opacity: 0; pointer-events: none; transition: 0.3s;
    }
    .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

    .sidebar {
      position: fixed; top: 0; left: 0; bottom: 0; width: 260px;
      background: #0a0a0a; border-right: 1px solid var(--border-color); z-index: 101;
      transform: translateX(-100%); transition: transform 0.3s ease-in-out;
      display: flex; flex-direction: column; padding: 30px 20px;
    }
    .sidebar.active { transform: translateX(0); }

    .nav-link {
      display: flex; align-items: center; gap: 15px; padding: 15px 10px;
      color: #aaa; cursor: pointer; transition: 0.2s; font-size: 16px; font-weight: 500;
      border-radius: 8px; margin-bottom: 5px;
    }
    .nav-link:hover { color: #fff; background: #1a1a1a; }
    .nav-link i { width: 24px; text-align: center; }

    /* Main Content Area */
    .main-wrapper {
      width: 100%; height: 100%; overflow-y: auto; padding-top: 60px;
      display: flex; flex-direction: column; align-items: center;
    }

    .content-container {
      width: 100%; max-width: 600px; /* Larghezza ottimale per iPad/Desktop */
      padding: 20px 15px 80px;
    }

    /* --- POST CARD (FIXED & RESTORED) --- */
    .post-card {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 12px; margin-bottom: 25px; overflow: hidden;
    }
    
    /* HEADER POST: Chi ha pubblicato */
    .post-header { 
        padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; 
        border-bottom: 1px solid #1a1a1a;
    }
    .post-author { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .author-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
    .author-name { font-weight: 600; font-size: 14px; }

    /* IMMAGINE */
    .post-image { width: 100%; display: block; object-fit: cover; max-height: 700px; }
    
    /* AZIONI: Like e Commenti */
    .post-actions-bar { padding: 12px 15px 8px; display: flex; gap: 20px; font-size: 24px; }
    .action-icon { cursor: pointer; transition: 0.2s; color: #fff; display: flex; align-items: center; gap: 6px; }
    .action-icon:hover { color: #ccc; }
    .action-icon.liked { color: #ef4444; }
    .action-icon.liked i { font-weight: 900; }

    /* TESTO E COMMENTI */
    .post-likes-count { padding: 0 15px; font-weight: 600; font-size: 14px; margin-bottom: 6px; }
    .post-caption-area { padding: 0 15px 15px; font-size: 14px; line-height: 1.4; }
    .caption-username { font-weight: 700; margin-right: 6px; cursor: pointer; }
    .view-comments-btn { color: var(--text-muted); cursor: pointer; margin-top: 6px; display: block; }

    /* PROFILE & MODALS (Keep existing styles) */
    .profile-header { text-align: center; padding: 30px 0; }
    .avatar-xl { width: 100px; height: 100px; border-radius: 50%; border: 2px solid #333; padding: 2px; object-fit: cover; margin: 0 auto 15px; }
    .stats-row { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
    .stat-box { text-align: center; cursor: pointer; }
    .stat-num { font-size: 18px; font-weight: 700; display: block; }
    .stat-label { font-size: 11px; text-transform: uppercase; color: #888; }

    .modal-wrap { position: fixed; inset: 0; z-index: 200; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); }
    .modal-wrap.active { display: flex; }
    .modal-box { background: #111; border: 1px solid #333; width: 95%; max-width: 450px; max-height: 85vh; overflow-y: auto; border-radius: 12px; position: relative; display: flex; flex-direction: column; }
    .modal-header { padding: 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }

    /* Detail Modal Specifics */
    .detail-layout { display: flex; flex-direction: column; height: 100%; }
    @media(min-width: 768px) { .detail-layout { flex-direction: row; max-width: 800px; } .detail-img-side { flex: 1.5; background: #000; display: flex; align-items: center; } .detail-info-side { flex: 1; border-left: 1px solid #222; display: flex; flex-direction: column; } }
    .comment-list { flex: 1; overflow-y: auto; padding: 15px; }
    .comment-row { display: flex; gap: 10px; margin-bottom: 12px; font-size: 13px; }
  </style>
</head>

<body>

<div id="auth-container" class="auth-wrapper">
  
  <div class="auth-side" id="slide-woman">
    <img class="auth-slide-img active" src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?q=80&w=1000"> <img class="auth-slide-img" src="https://images.unsplash.com/photo-1515886657613-9f3515b0c78f?q=80&w=1000"> <img class="auth-slide-img" src="https://images.unsplash.com/photo-1529139574466-a30052416880?q=80&w=1000"> </div>

  <div class="auth-side" id="slide-man">
    <img class="auth-slide-img active" src="https://images.unsplash.com/photo-1617137968427-85924c800a22?q=80&w=1000"> <img class="auth-slide-img" src="https://images.unsplash.com/photo-1488161628813-04466f872be2?q=80&w=1000"> <img class="auth-slide-img" src="https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=1000"> </div>

  <div class="auth-form-overlay">
    <div class="auth-form-box">
      <h1 class="brand-title">Hawenish</h1>
      <p class="text-xs text-gray-400 mb-6 uppercase tracking-widest">Official Fashion Society</p>
      <div id="msg-box" class="text-xs mb-4 hidden p-2 text-red-500 border border-red-800 bg-red-900/20 rounded"></div>

      <div id="login-form">
        <input type="email" id="l-email" class="input-field" placeholder="Email Address" required>
        <input type="password" id="l-pass" class="input-field" placeholder="Password" required>
        <button onclick="faiLogin()" class="btn-auth">Accedi</button>
        <div class="flex justify-between mt-4 text-xs text-gray-400">
          <span class="cursor-pointer hover:text-white" onclick="toggleAuth('signup')">Non hai un account? Registrati</span>
          <span class="cursor-pointer hover:text-white" onclick="recuperoPassword()">Password dimenticata?</span>
        </div>
      </div>

      <div id="signup-form" class="hidden">
        <input type="text" id="r-username" class="input-field" placeholder="Username (Pubblico)" required>
        <input type="text" id="r-nome" class="input-field" placeholder="Nome Completo" required>
        <input type="email" id="r-email" class="input-field" placeholder="Email" required>
        <input type="password" id="r-pass" class="input-field" placeholder="Password (min. 8)" required>
        <button onclick="faiRegistrazione()" class="btn-auth">Crea Account</button>
        <div class="mt-4 text-xs text-gray-400 cursor-pointer hover:text-white" onclick="toggleAuth('login')">Torna al Login</div>
      </div>
    </div>
  </div>
</div>

<div id="app-interface">
  <div class="mobile-header">
    <i class="fa-solid fa-bars text-xl cursor-pointer" onclick="toggleSidebar(true)"></i>
    <span class="serif italic text-lg">Hawenishland</span>
    <i class="fa-solid fa-magnifying-glass text-xl cursor-pointer" onclick="navigate('search')"></i>
  </div>

  <div class="sidebar-overlay" id="sb-overlay" onclick="toggleSidebar(false)"></div>
  <nav class="sidebar" id="sb-menu">
    <div class="flex justify-between items-center mb-8 pl-2">
      <h2 class="serif italic text-xl">Menu</h2>
      <i class="fa-solid fa-xmark text-xl cursor-pointer" onclick="toggleSidebar(false)"></i>
    </div>
    <div class="nav-link" onclick="navigate('feed')"><i class="fa-solid fa-house"></i> Home Feed</div>
    <div class="nav-link" onclick="navigate('search')"><i class="fa-solid fa-magnifying-glass"></i> Cerca Utenti</div>
    <div class="nav-link" onclick="navigate('create')"><i class="fa-regular fa-square-plus"></i> Crea Post</div>
    <div class="nav-link" onclick="navigate('profile')"><i class="fa-regular fa-user"></i> Il Mio Profilo</div>
    <div class="mt-auto nav-link text-red-500 hover:bg-red-900/20" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Esci</div>
  </nav>

  <div class="main-wrapper" id="main-scroll">
    
    <div id="view-feed" class="content-container">
      <div id="posts-container"></div>
    </div>

    <div id="view-profile" class="content-container hidden">
      <div class="profile-header">
        <button id="btn-back-profile" class="hidden mb-4 text-sm text-gray-400 hover:text-white flex items-center gap-2" onclick="navigate('feed')"><i class="fa-solid fa-arrow-left"></i> Torna al Feed</button>
        <img id="p-avatar" src="" class="avatar-xl cursor-pointer" onclick="handleAvatarClick()">
        <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="uploadAvatar()">
        
        <h2 id="p-username" class="text-2xl font-light mt-2">@username</h2>
        <p id="p-fullname" class="text-sm text-gray-500 font-bold">Nome Cognome</p>
        
        <div class="stats-row">
          <div class="stat-box" onclick="openList('followers')"><span class="stat-num" id="val-followers">0</span><span class="stat-label">Follower</span></div>
          <div class="stat-box" onclick="openList('following')"><span class="stat-num" id="val-following">0</span><span class="stat-label">Seguiti</span></div>
        </div>

        <div id="profile-actions" class="flex justify-center gap-3 mt-4"></div>

        <div id="edit-panel" class="hidden mt-6 bg-[#1a1a1a] p-4 rounded-lg text-left border border-[#333]">
           <p class="text-xs uppercase text-gray-500 mb-2 font-bold">Modifica Profilo</p>
           <input id="ed-name" class="input-field mb-2" placeholder="Nome Completo">
           <input id="ed-user" class="input-field mb-2" placeholder="Username">
           <button class="btn-auth py-2 text-sm mb-4" onclick="saveProfile()">Salva Modifiche</button>
           
           <p class="text-xs uppercase text-gray-500 mb-2 font-bold border-t border-[#333] pt-4">Sicurezza Account</p>
           <button class="w-full border border-red-800 text-red-500 py-2 text-sm rounded mb-2 hover:bg-red-900/20" onclick="sendReset()">Invia Reset Password</button>
           <button class="w-full border border-blue-800 text-blue-500 py-2 text-sm rounded hover:bg-blue-900/20" onclick="changeEmail()">Cambia Email</button>
        </div>
      </div>
      <div class="border-t border-[#262626] pt-6" id="profile-posts"></div>
    </div>
  </div>
</div>

<div id="modal-create" class="modal-wrap">
  <div class="modal-box">
    <div class="modal-header"><span>Crea Post</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-create')"></i></div>
    <div class="p-4">
      <textarea id="post-caption" class="w-full bg-[#1a1a1a] text-white p-3 border border-[#333] outline-none mb-4 rounded resize-none" rows="3" placeholder="Scrivi una didascalia..."></textarea>
      <label class="block mb-4 p-8 border-2 border-dashed border-[#333] text-center cursor-pointer hover:border-white rounded">
         <i class="fa-regular fa-image text-2xl mb-2 text-gray-400"></i><br><span class="text-sm text-gray-500">Tocca per caricare una foto</span>
         <input type="file" id="post-file" class="hidden" accept="image/*">
      </label>
      <button onclick="submitPost()" class="btn-auth">Pubblica Post</button>
    </div>
  </div>
</div>

<div id="modal-search" class="modal-wrap">
  <div class="modal-box h-[60vh]">
    <div class="p-3 border-b border-[#333] flex gap-2 items-center">
      <i class="fa-solid fa-magnifying-glass text-gray-400"></i>
      <input id="search-q" class="flex-1 bg-transparent outline-none text-white" placeholder="Cerca utenti..." onkeyup="doSearch()">
      <i class="fa-solid fa-xmark cursor-pointer px-2" onclick="closeModal('modal-search')"></i>
    </div>
    <div id="search-res" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="modal-list" class="modal-wrap">
  <div class="modal-box h-[50vh]">
    <div class="modal-header"><span id="list-title">Lista</span><i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-list')"></i></div>
    <div id="list-body" class="flex-1 overflow-y-auto p-2"></div>
  </div>
</div>

<div id="modal-detail" class="modal-wrap">
  <div class="modal-box md:max-w-[800px] md:flex-row h-full md:h-[80vh]" id="detail-box-inner">
    <div class="hidden md:flex flex-1 bg-black items-center justify-center" id="dt-img-container">
        <img id="dt-img-desk" class="max-w-full max-h-full object-contain">
    </div>
    <div class="flex-1 flex flex-col h-full md:border-l border-[#333] bg-[#121212]">
       <div class="modal-header p-3">
         <div class="flex items-center gap-2 cursor-pointer" id="dt-header-link">
             <img id="dt-avatar" class="w-8 h-8 rounded-full border border-[#333]">
             <span id="dt-username" class="font-bold text-sm"></span>
         </div>
         <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-detail')"></i>
       </div>
       <div class="flex-1 overflow-y-auto" id="dt-scroll-area">
           <img id="dt-img-mobile" class="w-full md:hidden">
           <div class="p-4 border-b border-[#262626]">
               <span id="dt-caption-user" class="font-bold mr-2 text-sm cursor-pointer"></span>
               <span id="dt-caption" class="text-sm"></span>
           </div>
           <div id="dt-comments-list" class="p-4"></div>
       </div>
       <div class="p-3 border-t border-[#333] flex gap-2 bg-[#1a1a1a] mt-auto">
           <input id="new-comm" class="flex-1 bg-transparent outline-none text-sm" placeholder="Aggiungi un commento...">
           <button onclick="postComm()" class="text-blue-400 font-bold text-sm">Pubblica</button>
       </div>
    </div>
  </div>
</div>


<script>
const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
const sb = window.supabase.createClient(SB_URL, SB_KEY);

let currentUser = null;
let viewingProfileId = null;
let currentDetailId = null;

// INIT & SLIDESHOW
window.addEventListener('load', async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) enterApp(session.user);
  
  // Slideshow Logic (Alternating)
  let i = 0;
  const women = document.querySelectorAll('#slide-woman .auth-slide-img');
  const men = document.querySelectorAll('#slide-man .auth-slide-img');
  if(women.length && men.length) {
    setInterval(() => {
      women[i].classList.remove('active');
      men[i].classList.remove('active');
      i = (i + 1) % women.length;
      women[i].classList.add('active');
      men[i].classList.add('active');
    }, 4000); // Change every 4 seconds
  }
});

// UI HELPERS
function toggleAuth(mode) {
  document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
  document.getElementById('signup-form').classList.toggle('hidden', mode !== 'signup');
  mess('', true); // clear errors
}
function toggleSidebar(show) {
  const sb = document.getElementById('sb-menu'); const ov = document.getElementById('sb-overlay');
  if(show) { sb.classList.add('active'); ov.classList.add('active'); } else { sb.classList.remove('active'); ov.classList.remove('active'); }
}
function navigate(view) {
  toggleSidebar(false);
  if(view === 'search') { openModal('modal-search'); document.getElementById('search-q').focus(); return; }
  if(view === 'create') { openModal('modal-create'); return; }
  
  document.getElementById('view-feed').classList.add('hidden');
  document.getElementById('view-profile').classList.add('hidden');
  document.getElementById('main-scroll').scrollTop = 0;
  
  if(view === 'feed') { document.getElementById('view-feed').classList.remove('hidden'); loadFeed(); }
  if(view === 'profile') { document.getElementById('view-profile').classList.remove('hidden'); loadProfile(currentUser.id); }
}
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function mess(txt, err=false) { const b=document.getElementById('msg-box'); b.innerText=txt; b.classList.toggle('hidden', !txt); b.classList.toggle('text-red-500', err); b.classList.toggle('text-green-500', !err); }
function escapeHtml(s) { return (s||'').replaceAll('&','&amp;').replaceAll('<','&lt;'); }

// AUTH LOGIC
async function faiLogin() {
  const e = document.getElementById('l-email').value, p = document.getElementById('l-pass').value;
  if(!e||!p) return mess("Inserisci email e password", true);
  const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
  if(error) mess(error.message, true); else enterApp(data.user);
}
async function faiRegistrazione() {
  const e = document.getElementById('r-email').value, p = document.getElementById('r-pass').value, u = document.getElementById('r-username').value, n = document.getElementById('r-nome').value;
  if(!u || !n || !e || !p) return mess("Compila tutti i campi obbligatori", true);
  const { data, error } = await sb.auth.signUp({ email:e, password:p, options: { data: { first_name:n } } });
  if(error) mess(error.message, true);
  else {
    if(data.user) await sb.from('profiles').upsert([{ id:data.user.id, username:u.toLowerCase(), full_name:n }]);
    alert("Successo! Controlla la tua email per confermare."); toggleAuth('login');
  }
}
async function logout() { await sb.auth.signOut(); location.reload(); }
function enterApp(user) {
  currentUser = user;
  document.getElementById('auth-container').style.opacity = '0';
  setTimeout(() => {
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('app-interface').style.display = 'block';
    navigate('feed');
  }, 500);
}

// FEED LOGIC (FIXED: POST HEADER & COMMENTS)
async function loadFeed() {
  const c = document.getElementById('posts-container');
  c.innerHTML = '<div class="text-center mt-10 text-gray-600"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';

  const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
  let ids = [currentUser.id];
  if(follows) ids = [...ids, ...follows.map(f => f.followed_id)];

  let query = sb.from('posts').select(`*, profiles(username, avatar_url), likes(count), comments(count)`).order('created_at', { ascending: false }).limit(50);
  if (ids.length > 1) query = query.in('user_id', ids); // Filter if following someone

  const { data: posts } = await query;
  
  if(!posts || posts.length === 0) {
    // Discovery fallback if feed empty
    const { data: global } = await sb.from('posts').select(`*, profiles(username, avatar_url), likes(count), comments(count)`).order('created_at', { ascending: false }).limit(20);
    renderPosts(c, global || [], true);
  } else {
    renderPosts(c, posts, false);
  }
}

function renderPosts(container, posts, isGlobal) {
  container.innerHTML = '';
  if(isGlobal && posts.length > 0) container.innerHTML = '<div class="text-center text-xs text-gray-500 mb-4 uppercase tracking-widest">Esplora (Nessun seguito)</div>';
  if(!posts || posts.length === 0) return container.innerHTML = '<div class="text-center mt-10 text-gray-600">Nessun post trovato.</div>';

  posts.forEach(p => {
    const u = p.profiles || { username: 'user', avatar_url: null };
    const likesCount = p.likes ? p.likes[0].count : 0;
    const commCount = p.comments ? p.comments[0].count : 0;

    const html = `
      <div class="post-card">
        <div class="post-header">
          <div class="post-author" onclick="loadProfile('${p.user_id}')">
            <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="author-avatar">
            <span class="author-name">@${u.username}</span>
          </div>
          ${p.user_id === currentUser.id ? `<i class="fa-solid fa-trash text-gray-600 hover:text-red-500 cursor-pointer px-2" onclick="deletePost('${p.id}')"></i>` : ''}
        </div>

        ${p.image_url ? `<img src="${p.image_url}" class="post-image" ondblclick="toggleLike('${p.id}')">` : ''}

        <div class="post-actions-bar">
           <div class="action-icon" id="btn-like-${p.id}" onclick="toggleLike('${p.id}')">
             <i class="fa-regular fa-heart"></i>
           </div>
           <div class="action-icon" onclick="openDetail('${p.id}')">
             <i class="fa-regular fa-comment"></i>
           </div>
           <div class="action-icon"><i class="fa-regular fa-paper-plane"></i></div>
        </div>

        <div class="post-likes-count"><span id="cnt-like-${p.id}">${likesCount}</span> Mi piace</div>
        <div class="post-caption-area">
          <div><span class="caption-username" onclick="loadProfile('${p.user_id}')">@${u.username}</span>${escapeHtml(p.caption)}</div>
          ${commCount > 0 ? `<div class="view-comments-btn" onclick="openDetail('${p.id}')">Mostra tutti e ${commCount} i commenti</div>` : ''}
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    checkLikeStatus(p.id); // Async check if I liked it
  });
}

// PROFILE LOGIC
async function loadProfile(uid) {
  viewingProfileId = uid;
  const isMe = (uid === currentUser.id);
  
  document.getElementById('btn-back-profile').classList.toggle('hidden', isMe);
  document.getElementById('edit-panel').classList.toggle('hidden', !isMe);

  const { data: prof } = await sb.from('profiles').select('*').eq('id', uid).single();
  if(prof) {
    document.getElementById('p-avatar').src = prof.avatar_url || 'https://via.placeholder.com/150';
    document.getElementById('p-username').innerText = '@' + prof.username;
    document.getElementById('p-fullname').innerText = prof.full_name;
    if(isMe) { document.getElementById('ed-name').value = prof.full_name; document.getElementById('ed-user').value = prof.username; }
  }

  // Stats
  const f1 = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', uid);
  const f2 = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', uid);
  document.getElementById('val-followers').innerText = f1.count || 0;
  document.getElementById('val-following').innerText = f2.count || 0;

  // Follow Button
  const actDiv = document.getElementById('profile-actions'); actDiv.innerHTML = '';
  if(!isMe) {
    const { data: rel } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', uid);
    const isFollowing = rel && rel.length > 0;
    actDiv.innerHTML = `<button onclick="doFollow('${uid}', ${isFollowing})" class="px-6 py-2 rounded border ${isFollowing ? 'bg-[#333] text-white border-[#333]' : 'bg-white text-black border-white'} font-bold text-sm transition hover:opacity-90">${isFollowing ? 'Segui già' : 'Segui'}</button>`;
  } else {
    actDiv.innerHTML = `<button onclick="document.getElementById('edit-panel').classList.toggle('hidden')" class="px-6 py-2 rounded border border-[#333] text-gray-300 font-bold text-sm hover:bg-[#1a1a1a]">Modifica</button>`;
  }

  // Posts
  const { data: posts } = await sb.from('posts').select(`*, profiles(username, avatar_url), likes(count), comments(count)`).eq('user_id', uid).order('created_at', { ascending: false });
  renderPosts(document.getElementById('profile-posts'), posts || [], false);
  navigate('profile');
}

function handleAvatarClick() { if(viewingProfileId === currentUser.id) document.getElementById('avatar-input').click(); }
async function uploadAvatar() {
  const f = document.getElementById('avatar-input').files[0]; if(!f) return;
  const path = `${currentUser.id}/${Date.now()}`;
  await sb.storage.from('avatars').upload(path, f);
  const { data } = sb.storage.from('avatars').getPublicUrl(path);
  await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
  loadProfile(currentUser.id);
}
async function saveProfile() {
    const n = document.getElementById('ed-name').value, u = document.getElementById('ed-user').value;
    await sb.from('profiles').update({ full_name: n, username: u }).eq('id', currentUser.id);
    alert("Profilo aggiornato"); loadProfile(currentUser.id);
}
async function doFollow(uid, isFollowing) {
    if(isFollowing) await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', uid);
    else await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: uid }]);
    loadProfile(uid);
}

// INTERACTIONS & DETAIL
async function checkLikeStatus(pid) {
  const { data } = await sb.from('likes').select('*').eq('post_id', pid).eq('user_id', currentUser.id);
  const btn = document.getElementById(`btn-like-${pid}`);
  if(btn && data.length) { btn.classList.add('liked'); btn.querySelector('i').classList.replace('fa-regular','fa-solid'); }
}
async function toggleLike(pid) {
   const btn = document.getElementById(`btn-like-${pid}`); const icon = btn.querySelector('i');
   const isLiked = btn.classList.contains('liked');
   
   // Optimistic UI update
   btn.classList.toggle('liked');
   icon.classList.toggle('fa-solid', !isLiked); icon.classList.toggle('fa-regular', isLiked);
   
   const cntEl = document.getElementById(`cnt-like-${pid}`);
   let current Count = parseInt(cntEl.innerText) || 0;
   cntEl.innerText = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;

   if(isLiked) await sb.from('likes').delete().eq('post_id', pid).eq('user_id', currentUser.id);
   else await sb.from('likes').insert([{ post_id: pid, user_id: currentUser.id }]);
}

async function openDetail(pid) {
    currentDetailId = pid;
    openModal('modal-detail');
    document.getElementById('dt-comments-list').innerHTML = '<div class="text-gray-500">Caricamento...</div>';
    
    const { data: p } = await sb.from('posts').select(`*, profiles(username, avatar_url)`).eq('id', pid).single();
    
    // Setup images (Desktop vs Mobile)
    const imgDesk = document.getElementById('dt-img-desk'); const imgMob = document.getElementById('dt-img-mobile');
    if(p.image_url) {
        imgDesk.src = p.image_url; imgDesk.parentElement.classList.remove('hidden');
        imgMob.src = p.image_url; imgMob.classList.remove('hidden');
    } else {
        imgDesk.parentElement.classList.add('hidden'); imgMob.classList.add('hidden');
    }

    // Header Info
    document.getElementById('dt-avatar').src = p.profiles.avatar_url || 'https://via.placeholder.com/30';
    document.getElementById('dt-username').innerText = '@'+p.profiles.username;
    document.getElementById('dt-header-link').onclick = () => { closeModal('modal-detail'); loadProfile(p.user_id); };

    // Caption
    document.getElementById('dt-caption-user').innerText = '@'+p.profiles.username;
    document.getElementById('dt-caption-user').onclick = () => { closeModal('modal-detail'); loadProfile(p.user_id); };
    document.getElementById('dt-caption').innerText = p.caption || '';

    // Load Comments
    const { data: comms } = await sb.from('comments').select(`*, profiles(username, avatar_url)`).eq('post_id', pid).order('created_at', {ascending: true});
    const cList = document.getElementById('dt-comments-list'); cList.innerHTML = '';
    if(!comms || comms.length === 0) cList.innerHTML = '<div class="text-gray-500 text-sm">Nessun commento.</div>';
    else {
        comms.forEach(c => {
            cList.insertAdjacentHTML('beforeend', `
               <div class="flex gap-3 mb-3 text-sm">
                 <img src="${c.profiles.avatar_url||'https://via.placeholder.com/30'}" class="w-8 h-8 rounded-full cursor-pointer" onclick="closeModal('modal-detail'); loadProfile('${c.user_id}')">
                 <div><span class="font-bold mr-2 cursor-pointer" onclick="closeModal('modal-detail'); loadProfile('${c.user_id}')">@${c.profiles.username}</span><span class="text-gray-300">${escapeHtml(c.content)}</span></div>
               </div>
            `);
        });
    }
    // Scroll to bottom of comments
    setTimeout(() => { document.getElementById('dt-scroll-area').scrollTop = document.getElementById('dt-scroll-area').scrollHeight; }, 100);
}

async function postComm() {
    const t = document.getElementById('new-comm').value.trim(); if(!t) return;
    await sb.from('comments').insert([{ post_id: currentDetailId, user_id: currentUser.id, content: t }]);
    document.getElementById('new-comm').value = '';
    openDetail(currentDetailId); // Reload detail
    loadFeed(); // Refresh feed counts
}

// OTHER ACTIONS
async function submitPost() {
  const c = document.getElementById('post-caption').value; const f = document.getElementById('post-file').files[0];
  if(!c && !f) return alert("Aggiungi foto o testo");
  let url = null;
  if(f) { const p = `${currentUser.id}/post_${Date.now()}`; await sb.storage.from('posts').upload(p, f); url = sb.storage.from('posts').getPublicUrl(p).data.publicUrl; }
  await sb.from('posts').insert([{ user_id: currentUser.id, image_url: url, caption: c }]);
  closeModal('modal-create'); document.getElementById('post-caption').value=''; document.getElementById('post-file').value='';
  navigate('feed');
}
async function deletePost(id) { if(confirm("Eliminare?")) { await sb.from('posts').delete().eq('id', id); loadFeed(); } }

async function doSearch() {
  const q = document.getElementById('search-q').value; if(q.length < 2) return;
  const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
  const c = document.getElementById('search-res'); c.innerHTML = '';
  data.forEach(u => {
     c.insertAdjacentHTML('beforeend', `<div class="flex items-center gap-3 p-3 hover:bg-[#222] cursor-pointer rounded" onclick="closeModal('modal-search'); loadProfile('${u.id}')"><img src="${u.avatar_url||'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover"><span class="font-bold">@${u.username}</span></div>`);
  });
}

async function openList(type) {
    openModal('modal-list'); document.getElementById('list-title').innerText = type === 'followers' ? 'Followers' : 'Seguiti';
    const c = document.getElementById('list-body'); c.innerHTML = 'Caricamento...';
    let q = sb.from('follows').select(type === 'followers' ? 'follower_id' : 'followed_id').eq(type === 'followers' ? 'followed_id' : 'follower_id', viewingProfileId);
    const { data } = await q;
    if(!data || data.length === 0) return c.innerHTML = '<div class="p-4 text-gray-500">Lista vuota.</div>';
    const ids = data.map(r => type === 'followers' ? r.follower_id : r.followed_id);
    const { data: profs } = await sb.from('profiles').select('*').in('id', ids);
    c.innerHTML = '';
    profs.forEach(u => {
        c.insertAdjacentHTML('beforeend', `<div class="flex items-center gap-3 p-3 hover:bg-[#222] cursor-pointer rounded" onclick="closeModal('modal-list'); loadProfile('${u.id}')"><img src="${u.avatar_url||'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover"><span class="font-bold">@${u.username}</span></div>`);
    });
}

// Security
async function sendReset() { if(confirm("Inviare mail di reset?")) { await sb.auth.resetPasswordForEmail(currentUser.email); alert("Mail inviata."); }}
async function changeEmail() { const m = prompt("Nuova email:"); if(m) { await sb.auth.updateUser({ email: m }); alert("Controlla la mail per confermare."); }}
async function recuperoPassword() { const m = prompt("Tua email:"); if(m) { await sb.auth.resetPasswordForEmail(m); alert("Se l'email esiste, riceverai un link."); }}
</script>
</body>
</html>
