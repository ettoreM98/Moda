<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HAWENISHLAND — Fashion Feed</title>

  <link rel="preconnect" href="https://cdn.tailwindcss.com">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@latest" defer></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,500;0,700;1,500&display=swap" rel="stylesheet">

  <style>
    /* --- LUXURY LIGHT THEME --- */
    :root {
      --bg-body: #ffffff;
      --bg-secondary: #f9f9f9;
      --text-main: #1a1a1a;
      --text-muted: #666666;
      --gold: #c6a87c; /* Oro caldo, elegante */
      --gold-dark: #a68b5b;
      --border: #e5e5e5;
      --radius: 12px;
      --shadow: 0 4px 20px rgba(0,0,0,0.05);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body { 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      font-family: 'Manrope', sans-serif; 
      margin: 0; 
      overflow-x: hidden; 
      -webkit-font-smoothing: antialiased;
    }

    /* Scrollbar nascosta ma funzionale */
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    
    .hidden { display: none !important; }
    .serif { font-family: 'Playfair Display', serif; }

    /* --- LAYOUT --- */
    .app-layout { 
      display: flex; 
      max-width: 1000px; 
      margin: 0 auto; 
      min-height: 100vh; 
    }

    /* --- NUOVA SIDEBAR (Minimalist) --- */
    .sidebar { 
      width: 240px; 
      height: 100vh; 
      position: sticky; 
      top: 0; 
      border-right: 1px solid var(--border);
      padding: 40px 30px;
      display: flex; 
      flex-direction: column; 
      background: #fff;
      z-index: 50;
    }

    .brand-logo {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 60px;
      color: #000;
      cursor: pointer;
    }

    .nav-item { 
      display: flex; align-items: center; gap: 15px;
      padding: 12px 0;
      cursor: pointer; 
      color: var(--text-muted);
      font-size: 16px;
      font-weight: 500;
      transition: all 0.2s;
      margin-bottom: 10px;
    }
    
    .nav-item:hover, .nav-item.active { color: #000; font-weight: 700; }
    .nav-item i { font-size: 22px; width: 30px; text-align: center; }
    .nav-text { display: block; }

    /* MOBILE NAVIGATION (Bottom Bar) */
    @media (max-width: 800px) {
      .sidebar { 
        width: 100%; height: 60px; 
        position: fixed; bottom: 0; top: auto; left: 0; 
        flex-direction: row; justify-content: space-around; 
        padding: 0; 
        border-right: none; border-top: 1px solid var(--border);
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
      }
      .brand-logo { display: none; }
      .nav-text { display: none; }
      .nav-item { margin: 0; padding: 0; height: 100%; width: 100%; justify-content: center; }
      .nav-item i { font-size: 24px; }
      .app-layout { display: block; padding-bottom: 70px; }
    }

    /* --- FEED AREA --- */
    .main-content { flex: 1; padding: 40px; max-width: 600px; margin: 0 auto; }
    @media (max-width: 800px) { .main-content { padding: 20px 0; width: 100%; } }

    /* TABS */
    .feed-tabs-container {
      display: flex; justify-content: center; gap: 40px;
      margin-bottom: 30px; border-bottom: 1px solid var(--border);
      padding-bottom: 15px; position: sticky; top: 0; background: rgba(255,255,255,0.9); z-index: 40; backdrop-filter: blur(5px);
    }
    .feed-tab {
      font-size: 14px; font-weight: 600; color: #999; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
    }
    .feed-tab.active { color: #000; position: relative; }
    .feed-tab.active::after {
      content: ''; position: absolute; bottom: -16px; left: 0; width: 100%; height: 2px; background: #000;
    }

    /* POST CARD (Clean) */
    .post-card { 
      background: #fff; margin-bottom: 50px; 
      border-bottom: 1px solid var(--border); padding-bottom: 20px;
    }
    .post-card:last-child { border-bottom: none; }

    .post-header { display: flex; align-items: center; justify-content: space-between; padding: 0 10px 15px 10px; }
    .user-badge { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border); }
    .username { font-weight: 700; font-size: 14px; color: #000; }
    .post-date { font-size: 11px; color: #999; }

    .post-img-container { position: relative; width: 100%; background: #f0f0f0; cursor: pointer; }
    .post-img { width: 100%; display: block; min-height: 300px; object-fit: cover; }

    .shop-tag-overlay {
      position: absolute; bottom: 15px; left: 15px;
      background: rgba(255,255,255,0.9); padding: 6px 14px;
      border-radius: 4px; display: flex; align-items: center; gap: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s;
    }
    .shop-tag-overlay:hover { transform: translateY(-2px); }
    .shop-tag-overlay span { font-size: 11px; font-weight: 700; color: #000; }

    .action-bar { display: flex; gap: 20px; padding: 15px 10px; }
    .icon-btn { font-size: 24px; cursor: pointer; color: #1a1a1a; transition: 0.2s; display: flex; align-items: center; gap: 6px; }
    .icon-btn:hover { color: var(--gold); }
    .likes-count-clickable { font-size: 14px; font-weight: 700; }

    .caption-box { padding: 0 10px; font-size: 14px; line-height: 1.5; color: #333; }
    .caption-user { font-weight: 700; margin-right: 5px; cursor: pointer; }

    /* BUTTONS */
    .btn-gold {
      background: #000; color: #fff; padding: 14px; border-radius: 4px;
      font-weight: 600; border: none; cursor: pointer; width: 100%;
      text-transform: uppercase; letter-spacing: 1px; font-size: 12px;
      transition: 0.2s;
    }
    .btn-gold:hover { background: var(--gold); }

    .btn-gold-outline {
      border: 1px solid #000; color: #000; padding: 8px 16px; border-radius: 4px;
      font-weight: 600; cursor: pointer; background: transparent; font-size: 11px;
    }

    /* LOGIN */
    .split-layout { 
      display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:200; background:#fff; 
      transition: transform 0.6s ease-in-out;
    }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#f0f0f0; }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{ position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; opacity:0; transition:opacity 2s; }
    .visual-side img.active{ opacity:1; }
    
    .form-side { flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; max-width:500px; margin:auto; }
    .input-group { margin-bottom: 20px; }
    .input-label { font-size: 10px; font-weight: 700; text-transform:uppercase; color: #999; margin-bottom:5px; display:block;}
    input.auth-input { 
      background: #f9f9f9; border: 1px solid #eee; padding: 12px; 
      width:100%; outline:none; font-size:14px; border-radius: 4px; color: #000;
    }
    input.auth-input:focus { border-color: #000; background: #fff; }
    
    .btn-black { 
      background: #000; color: #fff; padding: 15px; font-weight: 700; text-transform:uppercase; 
      width:100%; cursor:pointer; border:none; border-radius:4px; margin-top:10px; 
    }
    .link-small { text-align:center; margin-top:20px; font-size:12px; color:#666; cursor:pointer; }

    /* MODALS - FIXED Z-INDEX & CLICK */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0, 0.6); backdrop-filter: blur(5px);
      z-index: 9999; /* Z-Index altissimo per essere sicuro che sia sopra tutto */
      display: flex; justify-content: center; align-items: center;
    }
    
    .glass-modal { 
      background: #fff; width: 100%; max-width: 450px; max-height: 90vh;
      border-radius: 12px; overflow: hidden; position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      display: flex; flex-direction: column;
    }
    
    /* DETAIL MODAL SPECIAL LAYOUT */
    .detail-layout { width: 95vw; max-width: 1000px; height: 90vh; flex-direction: row; }
    .detail-img-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; }
    .detail-info-side { flex: 1; display: flex; flex-direction: column; background: #fff; border-left: 1px solid #eee; }
    
    @media (max-width: 800px) {
      .detail-layout { flex-direction: column; height: 100%; width: 100%; }
      .glass-modal { border-radius: 0; height: 100%; max-width: 100%; }
    }

    /* CHAT & NOTIF */
    .gold-dot { width: 8px; height: 8px; background: var(--gold); border-radius: 50%; position: absolute; top: 10px; right: -2px; display: none; }
    .msg-bubble { padding: 10px 14px; border-radius: 12px; font-size: 14px; margin-bottom: 8px; max-width: 80%; }
    .msg-mine { background: #000; color: #fff; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-theirs { background: #f0f0f0; color: #000; align-self: flex-start; border-bottom-left-radius: 2px; }
    .inbox-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
    .inbox-item:hover { background: #f9f9f9; }

    /* TOAST */
    .toast-box { 
      position: fixed; top: 20px; right: 20px; background: #000; color: #fff;
      padding: 15px 25px; border-radius: 50px; display: flex; align-items: center; gap: 10px; 
      z-index: 10000; transform: translateY(-100px); transition: transform 0.4s;
    }
    .toast-active { transform: translateY(0); }

    /* Helper Classes */
    .analyzing-box {
        position: absolute; inset: 0; background: rgba(255,255,255,0.9);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        z-index: 10;
    }
    .shared-post-bubble { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; width: 200px; background: #fff; }
    .added-product-item { display: flex; justify-content: space-between; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 5px; border: 1px solid #eee; }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1469334031218-e382a71b716b?q=80&w=1200">
  </div>
  <div class="form-side">
    <h1 class="serif text-5xl mb-10 text-center">Hawenishland</h1>
    <div id="msg-box" class="hidden p-3 text-center mb-5 text-sm rounded bg-gray-100"></div>
    
    <div id="login-form">
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="l-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="l-pass" class="auth-input"></div>
      <button onclick="faiLogin()" class="btn-black">ENTRA</button>
      <p onclick="recuperoPassword()" class="link-small">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="link-small">Nuovo qui? <b>Crea account</b></p>
    </div>

    <div id="signup-form" class="hidden">
      <div class="input-group"><label class="input-label">Username</label><input type="text" id="r-username" class="auth-input"></div>
      <div class="grid grid-cols-2 gap-4">
        <div class="input-group"><label class="input-label">Nome</label><input type="text" id="r-nome" class="auth-input"></div>
        <div class="input-group"><label class="input-label">Cognome</label><input type="text" id="r-cognome" class="auth-input"></div>
      </div>
      <div class="input-group"><label class="input-label">Data Nascita</label><input type="date" id="r-nascita" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Email</label><input type="email" id="r-email" class="auth-input"></div>
      <div class="input-group"><label class="input-label">Password</label><input type="password" id="r-pass" class="auth-input"></div>
      <button onclick="faiRegistrazione()" class="btn-black">ISCRIVITI</button>
      <p onclick="vaiA('login')" class="link-small">Hai già un account?</p>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    <div class="sidebar">
      <div class="brand-logo" onclick="renderFeedView()">Hawenishland</div>
      
      <div class="nav-item active" onclick="renderFeedView()">
        <i class="fa-solid fa-house"></i> <span class="nav-text">Home</span>
      </div>
      <div class="nav-item" onclick="openSearchModal()">
        <i class="fa-solid fa-magnifying-glass"></i> <span class="nav-text">Cerca</span>
      </div>
      <div class="nav-item" onclick="openUploadModal()">
        <i class="fa-regular fa-square-plus"></i> <span class="nav-text">Crea</span>
      </div>
      <div class="nav-item relative" onclick="openNotificationsModal()">
        <div id="notif-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-heart"></i> <span class="nav-text">Notifiche</span>
      </div>
      <div class="nav-item relative" onclick="openInboxModal()">
        <div id="global-gold-dot" class="gold-dot"></div>
        <i class="fa-regular fa-paper-plane"></i> <span class="nav-text">Messaggi</span>
      </div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)">
        <i class="fa-regular fa-user"></i> <span class="nav-text">Profilo</span>
      </div>
      
      <div style="margin-top:auto"></div>
      <div class="nav-item" onclick="logout()">
        <i class="fa-solid fa-arrow-right-from-bracket"></i> <span class="nav-text">Esci</span>
      </div>
    </div>

    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="toast-notif" class="toast-box">
  <i class="fa-solid fa-bell text-[#c6a87c]"></i>
  <span id="toast-msg">Notifica</span>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6">
    <div class="flex justify-between items-center mb-6">
      <h3 class="serif text-xl font-bold">Nuovo Post</h3>
      <i class="fa-solid fa-xmark cursor-pointer text-xl" onclick="closeModal('upload-modal')"></i>
    </div>
    
    <div class="flex flex-col gap-4 overflow-y-auto" style="max-height: 70vh;">
      <label class="h-48 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 relative overflow-hidden">
        <i class="fa-solid fa-camera text-3xl text-gray-400 mb-2"></i>
        <span class="text-xs text-gray-500 font-bold uppercase">Carica Foto</span>
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
        
        <div id="ai-loading" class="hidden analyzing-box">
            <i class="fa-solid fa-circle-notch fa-spin text-2xl text-black mb-2"></i>
            <span class="text-xs font-bold text-black">ANALISI AI...</span>
        </div>
      </label>

      <img id="upload-preview" class="hidden w-full h-48 object-cover rounded-lg">
      
      <div id="ai-error-msg" class="hidden p-3 bg-red-50 text-red-500 text-xs text-center border border-red-100 rounded">
        Questa immagine non sembra correlata alla moda.
      </div>

      <div id="upload-details-section" class="hidden">
        <div class="bg-gray-50 p-4 rounded-lg border border-gray-100 mb-4">
            <p class="text-[10px] font-bold uppercase mb-2 text-gray-500">Prodotti (Richiesto)</p>
            <div class="flex gap-2 mb-2">
               <input type="text" id="temp-prod-name" placeholder="Nome (es. Giacca Zara)" class="flex-1 p-2 text-xs border border-gray-300 rounded bg-white">
               <input type="url" id="temp-prod-link" placeholder="Link (http://...)" class="flex-1 p-2 text-xs border border-gray-300 rounded bg-white">
            </div>
            <button onclick="addProdToUpload()" class="btn-gold-outline w-full">+ Aggiungi</button>
            <div id="upload-products-list" class="mt-2"></div>
        </div>

        <textarea id="post-caption" rows="2" placeholder="Didascalia..." class="w-full border border-gray-300 p-3 rounded-lg text-sm mb-4 outline-none"></textarea>
        <button id="btn-publish" onclick="submitPost()" class="btn-gold">PUBBLICA</button>
      </div>
    </div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="glass-modal detail-layout">
    <div class="detail-img-side">
      <img id="detail-img" src="" style="max-width:100%; max-height:100%;">
      <div id="detail-noimg" class="hidden text-white">No Image</div>
    </div>
    <div class="detail-info-side">
      <div class="p-4 border-b border-gray-100 flex justify-between items-center">
        <div class="flex items-center gap-3" id="detail-user-link">
          <img id="detail-avatar" src="" class="w-8 h-8 rounded-full border border-gray-200">
          <span id="detail-username" class="font-bold text-sm"></span>
        </div>
        <div class="flex items-center gap-3">
          <div id="detail-delete-btn-container"></div>
          <i class="fa-solid fa-xmark cursor-pointer text-lg" onclick="closeModal('post-detail-modal')"></i>
        </div>
      </div>
      
      <div id="detail-comments" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
      
      <div class="p-4 border-t border-gray-100">
        <div class="flex gap-4 text-2xl mb-2 text-black">
          <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer"></i>
          <i class="fa-regular fa-comment"></i>
        </div>
        <div class="font-bold text-sm mb-3"><span id="detail-likes-count">0</span> Mi piace</div>
        <div class="flex gap-2">
          <input type="text" id="new-comment" placeholder="Commenta..." class="flex-1 outline-none text-sm">
          <button onclick="inviaCommento()" class="text-sm font-bold text-[#c6a87c]">Pubblica</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="share-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px]">
    <div class="p-4 border-b border-gray-100 flex justify-between font-bold">
      <span>Condividi</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('share-modal')"></i>
    </div>
    <div id="share-list-content" class="flex-1 overflow-y-auto p-2 h-[300px]"></div>
  </div>
</div>

<div id="shop-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px] p-6 text-center relative">
    <i class="fa-solid fa-xmark absolute top-4 right-4 cursor-pointer" onclick="closeModal('shop-modal')"></i>
    <h3 class="serif text-2xl mb-4 italic">Acquista</h3>
    <div id="shop-window-list" class="space-y-3 max-h-[300px] overflow-y-auto"></div>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px]">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
      <input type="text" id="search-query" class="w-full outline-none text-lg font-serif italic placeholder-gray-400" placeholder="Cerca..." onkeyup="performSearch()">
      <i class="fa-solid fa-xmark cursor-pointer ml-3" onclick="closeModal('search-modal')"></i>
    </div>
    <div id="search-results" class="flex-1 overflow-y-auto p-2 h-[400px]"></div>
  </div>
</div>

<div id="likes-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px]">
    <div class="p-4 border-b border-gray-100 flex justify-between font-bold">
      <span>Mi piace</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('likes-list-modal')"></i>
    </div>
    <div id="likes-list-content" class="flex-1 overflow-y-auto p-2 h-[300px]"></div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[350px]">
    <div class="p-4 border-b border-gray-100 flex justify-between font-bold">
      <span id="ul-title">Lista</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('user-list-modal')"></i>
    </div>
    <div id="ul-content" class="flex-1 overflow-y-auto p-2 h-[300px]"></div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="glass-modal p-6 w-[400px]">
    <h2 class="serif text-2xl text-center mb-6">Modifica Profilo</h2>
    <div class="flex flex-col items-center mb-6">
      <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full object-cover border-2 border-gray-200 mb-2">
      <label class="text-[#c6a87c] text-sm font-bold cursor-pointer">Cambia Foto
        <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar(this)">
      </label>
    </div>
    <div class="space-y-4">
      <input id="edit-username" type="text" placeholder="Username" class="w-full border p-3 rounded-lg text-sm bg-gray-50">
      <input id="edit-fullname" type="text" placeholder="Nome Completo" class="w-full border p-3 rounded-lg text-sm bg-gray-50">
      <button onclick="saveProfile()" class="btn-gold">SALVA</button>
      <button onclick="closeModal('edit-profile-modal')" class="w-full text-center text-xs text-gray-500 mt-2">ANNULLA</button>
    </div>
  </div>
</div>

<div id="inbox-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[600px]">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
      <h3 class="font-bold text-lg">Messaggi</h3>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('inbox-modal')"></i>
    </div>
    <div id="inbox-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="notifications-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[600px]">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center">
      <h3 class="font-bold text-lg">Notifiche</h3>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('notifications-modal')"></i>
    </div>
    <div id="notifications-list" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="chat-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[400px] h-[600px]">
    <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
      <div class="flex items-center gap-3">
        <img id="chat-header-avatar" src="" class="w-8 h-8 rounded-full">
        <span id="chat-header-name" class="font-bold">Chat</span>
      </div>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeChat()"></i>
    </div>
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-white"></div>
    <div class="p-3 border-t border-gray-100 flex gap-2 bg-gray-50">
      <input type="text" id="chat-input" placeholder="Scrivi..." class="flex-1 border border-gray-300 rounded-full px-4 text-sm outline-none" onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center"><i class="fa-regular fa-paper-plane"></i></button>
    </div>
  </div>
</div>


<script>
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';
  let currentUser = null, currentPostId = null, activeChatId = null, chatSub = null;
  let currentFeedMode = 'following'; 
  let uploadProductsList = [];
  let sharePostId = null; 
   
  // AI VARIABLES
  let classifierModel = null;
  const FASHION_KEYWORDS = [
    'shirt', 'pants', 'jean', 'dress', 'suit', 'shoe', 'boot', 'sandal', 'hat', 
    'sunglasses', 'jacket', 'coat', 'sweater', 'jersey', 'cardigan', 'skirt', 
    'tie', 't-shirt', 'blouse', 'trousers', 'shorts', 'footwear', 'outerwear',
    'miniskirt', 'maillot', 'tank suit', 'bikini', 'kimono', 'abaya', 'gown',
    'cloak', 'lab coat', 'pajama', 'velvet', 'wool', 'tie', 'bow tie', 'apron',
    'stole', 'necklace', 'wardrobe', 'closet', 'fashion', 'person', 'groom', 'bride',
    'uniform', 'vestment', 'trench coat', 'sweatshirt', 'Loafer', 'clog'
  ];

  window.addEventListener('load', async () => {
    try {
        console.log("Sto caricando il cervello AI...");
        if (typeof mobilenet !== 'undefined') {
            classifierModel = await mobilenet.load();
            console.log("AI Fashion Caricata con successo!");
        } else {
            console.warn("Libreria MobileNet non trovata.");
        }
    } catch(e) { console.error("Errore caricamento AI", e); }

    let i = 0; const imgs = document.querySelectorAll('.visual-side img');
    if (imgs.length) { setInterval(() => { imgs[i].classList.remove('active'); i = (i + 1) % imgs.length; imgs[i].classList.add('active'); }, 5000); }
    const { data: { session }, error } = await sb.auth.getSession();
    if (session && !error) enterApp(session.user);
    else document.getElementById('auth-container').style.display = 'flex';
  });

  async function checkImageContent(imgElement) {
    if (!classifierModel) return true; 
    try {
        const predictions = await classifierModel.classify(imgElement);
        console.log("L'AI vede:", predictions);
        const isFashion = predictions.some(p => {
            const terms = p.className.toLowerCase().split(','); 
            return terms.some(term => {
                const cleanTerm = term.trim();
                return FASHION_KEYWORDS.some(k => cleanTerm.includes(k) || k.includes(cleanTerm));
            });
        });
        return isFashion;
    } catch (e) {
        console.error("Errore classificazione:", e);
        return true; 
    }
  }

  function previewUpload(input) { 
    if(input.files && input.files[0]) { 
        const loadingBox = document.getElementById('ai-loading');
        const previewImg = document.getElementById('upload-preview');
        const detailsSection = document.getElementById('upload-details-section');
        const errorMsg = document.getElementById('ai-error-msg');
        
        previewImg.classList.add('hidden');
        detailsSection.classList.add('hidden'); 
        errorMsg.classList.add('hidden');
        loadingBox.classList.remove('hidden');

        const r = new FileReader(); 
        r.onload = async (e) => { 
            previewImg.src = e.target.result; 
            previewImg.onload = async () => {
                try {
                    const isApproved = await checkImageContent(previewImg);
                    loadingBox.classList.add('hidden');
                    previewImg.classList.remove('hidden');
                    if (isApproved) {
                        detailsSection.classList.remove('hidden');
                    } else {
                        errorMsg.classList.remove('hidden');
                        input.value = ""; 
                    }
                } catch (err) {
                    loadingBox.classList.add('hidden');
                    previewImg.classList.remove('hidden');
                    detailsSection.classList.remove('hidden');
                }
            };
        }; 
        r.readAsDataURL(input.files[0]); 
    } 
  }

  function openShareModal(postId) {
      sharePostId = postId;
      document.getElementById('share-modal').classList.remove('hidden');
      const container = document.getElementById('share-list-content');
      container.innerHTML = '<div class="text-center mt-4"><i class="fa-solid fa-spinner fa-spin"></i></div>';
      
      sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`)
        .eq('follower_id', currentUser.id)
        .then(({ data }) => {
            container.innerHTML = '';
            if(!data || data.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 text-sm mt-4">Nessun utente trovato.</p>';
                return;
            }
            data.forEach(x => {
                const u = x.profiles;
                container.insertAdjacentHTML('beforeend', `
                    <div class="flex items-center justify-between p-3 border-b border-gray-100">
                        <div class="flex items-center gap-3">
                            <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border">
                            <span class="font-bold text-sm">${u.username}</span>
                        </div>
                        <button onclick="sendPostToChat('${u.id}', this)" class="bg-black text-white px-4 py-1 rounded-full text-xs font-bold">Invia</button>
                    </div>
                `);
            });
        });
  }

  async function sendPostToChat(receiverId, btn) {
      if(!sharePostId) return;
      btn.innerText = "Inviato";
      btn.disabled = true;
      const { data: post } = await sb.from('posts').select('image_url, caption').eq('id', sharePostId).single();
      const messageContent = JSON.stringify({
          type: 'share_post',
          postId: sharePostId,
          img: post.image_url,
          caption: post.caption ? post.caption.substring(0, 30) + '...' : 'Post condiviso'
      });
      await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: receiverId, content: messageContent }]);
      setTimeout(() => closeModal('share-modal'), 500);
  }

  async function recuperoPassword() {
    const email = document.getElementById('l-email').value;
    if(!email) return alert("Inserisci l'email.");
    const { error } = await sb.auth.resetPasswordForEmail(email);
    if(error) alert(error.message);
    else alert("Email inviata!");
  }

  async function deletePost(postId) {
    if(!confirm("Eliminare post?")) return;
    const { error } = await sb.from('posts').delete().eq('id', postId).eq('user_id', currentUser.id);
    if(error) alert("Errore: " + error.message);
    else {
      closeModal('post-detail-modal'); 
      if(document.getElementById('view-profile-active')) openUserProfile(currentUser.id); 
      else renderFeedView(); 
    }
  }

  function addProdToUpload() {
    const nameInput = document.getElementById('temp-prod-name');
    const linkInput = document.getElementById('temp-prod-link');
    const name = nameInput.value.trim();
    const link = linkInput.value.trim();
    if(!name || !link) return alert("Inserisci nome e link.");
    uploadProductsList.push({ name, link });
    nameInput.value = ''; linkInput.value = '';
    renderUploadProductsList();
  }

  function removeProdFromUpload(index) {
    uploadProductsList.splice(index, 1);
    renderUploadProductsList();
  }

  function renderUploadProductsList() {
    const container = document.getElementById('upload-products-list');
    container.innerHTML = '';
    uploadProductsList.forEach((prod, idx) => {
        container.insertAdjacentHTML('beforeend', `
            <div class="added-product-item">
                <div class="truncate mr-2">
                    <div class="font-bold text-xs">${escapeHtml(prod.name)}</div>
                    <div class="text-[10px] text-gray-500 truncate">${escapeHtml(prod.link)}</div>
                </div>
                <i class="fa-solid fa-trash text-gray-400 hover:text-red-500 cursor-pointer text-xs" onclick="removeProdFromUpload(${idx})"></i>
            </div>
        `);
    });
  }

  function openShopWindow(productsJson, event) {
    if(event) event.stopPropagation();
    const container = document.getElementById('shop-window-list');
    container.innerHTML = '';
    let products = [];
    try { products = JSON.parse(decodeURIComponent(productsJson)); } catch(e) { return; }
    if(!products || products.length === 0) return;
    products.forEach(p => {
        container.insertAdjacentHTML('beforeend', `
            <div class="flex items-center justify-between p-3 border border-gray-100 rounded bg-gray-50">
                <div class="text-left">
                    <div class="font-bold text-sm">${escapeHtml(p.name)}</div>
                    <div class="text-[10px] text-gray-400">Clicca per acquistare</div>
                </div>
                <a href="${p.link}" target="_blank" class="bg-black text-white px-3 py-1 rounded text-xs font-bold">VAI</a>
            </div>
        `);
    });
    document.getElementById('shop-modal').classList.remove('hidden');
  }
  
  function switchFeedMode(mode) {
    if (currentFeedMode === mode) return; 
    currentFeedMode = mode;
    renderFeedView();
  }

  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    if(document.getElementById('view-profile-active')) document.getElementById('view-profile-active').remove();

    const tabsHtml = `
      <div class="feed-tabs-container">
        <div class="feed-tab ${currentFeedMode === 'following' ? 'active' : ''}" onclick="switchFeedMode('following')">Seguiti</div>
        <div class="feed-tab ${currentFeedMode === 'viral' ? 'active' : ''}" onclick="switchFeedMode('viral')">Per Te</div>
      </div>
    `;

    main.innerHTML = `${tabsHtml}<div class="flex justify-center mt-20"><i class="fa-solid fa-circle-notch fa-spin text-3xl"></i></div>`;

    let posts = [];
    let error = null;

    if (currentFeedMode === 'following') {
        const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
        const followingIds = follows ? follows.map(f => f.followed_id) : [];

        if (followingIds.length > 0) {
            const res = await sb.from('posts')
                .select(`*, profiles:user_id (username, avatar_url)`)
                .in('user_id', followingIds)
                .order('created_at', { ascending: false });
            posts = res.data;
            error = res.error;
        } else { posts = []; }
    } else {
        const res = await sb.from('posts')
            .select(`*, profiles:user_id (username, avatar_url)`)
            .order('created_at', { ascending: false })
            .limit(50);
        posts = res.data;
        error = res.error;
    }

    if (error) return main.innerHTML = `${tabsHtml}<p class="text-center mt-10">Errore feed.</p>`;

    if (!posts || posts.length === 0) {
        if (currentFeedMode === 'following') {
            return main.innerHTML = `
                ${tabsHtml}
                <div class="text-center py-10">
                  <h2 class="text-xl font-bold mb-2">Feed Vuoto</h2>
                  <p class="text-gray-500 mb-6">Non segui nessuno.</p>
                  <button onclick="switchFeedMode('viral')" class="btn-black inline-block w-auto px-6">Esplora</button>
                </div>
            `;
        } else {
            return main.innerHTML = `${tabsHtml}<div class="text-center py-10"><p>Nessun post.</p></div>`;
        }
    }

    main.innerHTML = tabsHtml;
    for (const post of posts) {
      const counts = await getPostCounts(post.id);
      const likedByMe = await isLikedByMe(post.id);
      main.insertAdjacentHTML('beforeend', createPostHTML(post, counts, likedByMe));
    }
  }

  function createPostHTML(post, counts, liked) {
    const user = post.profiles || { username: 'Utente', avatar_url: null };
    const dateStr = post.created_at ? new Date(post.created_at).toLocaleDateString('it-IT') : '';
    const heartIcon = liked ? 'fa-solid fa-heart text-red-500' : 'fa-regular fa-heart';
    const deleteIcon = (post.user_id === currentUser.id) 
      ? `<i class="fa-solid fa-trash text-gray-400 hover:text-red-500 cursor-pointer ml-auto" onclick="deletePost('${post.id}')"></i>` : '';

    let shopTag = '';
    let products = [];
    if(post.products && post.products.length > 0) products = post.products; 
    else if (post.product_link) products = [{ name: post.product_name || 'Prodotto', link: post.product_link }];

    if (products.length > 0) {
      const jsonStr = encodeURIComponent(JSON.stringify(products));
      shopTag = `<div class="shop-tag-overlay" onclick="openShopWindow('${jsonStr}', event)"><i class="fa-solid fa-bag-shopping"></i><span>SHOP (${products.length})</span></div>`;
    }

    return `
      <div class="post-card">
        <div class="post-header">
          <div class="user-badge" onclick="openUserProfile('${post.user_id}')">
            <img src="${user.avatar_url || 'https://via.placeholder.com/40'}" class="user-avatar">
            <div class="flex flex-col">
                <span class="username">${user.username}</span>
                <span class="post-date">${dateStr}</span>
            </div>
          </div>
          ${deleteIcon}
        </div>
        
        <div class="post-img-container">
            ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openPostDetail('${post.id}')">` : ''}
            ${shopTag}
        </div>

        <div class="action-bar">
          <div class="icon-btn">
            <i class="${heartIcon}" onclick="toggleLike('${post.id}', this.parentNode)"></i>
            <span class="likes-count-clickable ml-1" id="feed-likes-count-${post.id}" onclick="openLikesModal('${post.id}')">${counts.likes}</span>
          </div>
          <div class="icon-btn" onclick="openPostDetail('${post.id}')"><i class="fa-regular fa-comment"></i><span class="text-sm ml-1">${counts.comments}</span></div>
          <div class="icon-btn ml-auto" onclick="openShareModal('${post.id}')"><i class="fa-regular fa-paper-plane"></i></div>
        </div>
        <div class="caption-box">
            <span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>
            ${escapeHtml(post.caption)}
        </div>
      </div>
    `;
  }
  
  // LOGIC FOR MODALS & POST DETAILS (FIXED IDs)
  async function openPostDetail(postId) {
    currentPostId = postId;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    document.getElementById('detail-img').src = ''; 
    document.getElementById('detail-username').innerText = 'Caricamento...';
    
    const { data: post, error } = await sb.from('posts').select(`*, profiles:user_id (*)`).eq('id', postId).single();
    if(error) return alert("Errore caricamento post.");

    if(post.image_url) {
        document.getElementById('detail-img').src = post.image_url;
        document.getElementById('detail-img').classList.remove('hidden');
        document.getElementById('detail-noimg').classList.add('hidden');
    } else {
        document.getElementById('detail-img').classList.add('hidden');
        document.getElementById('detail-noimg').classList.remove('hidden');
    }

    const u = post.profiles;
    document.getElementById('detail-username').innerText = u.username;
    document.getElementById('detail-avatar').src = u.avatar_url || 'https://via.placeholder.com/40';
    document.getElementById('detail-user-link').onclick = () => { closeModal('post-detail-modal'); openUserProfile(u.id); };

    const delBtn = document.getElementById('detail-delete-btn-container');
    delBtn.innerHTML = (currentUser.id === post.user_id) ? 
        `<i class="fa-solid fa-trash text-gray-400 hover:text-red-500 cursor-pointer" onclick="deletePost('${post.id}')"></i>` : '';

    loadComments(postId);
    updateDetailCounts(postId);
    checkLikeStatusDetail(postId);
  }

  async function loadComments(postId) {
    const box = document.getElementById('detail-comments');
    box.innerHTML = '<div class="text-center text-gray-400 mt-4">Caricamento commenti...</div>';
    const { data: comments } = await sb.from('comments').select(`*, profiles:user_id (username)`).eq('post_id', postId).order('created_at', {ascending: true});
    box.innerHTML = '';
    if(!comments || comments.length === 0) {
        box.innerHTML = '<div class="text-center text-gray-400 mt-4">Nessun commento ancora.</div>';
        return;
    }
    comments.forEach(c => {
        box.insertAdjacentHTML('beforeend', `
            <div class="mb-2 text-sm">
                <span class="font-bold mr-2 cursor-pointer" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')">${c.profiles.username}</span>
                <span class="text-gray-700">${escapeHtml(c.content)}</span>
            </div>
        `);
    });
  }

  async function inviaCommento() {
    const input = document.getElementById('new-comment');
    const txt = input.value.trim();
    if(!txt || !currentPostId) return;
    input.value = '';
    const { error } = await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
    if(!error) {
        loadComments(currentPostId);
        updateDetailCounts(currentPostId);
        // Aggiorna anche il feed
        const countSpan = document.getElementById(`feed-likes-count-${currentPostId}`).parentNode.nextElementSibling.querySelector('span');
        if(countSpan) countSpan.innerText = parseInt(countSpan.innerText) + 1;
    }
  }

  async function updateDetailCounts(postId) {
     const counts = await getPostCounts(postId);
     document.getElementById('detail-likes-count').innerText = counts.likes;
  }

  async function checkLikeStatusDetail(postId) {
     const isLiked = await isLikedByMe(postId);
     const btn = document.getElementById('detail-like-btn');
     if(isLiked) { btn.className = 'fa-solid fa-heart text-red-500 cursor-pointer'; }
     else { btn.className = 'fa-regular fa-heart cursor-pointer'; }
     
     // Override click per il dettaglio
     btn.onclick = async () => {
         if(btn.classList.contains('fa-solid')) {
             await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
             btn.className = 'fa-regular fa-heart cursor-pointer';
         } else {
             await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
             btn.className = 'fa-solid fa-heart text-red-500 cursor-pointer';
         }
         updateDetailCounts(postId);
         // Aggiorna feed
         const feedIcon = document.querySelector(`i[onclick="toggleLike('${postId}', this.parentNode)"]`);
         const feedCount = document.getElementById(`feed-likes-count-${postId}`);
         if(feedIcon && feedCount) {
             const current = parseInt(feedCount.innerText);
             if(btn.classList.contains('fa-solid')) {
                 feedIcon.className = 'fa-solid fa-heart text-red-500';
                 feedCount.innerText = current + 1;
             } else {
                 feedIcon.className = 'fa-regular fa-heart';
                 feedCount.innerText = Math.max(0, current - 1);
             }
         }
     }
  }

  async function openLikesModal(postId) {
    document.getElementById('likes-list-modal').classList.remove('hidden');
    const container = document.getElementById('likes-list-content');
    container.innerHTML = '<div class="text-center mt-4">Caricamento...</div>';
    
    const { data: rawLikes } = await sb.from('likes').select('user_id').eq('post_id', postId);
    if (!rawLikes || rawLikes.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 mt-4">Nessun like.</p>'; return; }
    const userIds = rawLikes.map(item => item.user_id);
    const { data: profiles } = await sb.from('profiles').select('id, username, avatar_url').in('id', userIds);

    container.innerHTML = '';
    profiles.forEach(u => {
        container.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-3 hover:bg-gray-50 cursor-pointer rounded transition" onclick="closeModal('likes-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border">
                <div class="font-bold text-sm">${escapeHtml(u.username)}</div>
            </div>`);
    });
  }

  async function toggleLike(postId, btnContainer) {
    const icon = btnContainer.querySelector('i');
    const countSpan = document.getElementById(`feed-likes-count-${postId}`);
    let currentCount = parseInt(countSpan.innerText);
    const isLiked = icon.classList.contains('fa-solid');

    if (isLiked) {
      icon.className = 'fa-regular fa-heart';
      countSpan.innerText = Math.max(0, currentCount - 1);
      await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
    } else {
      icon.className = 'fa-solid fa-heart text-red-500';
      countSpan.innerText = currentCount + 1;
      await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
    }
  }

  async function getPostCounts(postId) {
    const { count: l } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    const { count: c } = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    return { likes: l || 0, comments: c || 0 };
  }
   
  async function isLikedByMe(postId) { 
    const { data } = await sb.from('likes').select('id').eq('post_id', postId).eq('user_id', currentUser.id); 
    return data && data.length > 0; 
  }
   
  async function openUserProfile(userId) {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div id="view-profile-active" class="hidden"></div><div class="flex justify-center mt-20"><i class="fa-solid fa-circle-notch fa-spin text-3xl"></i></div>`;
    
    const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
    if (!profile) return main.innerHTML = "<p class='text-center mt-10'>Utente non trovato.</p>";

    const { count: postsCount } = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const { count: followersCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const { count: followingCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
    
    let isFollowing = false;
    if (userId !== currentUser.id) {
      const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
      isFollowing = data && data.length > 0;
    }

    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    const isMe = userId === currentUser.id;
    
    let chatButtonHtml = '';
    if (isFollowing) {
        chatButtonHtml = `<button onclick="openChat('${userId}', '${profile.username}', '${profile.avatar_url}')" class="px-4 py-2 border border-black rounded-lg hover:bg-gray-100"><i class="fa-regular fa-comment-dots"></i></button>`;
    }

    const btn = isMe ? 
      `<button onclick="openEditProfile()" class="px-5 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-50">Modifica</button>` : 
      `<div class="flex gap-2">
         <button onclick="toggleFollow('${userId}')" id="follow-btn" class="px-6 py-2 rounded-lg text-sm font-bold transition ${isFollowing ? 'border border-gray-300 text-gray-500' : 'bg-black text-white'}">${isFollowing ? 'Seguito' : 'Segui'}</button>
         ${chatButtonHtml}
       </div>`;

    main.innerHTML = `
      <div id="view-profile-active" class="hidden"></div>
      <div class="flex flex-col items-center mb-8 border-b border-gray-100 pb-8">
        <img src="${profile.avatar_url || 'https://via.placeholder.com/150'}" class="w-28 h-28 rounded-full object-cover border-2 border-gray-100 mb-4 cursor-pointer" onclick="${isMe?'openEditProfile()':''}">
        <h2 class="text-2xl font-serif italic font-bold mb-2">${profile.username}</h2>
        <div class="text-gray-500 text-sm mb-4">${profile.full_name || ''}</div>
        
        <div class="flex gap-8 mb-6">
            <div class="text-center"><span class="block font-bold text-lg">${postsCount||0}</span><span class="text-xs text-gray-500 uppercase">Post</span></div>
            <div class="text-center cursor-pointer" onclick="showUserList('followers','${userId}')"><span class="block font-bold text-lg" id="p-followers">${followersCount||0}</span><span class="text-xs text-gray-500 uppercase">Follower</span></div>
            <div class="text-center cursor-pointer" onclick="showUserList('following','${userId}')"><span class="block font-bold text-lg">${followingCount||0}</span><span class="text-xs text-gray-500 uppercase">Seguiti</span></div>
        </div>
        ${btn}
      </div>

      <div class="grid grid-cols-3 gap-1">${posts ? posts.map(p => `
        <div class="relative aspect-square group cursor-pointer overflow-hidden bg-gray-100" onclick="openPostDetail('${p.id}')">
            ${p.image_url ? `<img src="${p.image_url}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-xs p-2 text-center text-gray-400 border border-gray-100">${escapeHtml(p.caption).substring(0,20)}...</div>`}
        </div>`).join('') : ''}
      </div>
    `;
  }

 async function toggleFollow(targetId) {
    const btn = document.getElementById('follow-btn');
    if (!btn) return;
    const isFollowing = btn.innerText === 'Seguito';
    const originalText = btn.innerText;
    btn.innerText = "...";
    btn.disabled = true;
    let error = null;
    try {
        if (isFollowing) {
            const { error: err } = await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', targetId);
            error = err;
        } else {
            const { error: err } = await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
            error = err;
        }
        if (error) throw error;
        openUserProfile(targetId);
    } catch (err) {
        btn.innerText = originalText;
        btn.disabled = false;
    }
  }

  async function submitPost() { 
    const f = document.getElementById('post-file').files[0]; 
    const c = document.getElementById('post-caption').value; 
    const pendingName = document.getElementById('temp-prod-name').value.trim();
    const pendingLink = document.getElementById('temp-prod-link').value.trim();
    if(pendingName && pendingLink) uploadProductsList.push({ name: pendingName, link: pendingLink });

    const btn = document.getElementById('btn-publish');
    const originalText = btn.innerText;

    if(uploadProductsList.length === 0) { alert("Tagga almeno un prodotto."); return; }
    if(!f) return alert("Carica foto.");

    btn.innerText = "Attendere...";
    btn.disabled = true;

    try {
        let url = null; 
        if(f) { 
          const n = `${currentUser.id}/${Date.now()}`; 
          const { error: upErr } = await sb.storage.from(BUCKET_POSTS).upload(n, f); 
          if(upErr) throw upErr;
          const { data } = sb.storage.from(BUCKET_POSTS).getPublicUrl(n); 
          url = data.publicUrl; 
        } 

        const { error: insErr } = await sb.from('posts').insert([{ user_id: currentUser.id, image_url: url, caption: c, products: uploadProductsList }]); 
        if(insErr) throw insErr;
        
        closeModal('upload-modal'); 
        renderFeedView();
    } catch(err) {
        alert("Errore: " + err.message);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
  }

  async function loadMessages() {
    const { data: msgs } = await sb.from('messages').select('*')
      .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${activeChatId}),and(sender_id.eq.${activeChatId},receiver_id.eq.${currentUser.id})`)
      .order('created_at', { ascending: true });

    const box = document.getElementById('chat-messages');
    box.innerHTML = '';
    msgs?.forEach(m => {
      const isMine = m.sender_id === currentUser.id;
      let contentHtml = escapeHtml(m.content);
      try {
          if (m.content.startsWith('{') && m.content.includes('share_post')) {
              const data = JSON.parse(m.content);
              contentHtml = `<div class="shared-post-bubble" onclick="openPostDetail('${data.postId}')"><img src="${data.img}" class="w-full h-32 object-cover"><div class="p-2 text-xs bg-gray-50"><b>Post</b><br>${escapeHtml(data.caption)}</div></div>`;
          }
      } catch(e) {}
      box.insertAdjacentHTML('beforeend', `<div class="msg-bubble ${isMine ? 'msg-mine' : 'msg-theirs'}">${contentHtml}</div>`);
    });
    box.scrollTop = box.scrollHeight;
  }

  function openEditProfile() { document.getElementById('edit-profile-modal').classList.remove('hidden'); sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data})=>{ document.getElementById('edit-username').value=data.username; document.getElementById('edit-fullname').value=data.full_name; document.getElementById('edit-avatar-preview').src=data.avatar_url||'https://via.placeholder.com/150'; }); }
  async function saveProfile() { await sb.from('profiles').update({ username:document.getElementById('edit-username').value, full_name:document.getElementById('edit-fullname').value }).eq('id', currentUser.id); closeModal('edit-profile-modal'); openUserProfile(currentUser.id); }
   
  async function uploadAvatar(i) { 
    const f=i.files[0]; if(!f)return; 
    const n=`${currentUser.id}/avatar_${Date.now()}`; 
    const { error: upErr } = await sb.storage.from(BUCKET_AVATARS).upload(n, f); 
    if(upErr) return alert("Errore avatar: " + upErr.message);
    const {data}=sb.storage.from(BUCKET_AVATARS).getPublicUrl(n); 
    document.getElementById('edit-avatar-preview').src=data.publicUrl; 
    await sb.from('profiles').update({ avatar_url:data.publicUrl }).eq('id',currentUser.id); 
  }

  async function checkNotifications() {
    const { count } = await sb.from('messages').select('*', { count: 'exact', head: true }).eq('receiver_id', currentUser.id).eq('is_read', false);
    document.getElementById('global-gold-dot').style.display = (count > 0) ? 'block' : 'none';
  }

  async function checkAppNotifications() {
    const { count } = await sb.from('notifications').select('*', { count: 'exact', head: true }).eq('recipient_id', currentUser.id).eq('is_read', false);
    document.getElementById('notif-gold-dot').style.display = (count > 0) ? 'block' : 'none';
  }

  async function openNotificationsModal() {
    document.getElementById('notifications-modal').classList.remove('hidden');
    document.getElementById('notif-gold-dot').style.display = 'none';
    const c = document.getElementById('notifications-list');
    c.innerHTML = '<div class="text-center mt-4">...</div>';

    const { data: rows } = await sb.from('notifications').select('id, created_at, type, actor_id, post_id, comment_id, is_read').eq('recipient_id', currentUser.id).order('created_at', { ascending: false }).limit(50);
    await sb.from('notifications').update({ is_read: true }).eq('recipient_id', currentUser.id).eq('is_read', false);

    c.innerHTML = '';
    if (!rows || rows.length === 0) { c.innerHTML = '<p class="text-center text-gray-400 mt-4">Nessuna notifica.</p>'; return; }

    for (const n of rows) {
      const { data: actor } = await sb.from('profiles').select('username, avatar_url').eq('id', n.actor_id).single();
      let icon, txt, clickAction;
      if (n.type === 'follow') {
         icon = '<i class="fa-solid fa-user-plus text-blue-500"></i>'; txt = 'ti segue'; clickAction = `closeModal('notifications-modal'); openUserProfile('${n.actor_id}')`;
      } else {
         icon = n.type === 'like' ? '<i class="fa-solid fa-heart text-red-500"></i>' : '<i class="fa-regular fa-comment text-yellow-600"></i>';
         txt = n.type === 'like' ? 'like al post' : 'commento al post';
         clickAction = `closeModal('notifications-modal'); openPostDetail('${n.post_id}')`;
      }
      c.insertAdjacentHTML('beforeend', `
        <div class="flex items-center gap-3 p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer" onclick="${clickAction}">
          <img src="${actor?.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border">
          <div><div class="text-sm"><b>${actor?.username}</b> ${txt}</div></div>
        </div>
      `);
    }
    checkAppNotifications();
  }

  function showToast(msg) {
    const t = document.getElementById('toast-notif');
    document.getElementById('toast-msg').innerText = msg;
    t.classList.add('toast-active');
    setTimeout(() => t.classList.remove('toast-active'), 4000);
    document.getElementById('notif-gold-dot').style.display = 'block';
  }

  async function openInboxModal() {
    document.getElementById('inbox-modal').classList.remove('hidden');
    const container = document.getElementById('inbox-list');
    container.innerHTML = '<div class="text-center mt-4">...</div>';

    const { data: msgs } = await sb.from('messages').select('*').or(`sender_id.eq.${currentUser.id},receiver_id.eq.${currentUser.id}`).order('created_at', { ascending: false });
    if (!msgs || msgs.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 mt-4">Nessun messaggio.</p>'; return; }

    const uniqueUsers = new Set();
    const previews = [];
    for (const m of msgs) {
      const otherId = m.sender_id === currentUser.id ? m.receiver_id : m.sender_id;
      if (!uniqueUsers.has(otherId)) { uniqueUsers.add(otherId); previews.push({ msg: m, otherId }); }
    }

    container.innerHTML = '';
    for (const item of previews) {
      const { data: u } = await sb.from('profiles').select('*').eq('id', item.otherId).single();
      const isUnread = (item.msg.receiver_id === currentUser.id && !item.msg.is_read);
      container.insertAdjacentHTML('beforeend', `
        <div class="inbox-item ${isUnread ? 'bg-blue-50' : ''}" onclick="closeModal('inbox-modal'); openChat('${u.id}', '${u.username}', '${u.avatar_url}')">
          <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border">
          <div class="flex-1 overflow-hidden">
            <div class="font-bold text-sm flex justify-between">${u.username} <i class="fa-solid fa-trash text-gray-300 hover:text-red-500" onclick="deleteChat('${u.id}', event)"></i></div>
            <div class="text-gray-500 text-xs truncate">${escapeHtml(item.msg.content)}</div>
          </div>
        </div>`);
    }
  }

  async function deleteChat(targetId, event) {
      if(event) event.stopPropagation();
      if(!confirm("Eliminare conversazione?")) return;
      await sb.from('messages').delete().or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${targetId}),and(sender_id.eq.${targetId},receiver_id.eq.${currentUser.id})`);
      openInboxModal(); 
  }

  async function openChat(userId, username, avatar) {
    if (userId === currentUser.id) return;
    activeChatId = userId;
    document.getElementById('chat-modal').classList.remove('hidden');
    document.getElementById('chat-header-name').innerText = username;
    document.getElementById('chat-header-avatar').src = avatar || 'https://via.placeholder.com/40';
    await loadMessages();
    await markAsRead(userId);
    if (chatSub) chatSub.unsubscribe();
    chatSub = sb.channel('chat-room').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        if ((payload.new.sender_id === activeChatId && payload.new.receiver_id === currentUser.id) || (payload.new.sender_id === currentUser.id && payload.new.receiver_id === activeChatId)) {
          loadMessages(); if (payload.new.receiver_id === currentUser.id) markAsRead(activeChatId);
        }
      }).subscribe();
  }

  async function sendMessage() {
    const input = document.getElementById('chat-input');
    const text = input.value.trim();
    if (!text || !activeChatId) return;
    input.value = '';
    const { error } = await sb.from('messages').insert([{ sender_id: currentUser.id, receiver_id: activeChatId, content: text }]);
    if (!error) loadMessages();
  }

  async function markAsRead(senderId) {
    await sb.from('messages').update({ is_read: true }).eq('sender_id', senderId).eq('receiver_id', currentUser.id);
    checkNotifications(); 
  }

  function closeChat() {
    document.getElementById('chat-modal').classList.add('hidden');
    activeChatId = null;
    if (chatSub) chatSub.unsubscribe();
    checkNotifications();
  }

  function enterApp(u) { 
    currentUser=u; 
    document.getElementById('auth-container').style.transform = "translateY(-100vh)"; 
    setTimeout(async ()=>{ 
      document.getElementById('auth-container').classList.add('hidden'); 
      document.getElementById('app-interface').classList.remove('hidden'); 
      renderFeedView(); checkNotifications(); checkAppNotifications(); 
      sb.channel('global-updates').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
          if(payload.new.receiver_id === currentUser.id) checkNotifications();
        }).on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'notifications', filter: `recipient_id=eq.${currentUser.id}` }, payload => {
          if (!payload?.new) return; showToast("Nuova Notifica!"); checkAppNotifications();
        }).subscribe();
    },600); 
  }

  function mess(t,e){const b=document.getElementById('msg-box');b.innerText=t;b.classList.remove('hidden');b.className = e ? 'p-3 text-center mb-5 text-sm rounded bg-red-100 text-red-500' : 'p-3 text-center mb-5 text-sm rounded bg-green-100 text-green-500';}
  function vaiA(m){ document.getElementById('login-form').classList.toggle('hidden',m==='signup'); document.getElementById('signup-form').classList.toggle('hidden',m==='login'); }
  function escapeHtml(t) { return t?t.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"):""; }
  function closeModal(modalId) { document.getElementById(modalId).classList.add('hidden'); }
  
  // FIX: Funzione performSearch che mancava nel codice precedente
  async function performSearch() {
      const q = document.getElementById('search-query').value;
      const resContainer = document.getElementById('search-results');
      if(q.length < 2) { resContainer.innerHTML = ''; return; }
      
      const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
      resContainer.innerHTML = '';
      if(data) {
          data.forEach(u => {
              resContainer.insertAdjacentHTML('beforeend', `
                <div class="flex items-center gap-3 p-2 hover:bg-gray-50 cursor-pointer" onclick="closeModal('search-modal'); openUserProfile('${u.id}')">
                    <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border">
                    <span>${u.username}</span>
                </div>
              `);
          });
      }
  }

  // FIX: Funzione showUserList che mancava
  async function showUserList(type, userId) {
      document.getElementById('user-list-modal').classList.remove('hidden');
      document.getElementById('ul-title').innerText = type === 'followers' ? 'Followers' : 'Seguiti';
      const c = document.getElementById('ul-content');
      c.innerHTML = '...';
      
      let q = sb.from('follows').select(`profiles!follows_${type === 'followers' ? 'follower' : 'followed'}_id_fkey(*)`);
      if(type === 'followers') q = q.eq('followed_id', userId);
      else q = q.eq('follower_id', userId);
      
      const { data } = await q;
      c.innerHTML = '';
      if(!data || data.length === 0) { c.innerHTML = '<p class="text-center text-gray-500">Lista vuota.</p>'; return; }
      
      data.forEach(x => {
          const u = x.profiles;
          c.insertAdjacentHTML('beforeend', `
            <div class="flex items-center gap-3 p-2 hover:bg-gray-50 cursor-pointer" onclick="closeModal('user-list-modal'); openUserProfile('${u.id}')">
                <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="w-10 h-10 rounded-full border">
                <span>${u.username}</span>
            </div>
          `);
      });
  }

  async function faiLogin() { const {data,error}=await sb.auth.signInWithPassword({ email:document.getElementById('l-email').value, password:document.getElementById('l-pass').value }); if(error)mess(error.message,true); else enterApp(data.user); }
  async function faiRegistrazione() { const {data,error}=await sb.auth.signUp({ email:document.getElementById('r-email').value, password:document.getElementById('r-pass').value }); if(error)return mess(error.message,true); if(data.user) await sb.from('profiles').insert([{ id:data.user.id, username:document.getElementById('r-username').value }]); mess("Registrazione OK!"); }
  async function logout() { await sb.auth.signOut(); location.reload(); }
</script>
</body>
</html>
