<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAWENISHLAND — Fashion Social</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400&family=Inter:wght@200;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Stili personalizzati per un look elegante e scuro */
        body { background: #000; color: #fff; font-family: 'Inter', sans-serif; overflow-x: hidden; }
        .serif { font-family: 'Playfair Display', serif; }
        .hidden { display: none !important; }
        .btn-white { background: #fff; color: #000; padding: 14px; font-weight: 600; text-transform: uppercase; width: 100%; cursor: pointer; border: none; font-size: 10px; letter-spacing: 2px; transition: 0.3s; }
        .btn-white:hover { background: #ccc; }
        .btn-white:disabled { background: #555; color: #888; cursor: not-allowed; }
        input, textarea { background: #080808; border: 1px solid #1a1a1a; padding: 14px; color: #fff; width: 100%; outline: none; margin-bottom: 12px; font-size: 14px; transition: 0.3s; }
        input:focus, textarea:focus { border-color: #fff; }
        .error-msg { background: #2d0000; border: 1px solid #ff4444; color: #ff4444; padding: 12px; font-size: 10px; text-transform: uppercase; margin-bottom: 20px; display: none; text-align: center; letter-spacing: 1px; }
        .post-card { border-bottom: 1px solid #111; padding: 50px 0; }
        .comment-item { background: #0a0a0a; padding: 12px; margin-top: 8px; font-size: 12px; border-left: 2px solid #333; color: #ccc; }
    </style>
</head>
<body>

    <section id="auth-screen" class="min-h-screen flex flex-col items-center justify-center p-6 text-center">
        <h1 class="serif text-7xl mb-12 italic tracking-tighter">Hawenishland</h1>
        
        <div class="w-full max-w-sm">
            <div id="error-display" class="error-msg"></div>

            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email">
                <input type="password" id="login-pass" placeholder="Password">
                <button onclick="handleLogin()" class="btn-white mb-4">Entra nell'Archivio</button>
                <button onclick="toggleAuth('signup')" class="text-[10px] text-zinc-500 uppercase tracking-widest hover:text-white transition italic">Non hai un account? Unisciti</button>
            </div>

            <div id="signup-form" class="hidden text-left">
                <input type="text" id="reg-nome" placeholder="Nome">
                <input type="text" id="reg-cognome" placeholder="Cognome">
                <p class="text-[9px] text-zinc-500 mb-2 uppercase tracking-widest font-bold">Data di nascita (Min. 16 anni)</p>
                <input type="date" id="reg-nascita">
                <input type="email" id="reg-email" placeholder="Email">
                <input type="password" id="reg-pass" placeholder="Password (Min. 6 caratteri)">
                <button onclick="handleSignup()" class="btn-white mb-4">Crea Account</button>
                <button onclick="toggleAuth('login')" class="text-[10px] text-zinc-500 uppercase tracking-widest hover:text-white block text-center italic">Hai già un account? Accedi</button>
            </div>

            <p onclick="forgotPassword()" class="text-[10px] text-zinc-500 uppercase cursor-pointer pt-8 hover:text-white block transition">Recupera Password</p>
            <div class="py-6 text-zinc-900 text-[10px] tracking-[0.5em] font-bold">— OPPURE —</div>
            <button onclick="loginGitHub()" class="flex items-center justify-center gap-4 border border-zinc-900 p-4 w-full hover:bg-white hover:text-black transition duration-300">
                <i data-lucide="github" class="w-4 h-4"></i>
                <span class="font-semibold text-[10px] uppercase tracking-widest">Entra con GitHub</span>
            </button>
        </div>
    </section>

    <section id="app-screen" class="hidden">
        <nav class="fixed top-0 w-full border-b border-zinc-900 bg-black/90 backdrop-blur-xl p-4 z-50 flex justify-between items-center px-6">
            <span class="serif text-2xl italic">Hawenishland</span>
            <div class="flex items-center bg-zinc-900 rounded-full px-3 py-1">
                <i data-lucide="search" class="w-3 h-3 text-zinc-500 mr-2"></i>
                <input type="text" id="search-input" oninput="loadPosts()" placeholder="Cerca nell'archivio..." class="max-w-[120px] bg-transparent border-none mb-0 p-0 text-[10px] focus:ring-0">
            </div>
            <button onclick="logout()" class="text-[9px] border border-zinc-800 px-4 py-2 hover:bg-white hover:text-black transition">LOGOUT</button>
        </nav>

        <main class="pt-32 max-w-xl mx-auto px-6 pb-20">
            <div class="mb-20 border border-zinc-900 p-8 bg-zinc-950/50">
                <textarea id="post-text" placeholder="Condividi la tua visione..." class="bg-transparent border-none text-2xl serif italic h-28 p-0 mb-6 w-full resize-none"></textarea>
                <div class="flex items-center justify-between">
                    <label for="post-file" class="cursor-pointer flex items-center gap-2 text-[10px] uppercase tracking-widest text-zinc-400 hover:text-white transition">
                        <i data-lucide="image" class="w-4 h-4"></i> Aggiungi Immagine
                        <input type="file" id="post-file" accept="image/*" class="hidden">
                    </label>
                    <button onclick="publishPost()" id="btn-publish" class="btn-white w-auto px-8 py-3">Pubblica</button>
                </div>
                <p id="file-chosen" class="text-[9px] text-zinc-600 mt-2 italic hidden"></p>
            </div>

            <div id="feed" class="space-y-12"></div>
        </main>
    </section>

    <script>
        // Configurazione di Supabase (ATTENZIONE: Non modificare questi dati)
        const SB_URL = 'https://nqueucpgvqexhpztpois.supabase.co';
        const SB_KEY = 'sb_publishable_KHwmrWNgwndph8Iuxu-WfW_aUkZTVFI';
        const supabase = window.supabase.createClient(SB_URL, SB_KEY);

        // --- Funzioni per l'interfaccia utente ---
        // Mostra il nome del file scelto per il caricamento
        document.getElementById('post-file').addEventListener('change', function(){
            const fileName = this.files[0] ? this.files[0].name : "Nessun file selezionato";
            document.getElementById('file-chosen').textContent = "File selezionato: " + fileName;
            document.getElementById('file-chosen').classList.remove('hidden');
        });

        // Alterna tra schermata di login e registrazione
        function toggleAuth(mode) {
            document.getElementById('login-form').classList.toggle('hidden', mode === 'signup');
            document.getElementById('signup-form').classList.toggle('hidden', mode === 'login');
            document.getElementById('error-display').style.display = 'none';
        }

        // Mostra i messaggi di errore nel box rosso
        function showError(msg) {
            const err = document.getElementById('error-display');
            err.innerText = msg;
            err.style.display = 'block';
        }

        // --- Funzioni di Autenticazione ---
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-pass').value;
            if(!email || !password) return showError("Inserisci email e password");

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                // Messaggi di errore personalizzati come richiesto
                if (error.message.includes("Invalid login credentials")) showError("E-mail o password sbagliati");
                else if (error.message.includes("Email not confirmed")) showError("Devi prima confermare l'email ricevuta!");
                else showError("Utente non registrato o errore di accesso");
            } else {
                location.reload(); // Ricarica la pagina per entrare
            }
        }

        async function handleSignup() {
            const nome = document.getElementById('reg-nome').value;
            const cognome = document.getElementById('reg-cognome').value;
            const nascita = document.getElementById('reg-nascita').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-pass').value;

            if (!nome || !cognome || !nascita || !email || !password) return showError("Compila tutti i campi obbligatori");

            // Controllo età: minimo 16 anni
            const oggi = new Date();
            const dataNascita = new Date(nascita);
            let eta = oggi.getFullYear() - dataNascita.getFullYear();
            const m = oggi.getMonth() - dataNascita.getMonth();
            if (m < 0 || (m === 0 && oggi.getDate() < dataNascita.getDate())) eta--;

            if (eta < 16) return showError("Devi avere almeno 16 anni per unirti a Hawenishland");

            const { error } = await supabase.auth.signUp({
                email, password,
                options: { data: { first_name: nome, last_name: cognome } }
            });

            if (error) showError(error.message);
            else {
                // Messaggio di successo e ritorno al login
                alert("REGISTRAZIONE COMPLETATA! CONTROLLA LA TUA E-MAIL (ANCHE NELLO SPAM) PER CONFERMARE L'ISCRIZIONE.");
                toggleAuth('login');
            }
        }

        async function loginGitHub() {
            // Reindirizza a GitHub per il login
            await supabase.auth.signInWithOAuth({ 
                provider: 'github', 
                options: { redirectTo: window.location.origin } 
            });
        }

        async function forgotPassword() {
            const email = document.getElementById('login-email').value;
            if(!email) return showError("Inserisci la tua email nel campo sopra per il recupero.");
            const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.origin });
            if (error) showError(error.message); else alert("Ti abbiamo inviato un'email con il link per reimpostare la password.");
        }

        // --- Funzioni Social (Post, Foto, Like, Commenti) ---
        async function publishPost() {
            const text = document.getElementById('post-text').value;
            const file = document.getElementById('post-file').files[0];
            const btn = document.getElementById('btn-publish');
            const { data: { user } } = await supabase.auth.getUser();

            if (!text && !file) return; // Non pubblica se è tutto vuoto
            
            btn.disabled = true; 
            btn.innerText = "PUBBLICAZIONE...";

            let imageUrl = null;
            // Caricamento immagine nel Bucket "immagini"
            if (file) {
                const fileName = `${Date.now()}-${file.name.replace(/[^a-zA-Z0-9.]/g, '')}`; // Pulisce il nome del file
                const { data, error } = await supabase.storage.from('immagini').upload(fileName, file);
                if (error) {
                    alert("Errore caricamento immagine: " + error.message);
                    btn.disabled = false; btn.innerText = "PUBBLICA";
                    return;
                }
                imageUrl = `${SB_URL}/storage/v1/object/public/immagini/${fileName}`;
            }

            // Salvataggio del post nel database
            const { error: postError } = await supabase.from('posts').insert([{ content: text, user_email: user.email, image_url: imageUrl }]);
            if(postError) {
                 alert("Errore pubblicazione: " + postError.message);
                 btn.disabled = false; btn.innerText = "PUBBLICA";
            } else {
                location.reload();
            }
        }

        async function loadPosts() {
            const search = document.getElementById('search-input').value.toLowerCase();
            // Carica post, conteggio like e commenti
            const { data, error } = await supabase.from('posts').select('*, likes(count), comments(*)').order('created_at', { ascending: false });
            
            if (error) { console.error("Errore caricamento feed:", error); return; }

            // Filtra i post in base alla ricerca
            const filtered = data.filter(p => 
                (p.content && p.content.toLowerCase().includes(search)) || 
                (p.user_email && p.user_email.toLowerCase().includes(search))
            );
            
            // Genera l'HTML del feed
            document.getElementById('feed').innerHTML = filtered.map(p => `
                <div class="post-card fade-in">
                    <div class="flex items-center mb-4">
                        <div class="w-8 h-8 bg-zinc-900 rounded-full flex items-center justify-center mr-3">
                            <i data-lucide="user" class="w-4 h-4 text-zinc-500"></i>
                        </div>
                        <p class="text-[11px] text-zinc-400 uppercase tracking-widest">${p.user_email.split('@')[0]}</p>
                    </div>

                    ${p.image_url ? `<img src="${p.image_url}" class="w-full mb-8 grayscale hover:grayscale-0 transition duration-700 shadow-2xl rounded-sm">` : ''}
                    <p class="serif text-3xl italic mb-8 leading-tight text-zinc-200">"${p.content}"</p>
                    
                    <div class="flex gap-8 items-center border-t border-zinc-900/50 pt-6">
                        <button onclick="addLike(${p.id})" class="flex items-center gap-2 text-[10px] uppercase tracking-widest hover:text-red-500 transition group">
                            <i data-lucide="heart" class="w-4 h-4 group-hover:fill-red-500 transition"></i> ${p.likes[0].count}
                        </button>
                        <div class="flex items-center gap-2 text-[10px] uppercase tracking-widest text-zinc-500">
                            <i data-lucide="message-square" class="w-4 h-4"></i> ${p.comments.length} COMMENTI
                        </div>
                    </div>

                    <div class="mt-8 space-y-3">
                        ${p.comments.map(c => `<div class="comment-item"><b>${c.user_email.split('@')[0]}</b> <span class="text-zinc-500 ml-2">${c.content}</span></div>`).join('')}
                        <input type="text" placeholder="Scrivi un commento e premi invio..." onkeydown="if(event.key==='Enter') sendComment(${p.id}, this.value)" class="text-[11px] py-3 mt-6 bg-zinc-950/50 focus:bg-zinc-900">
                    </div>
                </div>
            `).join('');
            lucide.createIcons(); // Aggiorna le icone
        }

        async function addLike(postId) {
            const { data: { user } } = await supabase.auth.getUser();
            if(!user) return alert("Devi essere loggato per mettere like.");
            // Verifica se l'utente ha già messo like (per evitare like doppi)
            const { data } = await supabase.from('likes').select('*').eq('post_id', postId).eq('user_email', user.email);
            if(data.length > 0) return; // Ha già messo like
            
            await supabase.from('likes').insert([{ post_id: postId, user_email: user.email }]);
            loadPosts(); // Ricarica il feed per mostrare il nuovo like
        }

        async function sendComment(postId, text) {
            const { data: { user } } = await supabase.auth.getUser();
            if(!user) return alert("Devi essere loggato per commentare.");
            if (!text.trim()) return; // Non invia commenti vuoti
            await supabase.from('comments').insert([{ post_id: postId, user_email: user.email, content: text }]);
            loadPosts(); // Ricarica il feed per mostrare il nuovo commento
        }

        // --- Gestione della Sessione ---
        async function checkSession() {
            // Controlla se l'utente è già loggato all'avvio
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                loadPosts();
            }
        }

        function logout() { 
            // Disconnette l'utente e ricarica la pagina
            supabase.auth.signOut().then(() => location.reload()); 
        }

        // Avvio dell'applicazione
        lucide.createIcons();
        checkSession();
    </script>
</body>
</html>
