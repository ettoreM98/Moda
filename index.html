<script>
const SB_URL = 'https://nqueucpgvqexhpztpois.supabase.co';
const SB_KEY = 'INSERISCI_LA_TUA_ANON_KEY';
const sb = supabase.createClient(SB_URL, SB_KEY);

function vaiA(m) {
    document.getElementById('login-form').classList.toggle('hidden', m === 'signup');
    document.getElementById('signup-form').classList.toggle('hidden', m === 'login');
    document.getElementById('msg-box').style.display = 'none';
}

function mess(t, err = false) {
    const b = document.getElementById('msg-box');
    b.innerText = t;
    b.style.display = 'block';
    b.style.color = err ? '#ff4444' : '#44ff44';
}

/* VALIDAZIONE EMAIL SERIA */
function emailValida(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

async function faiRegistrazione() {
    const e = document.getElementById('r-email').value.trim();
    const p = document.getElementById('r-pass').value;
    const n = document.getElementById('r-nome').value.trim();
    const c = document.getElementById('r-cognome').value.trim();
    const d = document.getElementById('r-nascita').value;

    if (!e || !p || !n || !c || !d)
        return mess("Compila tutti i campi.", true);

    if (!emailValida(e))
        return mess("Email non valida.", true);

    if (p.length < 8)
        return mess("Password minimo 8 caratteri.", true);

    const nascita = new Date(d);
    const oggi = new Date();
    let eta = oggi.getFullYear() - nascita.getFullYear();
    if (
        oggi.getMonth() < nascita.getMonth() ||
        (oggi.getMonth() === nascita.getMonth() && oggi.getDate() < nascita.getDate())
    ) eta--;

    if (eta < 16)
        return mess("Devi avere almeno 16 anni.", true);

    try {
        const { error } = await sb.auth.signUp({
            email: e,
            password: p,
            options: {
                data: { first_name: n, last_name: c, birthday: d },
                emailRedirectTo: window.location.origin
            }
        });

        if (error) {
            mess(error.message, true);
        } else {
            mess("Controlla la tua mail per confermare.", false);

            setTimeout(() => {
                vaiA('login');
            }, 2000);
        }

    } catch (err) {
        mess("Errore di connessione. Riprova piÃ¹ tardi.", true);
    }
}

async function faiLogin() {
    const e = document.getElementById('l-email').value;
    const p = document.getElementById('l-pass').value;

    const { error } = await sb.auth.signInWithPassword({ email: e, password: p });

    if (error) mess(error.message, true);
    else alert("Login effettuato.");
}

async function recuperoPassword() {
    const email = prompt("Inserisci la tua email:");
    if (!email) return;

    const { error } = await sb.auth.resetPasswordForEmail(email, {
        redirectTo: window.location.origin
    });

    if (error) alert(error.message);
    else alert("Email di recupero inviata.");
}

let idx = 0;
const imgs = document.querySelectorAll('.visual-side img');
setInterval(() => {
    imgs[idx].classList.remove('active');
    idx = (idx + 1) % imgs.length;
    imgs[idx].classList.add('active');
}, 5000);
</script>
