<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HAWENISHLAND â€” Official</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

  <style>
    /* --- CORE VARIABLES & RESET --- */
    :root {
      --bg-body: #050505;
      --bg-card: #0f0f0f;
      --text-main: #ffffff;
      --text-muted: #888888;
      --border-color: #222222;
    }

    body { background: var(--bg-body); color: var(--text-main); font-family: 'Inter', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
    .serif { font-family: 'Playfair Display', serif; }
    .hidden { display: none !important; }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    /* --- 1. AUTH SCREEN (MAN/WOMAN SPLIT) --- */
    .auth-wrapper {
      position: fixed; inset: 0; z-index: 999; background: #000;
      display: flex; flex-direction: row; transition: transform 0.6s ease-in-out;
    }
    
    /* Visual Side: Split Images */
    .auth-visual {
      flex: 1.5; display: flex; position: relative; overflow: hidden;
      background: #000;
    }
    @media (max-width: 768px) { .auth-wrapper { flex-direction: column; } .auth-visual { flex: 1; min-height: 200px; } }

    .split-img {
      flex: 1; height: 100%; position: relative;
      background-size: cover; background-position: center;
      filter: grayscale(100%) contrast(1.1);
      transition: filter 0.4s ease, transform 10s ease;
      cursor: crosshair;
    }
    /* Color on Hover */
    .split-img:hover { filter: grayscale(0%) contrast(1); }

    /* Form Side */
    .auth-form-container {
      flex: 1; display: flex; flex-direction: column; justify-content: center;
      padding: 40px; background: #050505; max-width: 550px; position: relative;
      box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    }

    .brand-title { font-family: 'Playfair Display', serif; font-size: 3.5rem; line-height: 1; margin-bottom: 10px; font-style: italic; }
    .brand-subtitle { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 40px; letter-spacing: 1px; text-transform: uppercase; }

    .input-group { margin-bottom: 20px; position: relative; }
    .input-field {
      width: 100%; background: transparent; border: none; border-bottom: 1px solid #333;
      padding: 15px 0; color: #fff; font-size: 16px; outline: none; transition: 0.3s;
      border-radius: 0; /* Remove iOS border radius */
    }
    .input-field:focus { border-bottom-color: #fff; }
    .input-label { position: absolute; top: 15px; left: 0; font-size: 14px; color: #666; pointer-events: none; transition: 0.3s; }
    .input-field:focus ~ .input-label, .input-field:not(:placeholder-shown) ~ .input-label {
      top: -10px; font-size: 11px; color: #fff;
    }

    .btn-auth {
      background: #fff; color: #000; padding: 16px; width: 100%; font-weight: 600;
      text-transform: uppercase; letter-spacing: 1px; border: 1px solid #fff; cursor: pointer;
      transition: 0.3s; margin-top: 20px;
    }
    .btn-auth:hover { background: #000; color: #fff; }

    /* --- 2. APP LAYOUT (OPTIMIZED) --- */
    #app-interface { display: none; height: 100vh; width: 100vw; overflow: hidden; position: relative; }

    /* Header Mobile/Tablet */
    .mobile-header {
      display: flex; align-items: center; justify-content: space-between;
      height: 60px; padding: 0 20px; border-bottom: 1px solid var(--border-color);
      position: fixed; top: 0; left: 0; width: 100%; background: rgba(5,5,5,0.9);
      backdrop-filter: blur(10px); z-index: 50;
    }
    .hamburger { font-size: 24px; cursor: pointer; padding: 10px; }

    /* Sidebar Drawer (Animated) */
    .sidebar-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100;
      opacity: 0; pointer-events: none; transition: 0.4s; backdrop-filter: blur(5px);
    }
    .sidebar-overlay.active { opacity: 1; pointer-events: auto; }

    .sidebar {
      position: fixed; top: 0; left: 0; bottom: 0; width: 280px;
      background: #0a0a0a; border-right: 1px solid #222; z-index: 101;
      transform: translateX(-100%); transition: transform 0.5s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex; flex-direction: column; padding: 30px;
    }
    .sidebar.active { transform: translateX(0); }

    .nav-link {
      display: flex; align-items: center; gap: 18px; padding: 16px 0;
      color: #888; cursor: pointer; transition: 0.2s; font-size: 18px;
    }
    .nav-link:hover, .nav-link.active { color: #fff; padding-left: 10px; }
    .nav-link i { width: 24px; text-align: center; }

    /* Main Content Area */
    .main-wrapper {
      width: 100%; height: 100%; overflow-y: auto; padding-top: 70px; /* Space for header */
      display: flex; flex-direction: column; align-items: center;
    }

    .content-container {
      width: 100%; max-width: 800px; /* WIDER for iPad */
      padding: 0 20px 100px 20px;
    }

    /* Feed & Posts */
    .post-card {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 0; margin-bottom: 30px; overflow: hidden;
    }
    .post-header { padding: 15px; display: flex; align-items: center; justify-content: space-between; }
    .user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .avatar-post { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid #333; }
    
    .post-image { width: 100%; display: block; object-fit: cover; max-height: 800px; cursor: pointer; }
    
    .post-actions { padding: 15px; display: flex; gap: 20px; font-size: 22px; }
    .action-btn { cursor: pointer; transition: 0.2s; color: #fff; display: flex; align-items: center; gap: 8px; }
    .action-btn span { font-size: 14px; font-weight: 600; color: #aaa; }
    .action-btn:hover { color: #ccc; }
    .action-btn.liked { color: #ef4444; }

    .post-caption { padding: 0 15px 15px; color: #ddd; font-size: 15px; line-height: 1.5; }
    .username-bold { font-weight: 700; color: #fff; margin-right: 8px; cursor: pointer; }

    /* Profile Header */
    .profile-section { text-align: center; margin-bottom: 40px; margin-top: 20px; }
    .avatar-large { width: 110px; height: 110px; border-radius: 50%; border: 2px solid #333; padding: 3px; object-fit: cover; margin-bottom: 15px; cursor: pointer; }
    .stats-flex { display: flex; justify-content: center; gap: 40px; margin: 20px 0; }
    .stat-item { text-align: center; cursor: pointer; }
    .stat-val { display: block; font-size: 18px; font-weight: 700; color: #fff; }
    .stat-lbl { font-size: 11px; text-transform: uppercase; color: #666; letter-spacing: 1px; }

    /* Modals */
    .modal-wrap { position: fixed; inset: 0; z-index: 200; display: none; justify-content: center; align-items: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); }
    .modal-wrap.active { display: flex; }
    .modal-box { background: #111; border: 1px solid #333; width: 95%; max-width: 500px; max-height: 80vh; overflow-y: auto; border-radius: 4px; position: relative; }
    .close-modal { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; z-index: 10; padding: 5px; }

    .search-row { padding: 12px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .search-row:hover { background: #1a1a1a; }
  </style>
</head>

<body>

<div id="auth-container" class="auth-wrapper">
  
  <div class="auth-visual">
    <div class="split-img" style="background-image: url('https://images.unsplash.com/photo-1534528741775-53994a69daeb?q=80&w=1000&auto=format&fit=crop');"></div>
    <div class="split-img" style="background-image: url('https://images.unsplash.com/photo-1506794778202-cad84cf45f1d?q=80&w=1000&auto=format&fit=crop');"></div>
  </div>

  <div class="auth-form-container">
    <div style="max-width: 380px; margin: 0 auto; width: 100%;">
      <h1 class="brand-title">Hawenish</h1>
      <p class="brand-subtitle">Fashion Social Network</p>
      
      <div id="msg-box" class="text-xs mb-4 hidden p-2 border border-red-500 text-red-500"></div>

      <div id="login-form">
        <div class="input-group">
          <input type="email" id="l-email" class="input-field" placeholder=" " required>
          <label class="input-label">Email Address</label>
        </div>
        <div class="input-group">
          <input type="password" id="l-pass" class="input-field" placeholder=" " required>
          <label class="input-label">Password</label>
        </div>
        <button onclick="faiLogin()" class="btn-auth">Login</button>
        <div class="flex justify-between mt-4 text-xs text-gray-500">
          <span class="cursor-pointer hover:text-white" onclick="toggleAuth('signup')">Crea Account</span>
          <span class="cursor-pointer hover:text-white" onclick="recuperoPassword()">Password persa?</span>
        </div>
      </div>

      <div id="signup-form" class="hidden">
        <div class="input-group">
          <input type="text" id="r-username" class="input-field" placeholder=" " required>
          <label class="input-label">Username</label>
        </div>
        <div class="input-group">
          <input type="text" id="r-nome" class="input-field" placeholder=" " required>
          <label class="input-label">Nome Completo</label>
        </div>
        <div class="input-group">
          <input type="date" id="r-nascita" class="input-field" style="color-scheme: dark;">
          <label class="input-label" style="top:-10px; font-size:11px; color:#fff;">Data di nascita</label>
        </div>
        <div class="input-group">
          <input type="email" id="r-email" class="input-field" placeholder=" " required>
          <label class="input-label">Email</label>
        </div>
        <div class="input-group">
          <input type="password" id="r-pass" class="input-field" placeholder=" " required>
          <label class="input-label">Password</label>
        </div>
        <button onclick="faiRegistrazione()" class="btn-auth">Registrati</button>
        <div class="mt-4 text-center text-xs text-gray-500 cursor-pointer hover:text-white" onclick="toggleAuth('login')">Torna al Login</div>
      </div>
    </div>
  </div>
</div>

<div id="app-interface">
  
  <div class="mobile-header">
    <i class="fa-solid fa-bars hamburger" onclick="toggleSidebar(true)"></i>
    <span class="serif text-xl italic font-bold">Hawenishland</span>
    <div class="w-8"></div> </div>

  <div class="sidebar-overlay" id="sb-overlay" onclick="toggleSidebar(false)"></div>
  <nav class="sidebar" id="sb-menu">
    <div class="flex justify-between items-center mb-8">
      <h2 class="serif text-2xl italic">Menu</h2>
      <i class="fa-solid fa-xmark text-xl cursor-pointer" onclick="toggleSidebar(false)"></i>
    </div>

    <div class="nav-link" onclick="navigate('feed')"><i class="fa-solid fa-house"></i> Feed</div>
    <div class="nav-link" onclick="navigate('search')"><i class="fa-solid fa-magnifying-glass"></i> Cerca</div>
    <div class="nav-link" onclick="navigate('create')"><i class="fa-regular fa-square-plus"></i> Nuovo Post</div>
    <div class="nav-link" onclick="navigate('profile')"><i class="fa-regular fa-user"></i> Il Mio Profilo</div>
    
    <div class="mt-auto nav-link text-red-500" onclick="logout()"><i class="fa-solid fa-arrow-right-from-bracket"></i> Esci</div>
  </nav>

  <div class="main-wrapper" id="main-scroll">
    
    <div id="view-feed" class="content-container">
      <h1 class="serif text-3xl italic text-center mb-8 mt-4 text-gray-400">Feed</h1>
      <div id="posts-container"></div>
    </div>

    <div id="view-profile" class="content-container hidden">
      <div class="profile-section">
        <button id="btn-back-profile" class="hidden mb-4 text-sm text-gray-400 hover:text-white" onclick="navigate('feed')"><i class="fa-solid fa-arrow-left"></i> Torna indietro</button>

        <img id="p-avatar" src="" class="avatar-large" onclick="handleAvatarClick()">
        <input type="file" id="avatar-input" class="hidden" accept="image/*" onchange="uploadAvatar()">
        
        <h2 id="p-username" class="text-2xl font-light mt-2">@username</h2>
        <p id="p-fullname" class="text-sm text-gray-500 font-bold mb-4">Nome Cognome</p>
        
        <div class="stats-flex">
          <div class="stat-item" onclick="openList('followers')">
            <span class="stat-val" id="val-followers">0</span>
            <span class="stat-lbl">Follower</span>
          </div>
          <div class="stat-item" onclick="openList('following')">
            <span class="stat-val" id="val-following">0</span>
            <span class="stat-lbl">Seguiti</span>
          </div>
        </div>

        <div id="profile-actions" class="mt-4 flex justify-center gap-4"></div>

        <div id="edit-panel" class="hidden mt-6 bg-gray-900 p-4 text-left max-w-sm mx-auto border border-gray-800">
           <p class="text-xs uppercase text-gray-500 mb-2">Modifica Dati</p>
           <input id="ed-name" class="w-full bg-black border border-gray-700 p-2 mb-2 text-white" placeholder="Nome">
           <input id="ed-user" class="w-full bg-black border border-gray-700 p-2 mb-2 text-white" placeholder="Username">
           <button class="bg-white text-black px-4 py-1 text-sm font-bold uppercase mb-4 w-full" onclick="saveProfile()">Salva</button>
           
           <p class="text-xs uppercase text-gray-500 mb-2 mt-4">Sicurezza</p>
           <button class="text-red-400 text-xs border border-red-900 px-3 py-2 w-full mb-2" onclick="sendReset()">Reset Password</button>
           <button class="text-blue-400 text-xs border border-blue-900 px-3 py-2 w-full" onclick="changeEmail()">Cambia Email</button>
        </div>
      </div>
      
      <div class="border-t border-gray-800 mt-8 pt-8 w-full" id="profile-posts"></div>
    </div>

  </div>
</div>

<div id="modal-create" class="modal-wrap">
  <div class="modal-box p-6">
    <i class="fa-solid fa-xmark close-modal" onclick="closeModal('modal-create')"></i>
    <h3 class="serif text-xl italic mb-4">Crea Post</h3>
    <textarea id="post-caption" class="w-full bg-gray-900 text-white p-3 border border-gray-700 outline-none mb-4 min-h-[100px]" placeholder="Scrivi qualcosa..."></textarea>
    <label class="block mb-4 p-4 border border-dashed border-gray-600 text-center cursor-pointer hover:border-white">
       <span class="text-sm text-gray-400">Aggiungi Foto</span>
       <input type="file" id="post-file" class="hidden" accept="image/*">
    </label>
    <button onclick="submitPost()" class="w-full bg-white text-black py-3 font-bold uppercase">Pubblica</button>
  </div>
</div>

<div id="modal-search" class="modal-wrap">
  <div class="modal-box p-0 min-h-[300px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex gap-2">
      <input id="search-q" class="w-full bg-transparent outline-none text-white text-lg" placeholder="Cerca..." onkeyup="doSearch()">
      <i class="fa-solid fa-xmark text-xl cursor-pointer" onclick="closeModal('modal-search')"></i>
    </div>
    <div id="search-res" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<div id="modal-list" class="modal-wrap">
  <div class="modal-box p-0 min-h-[300px] flex flex-col">
    <div class="p-4 border-b border-gray-800 flex justify-between">
      <span id="list-title" class="font-bold">Lista</span>
      <i class="fa-solid fa-xmark cursor-pointer" onclick="closeModal('modal-list')"></i>
    </div>
    <div id="list-body" class="flex-1 overflow-y-auto"></div>
  </div>
</div>

<script>
const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
const sb = window.supabase.createClient(SB_URL, SB_KEY);

let currentUser = null;
let viewingProfileId = null;

// INIT
window.addEventListener('load', async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session) enterApp(session.user);
});

// UI FUNCTIONS
function toggleAuth(mode) {
  document.getElementById('login-form').classList.toggle('hidden', mode !== 'login');
  document.getElementById('signup-form').classList.toggle('hidden', mode !== 'signup');
}

function toggleSidebar(show) {
  const sb = document.getElementById('sb-menu');
  const ov = document.getElementById('sb-overlay');
  if(show) { sb.classList.add('active'); ov.classList.add('active'); }
  else { sb.classList.remove('active'); ov.classList.remove('active'); }
}

function navigate(view) {
  toggleSidebar(false);
  
  if(view === 'search') { document.getElementById('modal-search').classList.add('active'); document.getElementById('search-q').focus(); return; }
  if(view === 'create') { document.getElementById('modal-create').classList.add('active'); return; }

  document.getElementById('view-feed').classList.add('hidden');
  document.getElementById('view-profile').classList.add('hidden');
  
  if(view === 'feed') {
    document.getElementById('view-feed').classList.remove('hidden');
    loadFeed();
  }
  if(view === 'profile') {
    document.getElementById('view-profile').classList.remove('hidden');
    loadProfile(currentUser.id);
  }
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function mess(txt) { const b=document.getElementById('msg-box'); b.innerText=txt; b.classList.remove('hidden'); setTimeout(()=>b.classList.add('hidden'),3000); }

// AUTH LOGIC
async function faiLogin() {
  const e = document.getElementById('l-email').value;
  const p = document.getElementById('l-pass').value;
  const { data, error } = await sb.auth.signInWithPassword({ email:e, password:p });
  if(error) mess("Errore Login: " + error.message);
  else enterApp(data.user);
}

async function faiRegistrazione() {
  const e = document.getElementById('r-email').value;
  const p = document.getElementById('r-pass').value;
  const u = document.getElementById('r-username').value;
  const n = document.getElementById('r-nome').value;
  const d = document.getElementById('r-nascita').value;
  
  if(!u || !n) return mess("Compila tutti i campi");

  const { data, error } = await sb.auth.signUp({ 
    email:e, password:p, 
    options: { data: { first_name:n, birthday:d } }
  });
  
  if(error) mess(error.message);
  else {
    if(data.user) {
       await sb.from('profiles').upsert([{ id:data.user.id, username:u.toLowerCase(), full_name:n }]);
    }
    alert("Registrato! Controlla la mail.");
    toggleAuth('login');
  }
}

async function logout() { await sb.auth.signOut(); location.reload(); }

function enterApp(user) {
  currentUser = user;
  document.getElementById('auth-container').style.transform = "translateX(-100vw)";
  setTimeout(() => {
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('app-interface').style.display = 'block';
    navigate('feed');
  }, 600);
}

// FEED LOGIC (FIXED: SHOW GLOBAL POSTS IF NO FRIENDS)
async function loadFeed() {
  const c = document.getElementById('posts-container');
  c.innerHTML = '<div class="text-center mt-10 text-gray-600">Caricamento...</div>';

  // 1. Get who I follow
  const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
  let ids = [currentUser.id];
  if(follows && follows.length > 0) {
    ids = [...ids, ...follows.map(f => f.followed_id)];
  }

  // 2. Fetch posts. If I only follow myself and haven't posted, fetch global.
  let query = sb.from('posts').select(`*, profiles(username, avatar_url)`).order('created_at', { ascending: false }).limit(50);
  
  // Se seguo qualcuno (o ho postato io), filtro per IDs. Altrimenti mostro tutto (Discovery).
  if (ids.length > 1) { // 1 is just me
     query = query.in('user_id', ids);
  }
  
  const { data: posts } = await query;
  
  if(!posts || posts.length === 0) {
    // Fallback: fetch global posts anyway if feed is empty
    const { data: globalPosts } = await sb.from('posts').select(`*, profiles(username, avatar_url)`).order('created_at', { ascending: false }).limit(20);
    renderPosts(c, globalPosts || [], true);
  } else {
    renderPosts(c, posts, false);
  }
}

function renderPosts(container, posts, isGlobal) {
  container.innerHTML = '';
  if(isGlobal && posts.length > 0) {
    container.innerHTML = '<div class="text-center text-xs text-gray-500 mb-4 uppercase tracking-widest">Esplora (Nessun seguito)</div>';
  }
  if(!posts || posts.length === 0) return container.innerHTML = '<div class="text-center mt-10 text-gray-600">Nessun post trovato.</div>';

  posts.forEach(p => {
    const u = p.profiles || { username: 'user', avatar_url: null };
    const html = `
      <div class="post-card">
        <div class="post-header">
          <div class="user-info" onclick="loadProfile('${p.user_id}')">
            <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="avatar-post">
            <span class="font-bold ml-2">@${u.username}</span>
          </div>
          ${p.user_id === currentUser.id ? `<i class="fa-solid fa-trash text-gray-600 hover:text-red-500 cursor-pointer" onclick="deletePost('${p.id}')"></i>` : ''}
        </div>
        ${p.image_url ? `<img src="${p.image_url}" class="post-image" onclick="toggleLike('${p.id}')">` : ''}
        <div class="post-actions">
           <div class="action-btn" id="btn-like-${p.id}" onclick="toggleLike('${p.id}')">
             <i class="fa-regular fa-heart"></i> <span id="cnt-like-${p.id}"></span>
           </div>
        </div>
        <div class="post-caption">
          <span class="username-bold" onclick="loadProfile('${p.user_id}')">@${u.username}</span>
          ${p.caption || ''}
        </div>
      </div>
    `;
    container.insertAdjacentHTML('beforeend', html);
    updatePostStats(p.id);
  });
}

// PROFILE LOGIC
async function loadProfile(uid) {
  viewingProfileId = uid;
  document.getElementById('view-feed').classList.add('hidden');
  document.getElementById('view-profile').classList.remove('hidden');
  
  const isMe = (uid === currentUser.id);
  document.getElementById('btn-back-profile').classList.toggle('hidden', isMe); // Hide back button if it's me
  document.getElementById('edit-panel').classList.toggle('hidden', !isMe); // Hide edit if not me

  const { data: prof } = await sb.from('profiles').select('*').eq('id', uid).single();
  
  if(prof) {
    document.getElementById('p-avatar').src = prof.avatar_url || 'https://via.placeholder.com/150';
    document.getElementById('p-username').innerText = '@' + prof.username;
    document.getElementById('p-fullname').innerText = prof.full_name;
    
    if(isMe) {
        document.getElementById('ed-name').value = prof.full_name;
        document.getElementById('ed-user').value = prof.username;
    }
  }

  // Stats
  const f1 = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', uid);
  const f2 = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', uid);
  document.getElementById('val-followers').innerText = f1.count || 0;
  document.getElementById('val-following').innerText = f2.count || 0;

  // Actions Button
  const actDiv = document.getElementById('profile-actions');
  actDiv.innerHTML = '';
  
  if(!isMe) {
    const { data: rel } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', uid);
    const isFollowing = rel && rel.length > 0;
    actDiv.innerHTML = `<button onclick="doFollow('${uid}', ${isFollowing})" class="px-6 py-2 border ${isFollowing ? 'bg-white text-black' : 'border-white text-white'} uppercase font-bold text-sm">${isFollowing ? 'Non seguire' : 'Segui'}</button>`;
  } else {
    actDiv.innerHTML = `<button onclick="toggleEdit()" class="px-6 py-2 border border-gray-600 text-gray-400 uppercase text-xs">Modifica Profilo</button>`;
  }

  // Load User Posts
  const { data: posts } = await sb.from('posts').select('*').eq('user_id', uid).order('created_at', { ascending: false });
  renderPosts(document.getElementById('profile-posts'), posts || [], false);
}

function handleAvatarClick() {
  if(viewingProfileId === currentUser.id) document.getElementById('avatar-input').click();
}

function toggleEdit() {
    document.getElementById('edit-panel').classList.toggle('hidden');
}

async function uploadAvatar() {
  const f = document.getElementById('avatar-input').files[0];
  if(!f) return;
  const path = `${currentUser.id}/${Date.now()}`;
  await sb.storage.from('avatars').upload(path, f);
  const { data } = sb.storage.from('avatars').getPublicUrl(path);
  await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
  loadProfile(currentUser.id);
}

async function saveProfile() {
    const n = document.getElementById('ed-name').value;
    const u = document.getElementById('ed-user').value;
    await sb.from('profiles').update({ full_name: n, username: u }).eq('id', currentUser.id);
    alert("Salvato");
    loadProfile(currentUser.id);
}

async function doFollow(uid, isFollowing) {
    if(isFollowing) await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', uid);
    else await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: uid }]);
    loadProfile(uid);
}

// INTERACTIONS
async function updatePostStats(pid) {
  const { count } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', pid);
  document.getElementById(`cnt-like-${pid}`).innerText = count || '';
  
  const { data } = await sb.from('likes').select('*').eq('post_id', pid).eq('user_id', currentUser.id);
  const btn = document.getElementById(`btn-like-${pid}`);
  if(data.length) { btn.classList.add('liked'); btn.querySelector('i').classList.replace('fa-regular', 'fa-solid'); }
}

async function toggleLike(pid) {
   const { data } = await sb.from('likes').select('*').eq('post_id', pid).eq('user_id', currentUser.id);
   if(data.length) await sb.from('likes').delete().eq('post_id', pid).eq('user_id', currentUser.id);
   else await sb.from('likes').insert([{ post_id: pid, user_id: currentUser.id }]);
   
   // Toggle UI immediately for better feel
   const btn = document.getElementById(`btn-like-${pid}`);
   btn.classList.toggle('liked');
   const icon = btn.querySelector('i');
   if(btn.classList.contains('liked')) icon.classList.replace('fa-regular', 'fa-solid');
   else icon.classList.replace('fa-solid', 'fa-regular');
   
   updatePostStats(pid); // sync number
}

// SEARCH
async function doSearch() {
  const q = document.getElementById('search-q').value;
  if(q.length < 2) return;
  const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
  const c = document.getElementById('search-res');
  c.innerHTML = '';
  data.forEach(u => {
     c.insertAdjacentHTML('beforeend', `
       <div class="search-row" onclick="loadProfile('${u.id}'); closeModal('modal-search');">
         <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full">
         <span class="font-bold">@${u.username}</span>
       </div>
     `);
  });
}

// LISTS (FOLLOWERS/FOLLOWING)
async function openList(type) {
    document.getElementById('modal-list').classList.add('active');
    const c = document.getElementById('list-body');
    c.innerHTML = 'Caricamento...';
    
    let q = sb.from('follows').select(type === 'followers' ? 'follower_id' : 'followed_id').eq(type === 'followers' ? 'followed_id' : 'follower_id', viewingProfileId);
    const { data } = await q;
    
    if(!data || data.length === 0) return c.innerHTML = '<div class="p-4 text-center text-gray-500">Nessuno.</div>';
    
    const ids = data.map(r => type === 'followers' ? r.follower_id : r.followed_id);
    const { data: profs } = await sb.from('profiles').select('*').in('id', ids);
    
    c.innerHTML = '';
    profs.forEach(u => {
        c.insertAdjacentHTML('beforeend', `
           <div class="search-row" onclick="loadProfile('${u.id}'); closeModal('modal-list');">
             <img src="${u.avatar_url || 'https://via.placeholder.com/40'}" class="w-8 h-8 rounded-full">
             <span class="font-bold">@${u.username}</span>
           </div>
        `);
    });
}

// CREATE POST
async function submitPost() {
  const caption = document.getElementById('post-caption').value;
  const file = document.getElementById('post-file').files[0];
  
  if(!caption && !file) return alert("Scrivi qualcosa o metti una foto!");
  
  let url = null;
  if(file) {
      const path = `${currentUser.id}/post_${Date.now()}`;
      await sb.storage.from('posts').upload(path, file);
      url = sb.storage.from('posts').getPublicUrl(path).data.publicUrl;
  }
  
  await sb.from('posts').insert([{ user_id: currentUser.id, image_url: url, caption: caption }]);
  closeModal('modal-create');
  document.getElementById('post-caption').value = '';
  document.getElementById('post-file').value = '';
  loadFeed();
}

async function deletePost(id) {
    if(confirm("Eliminare?")) {
        await sb.from('posts').delete().eq('id', id);
        loadFeed();
    }
}

// PASSWORD / EMAIL
async function sendReset() {
    if(confirm("Inviare mail di reset password?")) {
        await sb.auth.resetPasswordForEmail(currentUser.email);
        alert("Mail inviata.");
    }
}
async function changeEmail() {
    const m = prompt("Nuova email:");
    if(m) {
        await sb.auth.updateUser({ email: m });
        alert("Controlla la mail per confermare.");
    }
}
async function recuperoPassword() {
    const m = prompt("Tua email:");
    if(m) await sb.auth.resetPasswordForEmail(m);
}
</script>
</body>
</html>
