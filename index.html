<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND â€” Gold Edition Pro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@1,400&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-deep: #0f172a;       
      --bg-panel: rgba(15, 23, 42, 0.95); 
      --text-main: #f8fafc;     
      --text-muted: #94a3b8;    
      --gold: #d4af37;          
      --gold-glow: rgba(212, 175, 55, 0.2);
      --red-like: #ef4444;
      --glass-border: 1px solid rgba(212, 175, 55, 0.3);
    }

    body { 
      background-color: var(--bg-deep); 
      color: var(--text-main); 
      font-family: 'Outfit', sans-serif; 
      margin: 0; 
      background: radial-gradient(circle at top center, #1e293b 0%, #020617 80%);
      min-height: 100vh;
    }

    .hidden { display: none !important; }

    /* --- LAYOUT --- */
    .app-layout { display: flex; max-width: 1200px; margin: 0 auto; min-height: 100vh; }
    .sidebar { 
      width: 80px; position: sticky; top: 20px; height: calc(100vh - 40px);
      margin-left: 10px; padding: 30px 0; display: flex; flex-direction: column; align-items: center; 
      background: var(--bg-panel); backdrop-filter: blur(12px); border: var(--glass-border);
      border-radius: 40px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 50;
    }

    .nav-item { 
      width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;
      border-radius: 50%; cursor: pointer; transition: 0.3s; color: var(--text-muted);
      margin-bottom: 20px; font-size: 20px;
    }
    .nav-item:hover, .nav-item.active { background: rgba(212, 175, 55, 0.15); color: var(--gold); transform: scale(1.1); }

    /* --- POSTS --- */
    .main-content { flex: 1; padding: 40px; max-width: 700px; margin: 0 auto; }
    .post-card { 
      background: rgba(30, 41, 59, 0.4); margin-bottom: 40px; padding: 20px;
      border-radius: 20px; border: 1px solid rgba(212, 175, 55, 0.2);
    }
    .post-img { width: 100%; border-radius: 12px; margin-top: 15px; border: 1px solid rgba(255,255,255,0.1); }
    
    /* --- AUTH --- */
    .split-layout { display:flex; height:100vh; width:100vw; position:fixed; top:0; left:0; z-index:200; background:#0a0a0a; }
    .form-side { flex:1; display:flex; flex-direction:column; justify-content:center; padding:60px; max-width:500px; margin:auto; }
    .auth-input { background:transparent; border-bottom:1px solid #222; padding:10px 0; color:#fff; width:100%; outline:none; margin-bottom:20px; }
    .btn-white { background:#fff; color:#000; padding:14px; font-weight:600; width:100%; cursor:pointer; transition:.3s; }
    .btn-white:hover { background: var(--gold); color: #000; }

    /* --- MODALS --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; display: flex; justify-content: center; align-items: center; }
    .glass-modal { background: #1e293b; border: 1px solid var(--gold); border-radius: 24px; max-width: 90%; max-height: 90%; overflow: hidden; }
    
    .btn-gold { background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%); color: #000; padding: 10px 20px; border-radius: 10px; font-weight: bold; cursor: pointer; }

    /* Notifications Badge */
    .notif-badge { position: absolute; top: 0; right: 0; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

<div id="auth-container" class="split-layout">
  <div class="form-side">
    <h1 class="text-5xl italic mb-10 text-white" style="font-family: 'Playfair Display', serif;">Hawenishland</h1>
    <div id="msg-box" class="hidden p-3 text-center mb-4 text-sm border rounded"></div>
    
    <div id="login-form">
      <input type="email" id="l-email" placeholder="Email" class="auth-input">
      <input type="password" id="l-pass" placeholder="Password" class="auth-input">
      <button onclick="faiLogin()" class="btn-white">ACCEDI</button>
      <p onclick="recuperoPassword()" class="text-center text-xs text-gray-500 mt-6 cursor-pointer hover:text-white uppercase tracking-widest">Password dimenticata?</p>
      <p onclick="vaiA('signup')" class="text-center text-xs text-gray-500 mt-4 cursor-pointer hover:text-white uppercase tracking-widest">Crea un account</p>
    </div>

    <div id="signup-form" class="hidden">
      <input type="text" id="r-username" placeholder="Username" class="auth-input">
      <input type="email" id="r-email" placeholder="Email" class="auth-input">
      <input type="password" id="r-pass" placeholder="Password" class="auth-input">
      <button onclick="faiRegistrazione()" class="btn-white">REGISTRATI</button>
      <p onclick="vaiA('login')" class="text-center text-xs text-gray-500 mt-6 cursor-pointer hover:text-white uppercase tracking-widest">Torna al login</p>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-layout">
    <div class="sidebar">
      <div class="nav-item active" onclick="renderFeedView()"><i class="fa-solid fa-house"></i></div>
      <div class="nav-item" onclick="openSearchModal()"><i class="fa-solid fa-magnifying-glass"></i></div>
      <div class="nav-item" onclick="openUploadModal()"><i class="fa-solid fa-plus"></i></div>
      <div class="nav-item" onclick="openNotifications()"><i class="fa-solid fa-bell"></i><div id="notif-count" class="hidden notif-badge"></div></div>
      <div class="nav-item" onclick="openUserProfile(currentUser.id)"><i class="fa-solid fa-user"></i></div>
      <div class="mt-auto nav-item text-red-500" onclick="logout()"><i class="fa-solid fa-power-off"></i></div>
    </div>
    <div class="main-content" id="main-content-area"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="glass-modal w-[900px] h-[600px] flex">
    <div class="flex-1 bg-black flex items-center justify-center">
      <img id="detail-img" class="max-h-full object-contain">
    </div>
    <div class="w-[350px] flex flex-col bg-slate-900 border-l border-gray-800">
      <div class="p-4 border-b border-gray-800 flex items-center gap-3">
        <img id="detail-avatar" class="w-8 h-8 rounded-full">
        <span id="detail-username" class="font-bold text-white"></span>
        <i class="fa-solid fa-xmark ml-auto cursor-pointer" onclick="closeModal('post-detail-modal')"></i>
      </div>
      <div id="detail-comments" class="flex-1 overflow-y-auto p-4 space-y-4 text-sm"></div>
      <div class="p-4 border-t border-gray-800">
        <div class="flex gap-4 mb-2">
          <i id="detail-like-btn" class="fa-regular fa-heart text-2xl cursor-pointer"></i>
        </div>
        <div class="text-white font-bold text-xs mb-4"><span id="detail-likes-count">0</span> LIKE</div>
        <div class="flex gap-2">
          <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="bg-transparent text-white text-sm outline-none flex-1">
          <button onclick="inviaCommento()" class="text-gold font-bold text-xs">PUBBLICA</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
    <div class="glass-modal p-8 w-[400px]">
        <h3 class="text-xl font-bold mb-4 text-white">Nuovo Post</h3>
        <input type="file" id="post-file" class="mb-4 text-sm text-gray-400">
        <textarea id="post-caption" placeholder="Scrivi una didascalia..." class="w-full bg-slate-800 p-3 rounded-lg text-white mb-4 outline-none"></textarea>
        <button onclick="submitPost()" class="btn-gold w-full">CONDIVIDI</button>
        <button onclick="closeModal('upload-modal')" class="w-full mt-2 text-gray-500 text-xs">ANNULLA</button>
    </div>
</div>

<script>
  // CONFIGURAZIONE
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  
  let currentUser = null;
  let currentPostId = null;

  window.addEventListener('load', async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) enterApp(session.user);
  });

  // --- CORE AUTH ---
  async function faiLogin() {
    const email = document.getElementById('l-email').value;
    const password = document.getElementById('l-pass').value;
    const { data, error } = await sb.auth.signInWithPassword({ email, password });
    if(error) mess(error.message, true); else enterApp(data.user);
  }

  async function faiRegistrazione() {
    const email = document.getElementById('r-email').value;
    const password = document.getElementById('r-pass').value;
    const username = document.getElementById('r-username').value;
    const { data, error } = await sb.auth.signUp({ email, password });
    if(error) return mess(error.message, true);
    if(data.user) {
        await sb.from('profiles').insert([{ id: data.user.id, username: username }]);
        mess("Controlla l'email per confermare!", false);
    }
  }

  async function recuperoPassword() {
    const email = document.getElementById('l-email').value;
    if(!email) return mess("Inserisci la tua email", true);
    const { error } = await sb.auth.resetPasswordForEmail(email);
    if(error) mess(error.message, true);
    else mess("Email di reset inviata!", false);
  }

  function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-container').classList.add('hidden');
    document.getElementById('app-interface').classList.remove('hidden');
    renderFeedView();
    checkNotifications();
  }

  function logout() { sb.auth.signOut(); location.reload(); }

  // --- FEED & POSTS ---
  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    main.innerHTML = '<p class="text-center text-gray-500">Caricamento...</p>';

    const { data: posts, error } = await sb.from('posts')
      .select(`*, profiles:user_id (username, avatar_url)`)
      .order('created_at', { ascending: false });

    if (error) return main.innerHTML = "Errore caricamento.";

    main.innerHTML = '';
    for (const post of posts) {
      const { count: likes } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', post.id);
      const { data: myLike } = await sb.from('likes').select('*').eq('post_id', post.id).eq('user_id', currentUser.id);
      const isLiked = myLike && myLike.length > 0;
      
      main.insertAdjacentHTML('beforeend', `
        <div class="post-card">
          <div class="flex items-center gap-3 mb-4">
            <img src="${post.profiles.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full border border-gold">
            <span class="font-bold text-white">${post.profiles.username}</span>
          </div>
          ${post.image_url ? `<img src="${post.image_url}" class="post-img" onclick="openPostDetail('${post.id}')">` : ''}
          <div class="mt-4 flex gap-4 text-2xl">
            <i class="${isLiked ? 'fa-solid text-red-500' : 'fa-regular text-white'} fa-heart cursor-pointer" onclick="toggleLike('${post.id}', this)"></i>
            <i class="fa-regular fa-comment text-white cursor-pointer" onclick="openPostDetail('${post.id}')"></i>
          </div>
          <div class="text-xs font-bold text-white mt-2">${likes || 0} LIKE</div>
          <div class="text-sm mt-2"><span class="font-bold text-gold mr-2">${post.profiles.username}</span> ${post.caption || ''}</div>
        </div>
      `);
    }
  }

  async function toggleLike(postId, el) {
    const isLiked = el.classList.contains('fa-solid');
    if (isLiked) {
        await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
        el.className = 'fa-regular fa-heart text-white cursor-pointer';
    } else {
        await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
        el.className = 'fa-solid fa-heart text-red-500 cursor-pointer';
        
        // Notifica al proprietario del post
        const { data: p } = await sb.from('posts').select('user_id').eq('id', postId).single();
        if(p.user_id !== currentUser.id) {
            createNotification(p.user_id, 'like', postId);
        }
    }
    // Refresh locale conteggio se necessario o ri-render
  }

  // --- COMMENTI ---
  async function openPostDetail(postId) {
    currentPostId = postId;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    
    const { data: post } = await sb.from('posts').select(`*, profiles:user_id(*)`).eq('id', postId).single();
    const { data: comments } = await sb.from('comments').select(`*, profiles:user_id(username, avatar_url)`).eq('post_id', postId).order('created_at', { ascending: true });
    const { count: likes } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    const { data: myLike } = await sb.from('likes').select('*').eq('post_id', postId).eq('user_id', currentUser.id);

    document.getElementById('detail-img').src = post.image_url || '';
    document.getElementById('detail-username').innerText = post.profiles.username;
    document.getElementById('detail-avatar').src = post.profiles.avatar_url || 'https://via.placeholder.com/40';
    document.getElementById('detail-likes-count').innerText = likes || 0;
    
    const likeBtn = document.getElementById('detail-like-btn');
    likeBtn.className = (myLike && myLike.length > 0) ? 'fa-solid fa-heart text-red-500 text-2xl cursor-pointer' : 'fa-regular fa-heart text-white text-2xl cursor-pointer';

    const cDiv = document.getElementById('detail-comments');
    cDiv.innerHTML = post.caption ? `<div class="mb-4"><b>${post.profiles.username}</b> ${post.caption}</div>` : '';
    comments.forEach(c => {
        cDiv.insertAdjacentHTML('beforeend', `<div><b class="text-gold">${c.profiles.username}</b> ${c.content}</div>`);
    });
  }

  async function inviaCommento() {
    const input = document.getElementById('new-comment');
    const text = input.value.trim();
    if(!text) return;

    const { error } = await sb.from('comments').insert([{ 
        post_id: currentPostId, 
        user_id: currentUser.id, 
        content: text 
    }]);

    if(!error) {
        input.value = '';
        // Notifica
        const { data: p } = await sb.from('posts').select('user_id').eq('id', currentPostId).single();
        if(p.user_id !== currentUser.id) createNotification(p.user_id, 'comment', currentPostId);
        openPostDetail(currentPostId); 
    }
  }

  // --- NOTIFICHE & UTILS ---
  async function createNotification(receiverId, type, postId = null) {
    await sb.from('notifications').insert([{
        sender_id: currentUser.id,
        receiver_id: receiverId,
        type: type,
        post_id: postId
    }]);
  }

  async function checkNotifications() {
    const { count } = await sb.from('notifications')
        .select('*', { count: 'exact', head: true })
        .eq('receiver_id', currentUser.id)
        .eq('read', false);
    
    const badge = document.getElementById('notif-count');
    if(count > 0) {
        badge.innerText = count;
        badge.classList.remove('hidden');
    }
  }

  function mess(t, err) {
    const m = document.getElementById('msg-box');
    m.innerText = t;
    m.classList.remove('hidden');
    m.style.color = err ? 'red' : '#d4af37';
    m.style.borderColor = err ? 'red' : '#d4af37';
  }

  function vaiA(screen) {
    document.getElementById('login-form').classList.toggle('hidden', screen === 'signup');
    document.getElementById('signup-form').classList.toggle('hidden', screen === 'login');
  }

  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
  function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); }

  async function submitPost() {
    const file = document.getElementById('post-file').files[0];
    const caption = document.getElementById('post-caption').value;
    let url = null;

    if(file) {
        const name = `${currentUser.id}/${Date.now()}`;
        await sb.storage.from('posts').upload(name, file);
        const { data } = sb.storage.from('posts').getPublicUrl(name);
        url = data.publicUrl;
    }

    await sb.from('posts').insert([{ user_id: currentUser.id, image_url: url, caption: caption }]);
    closeModal('upload-modal');
    renderFeedView();
  }
</script>

</body>
</html>
