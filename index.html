<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HAWENISHLAND — Debug Supabase</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>

<style>
  body{background:#0a0a0a;color:#fff;font-family:Inter,system-ui;min-height:100vh;margin:0;padding:24px}
  .box{background:#0f0f0f;border:1px solid #222;padding:18px;border-radius:10px;margin-bottom:18px}
  button{background:#fff;color:#000;border:none;padding:10px 14px;border-radius:8px;cursor:pointer}
  button.warn{background:#ffdd57}
  pre{white-space:pre-wrap;word-break:break-word;font-size:13px}
  .small{font-size:13px;color:#bbb}
  input{padding:8px;border-radius:6px;border:1px solid #333;background:transparent;color:#fff;width:100%}
  label{display:block;margin-bottom:6px;color:#aaa;font-size:12px}
  .grid{display:grid;gap:10px}
</style>
</head>
<body>

<h1 style="font-family:Playfair Display,serif;font-size:28px;margin-bottom:12px">hawenishland — debug supabase</h1>

<div class="box">
  <div class="small">Info attuali:</div>
  <ul class="small" id="info-list">
    <li>site: <b id="site-origin">loading...</b></li>
    <li>supabase url: <b id="sb-url">loading...</b></li>
  </ul>
</div>

<div class="box">
  <div class="small" style="margin-bottom:8px">Form di test (usalo solo per debug; verrà creato un account di prova)</div>
  <div class="grid">
    <input id="t-nome" placeholder="nome (es: debug)" value="test">
    <input id="t-cognome" placeholder="cognome (es: user)" value="debug">
    <input id="t-email" placeholder="email" value="">
    <input id="t-pass" placeholder="password (min 8)" value="password123">
    <div style="display:flex;gap:8px">
      <button id="btn-js">Test signUp (supabase-js)</button>
      <button id="btn-fetch" class="warn">Test signUp (raw fetch)</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="btn-toggle-proxy">Rendi DNS-only (istruzioni)</button>
      <button id="btn-clear">Pulisci output</button>
    </div>
  </div>
</div>

<div class="box">
  <div class="small" style="margin-bottom:8px">Output debug</div>
  <pre id="debug-output">Qui appariranno i risultati dei test. Fai il test e copia QUI l'output intero.</pre>
</div>

<script>
/* CONFIG — sostituisci la tua anon key qui */
const SB_URL = 'https://nqueucpgvqexhpztpois.supabase.co'; // tua SB_URL (lascia com'è se è quello)
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc'; // sostituisci con la tua anon key
const sb = supabase.createClient(SB_URL, SB_KEY);

/* informazioni pagina */
document.getElementById('site-origin').innerText = window.location.origin;
document.getElementById('sb-url').innerText = SB_URL;

/* helper output */
function out(t){
  const el = document.getElementById('debug-output');
  el.innerText = typeof t === 'string' ? t : JSON.stringify(t, null, 2);
}

/* riempi email di debug con timestamp per evitare "email già esistente" */
document.getElementById('t-email').value = 'debug+' + Date.now() + '@hawenishland.test';

/* bottone supabase-js signUp */
document.getElementById('btn-js').addEventListener('click', async () => {
  out('Eseguo signUp con supabase-js… (attendi)');
  const nome = document.getElementById('t-nome').value.trim();
  const cognome = document.getElementById('t-cognome').value.trim();
  const email = document.getElementById('t-email').value.trim();
  const pass = document.getElementById('t-pass').value;
  try {
    const res = await sb.auth.signUp({
      email,
      password: pass,
      options: {
        data: { first_name: nome, last_name: cognome },
        emailRedirectTo: window.location.origin + '/login'
      }
    });
    out({note: 'risposta supabase-js', res});
    console.log('supabase-js res', res);
  } catch(e){
    out({note:'errore try/catch supabase-js', message: e.message || e, stack: e.stack || null});
    console.error(e);
  }
});

/* bottone raw fetch (mostra dettagli della richiesta) */
document.getElementById('btn-fetch').addEventListener('click', async () => {
  out('Eseguo fetch raw POST su /auth/v1/signup… (attendi)');
  const email = document.getElementById('t-email').value.trim();
  const pass = document.getElementById('t-pass').value;
  const payload = { email, password: pass };
  const url = SB_URL.replace(/\/$/, '') + '/auth/v1/signup';
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': SB_KEY,
        // Authorization header intentionally omitted (supabase-js uses apikey)
        'X-Client-Info': 'debug-client'
      },
      body: JSON.stringify(payload),
      mode: 'cors',
      credentials: 'omit'
    });
    const text = await resp.text();
    const info = {
      note: 'risposta raw fetch',
      url,
      status: resp.status,
      ok: resp.ok,
      statusText: resp.statusText,
      headers: {},
      bodyTextSample: text.slice(0, 2000)
    };
    // proviamo a leggere alcuni header (se consentiti)
    resp.headers.forEach((v,k) => info.headers[k]=v);
    out(info);
    console.log('raw fetch resp', info);
  } catch (err) {
    // Network / CORS / proxy errors arrivano qui (Status 0)
    out({ note: 'errore fetch (probabile CORS/proxy)', message: err.message || err.toString(), stack: err.stack || null });
    console.error(err);
  }
});

/* suggerimento per proxy toggle (istruzioni rapide) */
document.getElementById('btn-toggle-proxy').addEventListener('click', () => {
  const msg = [
    'ISTRUZIONI RAPIDE — verifica se è Cloudflare a bloccare:',
    '1) Apri Cloudflare → Domains → hawenishland.it → DNS',
    '2) Imposta entrambi i record su "DNS only" (clicca la nuvola arancione per farla diventare grigia)',
    '3) Salva e riprova il Test signUp (btn “Test signUp (supabase-js)”)',
    '',
    'Se con "DNS only" la registrazione funziona, allora il proxy/Firewall Cloudflare sta bloccando le POST verso Supabase.',
    'In tal caso rimetti proxy arancione e verifica Firewall → Events per regole bloccanti o disattiva temporaneamente WAF/Bot Fight mode.'
  ].join('\\n');
  alert(msg);
});

/* pulisci output */
document.getElementById('btn-clear').addEventListener('click', () => out(''));

/* test di reachability iniziale */
(async function initialCheck(){
  out('Verifico GET su /auth/v1 (ping supabase) …');
  const url = SB_URL.replace(/\/$/, '') + '/auth/v1';
  try {
    const r = await fetch(url, { method:'GET', mode:'cors', credentials:'omit' });
    out({note:'GET /auth/v1', url, status: r.status, ok: r.ok});
  } catch(e) {
    out({note:'GET /auth/v1 errore', message: e.message || e.toString()});
  }
})();
</script>
</body>
</html>
