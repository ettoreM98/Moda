<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>HAWENISHLAND â€” Pro</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- PROFESSIONAL THEME SETUP --- */
    :root {
      --bg-body: #000000;
      --bg-card: #0a0a0a;
      --bg-hover: #161616;
      --border-color: #262626;
      --accent: #fff;
      --text-muted: #737373;
    }

    body { background:var(--bg-body); color:#fff; font-family:'Inter',sans-serif; margin:0; height:100vh; overflow:hidden; }
    .hidden { display:none!important }

    /* Scrollbar minimal */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    /* AUTH LAYOUT */
    .auth-wrapper { position:fixed; inset:0; z-index:999; background:#000; display:flex; transition:transform 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
    .auth-visual { flex:1.2; position:relative; overflow:hidden; display:none; }
    @media (min-width:768px){ .auth-visual{display:block} }
    .auth-visual img { width:100%; height:100%; object-fit:cover; position:absolute; inset:0; opacity:0; transition:opacity 1s ease; filter:brightness(0.7); }
    .auth-visual img.active { opacity:1; }
    
    .auth-form { flex:1; display:flex; flex-direction:column; justify-content:center; padding:40px 60px; max-width:500px; margin:0 auto; }
    .brand-title { font-size:2.5rem; font-weight:700; letter-spacing:-1px; margin-bottom:40px; }
    
    .input-field {
      background:#111; border:1px solid #333; border-radius:8px; padding:14px;
      color:#fff; width:100%; margin-bottom:16px; font-size:14px; outline:none; transition:.2s;
    }
    .input-field:focus { border-color:#fff; }
    .btn-primary {
      background:#fff; color:#000; padding:14px; border-radius:8px; font-weight:600; width:100%;
      cursor:pointer; transition:.2s; font-size:14px; margin-top:10px;
    }
    .btn-primary:hover { background:#ddd; }

    /* APP LAYOUT */
    #app-interface { display:none; height:100vh; display:flex; }
    .sidebar { width:240px; border-right:1px solid var(--border-color); padding:24px; display:flex; flex-direction:column; gap:8px; flex-shrink:0; background: #000; }
    @media (max-width: 768px) { .sidebar { width: 60px; padding: 24px 10px; } .nav-text { display:none; } .brand-text { display:none; } }
    
    .nav-item {
      display:flex; align-items:center; gap:16px; padding:12px 16px; border-radius:8px;
      cursor:pointer; color:#eee; transition:.2s; font-weight:500;
    }
    .nav-item:hover { background:var(--bg-hover); }
    .nav-item i { font-size:20px; width:24px; text-align:center; }

    .main-shell { flex:1; display:flex; flex-direction:column; min-width:0; position:relative; }
    .content-area { flex:1; overflow-y:auto; padding:0; scroll-behavior: smooth; }

    /* FEEDS & POSTS */
    .feed-wrapper { max-width:600px; margin:0 auto; width:100%; padding-bottom: 80px; }
    
    .post-card {
      border-bottom:1px solid var(--border-color); padding:20px; background: #000;
    }
    .post-header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px; }
    .user-info { display:flex; align-items:center; gap:12px; cursor:pointer; }
    .avatar-sm { width:42px; height:42px; border-radius:50%; object-fit:cover; background:#222; }
    
    .post-image-container {
      width:100%; border-radius:12px; overflow:hidden; border:1px solid #222; margin-top:12px;
      background:#050505; cursor:pointer;
    }
    .post-image-container img { width:100%; display:block; object-fit:cover; max-height:600px; }
    
    .actions-bar { display:flex; gap:20px; margin-top:14px; }
    .action-btn { display:flex; align-items:center; gap:6px; color:#fff; cursor:pointer; transition:.2s; }
    .action-btn:hover { color:#aaa; }
    .action-btn.liked i { color:#ef4444; font-weight:900; }

    /* PROFILE */
    .profile-hero { padding:40px 20px; text-align:center; border-bottom:1px solid var(--border-color); }
    .avatar-xl { width:100px; height:100px; border-radius:50%; object-fit:cover; margin:0 auto 16px; border:4px solid #111; cursor:pointer; }
    
    .stats-container { display:flex; justify-content:center; gap:40px; margin:20px 0; }
    .stat-box { text-align:center; cursor:pointer; transition:.2s; }
    .stat-box:hover .stat-num { color: #fff; text-decoration: underline; }
    .stat-num { font-size:18px; font-weight:700; color:#fff; display:block; }
    .stat-label { font-size:13px; color:var(--text-muted); }

    .btn-edit {
      border:1px solid #333; background:transparent; color:#fff; padding:8px 20px;
      border-radius:8px; font-weight:600; font-size:13px; cursor:pointer; transition:.2s; margin-top:10px;
    }
    .btn-edit:hover { background:#fff; color:#000; }

    /* SEARCH RESULTS & LISTS */
    .user-row {
      display:flex; align-items:center; gap:12px; padding:12px 16px;
      border-bottom:1px solid #1a1a1a; cursor:pointer; transition:.2s;
    }
    .user-row:hover { background:#111; }

    /* MODALS */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,0.85); backdrop-filter:blur(8px);
      z-index:200; display:flex; align-items:center; justify-content:center; opacity:0; pointer-events:none; transition:.3s;
    }
    .modal-backdrop.open { opacity:1; pointer-events:auto; }
    
    .modal-content {
      background:#111; border:1px solid #262626; border-radius:16px;
      max-width:900px; width:95%; max-height:90vh; display:flex; overflow:hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }
    
    /* Post Detail Specific */
    .detail-img-box { flex:1.5; background:#000; display:flex; align-items:center; justify-content:center; border-right:1px solid #262626; }
    .detail-img-box img { max-width:100%; max-height:90vh; object-fit:contain; }
    .detail-info-box { flex:1; display:flex; flex-direction:column; background:#0a0a0a; min-width:320px; }
    
    .comment-list { flex:1; overflow-y:auto; padding:16px; }
    .comment-item { display:flex; gap:10px; margin-bottom:16px; font-size:13px; }
    .comment-avatar { width:32px; height:32px; border-radius:50%; object-fit:cover; flex-shrink:0; cursor:pointer; }
    .comment-bubble { flex:1; }
    .comment-author { font-weight:700; margin-right:6px; cursor:pointer; }
    .comment-author:hover { text-decoration:underline; }

    /* List Modal (Followers/Following) */
    .list-modal-box { width:400px; max-width:95%; display:flex; flex-direction:column; background:#111; border-radius:16px; height:60vh; border:1px solid #333; overflow:hidden; }
    .list-header { padding:16px; border-bottom:1px solid #262626; display:flex; justify-content:space-between; align-items:center; font-weight:600; }

  </style>
</head>

<body>

<div id="auth-container" class="auth-wrapper">
  <div class="auth-visual">
    <img src="https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=1500" class="active">
    <img src="https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=1500">
  </div>
  <div class="auth-form">
    <div class="brand-title">Hawenishland</div>
    <div id="msg-box" style="padding:10px; margin-bottom:10px; font-size:12px; border-radius:4px; display:none;"></div>

    <div id="login-form">
      <input type="email" id="l-email" class="input-field" placeholder="Email">
      <input type="password" id="l-pass" class="input-field" placeholder="Password">
      <button onclick="faiLogin()" class="btn-primary">Accedi</button>
      <div class="text-center mt-6 text-sm text-gray-500 cursor-pointer hover:text-white" onclick="vaiA('signup')">Non hai un account? <b>Registrati</b></div>
    </div>

    <div id="signup-form" class="hidden">
      <input type="text" id="r-username" class="input-field" placeholder="Username">
      <div class="flex gap-2">
        <input type="text" id="r-nome" class="input-field" placeholder="Nome">
        <input type="text" id="r-cognome" class="input-field" placeholder="Cognome">
      </div>
      <input type="date" id="r-nascita" class="input-field" style="color-scheme:dark">
      <input type="email" id="r-email" class="input-field" placeholder="Email">
      <input type="password" id="r-pass" class="input-field" placeholder="Password">
      <button id="btn-reg" onclick="faiRegistrazione()" class="btn-primary">Crea Account</button>
      <div class="text-center mt-6 text-sm text-gray-500 cursor-pointer hover:text-white" onclick="vaiA('login')">Torna al Login</div>
    </div>
  </div>
</div>

<div id="app-interface" style="display:none;"> <nav class="sidebar">
    <h2 class="brand-text text-xl font-bold mb-6 px-4 hidden md:block" style="font-family:'Inter'; letter-spacing:-1px;">Hawenishland</h2>
    <div class="nav-item" onclick="switchView('feed')"><i class="fa-solid fa-house"></i><span class="nav-text">Home</span></div>
    <div class="nav-item" onclick="openSearch()"><i class="fa-solid fa-magnifying-glass"></i><span class="nav-text">Cerca</span></div>
    <div class="nav-item" onclick="openUploadModal()"><i class="fa-regular fa-square-plus"></i><span class="nav-text">Crea</span></div>
    <div class="nav-item" onclick="switchView('dashboard')"><i class="fa-regular fa-user"></i><span class="nav-text">Profilo</span></div>
    <div class="nav-item mt-auto text-red-500 hover:bg-red-900/20" onclick="logout()"><i class="fa-solid fa-right-from-bracket"></i><span class="nav-text">Esci</span></div>
  </nav>

  <main class="main-shell">
    <div class="content-area" id="main-scroll">
      
      <div id="view-feed" class="view-section feed-wrapper pt-8">
        <h1 class="text-xl font-bold px-5 mb-6">Home</h1>
        <div id="posts-feed"></div>
      </div>

      <div id="view-dashboard" class="view-section feed-wrapper hidden pt-8">
        <div class="profile-hero">
          <div class="relative inline-block">
             <img id="dash-avatar" src="" class="avatar-xl" onclick="document.getElementById('avatar-upload').click()">
             <div class="absolute bottom-0 right-0 bg-white text-black w-8 h-8 rounded-full flex items-center justify-center cursor-pointer pointer-events-none border-2 border-black"><i class="fa-solid fa-camera text-xs"></i></div>
          </div>
          <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar()">
          
          <h2 id="dash-username" class="text-xl font-bold mt-2">@username</h2>
          <p id="dash-fullname" class="text-sm text-gray-400">Nome Cognome</p>

          <div class="stats-container">
            <div class="stat-box" onclick="openFollowList(currentUser.id, 'followers')">
              <span class="stat-num" id="my-followers-count">0</span>
              <span class="stat-label">Follower</span>
            </div>
            <div class="stat-box" onclick="openFollowList(currentUser.id, 'following')">
              <span class="stat-num" id="my-following-count">0</span>
              <span class="stat-label">Seguiti</span>
            </div>
          </div>

          <button class="btn-edit" onclick="toggleEdit()">Modifica Profilo</button>

          <div id="edit-panel" class="hidden mt-6 bg-neutral-900 p-4 rounded-lg text-left max-w-sm mx-auto">
             <label class="text-xs text-gray-500 uppercase block mb-1">Nome Pubblico</label>
             <input id="edit-fullname" type="text" class="input-field py-2" placeholder="Nome completo">
             <label class="text-xs text-gray-500 uppercase block mb-1">Username</label>
             <input id="edit-username" type="text" class="input-field py-2" placeholder="username">
             <button class="btn-primary py-2 mt-2" onclick="saveProfile()">Salva</button>
          </div>
        </div>
        <div class="border-t border-neutral-800 mt-4">
           <div id="my-posts-feed"></div>
        </div>
      </div>

      <div id="view-user-profile" class="view-section feed-wrapper hidden pt-8">
        <div class="profile-hero">
           <img id="pub-avatar" src="" class="avatar-xl" style="cursor:default; border-color:#333;">
           <h2 id="pub-username" class="text-xl font-bold mt-2">@username</h2>
           <p id="pub-fullname" class="text-sm text-gray-400">Nome Cognome</p>

           <div class="stats-container">
            <div class="stat-box" onclick="openFollowList(viewingUserId, 'followers')">
              <span class="stat-num" id="pub-followers-count">0</span>
              <span class="stat-label">Follower</span>
            </div>
            <div class="stat-box" onclick="openFollowList(viewingUserId, 'following')">
              <span class="stat-num" id="pub-following-count">0</span>
              <span class="stat-label">Seguiti</span>
            </div>
          </div>

           <button id="btn-follow" class="btn-primary max-w-[120px] mx-auto py-2 text-xs uppercase" onclick="toggleFollow()">Segui</button>
        </div>
        <div class="border-t border-neutral-800 mt-4">
           <div id="pub-posts-feed"></div>
        </div>
      </div>

    </div>
  </main>
</div>

<div id="upload-modal" class="modal-backdrop">
  <div class="bg-neutral-900 p-6 rounded-xl w-full max-w-md border border-neutral-800 relative">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-bold text-lg">Nuovo Post</h3>
      <button onclick="closeModal('upload-modal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
    </div>
    
    <div class="flex gap-3 mb-4">
      <img id="upload-avatar-preview" src="" class="w-10 h-10 rounded-full bg-gray-800 object-cover">
      <textarea id="post-caption" class="w-full bg-transparent text-white outline-none resize-none pt-2" rows="3" placeholder="A cosa stai pensando?"></textarea>
    </div>

    <div class="mb-4">
      <label class="block w-full h-32 border border-dashed border-gray-700 rounded-lg flex items-center justify-center cursor-pointer hover:bg-neutral-800 transition">
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewImage(this)">
        <div class="text-center text-gray-500" id="upload-placeholder">
           <i class="fa-regular fa-image text-2xl mb-2"></i><br>Aggiungi foto
        </div>
        <img id="image-preview" class="h-full object-contain hidden">
      </label>
    </div>
    <button onclick="submitPost()" class="btn-primary">Pubblica</button>
  </div>
</div>

<div id="post-detail-modal" class="modal-backdrop">
  <div class="modal-content">
    <div class="detail-img-box">
      <img id="detail-img" src="">
      <div id="detail-noimg" class="hidden text-gray-500">Solo testo</div>
    </div>
    <div class="detail-info-box">
      <div class="p-4 border-b border-neutral-800 flex items-center gap-3">
        <button onclick="closeModal('post-detail-modal')" class="md:hidden text-white mr-2"><i class="fa-solid fa-arrow-left"></i></button>
        <img id="detail-avatar" class="w-8 h-8 rounded-full cursor-pointer object-cover" onclick="goToProfileFromDetail()">
        <span id="detail-username" class="font-bold text-sm cursor-pointer hover:underline" onclick="goToProfileFromDetail()">User</span>
        <button onclick="closeModal('post-detail-modal')" class="ml-auto text-gray-400 hover:text-white hidden md:block"><i class="fa-solid fa-xmark text-xl"></i></button>
      </div>

      <div class="p-4 border-b border-neutral-800 text-sm">
         <span id="detail-caption-user" class="font-bold mr-2"></span>
         <span id="detail-caption" class="text-gray-300"></span>
      </div>
      
      <div class="comment-list" id="detail-comments"></div>

      <div class="p-4 border-t border-neutral-800 mt-auto bg-black">
         <div class="flex items-center gap-2">
           <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="bg-neutral-900 border-none rounded-full px-4 py-2 w-full text-sm text-white focus:ring-1 focus:ring-white outline-none">
           <button onclick="inviaCommento()" class="text-white font-bold text-sm p-2">Invia</button>
         </div>
      </div>
    </div>
  </div>
</div>

<div id="search-modal" class="modal-backdrop">
  <div class="bg-neutral-900 w-full max-w-md rounded-xl border border-neutral-800 overflow-hidden flex flex-col max-h-[70vh]">
    <div class="p-4 border-b border-neutral-800 flex gap-2">
      <input type="text" id="search-query" class="bg-black border border-neutral-700 rounded-lg px-4 py-2 w-full text-white outline-none focus:border-white" placeholder="Cerca persone..." onkeyup="performSearch()">
      <button onclick="closeModal('search-modal')" class="text-gray-400 px-2">Chiudi</button>
    </div>
    <div id="search-results" class="overflow-y-auto flex-1"></div>
  </div>
</div>

<div id="list-modal" class="modal-backdrop">
  <div class="list-modal-box">
     <div class="list-header">
        <span id="list-title">Lista</span>
        <button onclick="closeModal('list-modal')"><i class="fa-solid fa-xmark"></i></button>
     </div>
     <div id="list-content" class="overflow-y-auto flex-1 p-2">
        </div>
  </div>
</div>

<script>
  // --- CONFIGURAZIONE ---
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);

  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';

  let currentUser = null;
  let currentPostId = null;
  let viewingUserId = null; // L'utente che stiamo visualizzando

  // --- INIT ---
  window.addEventListener('load', async () => {
    const { data: { session } } = await sb.auth.getSession();
    if (session) enterApp(session.user);

    // Animazione sfondo login
    let i = 0; const imgs = document.querySelectorAll('.auth-visual img');
    if(imgs.length) setInterval(()=>{ imgs[i].classList.remove('active'); i=(i+1)%imgs.length; imgs[i].classList.add('active'); }, 5000);
  });

  // --- NAVIGAZIONE & UI ---
  function mess(t, e=false){ const b=document.getElementById('msg-box'); b.innerText=t; b.style.display='block'; b.style.background=e?'#ef4444':'#22c55e'; }
  function vaiA(m) { document.getElementById('login-form').classList.toggle('hidden',m==='signup'); document.getElementById('signup-form').classList.toggle('hidden',m==='login'); }
  
  function closeModal(id) { 
    document.getElementById(id).classList.remove('open');
    setTimeout(()=>document.getElementById(id).classList.add('hidden'), 300); // Wait for transition
  }
  function openModal(id) {
    document.getElementById(id).classList.remove('hidden');
    // Force reflow
    void document.getElementById(id).offsetWidth; 
    document.getElementById(id).classList.add('open');
  }

  function openSearch(){ openModal('search-modal'); document.getElementById('search-query').focus(); }
  
  async function openUploadModal(){ 
    openModal('upload-modal'); 
    // Set avatar preview
    const {data} = await sb.from('profiles').select('avatar_url').eq('id', currentUser.id).single();
    document.getElementById('upload-avatar-preview').src = data?.avatar_url || 'https://via.placeholder.com/50';
  }

  function switchView(name) {
    ['view-feed','view-dashboard','view-user-profile'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById(`view-${name}`).classList.remove('hidden');
    document.getElementById('main-scroll').scrollTop = 0;

    if(name === 'feed') loadFeedFollowed('posts-feed');
    if(name === 'dashboard') loadMyProfile();
  }

  function toggleEdit() { document.getElementById('edit-panel').classList.toggle('hidden'); }
  function escapeHtml(str){ return (str||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  
  // --- AUTH LOGIC ---
  async function faiRegistrazione() {
    const u=document.getElementById('r-username').value.trim();
    const e=document.getElementById('r-email').value.trim();
    const p=document.getElementById('r-pass').value;
    const n=document.getElementById('r-nome').value.trim();
    const c=document.getElementById('r-cognome').value.trim();
    const d=document.getElementById('r-nascita').value;
    
    if(!u||!e||!p||!n||!c||!d) return mess("Compila tutto.",true);
    
    document.getElementById('btn-reg').innerText = "Attendi...";
    try {
      const { data, error } = await sb.auth.signUp({ email:e, password:p, options:{ data:{ first_name:n, last_name:c, birthday:d } }});
      if(error) throw error;
      if(data.user) {
        await sb.from('profiles').upsert([{ id:data.user.id, username:u.toLowerCase(), full_name:`${n} ${c}`, avatar_url:null }], {onConflict:'id'});
      }
      mess("Registrato! Controlla email."); setTimeout(()=>vaiA('login'),2000);
    } catch(err){ mess(err.message,true); } 
    document.getElementById('btn-reg').innerText = "Crea Account";
  }

  async function faiLogin() {
    const e=document.getElementById('l-email').value.trim();
    const p=document.getElementById('l-pass').value;
    const {data, error} = await sb.auth.signInWithPassword({email:e, password:p});
    if(error) return mess(error.message,true);
    enterApp(data.user);
  }

  async function logout() { await sb.auth.signOut(); location.reload(); }

  function enterApp(user) {
    currentUser = user;
    document.getElementById('auth-container').style.transform = "translateY(-100%)"; // Slide up animation
    document.getElementById('app-interface').style.display = 'flex';
    switchView('feed');
  }

  // --- PROFILI & USER DATA ---
  async function loadMyProfile() {
    const { data: prof } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
    if(prof) {
      document.getElementById('dash-username').innerText = '@'+prof.username;
      document.getElementById('dash-fullname').innerText = prof.full_name;
      document.getElementById('dash-avatar').src = prof.avatar_url || 'https://via.placeholder.com/150';
      
      document.getElementById('edit-username').value = prof.username;
      document.getElementById('edit-fullname').value = prof.full_name;
    }
    updateStats(currentUser.id, 'my-followers-count', 'my-following-count');
    loadUserPosts(currentUser.id, 'my-posts-feed');
  }

  async function saveProfile() {
    const u = document.getElementById('edit-username').value.trim().toLowerCase();
    const f = document.getElementById('edit-fullname').value.trim();
    if(!u) return alert("Username obbligatorio");
    await sb.from('profiles').update({username:u, full_name:f}).eq('id', currentUser.id);
    toggleEdit(); loadMyProfile();
  }

  async function uploadAvatar() {
    const file = document.getElementById('avatar-upload').files[0];
    if(!file) return;
    const path = `${currentUser.id}/${Date.now()}_avatar`;
    await sb.storage.from(BUCKET_AVATARS).upload(path, file);
    const { data } = sb.storage.from(BUCKET_AVATARS).getPublicUrl(path);
    await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
    loadMyProfile();
  }

  // --- PUBLIC PROFILE LOGIC ---
  async function openUserProfile(userId) {
    // Chiudi modali aperte
    closeModal('search-modal');
    closeModal('post-detail-modal');
    closeModal('list-modal');

    if(userId === currentUser.id) return switchView('dashboard');
    viewingUserId = userId;
    switchView('user-profile');

    const { data: prof } = await sb.from('profiles').select('*').eq('id', userId).single();
    if(!prof) return;

    document.getElementById('pub-username').innerText = '@'+prof.username;
    document.getElementById('pub-fullname').innerText = prof.full_name;
    document.getElementById('pub-avatar').src = prof.avatar_url || 'https://via.placeholder.com/150';

    updateStats(userId, 'pub-followers-count', 'pub-following-count');
    loadUserPosts(userId, 'pub-posts-feed');

    // Check Follow Status
    const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
    const btn = document.getElementById('btn-follow');
    if(data.length) { btn.innerText = "Non seguire"; btn.style.background = "#333"; btn.style.color = "#fff"; } 
    else { btn.innerText = "Segui"; btn.style.background = "#fff"; btn.style.color = "#000"; }
  }

  async function toggleFollow() {
    const btn = document.getElementById('btn-follow');
    const isFollowing = btn.innerText === "Non seguire";
    if(isFollowing) {
      await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', viewingUserId);
      btn.innerText = "Segui"; btn.style.background = "#fff"; btn.style.color = "#000";
    } else {
      await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: viewingUserId }]);
      btn.innerText = "Non seguire"; btn.style.background = "#333"; btn.style.color = "#fff";
    }
    updateStats(viewingUserId, 'pub-followers-count', 'pub-following-count');
  }

  async function updateStats(uid, elFollowers, elFollowing) {
    const r1 = await sb.from('follows').select('*', {count:'exact', head:true}).eq('followed_id', uid);
    const r2 = await sb.from('follows').select('*', {count:'exact', head:true}).eq('follower_id', uid);
    document.getElementById(elFollowers).innerText = r1.count || 0;
    document.getElementById(elFollowing).innerText = r2.count || 0;
  }

  // --- LISTE FOLLOWERS / FOLLOWING ---
  async function openFollowList(userId, type) {
    // type = 'followers' o 'following'
    openModal('list-modal');
    const title = type === 'followers' ? 'Followers' : 'Persone Seguite';
    document.getElementById('list-title').innerText = title;
    const container = document.getElementById('list-content');
    container.innerHTML = '<div class="p-4 text-center text-gray-500">Caricamento...</div>';

    let ids = [];
    if(type === 'followers') {
        const { data } = await sb.from('follows').select('follower_id').eq('followed_id', userId);
        ids = data.map(x => x.follower_id);
    } else {
        const { data } = await sb.from('follows').select('followed_id').eq('follower_id', userId);
        ids = data.map(x => x.followed_id);
    }

    if(ids.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-500">Nessun utente trovato.</div>';
        return;
    }

    const { data: profiles } = await sb.from('profiles').select('id, username, full_name, avatar_url').in('id', ids);
    
    container.innerHTML = '';
    profiles.forEach(p => {
        const html = `
        <div class="user-row" onclick="openUserProfile('${p.id}')">
            <img src="${p.avatar_url || 'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover">
            <div>
                <div class="font-bold text-sm text-white">@${p.username}</div>
                <div class="text-xs text-gray-500">${p.full_name}</div>
            </div>
        </div>`;
        container.insertAdjacentHTML('beforeend', html);
    });
  }

  // --- FEED & POSTS SYSTEM ---
  async function loadFeedFollowed(targetId) {
    const c = document.getElementById(targetId);
    c.innerHTML = '<div class="text-center p-10 text-gray-500"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
    
    // Ottieni IDs seguiti
    const { data: f } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
    const ids = [currentUser.id, ...(f||[]).map(x=>x.followed_id)];
    
    const { data: posts } = await sb.from('posts')
      .select(`id, user_id, image_url, caption, created_at, profiles:profiles!posts_user_id_fkey(username, avatar_url)`)
      .in('user_id', ids)
      .order('created_at', {ascending:false});
      
    renderPosts(c, posts || []);
  }

  async function loadUserPosts(uid, targetId) {
    const c = document.getElementById(targetId);
    c.innerHTML = '<div class="text-center p-10 text-gray-500"><i class="fa-solid fa-circle-notch fa-spin"></i></div>';
    const { data: posts } = await sb.from('posts')
      .select(`id, user_id, image_url, caption, created_at, profiles:profiles!posts_user_id_fkey(username, avatar_url)`)
      .eq('user_id', uid)
      .order('created_at', {ascending:false});
    renderPosts(c, posts || []);
  }

  function renderPosts(container, posts) {
    container.innerHTML = '';
    if(!posts.length) return container.innerHTML = '<div class="text-center p-10 text-gray-600">Nessun post qui.</div>';
    
    posts.forEach(p => {
      const u = p.profiles;
      const hasImg = !!p.image_url;
      const contentHtml = hasImg 
        ? `<div class="post-image-container" onclick="openPostDetail('${p.id}')"><img src="${p.image_url}"></div>` 
        : `<div class="text-lg p-4 font-light text-white border border-neutral-800 rounded-lg mt-3 cursor-pointer hover:bg-neutral-900" onclick="openPostDetail('${p.id}')">${escapeHtml(p.caption)}</div>`;
      
      const captionBelow = hasImg ? `<div class="mt-3 text-sm"><span class="font-bold mr-2 cursor-pointer" onclick="openUserProfile('${p.user_id}')">${u.username}</span>${escapeHtml(p.caption)}</div>` : '';

      const html = `
      <div class="post-card" id="post-${p.id}">
         <div class="post-header">
            <div class="user-info" onclick="openUserProfile('${p.user_id}')">
               <img src="${u.avatar_url||'https://via.placeholder.com/40'}" class="avatar-sm">
               <div>
                 <div class="font-bold text-sm hover:underline">@${u.username}</div>
                 <div class="text-xs text-gray-500">${new Date(p.created_at).toLocaleDateString()}</div>
               </div>
            </div>
            ${p.user_id === currentUser.id ? `<i class="fa-solid fa-trash text-gray-700 hover:text-red-500 cursor-pointer" onclick="deletePost('${p.id}')"></i>` : ''}
         </div>
         ${contentHtml}
         <div class="actions-bar">
            <div class="action-btn" onclick="toggleLike('${p.id}')" id="btn-like-${p.id}">
               <i class="fa-regular fa-heart text-xl"></i>
               <span class="text-sm font-bold" id="cnt-like-${p.id}"></span>
            </div>
            <div class="action-btn" onclick="openPostDetail('${p.id}')">
               <i class="fa-regular fa-comment text-xl"></i>
               <span class="text-sm font-bold" id="cnt-comm-${p.id}"></span>
            </div>
         </div>
         ${captionBelow}
      </div>`;
      container.insertAdjacentHTML('beforeend', html);
      refreshCounts(p.id);
    });
  }

  // --- INTERAZIONI POST ---
  async function refreshCounts(pid) {
    const l = await sb.from('likes').select('*', {count:'exact', head:true}).eq('post_id', pid);
    const c = await sb.from('comments').select('*', {count:'exact', head:true}).eq('post_id', pid);
    
    const lEl = document.getElementById(`cnt-like-${pid}`);
    const cEl = document.getElementById(`cnt-comm-${pid}`);
    if(lEl) lEl.innerText = l.count > 0 ? l.count : '';
    if(cEl) cEl.innerText = c.count > 0 ? c.count : '';

    // Check my like
    const { data } = await sb.from('likes').select('*').eq('post_id', pid).eq('user_id', currentUser.id);
    const btn = document.getElementById(`btn-like-${pid}`);
    if(btn) {
      const icon = btn.querySelector('i');
      if(data.length) { btn.classList.add('liked'); icon.classList.remove('fa-regular'); icon.classList.add('fa-solid'); }
      else { btn.classList.remove('liked'); icon.classList.remove('fa-solid'); icon.classList.add('fa-regular'); }
    }
  }

  async function toggleLike(pid) {
    const {data} = await sb.from('likes').select('*').eq('post_id', pid).eq('user_id', currentUser.id);
    if(data.length) await sb.from('likes').delete().eq('post_id', pid).eq('user_id', currentUser.id);
    else await sb.from('likes').insert([{post_id:pid, user_id:currentUser.id}]);
    refreshCounts(pid);
  }

  // --- DETTAGLI POST E COMMENTI (Con Foto Profilo) ---
  let detailPostOwnerId = null; // Store per navigazione
  
  async function openPostDetail(pid) {
    currentPostId = pid;
    openModal('post-detail-modal');
    
    const { data: p } = await sb.from('posts')
       .select(`id, user_id, image_url, caption, profiles:profiles!posts_user_id_fkey(username, avatar_url)`)
       .eq('id', pid).single();
    
    if(!p) return;
    detailPostOwnerId = p.user_id;

    const imgEl = document.getElementById('detail-img');
    const noImgEl = document.getElementById('detail-noimg');
    
    if(p.image_url) { imgEl.src = p.image_url; imgEl.classList.remove('hidden'); noImgEl.classList.add('hidden'); }
    else { imgEl.classList.add('hidden'); noImgEl.classList.remove('hidden'); }

    const u = p.profiles;
    document.getElementById('detail-avatar').src = u.avatar_url || 'https://via.placeholder.com/40';
    document.getElementById('detail-username').innerText = u.username;
    
    // Caption nel modale
    const capUser = document.getElementById('detail-caption-user');
    const capText = document.getElementById('detail-caption');
    if(p.caption) {
      capUser.innerText = u.username; capUser.onclick = () => openUserProfile(p.user_id); capUser.style.cursor='pointer';
      capText.innerText = p.caption;
      capText.parentElement.classList.remove('hidden');
    } else {
      capText.parentElement.classList.add('hidden');
    }

    loadComments();
  }

  function goToProfileFromDetail() { if(detailPostOwnerId) openUserProfile(detailPostOwnerId); }

  async function loadComments() {
    const list = document.getElementById('detail-comments');
    list.innerHTML = '<div class="text-gray-600 text-center mt-4 text-xs">Caricamento...</div>';
    
    // JOIN CON PROFILES per avere avatar e username
    const { data } = await sb.from('comments')
      .select(`id, content, created_at, user_id, profiles:profiles!comments_user_id_fkey(username, avatar_url)`)
      .eq('post_id', currentPostId)
      .order('created_at', {ascending:true});
      
    list.innerHTML = '';
    if(!data.length) return list.innerHTML = '<div class="text-gray-600 text-center mt-4 text-xs">Nessun commento ancora.</div>';

    data.forEach(c => {
       const u = c.profiles;
       const html = `
       <div class="comment-item">
          <img src="${u.avatar_url || 'https://via.placeholder.com/30'}" class="comment-avatar" onclick="openUserProfile('${c.user_id}')">
          <div class="comment-bubble">
             <span class="comment-author" onclick="openUserProfile('${c.user_id}')">${u.username}</span>
             <span class="text-gray-300">${escapeHtml(c.content)}</span>
          </div>
       </div>`;
       list.insertAdjacentHTML('beforeend', html);
    });
  }

  async function inviaCommento() {
    const t = document.getElementById('new-comment').value.trim();
    if(!t) return;
    await sb.from('comments').insert([{post_id:currentPostId, user_id:currentUser.id, content:t}]);
    document.getElementById('new-comment').value = '';
    loadComments();
    refreshCounts(currentPostId);
  }

  // --- UPLOAD ---
  function previewImage(input) {
    if(input.files && input.files[0]) {
       const reader = new FileReader();
       reader.onload = function(e) {
          document.getElementById('image-preview').src = e.target.result;
          document.getElementById('image-preview').classList.remove('hidden');
          document.getElementById('upload-placeholder').classList.add('hidden');
       }
       reader.readAsDataURL(input.files[0]);
    }
  }

  async function submitPost() {
     const f = document.getElementById('post-file').files[0];
     const c = document.getElementById('post-caption').value.trim();
     if(!f && !c) return alert("Aggiungi qualcosa!");

     let url = null;
     if(f) {
        const path = `${currentUser.id}/post_${Date.now()}`;
        await sb.storage.from(BUCKET_POSTS).upload(path, f);
        url = sb.storage.from(BUCKET_POSTS).getPublicUrl(path).data.publicUrl;
     }
     await sb.from('posts').insert([{user_id:currentUser.id, image_url:url, caption:c}]);
     closeModal('upload-modal');
     document.getElementById('post-caption').value='';
     document.getElementById('post-file').value='';
     document.getElementById('image-preview').classList.add('hidden');
     document.getElementById('upload-placeholder').classList.remove('hidden');
     switchView('feed');
  }

  async function deletePost(id) {
    if(confirm("Eliminare?")) {
        await sb.from('posts').delete().eq('id', id);
        document.getElementById(`post-${id}`).remove();
    }
  }

  // --- RICERCA ---
  async function performSearch() {
     const q = document.getElementById('search-query').value.trim();
     const res = document.getElementById('search-results');
     if(q.length < 2) return res.innerHTML='';
     
     const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
     res.innerHTML = '';
     data.forEach(u => {
        const html = `
        <div class="user-row" onclick="openUserProfile('${u.id}')">
           <img src="${u.avatar_url||'https://via.placeholder.com/40'}" class="w-10 h-10 rounded-full object-cover">
           <div><div class="font-bold">@${u.username}</div><div class="text-xs text-gray-500">${u.full_name}</div></div>
        </div>`;
        res.insertAdjacentHTML('beforeend', html);
     });
  }

</script>
</body>
</html>
