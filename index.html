<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HAWENISHLAND — Premium Social</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

  <style>
    /* --- RESET & VARIABLES --- */
    :root {
      --bg-body: #0b0c0e;       /* Nero profondo ma non assoluto */
      --bg-card: #151619;       /* Grigio scuro per le card */
      --bg-sidebar: #0f1012;    /* Sidebar */
      --border-subtle: rgba(255, 255, 255, 0.08);
      --text-main: #f3f4f6;
      --text-muted: #9ca3af;
      --accent: #ffffff;
      --accent-hover: #e5e5e5;
      --shadow-card: 0 4px 20px rgba(0,0,0,0.5);
    }

    body { 
      background-color: var(--bg-body); 
      color: var(--text-main); 
      font-family: 'Plus Jakarta Sans', sans-serif; /* Font più moderno e geometrico */
      margin: 0; 
      overflow-x: hidden; 
    }

    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--bg-body); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    .hidden { display: none !important; }

    /* --- PULSANTI & UI ELEMENTS --- */
    .btn-primary {
      background: linear-gradient(135deg, #ffffff 0%, #d4d4d4 100%);
      color: #000;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      border: none;
      box-shadow: 0 4px 12px rgba(255,255,255,0.15);
    }
    .btn-primary:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 6px 15px rgba(255,255,255,0.25); 
    }
    
    .btn-secondary {
      background: rgba(255,255,255,0.05);
      color: #fff;
      padding: 10px 20px;
      border-radius: 12px;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border-subtle);
      text-align: center;
    }
    .btn-secondary:hover { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); }

    /* --- LAYOUT APP --- */
    .app-wrapper { display: flex; min-height: 100vh; max-width: 1440px; margin: 0 auto; }
    
    /* SIDEBAR (Stile Glassy) */
    .sidebar { 
      width: 260px; 
      height: 100vh; 
      position: sticky; 
      top: 0; 
      border-right: 1px solid var(--border-subtle); 
      padding: 30px 20px;
      display: flex; 
      flex-direction: column; 
      background: var(--bg-sidebar); 
      z-index: 50;
    }
    .brand-logo { 
      font-family: 'Inter', sans-serif; 
      font-style: italic;
      font-weight: 800; 
      font-size: 26px; 
      margin-bottom: 40px; 
      padding-left: 10px; 
      letter-spacing: -0.5px;
      background: linear-gradient(to right, #fff, #888);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      cursor: pointer;
    }
    .nav-link {
      display: flex; align-items: center; gap: 16px; padding: 14px 16px;
      border-radius: 12px; cursor: pointer; transition: 0.2s;
      font-size: 15px; color: var(--text-muted); margin-bottom: 6px;
      font-weight: 500;
    }
    .nav-link:hover, .nav-link.active { 
      background-color: rgba(255,255,255,0.06); 
      color: #fff; 
      transform: translateX(4px);
    }
    .nav-link i { font-size: 20px; width: 24px; text-align: center; }

    /* FEED & CARDS */
    .main-feed { flex: 1; max-width: 680px; margin: 0 auto; padding: 40px 20px; width: 100%; }
    
    .post-card { 
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 20px; /* Arrotondamento moderno */
      padding: 20px; 
      margin-bottom: 30px; 
      box-shadow: var(--shadow-card);
    }
    
    .post-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .user-info { display: flex; align-items: center; gap: 12px; cursor: pointer; }
    .avatar-sm { 
      width: 40px; height: 40px; 
      border-radius: 50%; object-fit: cover; 
      border: 2px solid rgba(255,255,255,0.1); 
      transition: transform 0.2s;
    }
    .avatar-sm:hover { transform: scale(1.05); border-color: #fff; }
    
    .username-bold { font-weight: 600; font-size: 15px; color: var(--text-main); }
    
    .post-image { 
      width: 100%; 
      border-radius: 12px; 
      border: 1px solid var(--border-subtle); 
      object-fit: cover; cursor: pointer; aspect-ratio: 1/1;
      background: #000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .post-actions { display: flex; gap: 20px; margin-top: 16px; font-size: 24px; padding: 0 4px; }
    .action-btn { cursor: pointer; transition: 0.2s; color: var(--text-main); opacity: 0.8; }
    .action-btn:hover { opacity: 1; transform: scale(1.1); }
    .like-active { color: #ff3040 !important; opacity: 1; animation: pop 0.2s ease-in-out; }
    
    .post-stats { font-weight: 600; font-size: 14px; margin-top: 12px; padding: 0 4px; color: var(--text-main); }
    .post-caption { margin-top: 8px; padding: 0 4px; font-size: 14px; line-height: 1.5; color: #d1d5db; }
    .caption-user { font-weight: 700; margin-right: 6px; color: #fff; cursor: pointer; }
    .view-comments { color: var(--text-muted); font-size: 13px; margin-top: 8px; padding: 0 4px; cursor: pointer; }

    /* PROFILE PAGE */
    .profile-header { 
      padding: 40px; 
      background: linear-gradient(to bottom, #1a1b1e, #0f1012);
      border-radius: 24px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 30px;
      display: flex; gap: 40px; align-items: center; 
    }
    .profile-avatar-lg { 
      width: 140px; height: 140px; 
      border-radius: 50%; object-fit: cover; 
      border: 4px solid #1a1b1e; 
      box-shadow: 0 0 0 2px var(--border-subtle);
      cursor: pointer; 
      transition: transform 0.3s;
    }
    .profile-avatar-lg:hover { transform: scale(1.02); }
    
    .profile-info { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .profile-top { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .profile-username { font-size: 24px; font-weight: 300; letter-spacing: -0.5px; }
    
    .profile-stats { display: flex; gap: 30px; font-size: 15px; color: #d1d5db; }
    .stat-value { font-weight: 700; color: #fff; }
    
    .posts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 20px; }
    .grid-item { position: relative; aspect-ratio: 1/1; cursor: pointer; border-radius: 8px; overflow: hidden; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s; }
    .grid-item:hover img { transform: scale(1.05); }
    .grid-overlay { 
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; 
      opacity: 0; transition: 0.2s; gap: 15px; color: #fff; font-weight: bold; backdrop-filter: blur(2px);
    }
    .grid-item:hover .grid-overlay { opacity: 1; }

    /* MODALS */
    .modal-overlay { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.75); z-index: 100; 
      display: flex; justify-content: center; align-items: center; 
      backdrop-filter: blur(8px); /* Effetto sfocato sfondo */
    }
    
    /* Post Detail Modal */
    .post-modal-layout { 
      display: flex; width: 90vw; max-width: 1100px; height: 85vh; 
      background: #1a1b1e; 
      border: 1px solid var(--border-subtle); 
      border-radius: 16px; 
      overflow: hidden;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
    }
    .pm-image-side { flex: 1.5; background: #000; display: flex; align-items: center; justify-content: center; border-right: 1px solid var(--border-subtle); }
    .pm-image-side img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .pm-info-side { flex: 1; display: flex; flex-direction: column; min-width: 350px; background: #1a1b1e; }
    .pm-header { padding: 20px; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; justify-content: space-between; }
    .pm-comments-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
    .comment-row { display: flex; gap: 12px; font-size: 14px; color: #e5e5e5; }
    .comment-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; cursor: pointer; }
    .pm-footer { padding: 20px; border-top: 1px solid var(--border-subtle); background: #151619; }

    /* AUTH SCREEN (MANTENUTO INTATTO COME RICHIESTO) */
    .auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 200; background: #000; display: flex; transition: transform 0.8s ease-in-out; }
    .visual-side { flex:1; position:relative; overflow:hidden; display:none; background:#000 }
    @media (min-width:768px){ .visual-side{display:block} }
    .visual-side img{
      position:absolute; top:0; left:0; width:100%; height:100%;
      object-fit:cover; filter:grayscale(100%); opacity:0;
      transition:opacity 1.5s ease, filter .8s ease; z-index:0;
      pointer-events:none;
    }
    .visual-side img.active{ opacity:1; z-index:1; pointer-events:auto; }
    .visual-side img.active:hover{ filter:grayscale(0%); cursor:crosshair; }

    .auth-form-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; padding: 40px; }
    .auth-box { width: 100%; max-width: 350px; display: flex; flex-direction: column; gap: 15px; }
    .input-field { 
      background: #18181b; 
      border: 1px solid #27272a; 
      padding: 12px; 
      border-radius: 8px; 
      color: #fff; width: 100%; font-size: 14px; 
      transition: border-color 0.2s;
    }
    .input-field:focus { border-color: #555; outline: none; background: #202023; }

    /* Common Modal & Lists */
    .user-list-modal { width: 400px; max-width: 90vw; background: #1a1b1e; border-radius: 16px; overflow: hidden; border: 1px solid var(--border-subtle); max-height: 500px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    .ul-header { padding: 16px; text-align: center; border-bottom: 1px solid var(--border-subtle); font-weight: 600; position: relative; background: rgba(255,255,255,0.02); }
    .ul-close { position: absolute; right: 16px; top: 16px; cursor: pointer; color: var(--text-muted); }
    .ul-body { overflow-y: auto; flex: 1; }
    .user-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; transition: background 0.2s; }
    .user-row:hover { background: rgba(255,255,255,0.05); }

    @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.2)} 100%{transform:scale(1)} }
    @media (max-width: 768px) {
      .sidebar { width: 70px; padding: 10px; align-items: center; }
      .nav-link { padding: 10px; justify-content: center; }
      .nav-link span, .brand-logo { display: none; }
      .nav-link i { font-size: 24px; margin: 0; }
      .post-modal-layout { flex-direction: column; width: 100%; height: 100%; border: none; border-radius: 0; }
      .pm-image-side { flex: 1; background: #000; }
      .pm-info-side { flex: 1; }
      .app-wrapper { justify-content: center; }
      .main-feed { padding: 20px 10px; }
    }
  </style>
</head>
<body>

<div id="auth-container" class="auth-container">
  <div class="visual-side">
    <img src="https://images.unsplash.com/photo-1617137984095-74e4e5e3613f?q=80&w=1200" class="active">
    <img src="https://images.unsplash.com/photo-1509631179647-0177331693ae?q=80&w=1200">
  </div>
  <div class="auth-form-wrapper">
    <div class="auth-box">
      <h1 class="text-3xl font-bold mb-6 text-center italic">Hawenishland</h1>
      <div id="msg-box" class="hidden text-xs text-center p-2 mb-2 border rounded"></div>

      <div id="login-form">
        <input type="email" id="l-email" placeholder="Email" class="input-field mb-2">
        <input type="password" id="l-pass" placeholder="Password" class="input-field mb-4">
        <button onclick="faiLogin()" class="btn-primary w-full">Accedi</button>
        <div class="mt-6 text-center text-xs text-gray-500">
          <p class="cursor-pointer hover:text-white mb-2" onclick="recuperoPassword()">Password dimenticata?</p>
          <p class="cursor-pointer hover:text-white" onclick="vaiA('signup')">Non hai un account? <span class="font-bold text-blue-400">Iscriviti</span></p>
        </div>
      </div>

      <div id="signup-form" class="hidden">
        <input type="text" id="r-username" placeholder="Username" class="input-field mb-2">
        <div class="flex gap-2 mb-2">
          <input type="text" id="r-nome" placeholder="Nome" class="input-field">
          <input type="text" id="r-cognome" placeholder="Cognome" class="input-field">
        </div>
        <input type="date" id="r-nascita" class="input-field mb-2" style="color-scheme: dark;">
        <input type="email" id="r-email" placeholder="Email" class="input-field mb-2">
        <input type="password" id="r-pass" placeholder="Password" class="input-field mb-4">
        <button id="btn-reg" onclick="faiRegistrazione()" class="btn-primary w-full">Iscriviti</button>
        <p class="mt-4 text-center text-xs cursor-pointer hover:text-white" onclick="vaiA('login')">Hai già un account? <span class="font-bold text-blue-400">Accedi</span></p>
      </div>
    </div>
  </div>
</div>

<div id="app-interface" class="hidden">
  <div class="app-wrapper">
    
    <nav class="sidebar">
      <div class="brand-logo" onclick="goHome()">Hawenishland</div>
      <div class="nav-link" onclick="goHome()">
        <i class="fa-solid fa-house"></i> <span>Home</span>
      </div>
      <div class="nav-link" onclick="openSearchModal()">
        <i class="fa-solid fa-magnifying-glass"></i> <span>Cerca</span>
      </div>
      <div class="nav-link" onclick="openUploadModal()">
        <i class="fa-regular fa-square-plus"></i> <span>Crea</span>
      </div>
      <div class="nav-link" onclick="goToMyProfile()">
        <i class="fa-regular fa-user"></i> <span>Profilo</span>
      </div>
      <div class="mt-auto nav-link text-red-500 hover:bg-red-900/10" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i> <span>Esci</span>
      </div>
    </nav>

    <main class="main-feed" id="main-content-area"></main>
  </div>
</div>

<div id="upload-modal" class="modal-overlay hidden">
  <div class="bg-[#1a1b1e] rounded-2xl p-6 w-[400px] border border-[#333] shadow-2xl">
    <div class="text-center font-bold border-b border-[#333] pb-4 mb-4 relative text-lg">
      Crea nuovo post
      <i class="fa-solid fa-xmark absolute right-0 top-0 cursor-pointer text-gray-400 hover:text-white" onclick="closeModal('upload-modal')"></i>
    </div>
    <div class="flex flex-col gap-4">
      <label class="flex flex-col items-center justify-center h-52 border-2 border-dashed border-[#444] rounded-xl cursor-pointer hover:bg-[#222] transition">
        <i class="fa-solid fa-image text-3xl mb-3 text-gray-400"></i>
        <span class="text-sm text-gray-400 font-medium">Trascina foto o clicca qui</span>
        <input type="file" id="post-file" accept="image/*" class="hidden" onchange="previewUpload(this)">
      </label>
      <img id="upload-preview" class="hidden w-full h-52 object-cover rounded-xl border border-[#333]">
      <textarea id="post-caption" rows="2" placeholder="Scrivi una didascalia..." class="input-field resize-none"></textarea>
      <button onclick="submitPost()" class="btn-primary w-full py-3">Condividi</button>
    </div>
  </div>
</div>

<div id="search-modal" class="modal-overlay hidden">
  <div class="user-list-modal">
    <div class="ul-header">Cerca <i class="fa-solid fa-xmark ul-close" onclick="closeModal('search-modal')"></i></div>
    <div class="p-4 border-b border-[#333]"><input type="text" id="search-query" class="input-field" placeholder="Cerca utenti..." onkeyup="performSearch()"></div>
    <div id="search-results" class="ul-body"></div>
  </div>
</div>

<div id="user-list-modal" class="modal-overlay hidden">
  <div class="user-list-modal">
    <div class="ul-header"><span id="ul-title">Lista</span> <i class="fa-solid fa-xmark ul-close" onclick="closeModal('user-list-modal')"></i></div>
    <div id="ul-content" class="ul-body"></div>
  </div>
</div>

<div id="post-detail-modal" class="modal-overlay hidden">
  <div class="post-modal-layout">
    <div class="pm-image-side">
      <img id="detail-img" src="">
      <div id="detail-noimg" class="hidden text-gray-500 font-medium">Solo Testo</div>
    </div>
    <div class="pm-info-side">
      <div class="pm-header">
        <div class="flex items-center gap-3 cursor-pointer" id="detail-user-link">
          <img id="detail-avatar" src="" class="avatar-sm">
          <span id="detail-username" class="font-bold text-sm"></span>
        </div>
        <i class="fa-solid fa-xmark cursor-pointer text-xl text-gray-400 hover:text-white" onclick="closeModal('post-detail-modal')"></i>
      </div>
      <div class="pm-comments-list" id="detail-comments"></div>
      <div class="pm-footer">
        <div class="flex gap-5 text-2xl mb-3">
          <i id="detail-like-btn" class="fa-regular fa-heart cursor-pointer hover:text-gray-400 transition"></i>
          <i class="fa-regular fa-comment cursor-pointer hover:text-gray-400 transition"></i>
        </div>
        <div class="font-bold text-sm mb-3"><span id="detail-likes-count">0</span> Mi piace</div>
        <div class="flex gap-3">
          <input type="text" id="new-comment" placeholder="Aggiungi un commento..." class="bg-transparent text-sm w-full outline-none text-white placeholder-gray-500">
          <button onclick="inviaCommento()" class="text-white font-semibold text-sm hover:opacity-80">Pubblica</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="edit-profile-modal" class="modal-overlay hidden">
  <div class="bg-[#1a1b1e] rounded-2xl p-6 w-[400px] border border-[#333] shadow-2xl">
    <h2 class="text-xl font-bold mb-5 text-center">Modifica Profilo</h2>
    <div class="flex flex-col gap-4">
      <div class="text-center">
        <div class="relative inline-block group">
          <img id="edit-avatar-preview" src="" class="w-24 h-24 rounded-full mx-auto mb-3 object-cover border-2 border-[#333] group-hover:border-white transition">
          <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition cursor-pointer" onclick="document.getElementById('avatar-upload').click()">
            <i class="fa-solid fa-pen text-white"></i>
          </div>
        </div>
        <label class="block text-blue-400 text-sm font-semibold cursor-pointer hover:text-blue-300">Cambia foto <input type="file" id="avatar-upload" class="hidden" accept="image/*" onchange="uploadAvatar(this)"></label>
      </div>
      <div><label class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1 block">Username</label><input id="edit-username" type="text" class="input-field"></div>
      <div><label class="text-xs text-gray-500 uppercase font-bold tracking-wider mb-1 block">Nome Completo</label><input id="edit-fullname" type="text" class="input-field"></div>
      <div class="flex gap-3 mt-4">
        <button onclick="saveProfile()" class="btn-primary flex-1">Salva</button>
        <button onclick="closeModal('edit-profile-modal')" class="btn-secondary flex-1">Annulla</button>
      </div>
    </div>
  </div>
</div>

<script>
  const SB_URL = 'https://nqeuecpgvqexhpztpois.supabase.co';
  const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZXVlY3BndnFleGhwenRwb2lzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNjYwMDksImV4cCI6MjA4Mzc0MjAwOX0.v7U65EtUk1tXcwS3e2Hl0wipT5NbuHO439XvO1h8Kxc';
  const sb = window.supabase.createClient(SB_URL, SB_KEY);
  const BUCKET_POSTS = 'posts';
  const BUCKET_AVATARS = 'avatars';

  let currentUser = null;
  let currentPostId = null;
  let viewingUserId = null;

  window.addEventListener('load', async () => {
    // Auth Animation
    let i = 0;
    const imgs = document.querySelectorAll('.visual-side img');
    if (imgs.length) {
      setInterval(() => {
        imgs[i].classList.remove('active');
        i = (i + 1) % imgs.length;
        imgs[i].classList.add('active');
      }, 5000);
    }

    const { data: { session } } = await sb.auth.getSession();
    if (session) enterApp(session.user);
    else document.getElementById('auth-container').style.display = 'flex';
  });

  // --- SHARE FUNCTIONALITY ---
  async function sharePost(postId, caption) {
    const textToShare = `Guarda questo post su Hawenishland: ${caption || ''}`;
    if (navigator.share) {
      try {
        await navigator.share({
          title: 'Hawenishland Post',
          text: textToShare,
          url: window.location.href
        });
      } catch (err) { console.log('Share canceled'); }
    } else {
      try {
        await navigator.clipboard.writeText(textToShare);
        alert("Link copiato negli appunti! Condividilo con i tuoi amici.");
      } catch (err) {
        alert("Impossibile copiare il link.");
      }
    }
  }

  // --- NAVIGATION ---
  function goHome() { renderFeedView(); }
  function goToMyProfile() { openUserProfile(currentUser.id); }
  function openSearchModal() { document.getElementById('search-modal').classList.remove('hidden'); document.getElementById('search-query').focus(); }
  function openUploadModal() { document.getElementById('upload-modal').classList.remove('hidden'); document.getElementById('upload-preview').classList.add('hidden'); document.getElementById('post-file').value = ""; }
  function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

  // --- FEED ---
  async function renderFeedView() {
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl text-gray-500"></i></div>`;
    
    const { data: follows } = await sb.from('follows').select('followed_id').eq('follower_id', currentUser.id);
    const followingIds = follows ? follows.map(f => f.followed_id) : [];
    followingIds.push(currentUser.id);

    const { data: posts, error } = await sb.from('posts').select(`*, profiles:user_id (username, avatar_url)`).in('user_id', followingIds).order('created_at', { ascending: false });

    if (error) return main.innerHTML = `<div class="text-center mt-10 text-red-500">Errore caricamento feed</div>`;
    if (!posts || posts.length === 0) return main.innerHTML = `<div class="text-center mt-20 text-gray-500"><i class="fa-regular fa-compass text-4xl mb-4"></i><p>Il feed è vuoto.</p><button onclick="openSearchModal()" class="btn-primary mt-4">Cerca Persone</button></div>`;

    main.innerHTML = '';
    for (const post of posts) {
      const counts = await getPostCounts(post.id);
      const likedByMe = await isLikedByMe(post.id);
      main.insertAdjacentHTML('beforeend', createPostHTML(post, counts, likedByMe));
    }
  }

  function createPostHTML(post, counts, liked) {
    const user = post.profiles || { username: 'Unknown', avatar_url: null };
    const likeClass = liked ? 'fa-solid text-red-500' : 'fa-regular';
    
    return `
      <div class="post-card">
        <div class="post-header">
          <div class="user-info" onclick="openUserProfile('${post.user_id}')">
            <img src="${user.avatar_url || 'https://via.placeholder.com/150'}" class="avatar-sm">
            <span class="username-bold">${user.username}</span>
          </div>
          <i class="fa-solid fa-ellipsis text-gray-500 cursor-pointer hover:text-white transition"></i>
        </div>
        ${post.image_url ? `<img src="${post.image_url}" class="post-image" onclick="openPostDetail('${post.id}')">` : ''}
        <div class="post-actions">
          <i class="${likeClass} fa-heart action-btn" id="feed-like-${post.id}" onclick="toggleLike('${post.id}', this)"></i>
          <i class="fa-regular fa-comment action-btn" onclick="openPostDetail('${post.id}')"></i>
          <i class="fa-regular fa-paper-plane action-btn" onclick="sharePost('${post.id}', '${escapeHtml(post.caption)}')"></i>
        </div>
        <div class="post-stats" onclick="openPostDetail('${post.id}')"><span id="feed-likes-count-${post.id}">${counts.likes}</span> Mi piace</div>
        <div class="post-caption"><span class="caption-user" onclick="openUserProfile('${post.user_id}')">${user.username}</span>${escapeHtml(post.caption)}</div>
        <div class="view-comments" onclick="openPostDetail('${post.id}')">Visualizza tutti e ${counts.comments} i commenti</div>
      </div>
    `;
  }

  // --- PROFILE ---
  async function openUserProfile(userId) {
    viewingUserId = userId;
    const main = document.getElementById('main-content-area');
    main.innerHTML = `<div class="flex justify-center mt-10"><i class="fa-solid fa-circle-notch fa-spin text-2xl"></i></div>`;
    const { data: profile } = await sb.from('profiles').select('*').eq('id', userId).single();
    if (!profile) return main.innerHTML = "Utente non trovato";

    const { count: postsCount } = await sb.from('posts').select('*', { count: 'exact', head: true }).eq('user_id', userId);
    const { count: followersCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('followed_id', userId);
    const { count: followingCount } = await sb.from('follows').select('*', { count: 'exact', head: true }).eq('follower_id', userId);
    
    let isFollowing = false;
    if (userId !== currentUser.id) {
      const { data } = await sb.from('follows').select('*').eq('follower_id', currentUser.id).eq('followed_id', userId);
      isFollowing = data && data.length > 0;
    }

    const { data: posts } = await sb.from('posts').select('*').eq('user_id', userId).order('created_at', { ascending: false });
    const isMe = userId === currentUser.id;
    const actionBtn = isMe ? `<button onclick="openEditProfile()" class="btn-secondary">Modifica</button>` : `<button onclick="toggleFollow('${userId}')" id="follow-btn" class="btn-primary ${isFollowing ? '!bg-transparent !text-white !border-gray-600' : ''}">${isFollowing ? 'Seguito' : 'Segui'}</button>`;

    main.innerHTML = `
      <div class="profile-header">
        <img src="${profile.avatar_url || 'https://via.placeholder.com/150'}" class="profile-avatar-lg" onclick="${isMe ? 'openEditProfile()' : ''}">
        <div class="profile-info">
          <div class="profile-top"><span class="profile-username">${profile.username}</span>${actionBtn}${isMe ? '<i class="fa-solid fa-gear text-xl cursor-pointer text-gray-400 hover:text-white" onclick="logout()"></i>' : ''}</div>
          <div class="profile-stats">
            <div class="stat-item"><span class="stat-value">${postsCount || 0}</span> post</div>
            <div class="stat-item" onclick="showUserList('followers', '${userId}')"><span class="stat-value" id="p-followers">${followersCount || 0}</span> follower</div>
            <div class="stat-item" onclick="showUserList('following', '${userId}')"><span class="stat-value">${followingCount || 0}</span> seguiti</div>
          </div>
          <div class="profile-bio"><div class="profile-fullname">${profile.full_name || ''}</div></div>
        </div>
      </div>
      <div class="posts-grid">${posts.map(p => `<div class="grid-item" onclick="openPostDetail('${p.id}')">${p.image_url ? `<img src="${p.image_url}">` : `<div class="w-full h-full bg-[#1a1b1e] flex items-center justify-center text-xs p-4 text-center text-gray-500 border border-gray-800">${escapeHtml(p.caption).substring(0,30)}...</div>`}<div class="grid-overlay"><span><i class="fa-solid fa-heart"></i> ${p.caption ? 'Info' : 'Testo'}</span></div></div>`).join('')}</div>
    `;
  }

  // --- ACTIONS ---
  async function toggleFollow(targetId) {
    const btn = document.getElementById('follow-btn');
    const isFollowing = btn.innerText === 'Seguito';
    if (isFollowing) {
      await sb.from('follows').delete().eq('follower_id', currentUser.id).eq('followed_id', targetId);
      btn.innerText = 'Segui'; btn.classList.remove('!bg-transparent', '!text-white', '!border-gray-600');
    } else {
      await sb.from('follows').insert([{ follower_id: currentUser.id, followed_id: targetId }]);
      btn.innerText = 'Seguito'; btn.classList.add('!bg-transparent', '!text-white', '!border-gray-600');
    }
    const countEl = document.getElementById('p-followers');
    if(countEl) countEl.innerText = isFollowing ? parseInt(countEl.innerText) - 1 : parseInt(countEl.innerText) + 1;
  }

  async function toggleLike(postId, btnElement) {
    const isLiked = btnElement.classList.contains('fa-solid');
    const countSpan = document.getElementById(`feed-likes-count-${postId}`);
    let currentCount = parseInt(countSpan.innerText);
    if (isLiked) {
      await sb.from('likes').delete().eq('post_id', postId).eq('user_id', currentUser.id);
      btnElement.classList.remove('fa-solid', 'text-red-500'); btnElement.classList.add('fa-regular');
      countSpan.innerText = Math.max(0, currentCount - 1);
    } else {
      await sb.from('likes').insert([{ post_id: postId, user_id: currentUser.id }]);
      btnElement.classList.remove('fa-regular'); btnElement.classList.add('fa-solid', 'text-red-500', 'like-active');
      countSpan.innerText = currentCount + 1;
      setTimeout(() => btnElement.classList.remove('like-active'), 200);
    }
  }

  // --- POST DETAIL ---
  async function openPostDetail(postId) {
    currentPostId = postId;
    document.getElementById('post-detail-modal').classList.remove('hidden');
    document.getElementById('detail-comments').innerHTML = '<div class="text-center text-gray-500 mt-5">Caricamento...</div>';
    
    const { data: post } = await sb.from('posts').select(`*, profiles:user_id(*)`).eq('id', postId).single();
    if (post.image_url) { document.getElementById('detail-img').src = post.image_url; document.getElementById('detail-img').classList.remove('hidden'); document.getElementById('detail-noimg').classList.add('hidden'); }
    else { document.getElementById('detail-img').classList.add('hidden'); document.getElementById('detail-noimg').classList.remove('hidden'); }

    const user = post.profiles;
    document.getElementById('detail-avatar').src = user.avatar_url || 'https://via.placeholder.com/32';
    document.getElementById('detail-username').innerText = user.username;
    document.getElementById('detail-user-link').onclick = () => { closeModal('post-detail-modal'); openUserProfile(post.user_id); };

    const liked = await isLikedByMe(postId);
    const likeBtn = document.getElementById('detail-like-btn');
    likeBtn.className = liked ? "fa-solid fa-heart cursor-pointer text-red-500" : "fa-regular fa-heart cursor-pointer hover:text-gray-400";
    likeBtn.onclick = () => { toggleLike(postId, likeBtn); refreshDetailCounts(postId); };

    const commentList = document.getElementById('detail-comments');
    commentList.innerHTML = '';
    if (post.caption) commentList.insertAdjacentHTML('beforeend', `<div class="comment-row mb-4"><img src="${user.avatar_url || 'https://via.placeholder.com/32'}" class="comment-avatar" onclick="closeModal('post-detail-modal'); openUserProfile('${post.user_id}')"><div><span class="font-bold mr-2 text-sm cursor-pointer hover:underline" onclick="closeModal('post-detail-modal'); openUserProfile('${post.user_id}')">${user.username}</span><span class="text-sm text-gray-300">${escapeHtml(post.caption)}</span></div></div>`);

    const { data: comments } = await sb.from('comments').select(`*, profiles:user_id(username, avatar_url)`).eq('post_id', postId).order('created_at', { ascending: true });
    comments.forEach(c => {
      const u = c.profiles;
      commentList.insertAdjacentHTML('beforeend', `<div class="comment-row"><img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="comment-avatar" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')"><div><span class="font-bold mr-2 cursor-pointer hover:text-gray-300" onclick="closeModal('post-detail-modal'); openUserProfile('${c.user_id}')">${u.username}</span><span class="text-gray-400">${escapeHtml(c.content)}</span></div></div>`);
    });
    refreshDetailCounts(postId);
  }

  async function refreshDetailCounts(postId) {
    const counts = await getPostCounts(postId);
    document.getElementById('detail-likes-count').innerText = counts.likes;
  }
  async function inviaCommento() {
    const txt = document.getElementById('new-comment').value.trim();
    if (!txt) return;
    await sb.from('comments').insert([{ post_id: currentPostId, user_id: currentUser.id, content: txt }]);
    document.getElementById('new-comment').value = '';
    openPostDetail(currentPostId);
  }

  // --- HELPERS ---
  async function showUserList(type, userId) {
    const modal = document.getElementById('user-list-modal');
    modal.classList.remove('hidden');
    document.getElementById('ul-title').innerText = type === 'followers' ? 'Follower' : 'Seguiti';
    const content = document.getElementById('ul-content');
    content.innerHTML = '<div class="p-4 text-center">Caricamento...</div>';
    
    let query = type === 'followers' ? sb.from('follows').select(`profiles!follows_follower_id_fkey(*)`).eq('followed_id', userId) : sb.from('follows').select(`profiles!follows_followed_id_fkey(*)`).eq('follower_id', userId);
    const { data, error } = await query;
    if (error || !data.length) return content.innerHTML = '<div class="p-4 text-center text-gray-500">Nessun utente.</div>';
    
    content.innerHTML = '';
    data.map(x => x.profiles).forEach(u => {
      content.insertAdjacentHTML('beforeend', `<div class="user-row cursor-pointer" onclick="closeModal('user-list-modal'); openUserProfile('${u.id}')"><div class="flex items-center gap-3"><img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="w-10 h-10 rounded-full bg-gray-800 object-cover"><div><div class="font-bold text-sm text-gray-200">${u.username}</div><div class="text-xs text-gray-500">${u.full_name || ''}</div></div></div></div>`);
    });
  }

  async function performSearch() {
    const q = document.getElementById('search-query').value.trim();
    const resDiv = document.getElementById('search-results');
    if (q.length < 2) return resDiv.innerHTML = '';
    const { data } = await sb.from('profiles').select('*').ilike('username', `%${q}%`).limit(10);
    resDiv.innerHTML = '';
    data.forEach(u => resDiv.insertAdjacentHTML('beforeend', `<div class="user-row cursor-pointer" onclick="closeModal('search-modal'); openUserProfile('${u.id}')"><div class="flex items-center gap-3"><img src="${u.avatar_url || 'https://via.placeholder.com/32'}" class="w-10 h-10 rounded-full bg-gray-800 object-cover"><div class="font-bold text-sm text-gray-200">${u.username}</div></div></div>`));
  }

  async function getPostCounts(postId) {
    const { count: l } = await sb.from('likes').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    const { count: c } = await sb.from('comments').select('*', { count: 'exact', head: true }).eq('post_id', postId);
    return { likes: l || 0, comments: c || 0 };
  }
  async function isLikedByMe(postId) { const { data } = await sb.from('likes').select('id').eq('post_id', postId).eq('user_id', currentUser.id); return data && data.length > 0; }
  function previewUpload(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = function(e) { const img = document.getElementById('upload-preview'); img.src = e.target.result; img.classList.remove('hidden'); }; reader.readAsDataURL(input.files[0]); } }
  async function submitPost() {
    const file = document.getElementById('post-file').files[0];
    const caption = document.getElementById('post-caption').value;
    if (!file && !caption) return alert("Aggiungi foto o testo");
    let publicUrl = null;
    if (file) { const fileName = `${currentUser.id}/${Date.now()}`; await sb.storage.from(BUCKET_POSTS).upload(fileName, file); const { data } = sb.storage.from(BUCKET_POSTS).getPublicUrl(fileName); publicUrl = data.publicUrl; }
    await sb.from('posts').insert([{ user_id: currentUser.id, image_url: publicUrl, caption: caption }]);
    closeModal('upload-modal'); renderFeedView();
  }
  function openEditProfile() {
    document.getElementById('edit-profile-modal').classList.remove('hidden');
    sb.from('profiles').select('*').eq('id', currentUser.id).single().then(({data}) => { document.getElementById('edit-username').value = data.username; document.getElementById('edit-fullname').value = data.full_name; document.getElementById('edit-avatar-preview').src = data.avatar_url || 'https://via.placeholder.com/150'; });
  }
  async function saveProfile() {
    await sb.from('profiles').update({ username: document.getElementById('edit-username').value, full_name: document.getElementById('edit-fullname').value }).eq('id', currentUser.id);
    closeModal('edit-profile-modal'); openUserProfile(currentUser.id);
  }
  async function uploadAvatar(input) {
    const file = input.files[0];
    if (!file) return;
    const fileName = `${currentUser.id}/avatar_${Date.now()}`;
    await sb.storage.from(BUCKET_AVATARS).upload(fileName, file);
    const { data } = sb.storage.from(BUCKET_AVATARS).getPublicUrl(fileName);
    document.getElementById('edit-avatar-preview').src = data.publicUrl;
    await sb.from('profiles').update({ avatar_url: data.publicUrl }).eq('id', currentUser.id);
  }

  // --- AUTH UTILS ---
  function mess(t,e){const b=document.getElementById('msg-box');b.innerText=t;b.classList.remove('hidden');b.style.borderColor=e?'red':'green';b.style.color=e?'red':'green';}
  function vaiA(m){ document.getElementById('login-form').classList.toggle('hidden',m==='signup'); document.getElementById('signup-form').classList.toggle('hidden',m==='login'); }
  function escapeHtml(text) { return text ? text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;") : ""; }
  async function faiLogin() { const { data, error } = await sb.auth.signInWithPassword({ email: document.getElementById('l-email').value, password: document.getElementById('l-pass').value }); if(error) mess(error.message, true); else enterApp(data.user); }
  async function faiRegistrazione() { const { data, error } = await sb.auth.signUp({email: document.getElementById('r-email').value, password: document.getElementById('r-pass').value}); if(error) return mess(error.message, true); if(data.user) { await sb.from('profiles').insert([{ id: data.user.id, username: document.getElementById('r-username').value }]); } mess("Registrazione ok, controlla email!"); }
  async function logout() { await sb.auth.signOut(); location.reload(); }
  function enterApp(user) { currentUser = user; document.getElementById('auth-container').style.transform = "translateY(-100vh)"; setTimeout(() => { document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-interface').classList.remove('hidden'); goHome(); }, 600); }
</script>
</body>
</html>
